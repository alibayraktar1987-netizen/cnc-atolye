<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
<title>CNC AtÃ¶lye Takip</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet"/>
<style>*{box-sizing:border-box;margin:0;padding:0;}body{background:#0a0c12;}</style>
</head>
<body>
<div id="root"></div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, collection, getDocs, addDoc, updateDoc, deleteDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA6BAv57T-M_oeg5c0-irynYThqQv0s1xI",
  authDomain: "cnc-atolye.firebaseapp.com",
  projectId: "cnc-atolye",
  storageBucket: "cnc-atolye.firebasestorage.app",
  messagingSenderId: "1059210834667",
  appId: "1:1059210834667:web:1e506c41567b4e273784ae"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// â”€â”€ DB HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.DB = {
  async getDoc(col, id) {
    try { const s = await getDoc(doc(db, col, id)); return s.exists() ? { id: s.id, ...s.data() } : null; } catch { return null; }
  },
  async setDoc(col, id, data) {
    try { await setDoc(doc(db, col, id), data, { merge: true }); return true; } catch(e) { console.error(e); return false; }
  },
  async getAll(col) {
    try { const s = await getDocs(collection(db, col)); return s.docs.map(d => ({ id: d.id, ...d.data() })); } catch { return []; }
  },
  async addDoc(col, data) {
    try { const r = await addDoc(collection(db, col), { ...data, createdAt: new Date().toISOString() }); return r.id; } catch { return null; }
  },
  async updateDoc(col, id, data) {
    try { await updateDoc(doc(db, col, id), data); return true; } catch { return false; }
  },
  async deleteDoc(col, id) {
    try { await deleteDoc(doc(db, col, id)); return true; } catch { return false; }
  }
};

// â”€â”€ SESSION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.Session = {
  get() { try { const s = localStorage.getItem("cnc_session"); return s ? JSON.parse(s) : null; } catch { return null; } },
  set(u) { localStorage.setItem("cnc_session", JSON.stringify(u)); },
  clear() { localStorage.removeItem("cnc_session"); }
};

// Signal that Firebase is ready
window.FB_READY = true;
window.dispatchEvent(new Event("fb_ready"));
</script>

<!-- React + Babel -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel" data-presets="react">
const { useState, useEffect, useCallback, useRef } = React;

// â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_MACHINES = ["CNC-1","CNC-2","CNC-3","CNC-4"];
const SHIFTS = [
  { id:"sabah", label:"Sabah", time:"06:00â€“14:00" },
  { id:"ogleden", label:"Ã–ÄŸleden Sonra", time:"14:00â€“22:00" },
  { id:"gece", label:"Gece", time:"22:00â€“06:00" },
];
const EFFECTIVE_SECONDS = 72000;
const LOGO_SRC = "./logo.png";
const PERMISSIONS = [
  { id:"data_entry", label:"Veri GiriÅŸi", icon:"ğŸ“", desc:"Ãœretim verisi girebilir" },
  { id:"view_reports", label:"Rapor GÃ¶rÃ¼ntÃ¼leme", icon:"ğŸ“Š", desc:"TÃ¼m raporlarÄ± gÃ¶rebilir" },
  { id:"manage_orders", label:"Ä°ÅŸ Emri OluÅŸturma", icon:"ğŸ“‹", desc:"Ä°ÅŸ emri ekleyip dÃ¼zenleyebilir" },
  { id:"approve_users", label:"KullanÄ±cÄ± Onaylama", icon:"ğŸ‘¥", desc:"KullanÄ±cÄ±larÄ± onaylayabilir" },
];

const C = {
  bg:"#0a0c12", surface:"#12151f", card:"#181b28", border:"#252837",
  accent:"#4f8ef7", accentDim:"#4f8ef715",
  green:"#00c896", greenDim:"#00c89615",
  red:"#ff4d6d", redDim:"#ff4d6d15",
  warn:"#ffb830", warnDim:"#ffb83015",
  purple:"#9b7ff4",
  text:"#e2e5f0", muted:"#5a5f75", muted2:"#8b90a8",
};
const ORDER_STATUS_OPTIONS = [
  { id:"active", label:"Aktif", color:C.green },
  { id:"completed", label:"TamamlandÄ±", color:C.accent },
  { id:"shipped", label:"KargolandÄ±", color:C.warn },
  { id:"liquidation", label:"Tesfiyede", color:C.red },
  { id:"passive", label:"Pasif", color:C.muted2 },
];

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const pad2 = n => String(n).padStart(2,"0");
const ymdLocal = (d=new Date()) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
const parseYmdLocal = s => {
  const [y,m,d]=(s||"").split("-").map(Number);
  if(!y||!m||!d) return new Date();
  return new Date(y,m-1,d);
};
const todayStr = () => ymdLocal(new Date());
const monthStr = (d=new Date()) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
function weekStart(d=new Date()) {
  const x=new Date(d); const day=x.getDay();
  x.setDate(x.getDate()-(day===0?6:day-1));
  return ymdLocal(x);
}
function calcPerf(correct,wrong,partSec) {
  if(!partSec||partSec<=0) return null;
  const max=Math.floor(EFFECTIVE_SECONDS/partSec);
  return {max, perf:max>0?Math.round(((correct+wrong)/max)*100):0};
}
function fmtSec(s) {
  if(!s) return "";
  const m=Math.floor(s/60),sec=s%60;
  return m>0?(sec>0?m+"dk "+sec+"sn":m+"dk"):sec+"sn";
}
function hasPermission(user,perm) {
  if(user.role==="admin") return true;
  return (user.permissions||[]).includes(perm);
}
async function fileToBase64(file) {
  return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
}
function getFileIcon(name) {
  const ext=(name||"").split(".").pop().toLowerCase();
  if(["jpg","jpeg","png","gif","webp"].includes(ext)) return "ğŸ–¼ï¸";
  if(ext==="pdf") return "ğŸ“„";
  if(["dxf","dwg"].includes(ext)) return "ğŸ“";
  return "ğŸ“";
}
function formatBytes(b) {
  if(b<1024) return b+" B";
  if(b<1048576) return (b/1024).toFixed(1)+" KB";
  return (b/1048576).toFixed(1)+" MB";
}
function hashPass(p) { return btoa(unescape(encodeURIComponent(p))); }
function getOrderStatusMeta(status) {
  return ORDER_STATUS_OPTIONS.find(s=>s.id===status) || ORDER_STATUS_OPTIONS.find(s=>s.id==="passive");
}

// â”€â”€ STYLE ATOMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const labelSt={color:C.muted2,fontSize:11,letterSpacing:.8,textTransform:"uppercase",fontWeight:600,marginBottom:6,display:"block"};
const inputSt={width:"100%",background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,padding:"11px 14px",color:C.text,fontSize:14,outline:"none",boxSizing:"border-box",fontFamily:"inherit"};
const chip=(active,color=C.accent)=>({padding:"8px 13px",borderRadius:9,border:`1px solid ${active?color:C.border}`,background:active?color+"18":C.surface,color:active?color:C.muted2,fontSize:12,fontWeight:active?700:400,cursor:"pointer",fontFamily:"inherit"});
const btnSt=(v="primary")=>({border:"none",borderRadius:10,padding:"11px 18px",fontSize:13,fontWeight:700,cursor:"pointer",fontFamily:"inherit",transition:"opacity .15s",
  ...(v==="primary"?{background:C.accent,color:"#fff",boxShadow:`0 4px 18px ${C.accent}30`}:
     v==="danger"?{background:C.red,color:"#fff"}:
     v==="green"?{background:C.green,color:"#0a0c12",boxShadow:`0 4px 18px ${C.green}30`}:
     v==="ghost"?{background:"transparent",color:C.muted2,border:`1px solid ${C.border}`}:
     {background:C.surface,color:C.text,border:`1px solid ${C.border}`})});

function Badge({label:l,color=C.muted2}) {
  return <span style={{background:color+"20",color,border:`1px solid ${color}40`,borderRadius:6,padding:"2px 8px",fontSize:10,fontWeight:700,letterSpacing:.5,textTransform:"uppercase"}}>{l}</span>;
}
function PerfBar({perf,small}) {
  const col=perf>=85?C.green:perf>=60?C.warn:C.red;
  return (
    <div style={{marginTop:small?4:8}}>
      <div style={{display:"flex",justifyContent:"space-between",fontSize:11,color:C.muted2,marginBottom:3}}>
        <span>Performans</span><span style={{color:col,fontWeight:700}}>{perf}%</span>
      </div>
      <div style={{background:C.border,borderRadius:99,height:small?4:6,overflow:"hidden"}}>
        <div style={{width:`${Math.min(perf,100)}%`,height:"100%",background:col,borderRadius:99,transition:"width .6s ease"}}/>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function AuthScreen({onLogin,logoSrc=LOGO_SRC}) {
  const [portal,setPortal]=useState("operator");
  const [mode,setMode]=useState("login");
  const [form,setForm]=useState({username:"",password:"",confirm:"",fullName:""});
  const [err,setErr]=useState(""); const [ok,setOk]=useState(""); const [loading,setLoading]=useState(false);
  const [logoError,setLogoError]=useState(false);
  const [adminStats,setAdminStats]=useState({loading:false,activeOrders:0,todayEntries:0,pendingUsers:0,activeOperators:0,todayCorrect:0,todayWrong:0,lastUpdated:""});
  const f=k=>e=>setForm(p=>({...p,[k]:e.target.value}));

  useEffect(()=>{
    if(portal==="admin"&&mode!=="login") setMode("login");
    setErr(""); setOk("");
  },[portal,mode]);
  useEffect(()=>{setLogoError(false);},[logoSrc]);

  const loadAdminStats=useCallback(async()=>{
    setAdminStats(s=>({...s,loading:true}));
    const [users,orders,entries]=await Promise.all([
      window.DB.getAll("users"),
      window.DB.getAll("orders"),
      window.DB.getAll("entries"),
    ]);
    const today=todayStr();
    const todayRows=entries.filter(e=>e.date===today);
    const now=new Date();
    const hh=pad2(now.getHours());
    const mm=pad2(now.getMinutes());
    setAdminStats({
      loading:false,
      activeOrders:orders.filter(o=>o.status==="active").length,
      todayEntries:todayRows.length,
      pendingUsers:users.filter(u=>u.status==="pending").length,
      activeOperators:users.filter(u=>u.role==="operator"&&u.status==="active").length,
      todayCorrect:todayRows.reduce((s,e)=>s+(Number(e.correct)||0),0),
      todayWrong:todayRows.reduce((s,e)=>s+(Number(e.wrong)||0),0),
      lastUpdated:`${hh}:${mm}`,
    });
  },[]);

  useEffect(()=>{
    if(portal!=="admin") return;
    loadAdminStats();
  },[portal,loadAdminStats]);

  async function doLogin() {
    setErr(""); setLoading(true);
    const u = await window.DB.getDoc("users", form.username.toLowerCase());
    if(!u){setErr("KullanÄ±cÄ± bulunamadÄ±.");setLoading(false);return;}
    if(u.password!==hashPass(form.password)){setErr("Åifre hatalÄ±.");setLoading(false);return;}
    if(u.status==="pending"){setErr("HesabÄ±nÄ±z onay bekliyor.");setLoading(false);return;}
    if(u.status==="rejected"){setErr("HesabÄ±nÄ±z reddedildi.");setLoading(false);return;}
    if(portal==="admin"&&u.role!=="admin"){setErr("Bu giriÅŸ ekranÄ± yalnÄ±zca yÃ¶netici hesaplarÄ± iÃ§indir.");setLoading(false);return;}
    if(portal==="operator"&&u.role!=="operator"){setErr("YÃ¶netici hesabÄ± ile YÃ¶netici GiriÅŸi ekranÄ±nÄ± kullanÄ±n.");setLoading(false);return;}
    window.Session.set({username:u.id});
    onLogin(u); setLoading(false);
  }

  async function doRegister() {
    setErr(""); setOk("");
    if(!form.username||!form.password||!form.fullName){setErr("TÃ¼m alanlar zorunlu.");return;}
    if(form.password!==form.confirm){setErr("Åifreler eÅŸleÅŸmiyor.");return;}
    if(form.password.length<4){setErr("Åifre en az 4 karakter.");return;}
    setLoading(true);
    const key=form.username.toLowerCase().trim();
    const existing=await window.DB.getDoc("users",key);
    if(existing){setErr("Bu kullanÄ±cÄ± adÄ± alÄ±nmÄ±ÅŸ.");setLoading(false);return;}
    const allUsers=await window.DB.getAll("users");
    const isFirst=allUsers.length===0;
    const saved=await window.DB.setDoc("users",key,{
      username:key, fullName:form.fullName, password:hashPass(form.password),
      role:isFirst?"admin":"operator", status:isFirst?"active":"pending",
      permissions:["data_entry","view_reports"]
    });
    if(!saved){setErr("Kullanici kaydi olusturulamadi. Veritabani yetkilerini (Firestore Rules) kontrol edin.");setLoading(false);return;}
    setOk(isFirst?"Ä°lk kullanÄ±cÄ± â†’ otomatik YÃ¶netici! GiriÅŸ yapabilirsiniz.":"KayÄ±t baÅŸarÄ±lÄ±! YÃ¶netici onayÄ±nÄ± bekleyin.");
    setMode("login"); setForm({username:"",password:"",confirm:"",fullName:""}); setLoading(false);
  }

  return (
    <div style={{minHeight:"100vh",background:C.bg,display:"flex",alignItems:"center",justifyContent:"center",padding:20}}>
      <div style={{width:"100%",maxWidth:portal==="admin"?980:380}}>
        <div style={{display:"flex",background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,padding:4,margin:"0 auto 22px",maxWidth:420}}>
          {[["operator","OperatÃ¶r GiriÅŸi"],["admin","YÃ¶netici GiriÅŸi"]].map(([id,lbl])=>(
            <button key={id} onClick={()=>setPortal(id)} style={{flex:1,padding:"10px 0",border:"none",borderRadius:9,cursor:"pointer",background:portal===id?C.card:"transparent",color:portal===id?C.text:C.muted2,fontWeight:portal===id?700:500,fontSize:13,fontFamily:"inherit"}}>{lbl}</button>
          ))}
        </div>

        {portal==="operator"?(
          <div style={{width:"100%",maxWidth:380,margin:"0 auto"}}>
            <div style={{textAlign:"center",marginBottom:28}}>
              <div style={{width:60,height:60,borderRadius:18,background:`linear-gradient(135deg,${C.accent},#7b5cf0)`,display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 10px",overflow:"hidden"}}>
                {!logoError?<img src={logoSrc||LOGO_SRC} alt="Logo" onError={()=>setLogoError(true)} style={{width:"100%",height:"100%",objectFit:"cover"}}/>:<span style={{fontSize:28}}>âš™ï¸</span>}
              </div>
              <div style={{fontWeight:800,fontSize:22,color:C.text,letterSpacing:-.5}}>CNC AtÃ¶lye</div>
              <div style={{color:C.muted2,fontSize:13,marginTop:2}}>Ä°ÅŸ Takip Sistemi</div>
            </div>
            <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:18,padding:24}}>
              <div style={{display:"flex",background:C.surface,borderRadius:10,padding:3,marginBottom:20}}>
                {[["login","GiriÅŸ Yap"],["register","KayÄ±t Ol"]].map(([id,lbl])=>(
                  <button key={id} onClick={()=>{setMode(id);setErr("");setOk("");}} style={{flex:1,padding:"9px 0",border:"none",borderRadius:8,cursor:"pointer",background:mode===id?C.card:"transparent",color:mode===id?C.text:C.muted2,fontWeight:mode===id?700:400,fontSize:13,fontFamily:"inherit"}}>{lbl}</button>
                ))}
              </div>
              {err&&<div style={{background:C.redDim,border:`1px solid ${C.red}40`,borderRadius:10,padding:"10px 14px",color:C.red,fontSize:13,marginBottom:14}}>{err}</div>}
              {ok&&<div style={{background:C.greenDim,border:`1px solid ${C.green}40`,borderRadius:10,padding:"10px 14px",color:C.green,fontSize:13,marginBottom:14}}>{ok}</div>}
              <div style={{display:"flex",flexDirection:"column",gap:12}}>
                {mode==="register"&&<div><span style={labelSt}>Ad Soyad</span><input style={inputSt} placeholder="AdÄ±nÄ±z SoyadÄ±nÄ±z" value={form.fullName} onChange={f("fullName")}/></div>}
                <div><span style={labelSt}>KullanÄ±cÄ± AdÄ±</span><input style={inputSt} placeholder="kullanici_adi" value={form.username} onChange={f("username")} autoCapitalize="none" autoCorrect="off"/></div>
                <div><span style={labelSt}>Åifre</span><input style={inputSt} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" type="password" value={form.password} onChange={f("password")}/></div>
                {mode==="register"&&<div><span style={labelSt}>Åifre Tekrar</span><input style={inputSt} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" type="password" value={form.confirm} onChange={f("confirm")}/></div>}
                <button onClick={mode==="login"?doLogin:doRegister} style={{...btnSt("primary"),width:"100%",padding:14,fontSize:15,opacity:loading?.7:1}} disabled={loading}>
                  {loading?"...":mode==="login"?"GiriÅŸ Yap":"KayÄ±t Ol"}
                </button>
              </div>
            </div>
            <div style={{textAlign:"center",color:C.muted,fontSize:11,marginTop:12}}>Ä°lk kayÄ±t otomatik YÃ¶netici olur.</div>
          </div>
        ):(
          <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(280px,1fr))",gap:16,alignItems:"stretch"}}>
            <div style={{background:`linear-gradient(155deg,${C.surface},${C.card})`,border:`1px solid ${C.border}`,borderRadius:16,padding:22}}>
              <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:18}}>
                <div style={{width:42,height:42,borderRadius:12,background:`linear-gradient(135deg,${C.accent},#7b5cf0)`,display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden"}}>
                  {!logoError?<img src={logoSrc||LOGO_SRC} alt="Logo" onError={()=>setLogoError(true)} style={{width:"100%",height:"100%",objectFit:"cover"}}/>:<span style={{fontSize:18}}>âš™ï¸</span>}
                </div>
                <div>
                  <div style={{fontWeight:800,fontSize:18,color:C.text,letterSpacing:-.3}}>YÃ¶netici Paneli</div>
                  <div style={{fontSize:12,color:C.muted2}}>Dashboard eriÅŸimi</div>
                </div>
              </div>
              <div style={{display:"grid",gridTemplateColumns:"repeat(2,minmax(0,1fr))",gap:10}}>
                {[
                  ["Aktif Ä°ÅŸ Emirleri",adminStats.activeOrders,C.accent],
                  ["BugÃ¼n GiriÅŸ",adminStats.todayEntries,C.green],
                  ["Onay Bekleyen",adminStats.pendingUsers,C.warn],
                  ["Aktif OperatÃ¶r",adminStats.activeOperators,C.muted2],
                ].map(([title,value,color])=>(
                  <div key={title} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:12}}>
                    <div style={{fontSize:11,color:C.muted2,marginBottom:6,textTransform:"uppercase",letterSpacing:.7}}>{title}</div>
                    <div style={{fontSize:22,color,marginBottom:2,fontWeight:800,fontFamily:"monospace"}}>{value}</div>
                  </div>
                ))}
              </div>
              <div style={{display:"flex",gap:10,marginTop:10}}>
                <div style={{flex:1,background:C.card,border:`1px solid ${C.border}`,borderRadius:10,padding:"8px 10px"}}>
                  <div style={{fontSize:10,color:C.muted2,textTransform:"uppercase",letterSpacing:.7}}>BugÃ¼n DoÄŸru / HatalÄ±</div>
                  <div style={{fontSize:14,color:C.text,fontWeight:700,marginTop:2}}><span style={{color:C.green}}>{adminStats.todayCorrect}</span> / <span style={{color:C.red}}>{adminStats.todayWrong}</span></div>
                </div>
                <button onClick={loadAdminStats} disabled={adminStats.loading} style={{...btnSt("ghost"),padding:"8px 12px",fontSize:12,alignSelf:"stretch",opacity:adminStats.loading?.7:1}}>
                  {adminStats.loading?"Yenileniyor...":"Yenile"}
                </button>
              </div>
            </div>
            <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:16,padding:22}}>
              <div style={{fontWeight:700,fontSize:18,color:C.text,marginBottom:4}}>YÃ¶netici GiriÅŸi</div>
              <div style={{fontSize:12,color:C.muted2,marginBottom:16}}>Sadece yÃ¶netici hesaplarÄ±yla giriÅŸ yapÄ±labilir. {adminStats.lastUpdated?`Son gÃ¼ncelleme: ${adminStats.lastUpdated}`:""}</div>
              {err&&<div style={{background:C.redDim,border:`1px solid ${C.red}40`,borderRadius:10,padding:"10px 14px",color:C.red,fontSize:13,marginBottom:14}}>{err}</div>}
              {ok&&<div style={{background:C.greenDim,border:`1px solid ${C.green}40`,borderRadius:10,padding:"10px 14px",color:C.green,fontSize:13,marginBottom:14}}>{ok}</div>}
              <div style={{display:"flex",flexDirection:"column",gap:12}}>
                <div><span style={labelSt}>KullanÄ±cÄ± AdÄ±</span><input style={inputSt} placeholder="yonetici_adi" value={form.username} onChange={f("username")} autoCapitalize="none" autoCorrect="off"/></div>
                <div><span style={labelSt}>Åifre</span><input style={inputSt} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" type="password" value={form.password} onChange={f("password")}/></div>
                <button onClick={doLogin} style={{...btnSt("primary"),width:"100%",padding:14,fontSize:15,opacity:loading?.7:1}} disabled={loading}>{loading?"...":"YÃ¶netici Olarak GiriÅŸ Yap"}</button>
                <button onClick={()=>{setPortal("operator");setMode("register");setErr("");setOk("");}} style={{...btnSt("ghost"),width:"100%",padding:12,fontSize:13}}>Yeni hesap oluÅŸtur</button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MACHINE SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function MachineSettings({machines,onUpdate}) {
  const [editing,setEditing]=useState(false);
  const [draft,setDraft]=useState([...machines]);
  const [newName,setNewName]=useState("");

  async function save() {
    const cleaned=draft.map(m=>m.trim()).filter(Boolean);
    if(cleaned.length===0){alert("En az 1 tezgah gerekli!");return;}
    await onUpdate(cleaned); setEditing(false);
  }
  return (
    <div style={{marginBottom:24}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
        <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",fontWeight:600}}>Tezgah Ä°simleri</div>
        {!editing&&<button onClick={()=>{setDraft([...machines]);setEditing(true);}} style={{...btnSt("ghost"),padding:"6px 12px",fontSize:12}}>âœï¸ DÃ¼zenle</button>}
      </div>
      {!editing?(
        <div style={{display:"flex",gap:7,flexWrap:"wrap"}}>
          {machines.map((m,i)=><div key={i} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:9,padding:"8px 14px",fontSize:13,fontWeight:600,color:C.text}}>{m}</div>)}
        </div>
      ):(
        <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:14}}>
          <div style={{display:"flex",flexDirection:"column",gap:8,marginBottom:12}}>
            {draft.map((m,i)=>(
              <div key={i} style={{display:"flex",gap:8,alignItems:"center"}}>
                <input value={m} onChange={e=>setDraft(d=>d.map((x,idx)=>idx===i?e.target.value:x))} style={{...inputSt,flex:1,padding:"9px 12px",fontSize:13}}/>
                <button onClick={()=>setDraft(d=>d.filter((_,idx)=>idx!==i))} style={{background:"transparent",border:`1px solid ${C.red}50`,borderRadius:8,color:C.red,width:34,height:34,cursor:"pointer",fontSize:16,flexShrink:0}}>Ã—</button>
              </div>
            ))}
          </div>
          <div style={{display:"flex",gap:8,marginBottom:12}}>
            <input value={newName} onChange={e=>setNewName(e.target.value)} onKeyDown={e=>{if(e.key==="Enter"&&newName.trim()){setDraft(d=>[...d,newName.trim()]);setNewName("");}}} placeholder="Yeni tezgah adÄ±..." style={{...inputSt,flex:1,padding:"9px 12px",fontSize:13}}/>
            <button onClick={()=>{if(newName.trim()){setDraft(d=>[...d,newName.trim()]);setNewName("");}}} style={{...btnSt("primary"),padding:"9px 14px",fontSize:13,flexShrink:0}}>+ Ekle</button>
          </div>
          <div style={{display:"flex",gap:8}}>
            <button onClick={save} style={{...btnSt("green"),flex:1,padding:10}}>ğŸ’¾ Kaydet</button>
            <button onClick={()=>setEditing(false)} style={{...btnSt("ghost"),padding:10}}>Ä°ptal</button>
          </div>
        </div>
      )}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN USERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function AdminUsers({currentUser,machines,onMachinesUpdate,currentLogo,onLogoUpdate}) {
  const [users,setUsers]=useState([]);
  const [loading,setLoading]=useState(true);
  const [expanded,setExpanded]=useState(null);
  const [logoLoading,setLogoLoading]=useState(false);
  const logoInputRef=useRef(null);

  const load=useCallback(async()=>{ const u=await window.DB.getAll("users"); setUsers(u); setLoading(false); },[]);
  useEffect(()=>{load();},[load]);

  async function update(id,patch) {
    await window.DB.updateDoc("users",id,patch);
    setUsers(u=>u.map(x=>x.id===id?{...x,...patch}:x));
  }
  async function togglePerm(id,permId) {
    const u=users.find(x=>x.id===id);
    const perms=[...(u.permissions||[])];
    const idx=perms.indexOf(permId);
    if(idx>=0) perms.splice(idx,1); else perms.push(permId);
    await update(id,{permissions:perms});
  }

  const list=[...users].sort((a,b)=>{const o={pending:0,active:1,rejected:2};return(o[a.status]??3)-(o[b.status]??3);});
  if(loading) return <div style={{padding:30,color:C.muted2,textAlign:"center"}}>YÃ¼kleniyor...</div>;

  async function pickLogo(e){
    const file=e.target.files&&e.target.files[0];
    if(!file) return;
    if(!file.type.startsWith("image/")){alert("Lutfen bir gorsel dosyasi secin."); return;}
    if(file.size>2*1024*1024){alert("Logo en fazla 2MB olabilir."); return;}
    setLogoLoading(true);
    const data=await fileToBase64(file);
    await onLogoUpdate(data);
    setLogoLoading(false);
    e.target.value="";
  }

  return (
    <div style={{padding:16}}>
      <div style={{marginBottom:18}}>
        <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",fontWeight:600,marginBottom:8}}>Logo Ayari</div>
        <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:12}}>
          <div style={{display:"flex",alignItems:"center",gap:12,marginBottom:10}}>
            <div style={{width:56,height:56,borderRadius:12,background:C.surface,border:`1px solid ${C.border}`,display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden"}}>
              <img src={currentLogo||LOGO_SRC} alt="Logo" style={{width:"100%",height:"100%",objectFit:"cover"}}/>
            </div>
            <div style={{fontSize:12,color:C.muted2}}>Giris sayfasi ve uygulama basliginda kullanilir.</div>
          </div>
          <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
            <button onClick={()=>logoInputRef.current?.click()} style={{...btnSt("primary"),padding:"8px 12px",fontSize:12}} disabled={logoLoading}>{logoLoading?"Yukleniyor...":"Logo Yukle"}</button>
            <button onClick={()=>onLogoUpdate("")} style={{...btnSt("ghost"),padding:"8px 12px",fontSize:12}} disabled={logoLoading}>Varsayilana Don</button>
            <input ref={logoInputRef} type="file" accept="image/*" style={{display:"none"}} onChange={pickLogo}/>
          </div>
        </div>
      </div>
      <MachineSettings machines={machines} onUpdate={onMachinesUpdate}/>
      <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",marginBottom:12}}>Ayarlar Â· KullanÄ±cÄ± YÃ¶netimi Â· {list.length} kullanÄ±cÄ±</div>
      {list.map(u=>(
        <div key={u.id} style={{background:C.card,border:`1px solid ${u.status==="pending"?C.warn+"60":C.border}`,borderRadius:14,padding:"14px 16px",marginBottom:10}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:8}}>
            <div><div style={{fontWeight:700,fontSize:14}}>{u.fullName}</div><div style={{color:C.muted2,fontSize:12,marginTop:1}}>@{u.username||u.id}</div></div>
            <div style={{display:"flex",gap:5,flexWrap:"wrap",justifyContent:"flex-end"}}>
              <Badge label={u.role==="admin"?"YÃ¶netici":"OperatÃ¶r"} color={u.role==="admin"?C.accent:C.muted2}/>
              <Badge label={u.status==="active"?"Aktif":u.status==="pending"?"Bekliyor":"AskÄ±da"} color={u.status==="active"?C.green:u.status==="pending"?C.warn:C.red}/>
            </div>
          </div>
          {u.id!==currentUser.id&&(
            <>
              <div style={{display:"flex",gap:7,flexWrap:"wrap",marginBottom:8}}>
                {u.status==="pending"&&<><button onClick={()=>update(u.id,{status:"active"})} style={{...btnSt("green"),padding:"7px 13px",fontSize:12}}>âœ“ Onayla</button><button onClick={()=>update(u.id,{status:"rejected"})} style={{...btnSt("danger"),padding:"7px 13px",fontSize:12}}>âœ• Reddet</button></>}
                {u.status==="active"&&<><button onClick={()=>update(u.id,{role:u.role==="admin"?"operator":"admin"})} style={{...btnSt(),padding:"7px 13px",fontSize:12}}>{u.role==="admin"?"ğŸ‘· OperatÃ¶r Yap":"ğŸ‘‘ YÃ¶netici Yap"}</button><button onClick={()=>update(u.id,{status:"rejected"})} style={{...btnSt("danger"),padding:"7px 13px",fontSize:12}}>AskÄ±ya Al</button></>}
                {u.status==="rejected"&&<button onClick={()=>update(u.id,{status:"active"})} style={{...btnSt("green"),padding:"7px 13px",fontSize:12}}>AktifleÅŸtir</button>}
                {u.role==="operator"&&<button onClick={()=>setExpanded(expanded===u.id?null:u.id)} style={{...btnSt("ghost"),padding:"7px 13px",fontSize:12}}>{expanded===u.id?"â–² Gizle":"âš™ï¸ Yetkiler"}</button>}
              </div>
              {expanded===u.id&&u.role==="operator"&&(
                <div style={{background:C.surface,borderRadius:10,padding:12,border:`1px solid ${C.border}`}}>
                  <div style={{color:C.muted2,fontSize:11,letterSpacing:.8,textTransform:"uppercase",marginBottom:10,fontWeight:600}}>KullanÄ±cÄ± Yetkileri</div>
                  {PERMISSIONS.map(p=>{
                    const active=(u.permissions||[]).includes(p.id);
                    return (
                      <div key={p.id} onClick={()=>togglePerm(u.id,p.id)} style={{display:"flex",alignItems:"center",gap:12,padding:"10px 12px",borderRadius:9,marginBottom:6,cursor:"pointer",background:active?C.accent+"12":C.card,border:`1px solid ${active?C.accent+"40":C.border}`}}>
                        <div style={{fontSize:18}}>{p.icon}</div>
                        <div style={{flex:1}}><div style={{fontWeight:600,fontSize:13,color:active?C.accent:C.text}}>{p.label}</div><div style={{fontSize:11,color:C.muted2,marginTop:1}}>{p.desc}</div></div>
                        <div style={{width:20,height:20,borderRadius:5,border:`2px solid ${active?C.accent:C.border}`,background:active?C.accent:"transparent",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>{active&&<span style={{color:"#fff",fontSize:12,fontWeight:800}}>âœ“</span>}</div>
                      </div>
                    );
                  })}
                </div>
              )}
            </>
          )}
          {u.id===currentUser.id&&<div style={{color:C.muted,fontSize:11}}>Bu sizin hesabÄ±nÄ±z</div>}
        </div>
      ))}
    </div>
  );
}

function ToolStock({currentUser,machines=DEFAULT_MACHINES}) {
  const isAdmin=currentUser.role==="admin";
  const [tools,setTools]=useState([]);
  const [loading,setLoading]=useState(true);
  const [search,setSearch]=useState("");
  const [showForm,setShowForm]=useState(false);
  const [editId,setEditId]=useState(null);
  const [form,setForm]=useState({code:"",name:"",category:"",machine:"",qty:"",minQty:"",location:"",notes:""});

  const load=useCallback(async()=>{
    const rows=await window.DB.getAll("toolStock");
    setTools(rows.sort((a,b)=>(a.name||"").localeCompare(b.name||"","tr")));
    setLoading(false);
  },[]);
  useEffect(()=>{load();},[load]);

  const resetForm=()=>setForm({code:"",name:"",category:"",machine:"",qty:"",minQty:"",location:"",notes:""});
  const fv=(k,v)=>setForm(p=>({...p,[k]:v}));

  async function saveTool(){
    if(!form.name.trim()){alert("Takim adi zorunlu.");return;}
    const payload={
      code:form.code.trim(),
      name:form.name.trim(),
      category:form.category.trim(),
      machine:form.machine.trim(),
      qty:Number(form.qty)||0,
      minQty:Number(form.minQty)||0,
      location:form.location.trim(),
      notes:form.notes.trim(),
      updatedAt:new Date().toISOString(),
    };
    if(editId){
      const ok=await window.DB.updateDoc("toolStock",editId,payload);
      if(ok){
        setTools(t=>t.map(x=>x.id===editId?{...x,...payload}:x));
        setShowForm(false); setEditId(null); resetForm();
      }
      return;
    }
    const id=`tool_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,7)}`;
    const ok=await window.DB.setDoc("toolStock",id,payload);
    if(ok){
      setTools(t=>[...t,{id,...payload}].sort((a,b)=>(a.name||"").localeCompare(b.name||"","tr")));
      setShowForm(false); resetForm();
    }
  }

  async function removeTool(id,name){
    if(!confirm(`"${name}" takimini silmek istiyor musunuz?`)) return;
    const ok=await window.DB.deleteDoc("toolStock",id);
    if(ok) setTools(t=>t.filter(x=>x.id!==id));
  }

  const filtered=tools.filter(t=>{
    const q=search.toLowerCase().trim();
    if(!q) return true;
    return (t.name||"").toLowerCase().includes(q)||
      (t.code||"").toLowerCase().includes(q)||
      (t.category||"").toLowerCase().includes(q)||
      (t.machine||"").toLowerCase().includes(q)||
      (t.location||"").toLowerCase().includes(q);
  });
  const lowCount=tools.filter(t=>(Number(t.qty)||0)<=Math.max(Number(t.minQty)||0,0)).length;

  if(loading) return <div style={{padding:30,color:C.muted2,textAlign:"center"}}>Yukleniyor...</div>;

  if(showForm&&isAdmin){
    return (
      <div style={{padding:16}}>
        <button onClick={()=>{setShowForm(false);setEditId(null);resetForm();}} style={{...btnSt("ghost"),marginBottom:16,padding:"8px 14px",fontSize:13}}>Geri</button>
        <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",marginBottom:14}}>{editId?"Takim Duzenle":"Yeni Takim"}</div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
          <div><span style={labelSt}>Kod</span><input style={inputSt} value={form.code} onChange={e=>fv("code",e.target.value)} placeholder="TKM-001"/></div>
          <div><span style={labelSt}>Takim Adi *</span><input style={inputSt} value={form.name} onChange={e=>fv("name",e.target.value)} placeholder="12mm Parmak Freze"/></div>
          <div><span style={labelSt}>Kategori</span><input style={inputSt} value={form.category} onChange={e=>fv("category",e.target.value)} placeholder="Freze, Matkap..."/></div>
          <div><span style={labelSt}>Ilgili Tezgah</span><input style={inputSt} value={form.machine} onChange={e=>fv("machine",e.target.value)} list="tool-stock-machines" placeholder="CNC-1"/></div>
          <div><span style={labelSt}>Stok Adedi</span><input style={inputSt} type="number" min="0" value={form.qty} onChange={e=>fv("qty",e.target.value)} placeholder="0"/></div>
          <div><span style={labelSt}>Minimum Adet</span><input style={inputSt} type="number" min="0" value={form.minQty} onChange={e=>fv("minQty",e.target.value)} placeholder="0"/></div>
          <div><span style={labelSt}>Konum</span><input style={inputSt} value={form.location} onChange={e=>fv("location",e.target.value)} placeholder="Raf A2"/></div>
          <div style={{gridColumn:"1 / -1"}}><span style={labelSt}>Not</span><textarea style={{...inputSt,resize:"vertical",minHeight:70}} value={form.notes} onChange={e=>fv("notes",e.target.value)} placeholder="Aciklama..."/></div>
          <div style={{gridColumn:"1 / -1",display:"flex",gap:8}}>
            <button onClick={saveTool} style={{...btnSt("primary"),padding:"10px 14px"}}>Kaydet</button>
            <button onClick={()=>{setShowForm(false);setEditId(null);resetForm();}} style={{...btnSt("ghost"),padding:"10px 14px"}}>Iptal</button>
          </div>
        </div>
        <datalist id="tool-stock-machines">
          {machines.map(m=><option key={m} value={m}/>)}
        </datalist>
      </div>
    );
  }

  return (
    <div style={{padding:16}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12,gap:8,flexWrap:"wrap"}}>
        <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase"}}>Takim Stogu Â· {tools.length} kayit Â· {lowCount} kritik</div>
        {isAdmin&&<button onClick={()=>{resetForm();setEditId(null);setShowForm(true);}} style={{...btnSt("primary"),padding:"8px 14px",fontSize:12}}>+ Yeni Takim</button>}
      </div>
      <div style={{marginBottom:12}}>
        <input style={{...inputSt,padding:"9px 12px",fontSize:13}} placeholder="Takim adi, kod, kategori, tezgah veya konum ara..." value={search} onChange={e=>setSearch(e.target.value)}/>
      </div>
      {filtered.length===0&&<div style={{textAlign:"center",color:C.muted2,padding:"30px 20px",background:C.card,borderRadius:14,border:`1px solid ${C.border}`}}>Sonuc yok</div>}
      {filtered.map(t=>{
        const qty=Number(t.qty)||0;
        const min=Math.max(Number(t.minQty)||0,0);
        const critical=qty<=min;
        return (
          <div key={t.id} style={{background:C.card,border:`1px solid ${critical?C.red+"66":C.border}`,borderRadius:14,padding:"12px 14px",marginBottom:9}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",gap:10,marginBottom:8}}>
              <div>
                <div style={{fontSize:14,fontWeight:700,color:C.text}}>{t.name||"-"}</div>
                <div style={{fontSize:12,color:C.muted2,marginTop:2}}>{t.code?`${t.code} Â· `:""}{t.category||"Kategori yok"}</div>
              </div>
              <div style={{display:"flex",gap:5,flexWrap:"wrap",justifyContent:"flex-end"}}>
                <Badge label={`Stok ${qty}`} color={critical?C.red:C.green}/>
                <Badge label={`Min ${min}`} color={C.muted2}/>
              </div>
            </div>
            <div style={{display:"flex",gap:7,flexWrap:"wrap",fontSize:11,color:C.muted2,marginBottom:8}}>
              {t.machine&&<span style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,padding:"3px 8px"}}>Tezgah: {t.machine}</span>}
              {t.location&&<span style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,padding:"3px 8px"}}>Konum: {t.location}</span>}
              {critical&&<span style={{background:C.redDim,border:`1px solid ${C.red}44`,borderRadius:8,padding:"3px 8px",color:C.red}}>Stok kritik</span>}
            </div>
            {t.notes&&<div style={{fontSize:12,color:C.muted2,marginBottom:8}}>{t.notes}</div>}
            {isAdmin&&(
              <div style={{display:"flex",gap:7}}>
                <button onClick={()=>{setEditId(t.id);setForm({code:t.code||"",name:t.name||"",category:t.category||"",machine:t.machine||"",qty:String(qty),minQty:String(min),location:t.location||"",notes:t.notes||""});setShowForm(true);}} style={{...btnSt("ghost"),padding:"6px 10px",fontSize:12}}>Duzenle</button>
                <button onClick={()=>removeTool(t.id,t.name||"Takim")} style={{...btnSt("danger"),padding:"6px 10px",fontSize:12}}>Sil</button>
              </div>
            )}
          </div>
        );
      })}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WORK ORDERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function WorkOrders({currentUser,machines=DEFAULT_MACHINES}) {
  const [orders,setOrders]=useState([]);
  const [loading,setLoading]=useState(true);
  const [showForm,setShowForm]=useState(false);
  const [editId,setEditId]=useState(null);
  const [statusFilters,setStatusFilters]=useState([]);
  const [search,setSearch]=useState("");
  const [viewOrder,setViewOrder]=useState(null);
  const [previewFile,setPreviewFile]=useState(null);
  const [uploading,setUploading]=useState(false);
  const fileRef=useRef();
  const emptyForm={code:"",name:"",material:"",partSec:"",machines:[],notes:"",files:[]};
  const [form,setForm]=useState(emptyForm);
  const nextOrderCode=useCallback((list=orders)=>{
    const nums=list.map(o=>{
      const m=(o.code||"").toUpperCase().match(/^IE-(\d+)$/);
      return m?Number(m[1]):null;
    }).filter(n=>n!==null);
    const next=(nums.length?Math.max(...nums):0)+1;
    return `IE-${String(next).padStart(3,"0")}`;
  },[orders]);

  const load=useCallback(async()=>{ const o=await window.DB.getAll("orders"); setOrders(o.sort((a,b)=>b.createdAt?.localeCompare(a.createdAt))); setLoading(false); },[]);
  useEffect(()=>{load();},[load]);

  const fv=(k,v)=>setForm(p=>({...p,[k]:v}));
  const toggleMachine=m=>fv("machines",form.machines.includes(m)?form.machines.filter(x=>x!==m):[...form.machines,m]);
  const canPreview=f=>!!(f&&f.data&&(f.type?.startsWith("image/")||f.type==="application/pdf"));

  async function handleFiles(fileList) {
    setUploading(true);
    const results=[];
    for(const file of Array.from(fileList)){
      if(file.size>5*1024*1024){alert(`${file.name} 5MB'dan bÃ¼yÃ¼k, atlandÄ±.`);continue;}
      const b64=await fileToBase64(file);
      results.push({name:file.name,size:file.size,type:file.type,data:b64});
    }
    fv("files",[...form.files,...results]);
    setUploading(false);
  }

  async function save() {
    if(!form.name||!form.partSec){alert("ParÃ§a adÄ± ve sÃ¼re zorunlu!");return;}
    if(form.machines.length===0){alert("En az bir tezgah seÃ§in!");return;}
    const finalCode=editId?form.code:(form.code||nextOrderCode());
    const data={code:finalCode.toUpperCase(),name:form.name,material:form.material,partSec:Number(form.partSec),machines:form.machines,notes:form.notes,files:form.files,status:"active",updatedAt:new Date().toISOString()};
    if(editId){
      await window.DB.updateDoc("orders",editId,data);
      setOrders(o=>o.map(x=>x.id===editId?{...x,...data}:x));
    } else {
      const id=await window.DB.addDoc("orders",{...data,createdBy:currentUser.id});
      if(id) setOrders(o=>[{id,...data,createdAt:new Date().toISOString()},...o]);
    }
    setShowForm(false); setForm(emptyForm); setEditId(null);
  }

  async function setOrderStatus(o,status) {
    if(o.status===status) return;
    await window.DB.updateDoc("orders",o.id,{status});
    setOrders(orders=>orders.map(x=>x.id===o.id?{...x,status}:x));
  }

  const q=search.trim().toLowerCase();
  const toggleStatusFilter=statusId=>{
    setStatusFilters(prev=>prev.includes(statusId)?prev.filter(x=>x!==statusId):[...prev,statusId]);
  };
  const filteredOrders=orders.filter(o=>{
    const statusOk=statusFilters.length===0 ? true : statusFilters.includes(o.status||"passive");
    const textOk=!q || (o.code||"").toLowerCase().includes(q) || (o.name||"").toLowerCase().includes(q) || (o.material||"").toLowerCase().includes(q);
    return statusOk&&textOk;
  });

  if(loading) return <div style={{padding:30,color:C.muted2,textAlign:"center"}}>YÃ¼kleniyor...</div>;

  if(viewOrder) return (
    <div style={{padding:16}}>
      <button onClick={()=>{setPreviewFile(null);setViewOrder(null);}} style={{...btnSt("ghost"),marginBottom:16,padding:"8px 14px",fontSize:13}}>â† Geri</button>
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:16,marginBottom:12}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:12}}>
          <div><div style={{fontWeight:800,fontSize:18,fontFamily:"monospace",color:C.text}}>{viewOrder.code}</div><div style={{fontSize:15,fontWeight:600,marginTop:2,color:C.text}}>{viewOrder.name}</div></div>
          <Badge label={getOrderStatusMeta(viewOrder.status).label} color={getOrderStatusMeta(viewOrder.status).color}/>
        </div>
        {[["Malzeme",viewOrder.material],["ParÃ§a SÃ¼resi",fmtSec(viewOrder.partSec)],["Maks Ãœretim/GÃ¼n",viewOrder.partSec?Math.floor(EFFECTIVE_SECONDS/viewOrder.partSec)+" adet":"-"],["Tezgahlar",(viewOrder.machines||[]).join(", ")],["Notlar",viewOrder.notes]].map(([l,v])=>v?(
          <div key={l} style={{marginBottom:10}}><div style={{color:C.muted2,fontSize:11,letterSpacing:.8,textTransform:"uppercase",marginBottom:2}}>{l}</div><div style={{fontSize:14,color:C.text}}>{v}</div></div>
        ):null)}
      </div>
      <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",marginBottom:10}}>Teknik Dosyalar ({(viewOrder.files||[]).length})</div>
      {(viewOrder.files||[]).length===0?<div style={{color:C.muted,fontSize:13,textAlign:"center",padding:20,background:C.card,borderRadius:12,border:`1px solid ${C.border}`}}>Dosya yÃ¼klenmemiÅŸ</div>:
        (viewOrder.files||[]).map((f,i)=>(
          <div key={i} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"12px 14px",marginBottom:8,display:"flex",alignItems:"center",gap:12}}>
            <div style={{fontSize:28,flexShrink:0}}>{getFileIcon(f.name)}</div>
            <div style={{flex:1,minWidth:0}}><div style={{fontWeight:600,fontSize:13,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",color:C.text}}>{f.name}</div><div style={{color:C.muted2,fontSize:11,marginTop:2}}>{formatBytes(f.size)}</div></div>
            {f.data&&f.type&&f.type.startsWith("image/")&&<img src={f.data} alt={f.name} style={{width:48,height:48,objectFit:"cover",borderRadius:8,border:`1px solid ${C.border}`}}/>}
            {canPreview(f)&&<button onClick={()=>setPreviewFile(f)} style={{...btnSt(),padding:"6px 10px",fontSize:12,flexShrink:0}}>GÃ¶rÃ¼ntÃ¼le</button>}
            {f.data&&<a href={f.data} download={f.name} style={{...btnSt("ghost"),padding:"6px 10px",fontSize:12,textDecoration:"none",flexShrink:0}}>â¬‡</a>}
          </div>
        ))
      }
      {previewFile&&(
        <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,.72)",zIndex:60,display:"flex",alignItems:"center",justifyContent:"center",padding:16}} onClick={()=>setPreviewFile(null)}>
          <div style={{width:"100%",maxWidth:960,maxHeight:"88vh",background:C.card,border:`1px solid ${C.border}`,borderRadius:14,overflow:"hidden",display:"flex",flexDirection:"column"}} onClick={e=>e.stopPropagation()}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"10px 12px",borderBottom:`1px solid ${C.border}`}}>
              <div style={{fontSize:13,fontWeight:700,color:C.text,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{previewFile.name}</div>
              <button onClick={()=>setPreviewFile(null)} style={{...btnSt("ghost"),padding:"6px 10px",fontSize:12}}>Kapat</button>
            </div>
            <div style={{padding:10,overflow:"auto",background:C.surface}}>
              {previewFile.type&&previewFile.type.startsWith("image/")&&<img src={previewFile.data} alt={previewFile.name} style={{width:"100%",height:"auto",borderRadius:10,border:`1px solid ${C.border}`}}/>}
              {previewFile.type==="application/pdf"&&<iframe title={previewFile.name} src={previewFile.data} style={{width:"100%",height:"70vh",border:`1px solid ${C.border}`,borderRadius:10,background:"#fff"}}/>}
            </div>
          </div>
        </div>
      )}
    </div>
  );

  if(showForm) return (
    <div style={{padding:16}}>
      <button onClick={()=>{setShowForm(false);setForm(emptyForm);setEditId(null);}} style={{...btnSt("ghost"),marginBottom:16,padding:"8px 14px",fontSize:13}}>â† Geri</button>
      <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",marginBottom:16}}>{editId?"Ä°ÅŸ Emri DÃ¼zenle":"Yeni Ä°ÅŸ Emri"}</div>
      <div style={{display:"flex",flexDirection:"column",gap:14}}>
        <div><span style={labelSt}>Ä°ÅŸ Emri Kodu *</span><input style={{...inputSt,background:editId?C.surface:C.card,color:editId?C.text:C.accent,fontWeight:700}} placeholder="IE-001" value={form.code} readOnly={!editId} onChange={e=>fv("code",e.target.value.toUpperCase())}/></div>
        <div><span style={labelSt}>ParÃ§a AdÄ± *</span><input style={inputSt} placeholder="ParÃ§a adÄ±" value={form.name} onChange={e=>fv("name",e.target.value)}/></div>
        <div><span style={labelSt}>Malzeme</span><input style={inputSt} placeholder="AISI 304, AlÃ¼minyum 6061..." value={form.material} onChange={e=>fv("material",e.target.value)}/></div>
        <div>
          <span style={labelSt}>ParÃ§a SÃ¼resi (saniye) *</span>
          <input style={inputSt} type="number" min="1" placeholder="Ã–rn: 90" value={form.partSec} onChange={e=>fv("partSec",e.target.value)}/>
          {form.partSec>0&&<div style={{color:C.muted2,fontSize:11,marginTop:5}}>â†’ Maks: <span style={{color:C.accent,fontWeight:700}}>{Math.floor(EFFECTIVE_SECONDS/Number(form.partSec))} adet</span>/gÃ¼n ({fmtSec(Number(form.partSec))}/parÃ§a)</div>}
        </div>
        <div>
          <span style={labelSt}>Tezgah AtamasÄ± *</span>
          <div style={{display:"flex",gap:7,flexWrap:"wrap"}}>
            {machines.map(m=><button key={m} onClick={()=>toggleMachine(m)} style={chip(form.machines.includes(m))}>{m}</button>)}
          </div>
        </div>
        <div><span style={labelSt}>Notlar</span><textarea style={{...inputSt,resize:"vertical",minHeight:70}} placeholder="Notlar..." value={form.notes} onChange={e=>fv("notes",e.target.value)}/></div>
        <div>
          <span style={labelSt}>Teknik Dosyalar</span>
          <div onClick={()=>fileRef.current?.click()} style={{border:`2px dashed ${C.border}`,borderRadius:12,padding:20,textAlign:"center",cursor:"pointer",background:C.surface}} onDragOver={e=>e.preventDefault()} onDrop={e=>{e.preventDefault();handleFiles(e.dataTransfer.files);}}>
            <div style={{fontSize:28,marginBottom:6}}>ğŸ“</div>
            <div style={{color:C.muted2,fontSize:13}}>{uploading?"YÃ¼kleniyor...":"Dosya seÃ§ veya sÃ¼rÃ¼kle bÄ±rak"}</div>
            <div style={{color:C.muted,fontSize:11,marginTop:4}}>Resim, PDF, DXF, DWG Â· Maks 5MB/dosya</div>
          </div>
          <input ref={fileRef} type="file" multiple accept="image/*,.pdf,.dxf,.dwg,.step,.stp" style={{display:"none"}} onChange={e=>handleFiles(e.target.files)}/>
          {form.files.map((f,i)=>(
            <div key={i} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:10,padding:"10px 12px",marginTop:8,display:"flex",alignItems:"center",gap:10}}>
              <span style={{fontSize:20}}>{getFileIcon(f.name)}</span>
              <div style={{flex:1,minWidth:0}}><div style={{fontSize:12,fontWeight:600,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",color:C.text}}>{f.name}</div><div style={{fontSize:11,color:C.muted2}}>{formatBytes(f.size)}</div></div>
              {f.data&&f.type&&f.type.startsWith("image/")&&<img src={f.data} alt="" style={{width:36,height:36,objectFit:"cover",borderRadius:6}}/>}
              <button onClick={()=>fv("files",form.files.filter((_,idx)=>idx!==i))} style={{background:"transparent",border:"none",color:C.red,fontSize:18,cursor:"pointer"}}>Ã—</button>
            </div>
          ))}
        </div>
        <div style={{display:"flex",gap:8}}><button onClick={save} style={{...btnSt("primary"),flex:1,padding:13}}>ğŸ’¾ Kaydet</button><button onClick={()=>{setShowForm(false);setForm(emptyForm);setEditId(null);}} style={{...btnSt("ghost"),padding:13}}>Ä°ptal</button></div>
      </div>
    </div>
  );

  return (
    <div style={{padding:16}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
        <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase"}}>Ä°ÅŸ Emirleri Â· {orders.filter(o=>o.status==="active").length} aktif</div>
        <button onClick={()=>{setEditId(null);setForm({...emptyForm,code:nextOrderCode()});setShowForm(true);}} style={{...btnSt("primary"),padding:"8px 14px",fontSize:12}}>+ Yeni</button>
      </div>
      <div style={{display:"flex",gap:8,marginBottom:12,flexWrap:"wrap"}}>
        <input style={{...inputSt,flex:"1 1 230px",padding:"9px 12px",fontSize:13}} placeholder="Kod, parÃ§a veya malzeme ara..." value={search} onChange={e=>setSearch(e.target.value)}/>
      </div>
      <div style={{display:"flex",gap:7,marginBottom:12,flexWrap:"wrap"}}>
        <button onClick={()=>setStatusFilters([])} style={chip(statusFilters.length===0,C.muted2)}>TÃ¼m Durumlar</button>
        {ORDER_STATUS_OPTIONS.map(s=><button key={s.id} onClick={()=>toggleStatusFilter(s.id)} style={chip(statusFilters.includes(s.id),s.color)}>{s.label}</button>)}
      </div>
      {orders.length===0&&<div style={{textAlign:"center",color:C.muted2,padding:"40px 20px",background:C.card,borderRadius:14,border:`1px solid ${C.border}`}}><div style={{fontSize:36,marginBottom:10}}>ğŸ“‹</div>HenÃ¼z iÅŸ emri yok</div>}
      {orders.length>0&&filteredOrders.length===0&&<div style={{textAlign:"center",color:C.muted2,padding:"24px 20px",background:C.card,borderRadius:14,border:`1px solid ${C.border}`}}>Filtreye uygun iÅŸ emri bulunamadÄ±</div>}
      {filteredOrders.map(o=>(
        <div key={o.id} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:"13px 15px",marginBottom:10,opacity:(o.status==="passive"||o.status==="liquidation")?.6:1}}>
          <div style={{marginBottom:8}}>
            <div style={{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"}}>
              <span style={{fontWeight:800,fontSize:14,fontFamily:"monospace",color:C.text}}>{o.code}</span>
              <Badge label={getOrderStatusMeta(o.status).label} color={getOrderStatusMeta(o.status).color}/>
              {(o.files||[]).length>0&&<Badge label={`${o.files.length} dosya`} color={C.purple}/>}
            </div>
            <div style={{fontSize:13,color:C.muted2,marginTop:3}}>{o.name}</div>
            {o.material&&<div style={{fontSize:11,color:C.muted,marginTop:1}}>ğŸ”© {o.material}</div>}
            <div style={{fontSize:11,color:C.muted,marginTop:1}}>â± {fmtSec(o.partSec)} Â· {(o.machines||[]).join(", ")}</div>
          </div>
          <div style={{display:"flex",gap:7,flexWrap:"wrap"}}>
            <button onClick={()=>setViewOrder(o)} style={{...btnSt("ghost"),padding:"6px 12px",fontSize:12}}>ğŸ‘ GÃ¶rÃ¼ntÃ¼le</button>
            <button onClick={()=>{setForm({code:o.code,name:o.name,material:o.material||"",partSec:o.partSec,machines:o.machines||[],notes:o.notes||"",files:o.files||[]});setEditId(o.id);setShowForm(true);}} style={{...btnSt(),padding:"6px 12px",fontSize:12}}>âœï¸ DÃ¼zenle</button>
            <select style={{...inputSt,width:150,padding:"6px 10px",fontSize:12}} value={o.status||"passive"} onChange={e=>setOrderStatus(o,e.target.value)}>
              {ORDER_STATUS_OPTIONS.map(s=><option key={s.id} value={s.id}>{s.label}</option>)}
            </select>
          </div>
        </div>
      ))}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA ENTRY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function DataEntry({currentUser,machines=DEFAULT_MACHINES}) {
  const [orders,setOrders]=useState([]);
  const [todayEntries,setTodayEntries]=useState([]);
  const [saved,setSaved]=useState(false);
  const [search,setSearch]=useState("");
  const [showPicker,setShowPicker]=useState(false);
  const [editId,setEditId]=useState(null);
  const [form,setForm]=useState({entryDate:todayStr(),machine:machines[0]||"CNC-1",shift:"sabah",selectedOrder:null,correct:"",wrong:""});

  useEffect(()=>{
    window.DB.getAll("orders").then(o=>setOrders(o.filter(x=>x.status==="active")));
    window.DB.getAll("entries").then(e=>setTodayEntries(e.filter(x=>x.date===form.entryDate&&x.operatorId===currentUser.id)));
  },[currentUser.id,form.entryDate]);

  const fv=(k,v)=>setForm(p=>({...p,[k]:v}));
  const filtered=orders.filter(o=>o.code.toLowerCase().includes(search.toLowerCase())||o.name.toLowerCase().includes(search.toLowerCase()));
  const selectedDateObj=parseYmdLocal(form.entryDate);
  const selectedDateLabel=new Intl.DateTimeFormat("tr-TR",{weekday:"long",day:"2-digit",month:"long",year:"numeric"}).format(selectedDateObj);
  const resetEntryForm=()=>setForm(p=>({entryDate:p.entryDate,machine:p.machine||machines[0]||"CNC-1",shift:p.shift||"sabah",selectedOrder:null,correct:"",wrong:""}));

  async function submit() {
    if(!form.selectedOrder){alert("Ä°ÅŸ emri seÃ§in!");return;}
    if(!form.correct){alert("DoÄŸru adet zorunlu!");return;}
    const d=parseYmdLocal(form.entryDate);
    const entry={
      date:ymdLocal(d), week:weekStart(d), month:monthStr(d),
      machine:form.machine, shift:form.shift,
      operatorId:currentUser.id, operatorName:currentUser.fullName,
      jobCode:form.selectedOrder.code, jobName:form.selectedOrder.name,
      partSec:Number(form.selectedOrder.partSec),
      correct:Number(form.correct), wrong:Number(form.wrong)||0,
    };
    if(editId){
      const ok=await window.DB.updateDoc("entries",editId,entry);
      if(ok){
        setTodayEntries(e=>e.map(x=>x.id===editId?{...x,...entry}:x));
        setEditId(null);
        setSaved(true); setTimeout(()=>setSaved(false),2000);
        resetEntryForm();
      }
      return;
    }
    const id=await window.DB.addDoc("entries",entry);
    if(id){
      setTodayEntries(e=>[{id,...entry},...e]);
      setSaved(true); setTimeout(()=>setSaved(false),2000);
      resetEntryForm();
    }
  }

  function startEdit(entry){
    const matched=orders.find(o=>o.code===entry.jobCode);
    const selectedOrder=matched||{code:entry.jobCode,name:entry.jobName,partSec:entry.partSec};
    setEditId(entry.id);
    setShowPicker(false);
    setForm({
      entryDate:entry.date||todayStr(),
      machine:entry.machine||machines[0]||"CNC-1",
      shift:entry.shift||"sabah",
      selectedOrder,
      correct:String(entry.correct??""),
      wrong:String(entry.wrong??0),
    });
  }

  async function removeEntry(entry){
    if(!confirm(`Bu girisi silmek istiyor musunuz? (${entry.jobCode})`)) return;
    const ok=await window.DB.deleteDoc("entries",entry.id);
    if(!ok) return;
    setTodayEntries(e=>e.filter(x=>x.id!==entry.id));
    if(editId===entry.id){
      setEditId(null);
      resetEntryForm();
    }
  }

  return (
    <div style={{padding:16,display:"flex",flexDirection:"column",gap:14}}>
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"10px 12px",display:"flex",justifyContent:"space-between",alignItems:"center",gap:10,flexWrap:"wrap"}}>
        <div style={{fontSize:13,fontWeight:600,color:C.text,textTransform:"capitalize"}}>{selectedDateLabel}</div>
        <div style={{minWidth:170}}>
          <input style={{...inputSt,padding:"8px 10px",fontSize:13}} type="date" max={todayStr()} value={form.entryDate} onChange={e=>fv("entryDate",e.target.value||todayStr())}/>
        </div>
      </div>
      {editId&&(
        <div style={{background:C.warnDim,border:`1px solid ${C.warn}50`,borderRadius:10,padding:"10px 12px",display:"flex",justifyContent:"space-between",alignItems:"center",gap:10}}>
          <span style={{fontSize:12,color:C.warn,fontWeight:700}}>DÃ¼zenleme modu aÃ§Ä±k</span>
          <button onClick={()=>{setEditId(null);resetEntryForm();}} style={{...btnSt("ghost"),padding:"6px 10px",fontSize:12}}>Ä°ptal</button>
        </div>
      )}
      <div>
        <span style={labelSt}>Tezgah</span>
        <div style={{display:"flex",gap:7,flexWrap:"wrap"}}>
          {machines.map(m=><button key={m} onClick={()=>fv("machine",m)} style={chip(form.machine===m)}>{m}</button>)}
        </div>
      </div>
      <div>
        <span style={labelSt}>Vardiya</span>
        <div style={{display:"flex",gap:7,flexWrap:"wrap"}}>
          {SHIFTS.map(s=><button key={s.id} onClick={()=>fv("shift",s.id)} style={chip(form.shift===s.id)}>{s.label}<br/><span style={{fontSize:10,color:form.shift===s.id?C.accent:C.muted}}>{s.time}</span></button>)}
        </div>
      </div>
      <div>
        <span style={labelSt}>Ä°ÅŸ Emri *</span>
        {form.selectedOrder?(
          <div style={{background:C.surface,border:`1px solid ${C.accent}50`,borderRadius:10,padding:"12px 14px",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
            <div>
              <div style={{fontWeight:700,fontFamily:"monospace",fontSize:14,color:C.text}}>{form.selectedOrder.code}</div>
              <div style={{fontSize:12,color:C.muted2,marginTop:1}}>{form.selectedOrder.name} Â· {fmtSec(form.selectedOrder.partSec)} Â· Maks: {Math.floor(EFFECTIVE_SECONDS/form.selectedOrder.partSec)} adet/gÃ¼n</div>
              {form.selectedOrder.material&&<div style={{fontSize:11,color:C.muted,marginTop:1}}>ğŸ”© {form.selectedOrder.material}</div>}
            </div>
            <button onClick={()=>fv("selectedOrder",null)} style={{background:"transparent",border:"none",color:C.red,fontSize:20,cursor:"pointer"}}>Ã—</button>
          </div>
        ):(
          <>
            <button onClick={()=>setShowPicker(!showPicker)} style={{...inputSt,textAlign:"left",cursor:"pointer",color:C.muted2,display:"block"}}>{orders.length===0?"Aktif iÅŸ emri yok":"Ä°ÅŸ emri seÃ§in..."}</button>
            {showPicker&&(
              <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:10,marginTop:4,overflow:"hidden"}}>
                <input style={{...inputSt,borderRadius:0,borderBottom:`1px solid ${C.border}`}} placeholder="Ara..." value={search} onChange={e=>setSearch(e.target.value)} autoFocus/>
                <div style={{maxHeight:240,overflowY:"auto"}}>
                  {filtered.length===0&&<div style={{padding:16,color:C.muted2,textAlign:"center",fontSize:13}}>SonuÃ§ yok</div>}
                  {filtered.map(o=>(
                    <div key={o.id} onClick={()=>{fv("selectedOrder",o);setShowPicker(false);setSearch("");}} style={{padding:"12px 14px",cursor:"pointer",borderBottom:`1px solid ${C.border}`}}>
                      <div style={{fontWeight:700,fontFamily:"monospace",fontSize:13,color:C.text}}>{o.code}</div>
                      <div style={{fontSize:12,color:C.muted2,marginTop:1}}>{o.name} Â· â±{fmtSec(o.partSec)} Â· {(o.machines||[]).join(", ")}</div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </>
        )}
      </div>
      <div style={{display:"flex",gap:10}}>
        <div style={{flex:1}}><span style={labelSt}>âœ… DoÄŸru Adet *</span><input style={{...inputSt,borderColor:C.green+"50"}} type="number" min="0" placeholder="0" value={form.correct} onChange={e=>fv("correct",e.target.value)}/></div>
        <div style={{flex:1}}><span style={labelSt}>âŒ HatalÄ± Adet</span><input style={{...inputSt,borderColor:C.red+"50"}} type="number" min="0" placeholder="0" value={form.wrong} onChange={e=>fv("wrong",e.target.value)}/></div>
      </div>
      <button onClick={submit} style={{...btnSt(saved?"green":"primary"),width:"100%",padding:14,fontSize:15}}>{saved?"Kaydedildi!":editId?"GÃ¼ncellemeyi Kaydet":"Kaydet"}</button>
      {todayEntries.length>0&&(
        <div>
          <span style={{...labelSt,marginTop:4}}>SeÃ§ili GÃ¼n GiriÅŸlerim</span>
          {todayEntries.slice(0,5).map(e=>{
            const p=calcPerf(e.correct,e.wrong,e.partSec);
            return (
              <div key={e.id} style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,padding:"12px 14px",marginBottom:8}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                  <div><span style={{fontWeight:700,fontSize:13,fontFamily:"monospace",color:C.text}}>{e.jobCode}</span><span style={{fontSize:12,color:C.muted2,marginLeft:6}}>{e.jobName}</span></div>
                  <div style={{display:"flex",gap:5}}><Badge label={e.machine} color={C.accent}/><Badge label={e.shift} color={C.muted2}/></div>
                </div>
                <div style={{display:"flex",gap:12,marginTop:7,fontSize:13}}>
                  <span style={{color:C.green,fontWeight:600}}>âœ… {e.correct}</span>
                  <span style={{color:C.red,fontWeight:600}}>âŒ {e.wrong}</span>
                  {p&&<span style={{color:C.muted2}}>Maks/gÃ¼n: {p.max}</span>}
                </div>
                <div style={{marginTop:8,display:"flex",gap:8}}>
                  <button onClick={()=>startEdit(e)} style={{...btnSt("ghost"),padding:"6px 10px",fontSize:12}}>DÃ¼zenle</button>
                  <button onClick={()=>removeEntry(e)} style={{...btnSt("danger"),padding:"6px 10px",fontSize:12}}>Sil</button>
                </div>
                {p&&<PerfBar perf={p.perf} small/>}
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function Report({currentUser,machines=DEFAULT_MACHINES}) {
  const [period,setPeriod]=useState("gunluk");
  const [rangeEnabled,setRangeEnabled]=useState(false);
  const [fromDate,setFromDate]=useState(()=>todayStr());
  const [toDate,setToDate]=useState(()=>todayStr());
  const [entries,setEntries]=useState([]);
  const [loading,setLoading]=useState(true);

  useEffect(()=>{window.DB.getAll("entries").then(e=>{setEntries(e);setLoading(false);});},[]);

  function applyRangePreset(type){
    const end=todayStr();
    const endDate=parseYmdLocal(end);
    let start=end;
    if(type==="last7"){
      const d=new Date(endDate); d.setDate(d.getDate()-6); start=ymdLocal(d);
    }else if(type==="last30"){
      const d=new Date(endDate); d.setDate(d.getDate()-29); start=ymdLocal(d);
    }else if(type==="thisMonth"){
      const d=new Date(endDate.getFullYear(),endDate.getMonth(),1); start=ymdLocal(d);
    }
    setRangeEnabled(true);
    setFromDate(start);
    setToDate(end);
  }

  const today=todayStr(),thisWeek=weekStart(),thisMonth=monthStr();
  const rangeStart=fromDate<=toDate?fromDate:toDate;
  const rangeEnd=fromDate<=toDate?toDate:fromDate;
  const filtered=entries.filter(e=>rangeEnabled?(e.date>=rangeStart&&e.date<=rangeEnd):(period==="gunluk"?e.date===today:period==="haftalik"?e.week===thisWeek:e.month===thisMonth));
  const byJob={};
  filtered.forEach(e=>{
    if(!byJob[e.jobCode]) byJob[e.jobCode]={jobCode:e.jobCode,jobName:e.jobName,correct:0,wrong:0,partSec:e.partSec,machines:new Set(),ops:new Set()};
    byJob[e.jobCode].correct+=e.correct; byJob[e.jobCode].wrong+=e.wrong;
    byJob[e.jobCode].machines.add(e.machine); byJob[e.jobCode].ops.add(e.operatorName||e.operatorId);
  });
  const jobs=Object.values(byJob).map(j=>({...j,machines:[...j.machines],ops:[...j.ops]}));
  const totalC=filtered.reduce((s,e)=>s+e.correct,0);
  const totalW=filtered.reduce((s,e)=>s+e.wrong,0);
  const qual=totalC+totalW>0?Math.round((totalC/(totalC+totalW))*100):0;
  const periodLabel=rangeEnabled?`Tarih AralÄ±ÄŸÄ± (${rangeStart} - ${rangeEnd})`:(period==="gunluk"?"GÃ¼nlÃ¼k":period==="haftalik"?"HaftalÄ±k":"AylÄ±k");
  const dailyBars=machines.map(m=>{
    const md=filtered.filter(e=>e.machine===m);
    const correct=md.reduce((s,e)=>s+e.correct,0);
    const wrong=md.reduce((s,e)=>s+e.wrong,0);
    const total=correct+wrong;
    return {machine:m,correct,wrong,total};
  }).filter(x=>x.total>0);
  const dailyBarsPct=dailyBars.map(b=>({
    ...b,
    correctPct:(totalC+totalW)>0?(b.correct/(totalC+totalW))*100:0,
    wrongPct:(totalC+totalW)>0?(b.wrong/(totalC+totalW))*100:0,
  }));
  const dailyMaxPct=Math.max(5,Math.ceil((Math.max(0,...dailyBarsPct.map(b=>b.correctPct+b.wrongPct))+2)/5)*5);
  const chartPalette=["#4f8ef7","#00c896","#ffb830","#9b7ff4","#ff4d6d","#2dd4bf","#f97316","#38bdf8"];
  const dayKeys=(()=>{
    if(rangeEnabled){
      const start=parseYmdLocal(rangeStart);
      const end=parseYmdLocal(rangeEnd);
      const out=[];
      const cur=new Date(start);
      while(cur<=end&&out.length<120){
        out.push(ymdLocal(cur));
        cur.setDate(cur.getDate()+1);
      }
      return out;
    }
    if(period==="gunluk") return [today];
    if(period==="haftalik"){
      const start=parseYmdLocal(thisWeek);
      return Array.from({length:7},(_,i)=>{
        const d=new Date(start);
        d.setDate(start.getDate()+i);
        return ymdLocal(d);
      });
    }
    const [y,m]=thisMonth.split("-").map(Number);
    const count=new Date(y,m,0).getDate();
    return Array.from({length:count},(_,i)=>`${thisMonth}-${pad2(i+1)}`);
  })();
  const dayLabels=dayKeys.map(k=>{
    const d=parseYmdLocal(k);
    if(rangeEnabled) return String(d.getDate());
    if(period==="haftalik") return new Intl.DateTimeFormat("tr-TR",{weekday:"short",day:"2-digit"}).format(d);
    if(period==="aylik") return String(d.getDate());
    return new Intl.DateTimeFormat("tr-TR",{day:"2-digit",month:"2-digit"}).format(d);
  });
  const lineSeries=machines.map((m,i)=>{
    const totals=dayKeys.map(day=>filtered
      .filter(e=>e.machine===m&&e.date===day)
      .reduce((s,e)=>s+e.correct+e.wrong,0)
    );
    return {name:m,color:chartPalette[i%chartPalette.length],totals};
  });
  const maxLineValue=Math.max(1,...lineSeries.flatMap(s=>s.totals));

  if(loading) return <div style={{padding:30,color:C.muted2,textAlign:"center"}}>YÃ¼kleniyor...</div>;

  return (
    <div style={{padding:16}}>
      <div style={{display:"flex",gap:7,marginBottom:16}}>
        {[["gunluk","GÃ¼nlÃ¼k"],["haftalik","HaftalÄ±k"],["aylik","AylÄ±k"]].map(([id,lbl])=>(
          <button key={id} onClick={()=>{setPeriod(id);setRangeEnabled(false);}} style={{flex:1,...chip(!rangeEnabled&&period===id)}}>{lbl}</button>
        ))}
      </div>
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"10px 12px",marginBottom:12}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:rangeEnabled?10:0}}>
          <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase"}}>Filtre</div>
          <button onClick={()=>setRangeEnabled(v=>!v)} style={chip(rangeEnabled,C.accent)}>{rangeEnabled?"Tarih AralÄ±ÄŸÄ±: AÃ§Ä±k":"Tarih AralÄ±ÄŸÄ±"}</button>
        </div>
        {rangeEnabled&&(
          <div style={{display:"flex",flexDirection:"column",gap:8}}>
            <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
              <button onClick={()=>applyRangePreset("last7")} style={{...btnSt("ghost"),padding:"7px 10px",fontSize:12}}>Son 7 gÃ¼n</button>
              <button onClick={()=>applyRangePreset("last30")} style={{...btnSt("ghost"),padding:"7px 10px",fontSize:12}}>Son 30 gÃ¼n</button>
              <button onClick={()=>applyRangePreset("thisMonth")} style={{...btnSt("ghost"),padding:"7px 10px",fontSize:12}}>Bu ay</button>
            </div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr auto",gap:8,alignItems:"end"}}>
            <div><span style={labelSt}>BaÅŸlangÄ±Ã§</span><input type="date" value={fromDate} max={today} onChange={e=>setFromDate(e.target.value||today)} style={{...inputSt,padding:"9px 10px",fontSize:13}}/></div>
            <div><span style={labelSt}>BitiÅŸ</span><input type="date" value={toDate} max={today} onChange={e=>setToDate(e.target.value||today)} style={{...inputSt,padding:"9px 10px",fontSize:13}}/></div>
            <button onClick={()=>{const t=todayStr();setFromDate(t);setToDate(t);}} style={{...btnSt("ghost"),padding:"9px 11px",fontSize:12,marginBottom:1}}>BugÃ¼n</button>
            </div>
          </div>
        )}
      </div>
      {filtered.length===0?(
        <div style={{textAlign:"center",color:C.muted2,padding:"40px 20px",background:C.card,borderRadius:14,border:`1px solid ${C.border}`}}><div style={{fontSize:36,marginBottom:10}}>ğŸ“°</div>Bu dÃ¶nemde kayÄ±t yok</div>
      ):(
        <>
          <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"12px 14px",marginBottom:12}}>
            <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",marginBottom:10}}>Tezgah GrafiÄŸi Â· {periodLabel}</div>
            {period==="gunluk"?(
              <>
                <div style={{display:"flex",gap:14,alignItems:"center",marginBottom:8,fontSize:11,color:C.muted2}}>
                  <span style={{display:"inline-flex",alignItems:"center",gap:5}}><span style={{width:12,height:12,borderRadius:3,background:C.green,display:"inline-block"}}/>DoÄŸru</span>
                  <span style={{display:"inline-flex",alignItems:"center",gap:5}}><span style={{width:12,height:12,borderRadius:3,background:C.red,display:"inline-block"}}/>YanlÄ±ÅŸ</span>
                </div>
                <div style={{height:250,overflowX:"auto"}}>
                  <svg width="100%" height="250" viewBox="0 0 760 250" preserveAspectRatio="none">
                    <rect x="0" y="0" width="760" height="250" fill="transparent"/>
                    {[0,1,2,3,4,5].map(i=>{
                      const y=210-(170*(i/5));
                      const v=Math.round((dailyMaxPct*i)/5);
                      return (
                        <g key={i}>
                          <line x1="58" y1={y} x2="740" y2={y} stroke={C.border} strokeWidth="1"/>
                          <text x="50" y={y+4} fill={C.muted2} fontSize="10" textAnchor="end">{v}%</text>
                        </g>
                      );
                    })}
                    <line x1="58" y1="40" x2="58" y2="210" stroke={C.muted2} strokeWidth="1.2"/>
                    <line x1="58" y1="210" x2="740" y2="210" stroke={C.muted2} strokeWidth="1.2"/>
                    {dailyBarsPct.map((b,i)=>{
                      const n=Math.max(dailyBarsPct.length,1);
                      const band=680/n;
                      const barW=Math.min(56,band*.62);
                      const x=60+(band*i)+((band-barW)/2);
                      const hCorrect=(b.correctPct/dailyMaxPct)*170;
                      const hWrong=(b.wrongPct/dailyMaxPct)*170;
                      const yCorrect=210-hCorrect;
                      const yWrong=yCorrect-hWrong;
                      return (
                        <g key={b.machine}>
                          <rect x={x} y={yCorrect} width={barW} height={Math.max(hCorrect,1)} fill={C.green}/>
                          <rect x={x} y={yWrong} width={barW} height={Math.max(hWrong,1)} fill={C.red}/>
                          {(b.correct+b.wrong)>0&&<text x={x+barW/2} y={Math.max(yWrong-6,16)} fill={C.text} fontSize="10" textAnchor="middle">{b.correct+b.wrong}</text>}
                          <text x={x+barW/2} y="228" fill={C.muted2} fontSize="10" textAnchor="middle">{b.machine}</text>
                        </g>
                      );
                    })}
                    <text x="399" y="245" fill={C.muted2} fontSize="11" textAnchor="middle">Tezgah</text>
                  </svg>
                </div>
                <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(120px,1fr))",gap:6}}>
                  {dailyBars.map(b=>(
                    <div key={b.machine} style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,padding:"6px 8px",fontSize:11,color:C.muted2}}>
                      <span style={{color:C.text,fontWeight:700}}>{b.machine}</span> Â· <span style={{color:C.green}}>âœ“ {b.correct}</span> <span style={{color:C.red}}>âœ• {b.wrong}</span>
                    </div>
                  ))}
                </div>
              </>
            ):(
              <>
                <div style={{display:"flex",gap:12,flexWrap:"wrap",marginBottom:10}}>
                  {lineSeries.map(s=>(
                    <div key={s.name} style={{display:"flex",alignItems:"center",gap:6,fontSize:11,color:C.muted2}}>
                      <span style={{width:12,height:3,borderRadius:99,background:s.color,display:"inline-block"}}/>
                      <span>{s.name}</span>
                    </div>
                  ))}
                </div>
                <div style={{height:220,overflowX:"auto"}}>
                  <svg width="100%" height="220" viewBox="0 0 760 220" preserveAspectRatio="none">
                    <rect x="0" y="0" width="760" height="220" fill="transparent" />
                    {[0,1,2,3,4].map(i=>{
                      const y=20+i*40;
                      const v=Math.round(maxLineValue*((4-i)/4));
                      return (
                        <g key={i}>
                          <line x1="56" y1={y} x2="740" y2={y} stroke={C.border} strokeWidth="1" />
                          <text x="50" y={y+4} fill={C.muted2} fontSize="10" textAnchor="end">{v}</text>
                        </g>
                      );
                    })}
                    {lineSeries.map(s=>{
                      const n=Math.max(dayKeys.length-1,1);
                      const pts=s.totals.map((v,i)=>{
                        const x=56+(684*(i/n));
                        const y=180-((v/maxLineValue)*160);
                        return `${x},${y}`;
                      }).join(" ");
                      return <polyline key={s.name} points={pts} fill="none" stroke={s.color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" />;
                    })}
                    {dayLabels.map((lbl,i)=>{
                      const n=Math.max(dayLabels.length-1,1);
                      const x=56+(684*(i/n));
                      return <text key={i} x={x} y="206" fill={C.muted2} fontSize="10" textAnchor="middle">{lbl}</text>;
                    })}
                  </svg>
                </div>
              </>
            )}
          </div>
          <div style={{display:"flex",gap:8,marginBottom:16}}>
            {[{l:"DoÄŸru",v:totalC,col:C.green},{l:"HatalÄ±",v:totalW,col:C.red},{l:"Kalite",v:`${qual}%`,col:qual>=90?C.green:qual>=75?C.warn:C.red}].map(({l,v,col})=>(
              <div key={l} style={{flex:1,background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"12px 14px"}}>
                <div style={{color:C.muted2,fontSize:10,letterSpacing:1,textTransform:"uppercase",marginBottom:3}}>{l}</div>
                <div style={{color:col,fontSize:24,fontWeight:800,fontFamily:"monospace"}}>{v}</div>
              </div>
            ))}
          </div>
          <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",marginBottom:10}}>Ä°ÅŸ Emri BazlÄ±</div>
          {jobs.map(j=>{
            const p=calcPerf(j.correct,j.wrong,j.partSec);
            const q=j.correct+j.wrong>0?Math.round((j.correct/(j.correct+j.wrong))*100):0;
            return (
              <div key={j.jobCode} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:"14px 16px",marginBottom:10}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:8}}>
                  <div><div style={{fontWeight:800,fontSize:14,fontFamily:"monospace",color:C.text}}>{j.jobCode}</div><div style={{fontSize:12,color:C.muted2,marginTop:1}}>{j.jobName}</div><div style={{fontSize:11,color:C.muted,marginTop:1}}>{j.machines.join(", ")} Â· {j.ops.join(", ")}</div></div>
                  <div style={{textAlign:"right"}}><div style={{fontSize:10,color:C.muted2}}>Kalite</div><div style={{fontWeight:800,color:q>=90?C.green:q>=75?C.warn:C.red,fontSize:16}}>{q}%</div></div>
                </div>
                <div style={{display:"flex",gap:8,fontSize:13,marginBottom:p?6:0}}>
                  <div style={{background:C.greenDim,border:`1px solid ${C.green}30`,borderRadius:8,padding:"5px 12px",color:C.green,fontWeight:700}}>âœ… {j.correct}</div>
                  <div style={{background:C.redDim,border:`1px solid ${C.red}30`,borderRadius:8,padding:"5px 12px",color:C.red,fontWeight:700}}>âŒ {j.wrong}</div>
                  {p&&<div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,padding:"5px 12px",color:C.muted2,fontSize:12}}>Maks/gÃ¼n: {p.max}</div>}
                </div>
                {p&&<PerfBar perf={p.perf}/>}
              </div>
            );
          })}
          <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",marginBottom:10,marginTop:18}}>Tezgah Ã–zeti</div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
            {machines.map(m=>{
              const md=filtered.filter(e=>e.machine===m);
              const mc=md.reduce((s,e)=>s+e.correct,0),mw=md.reduce((s,e)=>s+e.wrong,0);
              const mq=mc+mw>0?Math.round((mc/(mc+mw))*100):null;
              return (
                <div key={m} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"12px 14px",opacity:md.length===0?.4:1}}>
                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4}}><span style={{fontWeight:700,color:C.text}}>{m}</span>{mq!==null&&<span style={{color:mq>=90?C.green:mq>=75?C.warn:C.red,fontWeight:700,fontSize:13}}>{mq}%</span>}</div>
                  <div style={{fontSize:12,color:C.muted2}}>{md.length===0?"KayÄ±t yok":`âœ… ${mc}  âŒ ${mw}`}</div>
                  {mq!==null&&<div style={{background:C.border,borderRadius:99,height:4,marginTop:8}}><div style={{width:`${mq}%`,height:"100%",background:mq>=90?C.green:mq>=75?C.warn:C.red,borderRadius:99}}/></div>}
                </div>
              );
            })}
          </div>
          {currentUser.role==="admin"&&(()=>{
            const byOp={};
            filtered.forEach(e=>{const k=e.operatorName||e.operatorId;if(!byOp[k])byOp[k]={name:k,correct:0,wrong:0};byOp[k].correct+=e.correct;byOp[k].wrong+=e.wrong;});
            const ops=Object.values(byOp).sort((a,b)=>b.correct-a.correct);
            if(!ops.length) return null;
            return (<>
              <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",marginBottom:10,marginTop:18}}>OperatÃ¶r PerformansÄ±</div>
              {ops.map((op,i)=>{const q=op.correct+op.wrong>0?Math.round((op.correct/(op.correct+op.wrong))*100):0;return(
                <div key={op.name} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"12px 16px",marginBottom:8,display:"flex",alignItems:"center",gap:12}}>
                  <div style={{width:28,height:28,borderRadius:8,background:i===0?C.warn+"25":C.surface,display:"flex",alignItems:"center",justifyContent:"center",color:i===0?C.warn:C.muted2,fontWeight:800,fontSize:13}}>{i+1}</div>
                  <div style={{flex:1}}><div style={{fontWeight:600,fontSize:13,color:C.text}}>{op.name}</div><div style={{fontSize:12,color:C.muted2,marginTop:1}}>âœ… {op.correct} &nbsp; âŒ {op.wrong}</div></div>
                  <div style={{color:q>=90?C.green:q>=75?C.warn:C.red,fontWeight:800,fontSize:15}}>{q}%</div>
                </div>
              );})}
            </>);
          })()}
        </>
      )}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAIN APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function App() {
  const [currentUser,setCurrentUser]=useState(null);
  const [loading,setLoading]=useState(true);
  const [tab,setTab]=useState("giris");
  const [machines,setMachines]=useState(DEFAULT_MACHINES);
  const [logoSrc,setLogoSrc]=useState(LOGO_SRC);
  const [isTablet,setIsTablet]=useState(()=>typeof window!=="undefined"?window.matchMedia("(min-width: 768px)").matches:false);
  const [logoError,setLogoError]=useState(false);

  useEffect(()=>{
    async function init() {
      const mc=await window.DB.getDoc("config","machines");
      if(mc&&mc.list&&mc.list.length>0) setMachines(mc.list);
      const branding=await window.DB.getDoc("config","branding");
      if(branding&&branding.logo) setLogoSrc(branding.logo);
      const session=window.Session.get();
      if(session){
        const u=await window.DB.getDoc("users",session.username);
        if(u&&u.status==="active") setCurrentUser(u);
        else window.Session.clear();
      }
      setLoading(false);
    }
    if(window.FB_READY) init();
    else window.addEventListener("fb_ready",init,{once:true});
  },[]);

  useEffect(()=>{
    const mq=window.matchMedia("(min-width: 768px)");
    const onChange=e=>setIsTablet(e.matches);
    setIsTablet(mq.matches);
    if(mq.addEventListener) mq.addEventListener("change",onChange);
    else mq.addListener(onChange);
    return ()=>{
      if(mq.removeEventListener) mq.removeEventListener("change",onChange);
      else mq.removeListener(onChange);
    };
  },[]);
  useEffect(()=>{setLogoError(false);},[logoSrc]);

  async function updateMachines(list){
    setMachines(list);
    await window.DB.setDoc("config","machines",{list});
  }
  async function updateLogo(logoData){
    const next=logoData||LOGO_SRC;
    setLogoSrc(next);
    await window.DB.setDoc("config","branding",{logo:logoData||""});
  }
  async function logout(){window.Session.clear();setCurrentUser(null);setTab("giris");}

  if(loading) return <div style={{background:C.bg,minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",gap:12}}><div style={{width:40,height:40,border:`3px solid ${C.border}`,borderTop:`3px solid ${C.accent}`,borderRadius:"50%",animation:"spin 1s linear infinite"}}/><div style={{color:C.muted2,fontSize:13}}>BaÄŸlanÄ±yor...</div><style>{`@keyframes spin{to{transform:rotate(360deg)}}`}</style></div>;
  if(!currentUser) return <AuthScreen onLogin={u=>setCurrentUser(u)} logoSrc={logoSrc}/>;

  const isAdmin=currentUser.role==="admin";
  const canEntry=hasPermission(currentUser,"data_entry");
  const canReport=hasPermission(currentUser,"view_reports");
  const canOrders=hasPermission(currentUser,"manage_orders")||isAdmin;
  const canUsers=hasPermission(currentUser,"approve_users")||isAdmin;
  const canTools=true;

  const tabs=[
    ...(canEntry?[{id:"giris",icon:"ğŸ“",label:"GiriÅŸ"}]:[]),
    ...(canReport?[{id:"rapor",icon:"ğŸ“Š",label:"Rapor"}]:[]),
    ...(canTools?[{id:"tools",icon:"ğŸ§°",label:"TakÄ±m StoÄŸu"}]:[]),
    ...(canOrders?[{id:"orders",icon:"ğŸ“‹",label:"Ä°ÅŸ Emirleri"}]:[]),
    ...(canUsers?[{id:"users",icon:"ğŸ‘¥",label:"Ayarlar"}]:[]),
  ];

  const activeView=(
    <>
      {tab==="giris"&&<DataEntry currentUser={currentUser} machines={machines}/>}
      {tab==="rapor"&&<Report currentUser={currentUser} machines={machines}/>} 
      {tab==="tools"&&<ToolStock currentUser={currentUser} machines={machines}/>} 
      {tab==="orders"&&<WorkOrders currentUser={currentUser} machines={machines}/>} 
      {tab==="users"&&<AdminUsers currentUser={currentUser} machines={machines} onMachinesUpdate={updateMachines} currentLogo={logoSrc} onLogoUpdate={updateLogo}/>} 
    </>
  );

  return (
    <div style={{background:C.bg,minHeight:"100vh",color:C.text,fontFamily:"'DM Sans','Segoe UI',sans-serif"}}>
      <div style={{width:"100%",maxWidth:isTablet?1040:480,margin:"0 auto",paddingBottom:isTablet?20:80}}>
        <div style={{background:C.surface,borderBottom:`1px solid ${C.border}`,padding:isTablet?"14px 20px":"14px 16px",position:"sticky",top:0,zIndex:10}}>
          <div style={{display:"flex",alignItems:"center",gap:10}}>
            <div style={{width:34,height:34,borderRadius:10,background:`linear-gradient(135deg,${C.accent},#7b5cf0)`,display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden"}}>
              {!logoError?<img src={logoSrc||LOGO_SRC} alt="Logo" onError={()=>setLogoError(true)} style={{width:"100%",height:"100%",objectFit:"cover"}}/>:<span style={{fontSize:16}}>âš™ï¸</span>}
            </div>
            <div style={{flex:1}}><div style={{fontWeight:700,fontSize:14,color:C.text}}>CNC AtÃ¶lye Takip</div><div style={{color:C.muted2,fontSize:11,display:"flex",alignItems:"center",gap:5}}><span>{currentUser.fullName}</span><Badge label={isAdmin?"YÃ¶netici":"OperatÃ¶r"} color={isAdmin?C.accent:C.muted2}/></div></div>
            <button onClick={logout} style={{...btnSt("ghost"),padding:"7px 12px",fontSize:12}}>Ã‡Ä±kÄ±ÅŸ</button>
          </div>
        </div>

        {isTablet?(
          <div style={{display:"grid",gridTemplateColumns:"minmax(0,1fr) 220px",gap:14,alignItems:"start"}}>
            <div style={{minWidth:0}}>{activeView}</div>
            <div style={{position:"sticky",top:74,padding:"12px 10px"}}>
              <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:14,padding:8,display:"flex",flexDirection:"column",gap:8}}>
                {tabs.map(t=>( 
                  <button key={t.id} onClick={()=>setTab(t.id)} style={{display:"flex",alignItems:"center",gap:10,textAlign:"left",padding:"10px 12px",borderRadius:10,border:`1px solid ${tab===t.id?C.accent:C.border}`,background:tab===t.id?C.accent+"18":C.card,color:tab===t.id?C.accent:C.text,cursor:"pointer",fontFamily:"inherit"}}>
                    <span style={{fontSize:18,width:22,textAlign:"center"}}>{t.icon}</span>
                    <span style={{fontSize:13,fontWeight:tab===t.id?700:500}}>{t.label}</span>
                  </button>
                ))}
              </div>
            </div>
          </div>
        ):( 
          <>
            {activeView}
            <div style={{position:"fixed",bottom:0,left:"50%",transform:"translateX(-50%)",width:"100%",maxWidth:480,background:C.surface,borderTop:`1px solid ${C.border}`,display:"flex",zIndex:20}}>
              {tabs.map(t=>( 
                <button key={t.id} onClick={()=>setTab(t.id)} style={{flex:1,padding:"12px 0 10px",border:"none",background:"transparent",cursor:"pointer",color:tab===t.id?C.accent:C.muted,borderTop:`2px solid ${tab===t.id?C.accent:"transparent"}`,fontFamily:"inherit"}}>
                  <div style={{fontSize:20}}>{t.icon}</div>
                  <div style={{fontSize:10,fontWeight:tab===t.id?700:400,marginTop:2}}>{t.label}</div>
                </button>
              ))}
            </div>
          </>
        )}
      </div>
    </div>
  );
}
ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>


