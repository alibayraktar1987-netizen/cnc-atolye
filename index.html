<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
<title>CNC Atölye Takip</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet"/>
<style>*{box-sizing:border-box;margin:0;padding:0;}body{background:#0a0c12;}</style>
</head>
<body>
<div id="root"></div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, collection, getDocs, addDoc, updateDoc, deleteDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA6BAv57T-M_oeg5c0-irynYThqQv0s1xI",
  authDomain: "cnc-atolye.firebaseapp.com",
  projectId: "cnc-atolye",
  storageBucket: "cnc-atolye.firebasestorage.app",
  messagingSenderId: "1059210834667",
  appId: "1:1059210834667:web:1e506c41567b4e273784ae"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ── DB HELPERS ──────────────────────────────────────────────
window.DB = {
  async getDoc(col, id) {
    try { const s = await getDoc(doc(db, col, id)); return s.exists() ? { id: s.id, ...s.data() } : null; } catch { return null; }
  },
  async setDoc(col, id, data) {
    try { await setDoc(doc(db, col, id), data, { merge: true }); return true; } catch(e) { console.error(e); return false; }
  },
  async getAll(col) {
    try { const s = await getDocs(collection(db, col)); return s.docs.map(d => ({ id: d.id, ...d.data() })); } catch { return []; }
  },
  async addDoc(col, data) {
    try { const r = await addDoc(collection(db, col), { ...data, createdAt: new Date().toISOString() }); return r.id; } catch { return null; }
  },
  async updateDoc(col, id, data) {
    try { await updateDoc(doc(db, col, id), data); return true; } catch { return false; }
  },
  async deleteDoc(col, id) {
    try { await deleteDoc(doc(db, col, id)); return true; } catch { return false; }
  }
};

// ── SESSION ─────────────────────────────────────────────────
window.Session = {
  get() { try { const s = localStorage.getItem("cnc_session"); return s ? JSON.parse(s) : null; } catch { return null; } },
  set(u) {
    localStorage.setItem("cnc_session", JSON.stringify({
      ...u,
      createdAt:Date.now(),
      touchedAt:Date.now(),
    }));
  },
  touch() {
    const curr=this.get();
    if(!curr) return;
    localStorage.setItem("cnc_session",JSON.stringify({...curr,touchedAt:Date.now()}));
  },
  clear() { localStorage.removeItem("cnc_session"); }
};

// Signal that Firebase is ready
window.FB_READY = true;
window.dispatchEvent(new Event("fb_ready"));
</script>

<!-- React + Babel -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel" data-presets="react">
const { useState, useEffect, useCallback, useRef, useMemo } = React;

// ── CONSTANTS ────────────────────────────────────────────────
const DEFAULT_MACHINES = ["CNC-1","CNC-2","CNC-3","CNC-4"];
const SHIFTS = [
  { id:"sabah", label:"Sabah", time:"06:00–14:00" },
  { id:"ogleden", label:"Öğleden Sonra", time:"14:00–22:00" },
  { id:"gece", label:"Gece", time:"22:00–06:00" },
];
const EFFECTIVE_SECONDS = 72000;
const LOGO_SRC = "./logo.png";
const SESSION_TIMEOUT_MIN = 30;
const USER_ROLES = [
  { id:"admin", label:"Admin" },
  { id:"sales", label:"Satis" },
  { id:"planner", label:"Planlama" },
  { id:"purchasing", label:"Satin Alma" },
  { id:"supervisor", label:"Vardiya Sefi" },
  { id:"operator", label:"Operator" },
  { id:"quality", label:"Kalite" },
  { id:"viewer", label:"Izleyici" },
];
const PERMISSIONS = [
  { id:"data_entry", label:"Veri Girişi", icon:"📝", desc:"Üretim verisi girebilir" },
  { id:"view_reports", label:"Rapor Görüntüleme", icon:"📊", desc:"Tüm raporları görebilir" },
  { id:"manage_orders", label:"İş Emri Oluşturma", icon:"📋", desc:"İş emri ekleyip düzenleyebilir" },
  { id:"approve_users", label:"Kullanıcı Onaylama", icon:"👥", desc:"Kullanıcıları onaylayabilir" },
  { id:"manage_sales", label:"Satis ve Teklif", icon:"💼", desc:"Teklif ve siparis yonetebilir" },
  { id:"manage_purchasing", label:"Satin Alma", icon:"🛒", desc:"Talep ve PO yonetebilir" },
  { id:"manage_quality", label:"Kalite", icon:"🧪", desc:"Muayene ve FAI kayitlari girebilir" },
  { id:"manage_downtime", label:"Durus Yonetimi", icon:"⏱️", desc:"Durus nedeni ve kaydi girebilir" },
  { id:"manage_notifications", label:"Bildirim Kurallari", icon:"🔔", desc:"Uyari kurallari duzenleyebilir" },
];
const ROLE_PERMISSION_DEFAULTS = {
  admin: PERMISSIONS.map(p=>p.id),
  sales:["manage_sales","view_reports"],
  planner:["manage_orders","view_reports","manage_sales"],
  purchasing:["manage_purchasing","view_reports"],
  supervisor:["data_entry","view_reports","manage_downtime","manage_notifications"],
  operator:["data_entry"],
  quality:["manage_quality","view_reports"],
  viewer:["view_reports"],
};

const C = {
  bg:"#0a0c12", surface:"#12151f", card:"#181b28", border:"#252837",
  accent:"#4f8ef7", accentDim:"#4f8ef715",
  green:"#00c896", greenDim:"#00c89615",
  red:"#ff4d6d", redDim:"#ff4d6d15",
  warn:"#ffb830", warnDim:"#ffb83015",
  purple:"#9b7ff4",
  text:"#e2e5f0", muted:"#5a5f75", muted2:"#8b90a8",
};
const ORDER_STATUS_OPTIONS = [
  { id:"planned", label:"Planlandi", color:C.accent },
  { id:"in_production", label:"Uretimde", color:C.green },
  { id:"waiting", label:"Bekliyor", color:C.warn },
  { id:"completed", label:"Tamamlandi", color:C.accent },
  { id:"cancelled", label:"Iptal", color:C.red },
  { id:"active", label:"Aktif (Legacy)", color:C.green },
  { id:"passive", label:"Pasif", color:C.muted2 },
  { id:"liquidation", label:"Tasfiye", color:C.red },
  { id:"shipped", label:"Teslim/Sevk", color:C.warn },
];
const SALES_STATUS_OPTIONS = [
  { id:"offer", label:"Teklif", color:C.muted2 },
  { id:"approved", label:"Onaylandi", color:C.accent },
  { id:"in_production", label:"Uretimde", color:C.green },
  { id:"delivered", label:"Teslim Edildi", color:C.green },
  { id:"new", label:"Yeni", color:C.accent },
  { id:"waiting", label:"Beklemede", color:C.warn },
  { id:"cancelled", label:"Iptal", color:C.red },
  { id:"converted", label:"Donustu", color:C.green },
];
const PRIORITY_OPTIONS = [
  { id:"acil", label:"Acil", color:C.red },
  { id:"normal", label:"Normal", color:C.accent },
  { id:"dusuk", label:"Dusuk", color:C.muted2 },
];
const MACHINE_BRAND_OPTIONS = ["Fanuc","Siemens","Heidenhain","Generic"];
const MACHINE_PROTOCOL_OPTIONS = {
  Fanuc:["FOCAS2","MTConnect"],
  Siemens:["OPC-UA"],
  Heidenhain:["LSV2","OPC-UA"],
  Generic:["MTConnect","MQTT"],
};
const MACHINE_DATA_POINTS = [
  { id:"status", label:"Makina Durumu" },
  { id:"program", label:"Aktif Program" },
  { id:"spindleLoad", label:"Spindle Load %" },
  { id:"feedOverride", label:"Feed Override %" },
  { id:"cycleElapsed", label:"Cycle Time" },
  { id:"partCounter", label:"Part Counter" },
  { id:"alarms", label:"Alarmlar" },
  { id:"toolLife", label:"Tool Life" },
  { id:"operatorId", label:"Operator ID" },
];
const MACHINE_DEFAULT_POINTS = MACHINE_DATA_POINTS.reduce((acc,p)=>{
  acc[p.id]=true;
  return acc;
},{});

// ── HELPERS ──────────────────────────────────────────────────
const pad2 = n => String(n).padStart(2,"0");
const ymdLocal = (d=new Date()) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
const parseYmdLocal = s => {
  const [y,m,d]=(s||"").split("-").map(Number);
  if(!y||!m||!d) return new Date();
  return new Date(y,m-1,d);
};
const todayStr = () => ymdLocal(new Date());
const monthStr = (d=new Date()) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
function weekStart(d=new Date()) {
  const x=new Date(d); const day=x.getDay();
  x.setDate(x.getDate()-(day===0?6:day-1));
  return ymdLocal(x);
}
function calcPerf(correct,wrong,partSec) {
  if(!partSec||partSec<=0) return null;
  const max=Math.floor(EFFECTIVE_SECONDS/partSec);
  return {max, perf:max>0?Math.round(((correct+wrong)/max)*100):0};
}
function fmtSec(s) {
  if(!s) return "";
  const m=Math.floor(s/60),sec=s%60;
  return m>0?(sec>0?m+"dk "+sec+"sn":m+"dk"):sec+"sn";
}
const moneyFmt = n => `${safeNum(n).toFixed(2)} TRY`;
function hasPermission(user,perm) {
  if(user.role==="admin") return true;
  const rolePerms=ROLE_PERMISSION_DEFAULTS[user.role]||[];
  return (user.permissions||[]).includes(perm)||rolePerms.includes(perm);
}
function isOpenOrderStatus(status) {
  return !["completed","cancelled","passive","liquidation","shipped"].includes(status||"");
}
function safeNum(v) {
  const n=Number(v);
  return Number.isFinite(n)?n:0;
}
async function addAuditLog(actorId,entityType,entityId,action,beforeData,afterData,meta={}) {
  try{
    await window.DB.addDoc("auditLogs",{
      actorId:actorId||"",
      entityType:entityType||"",
      entityId:entityId||"",
      action:action||"",
      before:beforeData||null,
      after:afterData||null,
      meta,
      createdAt:new Date().toISOString(),
    });
  }catch{}
}
async function fileToBase64(file) {
  return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
}
function getFileIcon(name) {
  const ext=(name||"").split(".").pop().toLowerCase();
  if(["jpg","jpeg","png","gif","webp"].includes(ext)) return "🖼️";
  if(ext==="pdf") return "📄";
  if(["dxf","dwg"].includes(ext)) return "📐";
  return "📎";
}
function formatBytes(b) {
  if(b<1024) return b+" B";
  if(b<1048576) return (b/1024).toFixed(1)+" KB";
  return (b/1048576).toFixed(1)+" MB";
}
function hashPass(p) { return btoa(unescape(encodeURIComponent(p))); }
function getOrderStatusMeta(status) {
  return ORDER_STATUS_OPTIONS.find(s=>s.id===status) || ORDER_STATUS_OPTIONS.find(s=>s.id==="planned");
}
function getSalesStatusMeta(status) {
  return SALES_STATUS_OPTIONS.find(s=>s.id===status) || SALES_STATUS_OPTIONS.find(s=>s.id==="new");
}
function addDays(baseYmd,days){
  const d=parseYmdLocal(baseYmd||todayStr());
  d.setDate(d.getDate()+Number(days||0));
  return ymdLocal(d);
}
function dayDiff(fromYmd,toYmd){
  const a=parseYmdLocal(fromYmd||todayStr());
  const b=parseYmdLocal(toYmd||todayStr());
  return Math.floor((b-a)/86400000);
}
function startOfWeekYmd(s){
  const d=parseYmdLocal(s||todayStr());
  const day=d.getDay()||7;
  d.setDate(d.getDate()-(day-1));
  return ymdLocal(d);
}
function csvEscape(value){
  const raw=String(value??"");
  if(/[",\n;]/.test(raw)) return `"${raw.replace(/"/g,'""')}"`;
  return raw;
}
function downloadCsv(filename,columns,rows){
  const sep=";";
  const header=columns.map(c=>csvEscape(c.label)).join(sep);
  const body=rows.map(r=>columns.map(c=>csvEscape(typeof c.value==="function"?c.value(r):(r[c.key]??""))).join(sep)).join("\n");
  const blob=new Blob([`\uFEFF${header}\n${body}`],{type:"text/csv;charset=utf-8;"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// ── STYLE ATOMS ──────────────────────────────────────────────
const labelSt={color:C.muted2,fontSize:11,letterSpacing:.8,textTransform:"uppercase",fontWeight:600,marginBottom:6,display:"block"};
const inputSt={width:"100%",background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,padding:"11px 14px",color:C.text,fontSize:14,outline:"none",boxSizing:"border-box",fontFamily:"inherit"};
const chip=(active,color=C.accent)=>({padding:"8px 13px",borderRadius:9,border:`1px solid ${active?color:C.border}`,background:active?color+"18":C.surface,color:active?color:C.muted2,fontSize:12,fontWeight:active?700:400,cursor:"pointer",fontFamily:"inherit"});
const btnSt=(v="primary")=>({border:"none",borderRadius:10,padding:"11px 18px",fontSize:13,fontWeight:700,cursor:"pointer",fontFamily:"inherit",transition:"opacity .15s",
  ...(v==="primary"?{background:C.accent,color:"#fff",boxShadow:`0 4px 18px ${C.accent}30`}:
     v==="danger"?{background:C.red,color:"#fff"}:
     v==="green"?{background:C.green,color:"#0a0c12",boxShadow:`0 4px 18px ${C.green}30`}:
     v==="ghost"?{background:"transparent",color:C.muted2,border:`1px solid ${C.border}`}:
     {background:C.surface,color:C.text,border:`1px solid ${C.border}`})});

function Badge({label:l,color=C.muted2}) {
  return <span style={{background:color+"20",color,border:`1px solid ${color}40`,borderRadius:6,padding:"2px 8px",fontSize:10,fontWeight:700,letterSpacing:.5,textTransform:"uppercase"}}>{l}</span>;
}
function PerfBar({perf,small}) {
  const col=perf>=85?C.green:perf>=60?C.warn:C.red;
  return (
    <div style={{marginTop:small?4:8}}>
      <div style={{display:"flex",justifyContent:"space-between",fontSize:11,color:C.muted2,marginBottom:3}}>
        <span>Performans</span><span style={{color:col,fontWeight:700}}>{perf}%</span>
      </div>
      <div style={{background:C.border,borderRadius:99,height:small?4:6,overflow:"hidden"}}>
        <div style={{width:`${Math.min(perf,100)}%`,height:"100%",background:col,borderRadius:99,transition:"width .6s ease"}}/>
      </div>
    </div>
  );
}

// ════════════════════════════════════════════════════════════
//  AUTH SCREEN
// ════════════════════════════════════════════════════════════
function AuthScreen({onLogin,logoSrc=LOGO_SRC}) {
  const [portal,setPortal]=useState("operator");
  const [mode,setMode]=useState("login");
  const [form,setForm]=useState({username:"",password:"",confirm:"",fullName:""});
  const [err,setErr]=useState(""); const [ok,setOk]=useState(""); const [loading,setLoading]=useState(false);
  const [logoError,setLogoError]=useState(false);
  const [adminStats,setAdminStats]=useState({loading:false,activeOrders:0,todayEntries:0,pendingUsers:0,activeOperators:0,todayCorrect:0,todayWrong:0,lastUpdated:""});
  const f=k=>e=>setForm(p=>({...p,[k]:e.target.value}));

  useEffect(()=>{
    if(portal==="admin"&&mode!=="login") setMode("login");
    setErr(""); setOk("");
  },[portal,mode]);
  useEffect(()=>{setLogoError(false);},[logoSrc]);
  useEffect(()=>{
    if(!currentUser) return;
    const updateTouch=()=>window.Session.touch();
    const evts=["click","keydown","mousemove","touchstart","scroll"];
    evts.forEach(evt=>window.addEventListener(evt,updateTouch,{passive:true}));
    const timer=setInterval(()=>{
      const s=window.Session.get();
      if(!s) return;
      const idleMin=(Date.now()-Number(s.touchedAt||s.createdAt||Date.now()))/60000;
      if(idleMin>=SESSION_TIMEOUT_MIN){
        window.Session.clear();
        setCurrentUser(null);
        setTab("dashboard");
      }
    },15000);
    return ()=>{
      clearInterval(timer);
      evts.forEach(evt=>window.removeEventListener(evt,updateTouch));
    };
  },[currentUser]);

  const loadAdminStats=useCallback(async()=>{
    setAdminStats(s=>({...s,loading:true}));
    const [users,orders,entries]=await Promise.all([
      window.DB.getAll("users"),
      window.DB.getAll("orders"),
      window.DB.getAll("entries"),
    ]);
    const today=todayStr();
    const todayRows=entries.filter(e=>e.date===today);
    const now=new Date();
    const hh=pad2(now.getHours());
    const mm=pad2(now.getMinutes());
    setAdminStats({
      loading:false,
      activeOrders:orders.filter(o=>isOpenOrderStatus(o.status)).length,
      todayEntries:todayRows.length,
      pendingUsers:users.filter(u=>u.status==="pending").length,
      activeOperators:users.filter(u=>u.role==="operator"&&u.status==="active").length,
      todayCorrect:todayRows.reduce((s,e)=>s+(Number(e.correct)||0),0),
      todayWrong:todayRows.reduce((s,e)=>s+(Number(e.wrong)||0),0),
      lastUpdated:`${hh}:${mm}`,
    });
  },[]);

  useEffect(()=>{
    if(portal!=="admin") return;
    loadAdminStats();
  },[portal,loadAdminStats]);

  async function doLogin() {
    setErr(""); setLoading(true);
    const u = await window.DB.getDoc("users", form.username.toLowerCase());
    if(!u){setErr("Kullanıcı bulunamadı.");setLoading(false);return;}
    if(u.password!==hashPass(form.password)){setErr("Şifre hatalı.");setLoading(false);return;}
    if(u.status==="pending"){setErr("Hesabınız onay bekliyor.");setLoading(false);return;}
    if(u.status==="rejected"){setErr("Hesabınız reddedildi.");setLoading(false);return;}
    if(portal==="admin"&&u.role!=="admin"){setErr("Bu giriş ekranı yalnızca yönetici hesapları içindir.");setLoading(false);return;}
    if(portal==="operator"&&u.role!=="operator"){setErr("Yönetici hesabı ile Yönetici Girişi ekranını kullanın.");setLoading(false);return;}
    window.Session.set({username:u.id});
    onLogin(u); setLoading(false);
  }

  async function doRegister() {
    setErr(""); setOk("");
    if(!form.username||!form.password||!form.fullName){setErr("Tüm alanlar zorunlu.");return;}
    if(form.password!==form.confirm){setErr("Şifreler eşleşmiyor.");return;}
    if(form.password.length<8){setErr("Sifre en az 8 karakter olmali.");return;}
    if(!/[A-Z]/.test(form.password)||!/[a-z]/.test(form.password)||!/[0-9]/.test(form.password)){setErr("Sifre buyuk-kucuk harf ve rakam icermeli.");return;}
    setLoading(true);
    const key=form.username.toLowerCase().trim();
    const existing=await window.DB.getDoc("users",key);
    if(existing){setErr("Bu kullanıcı adı alınmış.");setLoading(false);return;}
    const allUsers=await window.DB.getAll("users");
    const isFirst=allUsers.length===0;
    const role=isFirst?"admin":"operator";
    const saved=await window.DB.setDoc("users",key,{
      username:key, fullName:form.fullName, password:hashPass(form.password),
      role, status:isFirst?"active":"pending",
      permissions:[...(ROLE_PERMISSION_DEFAULTS[role]||[])],
      createdAt:new Date().toISOString(),
      updatedAt:new Date().toISOString(),
    });
    if(!saved){setErr("Kullanici kaydi olusturulamadi. Veritabani yetkilerini (Firestore Rules) kontrol edin.");setLoading(false);return;}
    setOk(isFirst?"İlk kullanıcı → otomatik Yönetici! Giriş yapabilirsiniz.":"Kayıt başarılı! Yönetici onayını bekleyin.");
    setMode("login"); setForm({username:"",password:"",confirm:"",fullName:""}); setLoading(false);
  }

  return (
    <div style={{minHeight:"100vh",background:C.bg,display:"flex",alignItems:"center",justifyContent:"center",padding:20}}>
      <div style={{width:"100%",maxWidth:portal==="admin"?980:380}}>
        <div style={{display:"flex",background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,padding:4,margin:"0 auto 22px",maxWidth:420}}>
          {[["operator","Operatör Girişi"],["admin","Yönetici Girişi"]].map(([id,lbl])=>(
            <button key={id} onClick={()=>setPortal(id)} style={{flex:1,padding:"10px 0",border:"none",borderRadius:9,cursor:"pointer",background:portal===id?C.card:"transparent",color:portal===id?C.text:C.muted2,fontWeight:portal===id?700:500,fontSize:13,fontFamily:"inherit"}}>{lbl}</button>
          ))}
        </div>

        {portal==="operator"?(
          <div style={{width:"100%",maxWidth:380,margin:"0 auto"}}>
            <div style={{textAlign:"center",marginBottom:28}}>
              <div style={{width:60,height:60,borderRadius:18,background:`linear-gradient(135deg,${C.accent},#7b5cf0)`,display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 10px",overflow:"hidden"}}>
                {!logoError?<img src={logoSrc||LOGO_SRC} alt="Logo" onError={()=>setLogoError(true)} style={{width:"100%",height:"100%",objectFit:"cover"}}/>:<span style={{fontSize:28}}>⚙️</span>}
              </div>
              <div style={{fontWeight:800,fontSize:22,color:C.text,letterSpacing:-.5}}>CNC Atölye</div>
              <div style={{color:C.muted2,fontSize:13,marginTop:2}}>İş Takip Sistemi</div>
            </div>
            <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:18,padding:24}}>
              <div style={{display:"flex",background:C.surface,borderRadius:10,padding:3,marginBottom:20}}>
                {[["login","Giriş Yap"],["register","Kayıt Ol"]].map(([id,lbl])=>(
                  <button key={id} onClick={()=>{setMode(id);setErr("");setOk("");}} style={{flex:1,padding:"9px 0",border:"none",borderRadius:8,cursor:"pointer",background:mode===id?C.card:"transparent",color:mode===id?C.text:C.muted2,fontWeight:mode===id?700:400,fontSize:13,fontFamily:"inherit"}}>{lbl}</button>
                ))}
              </div>
              {err&&<div style={{background:C.redDim,border:`1px solid ${C.red}40`,borderRadius:10,padding:"10px 14px",color:C.red,fontSize:13,marginBottom:14}}>{err}</div>}
              {ok&&<div style={{background:C.greenDim,border:`1px solid ${C.green}40`,borderRadius:10,padding:"10px 14px",color:C.green,fontSize:13,marginBottom:14}}>{ok}</div>}
              <div style={{display:"flex",flexDirection:"column",gap:12}}>
                {mode==="register"&&<div><span style={labelSt}>Ad Soyad</span><input style={inputSt} placeholder="Adınız Soyadınız" value={form.fullName} onChange={f("fullName")}/></div>}
                <div><span style={labelSt}>Kullanıcı Adı</span><input style={inputSt} placeholder="kullanici_adi" value={form.username} onChange={f("username")} autoCapitalize="none" autoCorrect="off"/></div>
                <div><span style={labelSt}>Şifre</span><input style={inputSt} placeholder="••••••" type="password" value={form.password} onChange={f("password")}/></div>
                {mode==="register"&&<div><span style={labelSt}>Şifre Tekrar</span><input style={inputSt} placeholder="••••••" type="password" value={form.confirm} onChange={f("confirm")}/></div>}
                <button onClick={mode==="login"?doLogin:doRegister} style={{...btnSt("primary"),width:"100%",padding:14,fontSize:15,opacity:loading?.7:1}} disabled={loading}>
                  {loading?"...":mode==="login"?"Giriş Yap":"Kayıt Ol"}
                </button>
              </div>
            </div>
            <div style={{textAlign:"center",color:C.muted,fontSize:11,marginTop:12}}>İlk kayıt otomatik Yönetici olur.</div>
          </div>
        ):(
          <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(280px,1fr))",gap:16,alignItems:"stretch"}}>
            <div style={{background:`linear-gradient(155deg,${C.surface},${C.card})`,border:`1px solid ${C.border}`,borderRadius:16,padding:22}}>
              <div style={{display:"flex",alignItems:"center",gap:10,marginBottom:18}}>
                <div style={{width:42,height:42,borderRadius:12,background:`linear-gradient(135deg,${C.accent},#7b5cf0)`,display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden"}}>
                  {!logoError?<img src={logoSrc||LOGO_SRC} alt="Logo" onError={()=>setLogoError(true)} style={{width:"100%",height:"100%",objectFit:"cover"}}/>:<span style={{fontSize:18}}>⚙️</span>}
                </div>
                <div>
                  <div style={{fontWeight:800,fontSize:18,color:C.text,letterSpacing:-.3}}>Yönetici Paneli</div>
                  <div style={{fontSize:12,color:C.muted2}}>Dashboard erişimi</div>
                </div>
              </div>
              <div style={{display:"grid",gridTemplateColumns:"repeat(2,minmax(0,1fr))",gap:10}}>
                {[
                  ["Aktif İş Emirleri",adminStats.activeOrders,C.accent],
                  ["Bugün Giriş",adminStats.todayEntries,C.green],
                  ["Onay Bekleyen",adminStats.pendingUsers,C.warn],
                  ["Aktif Operatör",adminStats.activeOperators,C.muted2],
                ].map(([title,value,color])=>(
                  <div key={title} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:12}}>
                    <div style={{fontSize:11,color:C.muted2,marginBottom:6,textTransform:"uppercase",letterSpacing:.7}}>{title}</div>
                    <div style={{fontSize:22,color,marginBottom:2,fontWeight:800,fontFamily:"monospace"}}>{value}</div>
                  </div>
                ))}
              </div>
              <div style={{display:"flex",gap:10,marginTop:10}}>
                <div style={{flex:1,background:C.card,border:`1px solid ${C.border}`,borderRadius:10,padding:"8px 10px"}}>
                  <div style={{fontSize:10,color:C.muted2,textTransform:"uppercase",letterSpacing:.7}}>Bugün Doğru / Hatalı</div>
                  <div style={{fontSize:14,color:C.text,fontWeight:700,marginTop:2}}><span style={{color:C.green}}>{adminStats.todayCorrect}</span> / <span style={{color:C.red}}>{adminStats.todayWrong}</span></div>
                </div>
                <button onClick={loadAdminStats} disabled={adminStats.loading} style={{...btnSt("ghost"),padding:"8px 12px",fontSize:12,alignSelf:"stretch",opacity:adminStats.loading?.7:1}}>
                  {adminStats.loading?"Yenileniyor...":"Yenile"}
                </button>
              </div>
            </div>
            <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:16,padding:22}}>
              <div style={{fontWeight:700,fontSize:18,color:C.text,marginBottom:4}}>Yönetici Girişi</div>
              <div style={{fontSize:12,color:C.muted2,marginBottom:16}}>Sadece yönetici hesaplarıyla giriş yapılabilir. {adminStats.lastUpdated?`Son güncelleme: ${adminStats.lastUpdated}`:""}</div>
              {err&&<div style={{background:C.redDim,border:`1px solid ${C.red}40`,borderRadius:10,padding:"10px 14px",color:C.red,fontSize:13,marginBottom:14}}>{err}</div>}
              {ok&&<div style={{background:C.greenDim,border:`1px solid ${C.green}40`,borderRadius:10,padding:"10px 14px",color:C.green,fontSize:13,marginBottom:14}}>{ok}</div>}
              <div style={{display:"flex",flexDirection:"column",gap:12}}>
                <div><span style={labelSt}>Kullanıcı Adı</span><input style={inputSt} placeholder="yonetici_adi" value={form.username} onChange={f("username")} autoCapitalize="none" autoCorrect="off"/></div>
                <div><span style={labelSt}>Şifre</span><input style={inputSt} placeholder="••••••" type="password" value={form.password} onChange={f("password")}/></div>
                <button onClick={doLogin} style={{...btnSt("primary"),width:"100%",padding:14,fontSize:15,opacity:loading?.7:1}} disabled={loading}>{loading?"...":"Yönetici Olarak Giriş Yap"}</button>
                <button onClick={()=>{setPortal("operator");setMode("register");setErr("");setOk("");}} style={{...btnSt("ghost"),width:"100%",padding:12,fontSize:13}}>Yeni hesap oluştur</button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

function NavIcon({name,size=18}) {
  const st={width:size,height:size,display:"block"};
  const p={fill:"none",stroke:"currentColor",strokeWidth:"1.9",strokeLinecap:"round",strokeLinejoin:"round"};
  if(name==="giris") return (
    <svg viewBox="0 0 24 24" style={st}><path {...p} d="M8 4h8l4 4v12H8z"/><path {...p} d="M16 4v4h4"/><path {...p} d="M10 13h6M10 17h4"/></svg>
  );
  if(name==="planning") return (
    <svg viewBox="0 0 24 24" style={st}><rect {...p} x="3" y="5" width="18" height="16" rx="2"/><path {...p} d="M16 3v4M8 3v4M3 10h18"/></svg>
  );
  if(name==="dashboard") return (
    <svg viewBox="0 0 24 24" style={st}><path {...p} d="M4 13h6v7H4zM14 4h6v16h-6zM4 4h6v5H4z"/></svg>
  );
  if(name==="mps") return (
    <svg viewBox="0 0 24 24" style={st}><path {...p} d="M4 6h16M4 12h16M4 18h10"/><circle {...p} cx="18" cy="18" r="2.2"/></svg>
  );
  if(name==="mrp") return (
    <svg viewBox="0 0 24 24" style={st}><path {...p} d="M4 20V8l8-4 8 4v12z"/><path {...p} d="M8 13h8M8 17h5"/></svg>
  );
  if(name==="purchase") return (
    <svg viewBox="0 0 24 24" style={st}><path {...p} d="M4 7h16l-1.4 10H5.4z"/><path {...p} d="M9 7V5a3 3 0 0 1 6 0v2"/></svg>
  );
  if(name==="quotes") return (
    <svg viewBox="0 0 24 24" style={st}><path {...p} d="M5 4h14v16H5z"/><path {...p} d="M8 9h8M8 13h8M8 17h5"/><path {...p} d="M9 4v3M15 4v3"/></svg>
  );
  if(name==="downtime") return (
    <svg viewBox="0 0 24 24" style={st}><circle {...p} cx="12" cy="12" r="8"/><path {...p} d="M12 8v5l3 2"/></svg>
  );
  if(name==="notifications") return (
    <svg viewBox="0 0 24 24" style={st}><path {...p} d="M6 16h12l-1-2v-3a5 5 0 0 0-10 0v3z"/><path {...p} d="M10 18a2 2 0 0 0 4 0"/></svg>
  );
  if(name==="quality") return (
    <svg viewBox="0 0 24 24" style={st}><path {...p} d="M12 3l8 4v5c0 5-3.3 8-8 9-4.7-1-8-4-8-9V7z"/><path {...p} d="M9 12l2 2 4-4"/></svg>
  );
  if(name==="cost") return (
    <svg viewBox="0 0 24 24" style={st}><circle {...p} cx="12" cy="12" r="8"/><path {...p} d="M12 7v10M8.5 9.5c0-1.1 1.3-2 3.5-2s3.5.9 3.5 2-1.3 2-3.5 2-3.5.9-3.5 2 1.3 2 3.5 2 3.5-.9 3.5-2"/></svg>
  );
  if(name==="integration") return (
    <svg viewBox="0 0 24 24" style={st}><path {...p} d="M8 8h8M8 16h8"/><circle {...p} cx="6" cy="8" r="2"/><circle {...p} cx="18" cy="8" r="2"/><circle {...p} cx="6" cy="16" r="2"/><circle {...p} cx="18" cy="16" r="2"/><path {...p} d="M8 8l8 8"/></svg>
  );
  if(name==="customers") return (
    <svg viewBox="0 0 24 24" style={st}><rect {...p} x="3" y="3" width="18" height="18" rx="2"/><path {...p} d="M8 21V8h8v13M10 12h4M10 16h4"/></svg>
  );
  if(name==="materials") return (
    <svg viewBox="0 0 24 24" style={st}><path {...p} d="M4 6h16M4 12h16M4 18h10"/><circle {...p} cx="18" cy="18" r="2"/></svg>
  );
  if(name==="rapor") return (
    <svg viewBox="0 0 24 24" style={st}><path {...p} d="M4 20V9M10 20V4M16 20v-7M22 20H2"/></svg>
  );
  if(name==="tools") return (
    <svg viewBox="0 0 24 24" style={st}><path {...p} d="M14 7a4 4 0 0 0-5.4 5.4L3 18l3 3 5.6-5.6A4 4 0 0 0 17 10z"/><path {...p} d="M14 7l3-3 3 3-3 3"/></svg>
  );
  if(name==="orders") return (
    <svg viewBox="0 0 24 24" style={st}><rect {...p} x="5" y="3" width="14" height="18" rx="2"/><path {...p} d="M8 8h8M8 12h8M8 16h5"/></svg>
  );
  if(name==="sales") return (
    <svg viewBox="0 0 24 24" style={st}><path {...p} d="M4 7h16M4 12h10M4 17h8"/><circle {...p} cx="18" cy="17" r="3"/></svg>
  );
  if(name==="users") return (
    <svg viewBox="0 0 24 24" style={st}><circle {...p} cx="12" cy="8" r="3.2"/><path {...p} d="M5 20a7 7 0 0 1 14 0"/></svg>
  );
  if(name==="machines") return (
    <svg viewBox="0 0 24 24" style={st}><rect {...p} x="3" y="5" width="18" height="12" rx="2"/><path {...p} d="M7 17v2m10-2v2M6 9h12M8 13h2m4 0h2"/></svg>
  );
  return null;
}

// ════════════════════════════════════════════════════════════
//  MACHINE SETTINGS
// ════════════════════════════════════════════════════════════
function MachineSettings({machines,onUpdate}) {
  const [editing,setEditing]=useState(false);
  const [draft,setDraft]=useState([...machines]);
  const [newName,setNewName]=useState("");

  async function save() {
    const cleaned=draft.map(m=>m.trim()).filter(Boolean);
    if(cleaned.length===0){alert("En az 1 tezgah gerekli!");return;}
    await onUpdate(cleaned); setEditing(false);
  }
  return (
    <div style={{marginBottom:24}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
        <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",fontWeight:600}}>Tezgah İsimleri</div>
        {!editing&&<button onClick={()=>{setDraft([...machines]);setEditing(true);}} style={{...btnSt("ghost"),padding:"6px 12px",fontSize:12}}>✏️ Düzenle</button>}
      </div>
      {!editing?(
        <div style={{display:"flex",gap:7,flexWrap:"wrap"}}>
          {machines.map((m,i)=><div key={i} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:9,padding:"8px 14px",fontSize:13,fontWeight:600,color:C.text}}>{m}</div>)}
        </div>
      ):(
        <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:14}}>
          <div style={{display:"flex",flexDirection:"column",gap:8,marginBottom:12}}>
            {draft.map((m,i)=>(
              <div key={i} style={{display:"flex",gap:8,alignItems:"center"}}>
                <input value={m} onChange={e=>setDraft(d=>d.map((x,idx)=>idx===i?e.target.value:x))} style={{...inputSt,flex:1,padding:"9px 12px",fontSize:13}}/>
                <button onClick={()=>setDraft(d=>d.filter((_,idx)=>idx!==i))} style={{background:"transparent",border:`1px solid ${C.red}50`,borderRadius:8,color:C.red,width:34,height:34,cursor:"pointer",fontSize:16,flexShrink:0}}>×</button>
              </div>
            ))}
          </div>
          <div style={{display:"flex",gap:8,marginBottom:12}}>
            <input value={newName} onChange={e=>setNewName(e.target.value)} onKeyDown={e=>{if(e.key==="Enter"&&newName.trim()){setDraft(d=>[...d,newName.trim()]);setNewName("");}}} placeholder="Yeni tezgah adı..." style={{...inputSt,flex:1,padding:"9px 12px",fontSize:13}}/>
            <button onClick={()=>{if(newName.trim()){setDraft(d=>[...d,newName.trim()]);setNewName("");}}} style={{...btnSt("primary"),padding:"9px 14px",fontSize:13,flexShrink:0}}>+ Ekle</button>
          </div>
          <div style={{display:"flex",gap:8}}>
            <button onClick={save} style={{...btnSt("green"),flex:1,padding:10}}>💾 Kaydet</button>
            <button onClick={()=>setEditing(false)} style={{...btnSt("ghost"),padding:10}}>İptal</button>
          </div>
        </div>
      )}
    </div>
  );
}

// ════════════════════════════════════════════════════════════
//  ADMIN USERS
// ════════════════════════════════════════════════════════════
function AdminUsers({currentUser,machines,onMachinesUpdate,currentLogo,onLogoUpdate}) {
  const [users,setUsers]=useState([]);
  const [loading,setLoading]=useState(true);
  const [expanded,setExpanded]=useState(null);
  const [logoLoading,setLogoLoading]=useState(false);
  const logoInputRef=useRef(null);

  const load=useCallback(async()=>{ const u=await window.DB.getAll("users"); setUsers(u); setLoading(false); },[]);
  useEffect(()=>{load();},[load]);

  async function update(id,patch) {
    await window.DB.updateDoc("users",id,patch);
    setUsers(u=>u.map(x=>x.id===id?{...x,...patch}:x));
  }
  async function togglePerm(id,permId) {
    const u=users.find(x=>x.id===id);
    const perms=[...(u.permissions||[])];
    const idx=perms.indexOf(permId);
    if(idx>=0) perms.splice(idx,1); else perms.push(permId);
    await update(id,{permissions:perms});
  }
  async function changeRole(user,newRole){
    const patch={
      role:newRole,
      permissions:[...(ROLE_PERMISSION_DEFAULTS[newRole]||[])],
      updatedAt:new Date().toISOString(),
    };
    await update(user.id,patch);
  }
  const roleLabel=roleId=>(USER_ROLES.find(r=>r.id===roleId)||{label:roleId||"-"}).label;

  const list=[...users].sort((a,b)=>{const o={pending:0,active:1,rejected:2};return(o[a.status]??3)-(o[b.status]??3);});
  if(loading) return <div style={{padding:30,color:C.muted2,textAlign:"center"}}>Yükleniyor...</div>;

  async function pickLogo(e){
    const file=e.target.files&&e.target.files[0];
    if(!file) return;
    if(!file.type.startsWith("image/")){alert("Lutfen bir gorsel dosyasi secin."); return;}
    if(file.size>2*1024*1024){alert("Logo en fazla 2MB olabilir."); return;}
    setLogoLoading(true);
    const data=await fileToBase64(file);
    await onLogoUpdate(data);
    setLogoLoading(false);
    e.target.value="";
  }

  return (
    <div style={{padding:16}}>
      <div style={{marginBottom:18}}>
        <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",fontWeight:600,marginBottom:8}}>Logo Ayari</div>
        <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:12}}>
          <div style={{display:"flex",alignItems:"center",gap:12,marginBottom:10}}>
            <div style={{width:56,height:56,borderRadius:12,background:C.surface,border:`1px solid ${C.border}`,display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden"}}>
              <img src={currentLogo||LOGO_SRC} alt="Logo" style={{width:"100%",height:"100%",objectFit:"cover"}}/>
            </div>
            <div style={{fontSize:12,color:C.muted2}}>Giris sayfasi ve uygulama basliginda kullanilir.</div>
          </div>
          <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
            <button onClick={()=>logoInputRef.current?.click()} style={{...btnSt("primary"),padding:"8px 12px",fontSize:12}} disabled={logoLoading}>{logoLoading?"Yukleniyor...":"Logo Yukle"}</button>
            <button onClick={()=>onLogoUpdate("")} style={{...btnSt("ghost"),padding:"8px 12px",fontSize:12}} disabled={logoLoading}>Varsayilana Don</button>
            <input ref={logoInputRef} type="file" accept="image/*" style={{display:"none"}} onChange={pickLogo}/>
          </div>
        </div>
      </div>
      <MachineSettings machines={machines} onUpdate={onMachinesUpdate}/>
      <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",marginBottom:12}}>Ayarlar · Kullanıcı Yönetimi · {list.length} kullanıcı</div>
      {list.map(u=>(
        <div key={u.id} style={{background:C.card,border:`1px solid ${u.status==="pending"?C.warn+"60":C.border}`,borderRadius:14,padding:"14px 16px",marginBottom:10}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:8}}>
            <div><div style={{fontWeight:700,fontSize:14}}>{u.fullName}</div><div style={{color:C.muted2,fontSize:12,marginTop:1}}>@{u.username||u.id}</div></div>
            <div style={{display:"flex",gap:5,flexWrap:"wrap",justifyContent:"flex-end"}}>
              <Badge label={u.role==="admin"?"Yönetici":roleLabel(u.role)} color={u.role==="admin"?C.accent:C.muted2}/>
              <Badge label={u.status==="active"?"Aktif":u.status==="pending"?"Bekliyor":"Askıda"} color={u.status==="active"?C.green:u.status==="pending"?C.warn:C.red}/>
            </div>
          </div>
          {u.id!==currentUser.id&&(
            <>
              <div style={{display:"flex",gap:7,flexWrap:"wrap",marginBottom:8}}>
                {u.status==="pending"&&<><button onClick={()=>update(u.id,{status:"active"})} style={{...btnSt("green"),padding:"7px 13px",fontSize:12}}>✓ Onayla</button><button onClick={()=>update(u.id,{status:"rejected"})} style={{...btnSt("danger"),padding:"7px 13px",fontSize:12}}>✕ Reddet</button></>}
                {u.status==="active"&&<>
                  <select value={u.role||"operator"} onChange={e=>changeRole(u,e.target.value)} style={{...inputSt,padding:"7px 10px",fontSize:12,maxWidth:190}}>
                    {USER_ROLES.map(r=><option key={r.id} value={r.id}>{r.label}</option>)}
                  </select>
                  <button onClick={()=>update(u.id,{status:"rejected"})} style={{...btnSt("danger"),padding:"7px 13px",fontSize:12}}>Askıya Al</button>
                </>}
                {u.status==="rejected"&&<button onClick={()=>update(u.id,{status:"active"})} style={{...btnSt("green"),padding:"7px 13px",fontSize:12}}>Aktifleştir</button>}
                {u.role!=="admin"&&<button onClick={()=>setExpanded(expanded===u.id?null:u.id)} style={{...btnSt("ghost"),padding:"7px 13px",fontSize:12}}>{expanded===u.id?"▲ Gizle":"⚙️ Yetkiler"}</button>}
              </div>
              {expanded===u.id&&u.role!=="admin"&&(
                <div style={{background:C.surface,borderRadius:10,padding:12,border:`1px solid ${C.border}`}}>
                  <div style={{color:C.muted2,fontSize:11,letterSpacing:.8,textTransform:"uppercase",marginBottom:10,fontWeight:600}}>Kullanıcı Yetkileri</div>
                  {PERMISSIONS.map(p=>{
                    const active=(u.permissions||[]).includes(p.id);
                    return (
                      <div key={p.id} onClick={()=>togglePerm(u.id,p.id)} style={{display:"flex",alignItems:"center",gap:12,padding:"10px 12px",borderRadius:9,marginBottom:6,cursor:"pointer",background:active?C.accent+"12":C.card,border:`1px solid ${active?C.accent+"40":C.border}`}}>
                        <div style={{fontSize:18}}>{p.icon}</div>
                        <div style={{flex:1}}><div style={{fontWeight:600,fontSize:13,color:active?C.accent:C.text}}>{p.label}</div><div style={{fontSize:11,color:C.muted2,marginTop:1}}>{p.desc}</div></div>
                        <div style={{width:20,height:20,borderRadius:5,border:`2px solid ${active?C.accent:C.border}`,background:active?C.accent:"transparent",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>{active&&<span style={{color:"#fff",fontSize:12,fontWeight:800}}>✓</span>}</div>
                      </div>
                    );
                  })}
                </div>
              )}
            </>
          )}
          {u.id===currentUser.id&&<div style={{color:C.muted,fontSize:11}}>Bu sizin hesabınız</div>}
        </div>
      ))}
    </div>
  );
}

function ToolStock({currentUser}) {
  const isAdmin=currentUser.role==="admin";
  const TOOL_CATEGORY_OPTIONS=["Freze","Matkap","Rayba","Kılavuz","Torna","Insert","Tutucu","Olcu Takimi","Diger"];
  const [tools,setTools]=useState([]);
  const [loading,setLoading]=useState(true);
  const [search,setSearch]=useState("");
  const [showForm,setShowForm]=useState(false);
  const [editId,setEditId]=useState(null);
  const [form,setForm]=useState({code:"",name:"",category:"",qty:"",minQty:"",location:"",geometry:"",toolMaterial:"",expectedLife:"",remainingLifePct:"100",assignedProgram:"",assignedWorkOrder:"",presetterOffset:"",notes:""});
  const [orders,setOrders]=useState([]);
  const [movements,setMovements]=useState([]);
  const [moveOpenId,setMoveOpenId]=useState(null);
  const [moveForm,setMoveForm]=useState({type:"out",qty:"",orderId:"",note:""});

  const load=useCallback(async()=>{
    const [rows,ords,mvs]=await Promise.all([
      window.DB.getAll("toolStock"),
      window.DB.getAll("orders"),
      window.DB.getAll("toolMovements"),
    ]);
    setTools(rows.sort((a,b)=>(a.name||"").localeCompare(b.name||"","tr")));
    setOrders(ords.sort((a,b)=>(b.createdAt||"").localeCompare(a.createdAt||"")));
    setMovements(mvs.sort((a,b)=>(b.createdAt||"").localeCompare(a.createdAt||"")));
    setLoading(false);
  },[]);
  useEffect(()=>{load();},[load]);

  const resetForm=()=>setForm({code:"",name:"",category:"",qty:"",minQty:"",location:"",geometry:"",toolMaterial:"",expectedLife:"",remainingLifePct:"100",assignedProgram:"",assignedWorkOrder:"",presetterOffset:"",notes:""});
  const fv=(k,v)=>setForm(p=>({...p,[k]:v}));
  const nextToolCode=useCallback((list=tools)=>{
    const nums=list.map(t=>{
      const m=String(t.code||"").toUpperCase().match(/^TKM-(\d+)$/);
      return m?Number(m[1]):null;
    }).filter(n=>n!==null);
    const next=(nums.length?Math.max(...nums):0)+1;
    return `TKM-${String(next).padStart(3,"0")}`;
  },[tools]);

  async function saveTool(){
    if(!form.name.trim()){alert("Takim adi zorunlu.");return;}
    const payload={
      code:(form.code.trim()||nextToolCode()).toUpperCase(),
      name:form.name.trim(),
      category:form.category.trim(),
      qty:Number(form.qty)||0,
      minQty:Number(form.minQty)||0,
      location:form.location.trim(),
      geometry:form.geometry.trim(),
      toolMaterial:form.toolMaterial.trim(),
      expectedLife:Math.max(0,Number(form.expectedLife)||0),
      remainingLifePct:Math.max(0,Math.min(100,Number(form.remainingLifePct)||0)),
      assignedProgram:form.assignedProgram.trim(),
      assignedWorkOrder:form.assignedWorkOrder.trim(),
      presetterOffset:form.presetterOffset.trim(),
      notes:form.notes.trim(),
      updatedAt:new Date().toISOString(),
    };
    if(editId){
      const ok=await window.DB.updateDoc("toolStock",editId,payload);
      if(ok){
        setTools(t=>t.map(x=>x.id===editId?{...x,...payload}:x));
        setShowForm(false); setEditId(null); resetForm();
      }
      return;
    }
    const id=`tool_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,7)}`;
    const ok=await window.DB.setDoc("toolStock",id,payload);
    if(ok){
      setTools(t=>[...t,{id,...payload}].sort((a,b)=>(a.name||"").localeCompare(b.name||"","tr")));
      setShowForm(false); resetForm();
    }
  }

  async function removeTool(id,name){
    if(!confirm(`"${name}" takimini silmek istiyor musunuz?`)) return;
    const ok=await window.DB.deleteDoc("toolStock",id);
    if(ok) setTools(t=>t.filter(x=>x.id!==id));
  }
  function openMovement(toolId,type){
    setMoveOpenId(toolId);
    setMoveForm({type,qty:"",orderId:"",note:""});
  }
  async function saveMovement(tool){
    const qty=Math.max(0,Number(moveForm.qty)||0);
    if(!qty){alert("Miktar girin.");return;}
    const currentQty=Number(tool.qty)||0;
    if(moveForm.type==="out"&&qty>currentQty){alert("Stok yetersiz.");return;}
    const nextQty=moveForm.type==="in"?(currentQty+qty):(currentQty-qty);
    const pickedOrder=orders.find(o=>o.id===moveForm.orderId);
    const stockOk=await window.DB.updateDoc("toolStock",tool.id,{qty:nextQty,updatedAt:new Date().toISOString()});
    if(!stockOk){alert("Stok guncellenemedi.");return;}
    const movePayload={
      toolId:tool.id,
      toolCode:tool.code||"",
      toolName:tool.name||"",
      type:moveForm.type,
      qty,
      orderId:pickedOrder?.id||"",
      orderCode:pickedOrder?.code||"",
      orderName:pickedOrder?.name||"",
      note:moveForm.note.trim(),
      createdAt:new Date().toISOString(),
      userId:currentUser.id,
      userName:currentUser.fullName||currentUser.id,
      balanceAfter:nextQty,
    };
    await window.DB.addDoc("toolMovements",movePayload);
    setTools(t=>t.map(x=>x.id===tool.id?{...x,qty:nextQty,updatedAt:new Date().toISOString()}:x));
    setMovements(m=>[{...movePayload,id:`temp_${Date.now()}`},...m]);
    setMoveOpenId(null);
    setMoveForm({type:"out",qty:"",orderId:"",note:""});
  }

  const filtered=tools.filter(t=>{
    const q=search.toLowerCase().trim();
    if(!q) return true;
    return (t.name||"").toLowerCase().includes(q)||
      (t.code||"").toLowerCase().includes(q)||
      (t.category||"").toLowerCase().includes(q)||
      (t.location||"").toLowerCase().includes(q)||
      (t.assignedProgram||"").toLowerCase().includes(q)||
      (t.assignedWorkOrder||"").toLowerCase().includes(q);
  });
  const lowCount=tools.filter(t=>(Number(t.qty)||0)<=Math.max(Number(t.minQty)||0,0)).length;
  const lowLifeCount=tools.filter(t=>Math.max(0,Number(t.remainingLifePct)||0)<=20).length;
  const stockedTools=[...tools].filter(t=>(Number(t.qty)||0)>0).sort((a,b)=>(Number(b.qty)||0)-(Number(a.qty)||0));
  const categoryOptions=(form.category&& !TOOL_CATEGORY_OPTIONS.includes(form.category))
    ? [...TOOL_CATEGORY_OPTIONS,form.category]
    : TOOL_CATEGORY_OPTIONS;

  if(loading) return <div style={{padding:30,color:C.muted2,textAlign:"center"}}>Yukleniyor...</div>;

  return (
    <div style={{padding:16}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12,gap:8,flexWrap:"wrap"}}>
        <div style={{fontWeight:700,color:C.text}}>Takim Stogu</div>
        {isAdmin&&<button onClick={()=>{if(showForm){setShowForm(false);setEditId(null);resetForm();}else{resetForm();setEditId(null);setForm(p=>({...p,code:nextToolCode()}));setShowForm(true);}}} style={{...btnSt("primary"),padding:"8px 14px",fontSize:12}}>{showForm?"Kapat":"+ Yeni Ekle"}</button>}
      </div>

      {showForm&&isAdmin&&(
        <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:14,marginBottom:12}}>
          <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",marginBottom:14}}>{editId?"Takim Duzenle":"Yeni Takim"}</div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
            <div><span style={labelSt}>Kod</span><input style={inputSt} value={form.code} onChange={e=>fv("code",e.target.value)} placeholder="TKM-001"/></div>
            <div><span style={labelSt}>Takim Adi *</span><input style={inputSt} value={form.name} onChange={e=>fv("name",e.target.value)} placeholder="12mm Parmak Freze"/></div>
            <div>
              <span style={labelSt}>Kategori</span>
              <select style={inputSt} value={form.category} onChange={e=>fv("category",e.target.value)}>
                <option value="">Kategori secin...</option>
                {categoryOptions.map(c=><option key={c} value={c}>{c}</option>)}
              </select>
            </div>
            <div><span style={labelSt}>Stok Adedi</span><input style={inputSt} type="number" min="0" value={form.qty} onChange={e=>fv("qty",e.target.value)} placeholder="0"/></div>
            <div><span style={labelSt}>Minimum Adet</span><input style={inputSt} type="number" min="0" value={form.minQty} onChange={e=>fv("minQty",e.target.value)} placeholder="0"/></div>
            <div><span style={labelSt}>Konum</span><input style={inputSt} value={form.location} onChange={e=>fv("location",e.target.value)} placeholder="Raf A2"/></div>
            <div><span style={labelSt}>Geometri</span><input style={inputSt} value={form.geometry} onChange={e=>fv("geometry",e.target.value)} placeholder="D12 L75"/></div>
            <div><span style={labelSt}>Takim Malzemesi</span><input style={inputSt} value={form.toolMaterial} onChange={e=>fv("toolMaterial",e.target.value)} placeholder="Carbide / HSS"/></div>
            <div><span style={labelSt}>Beklenen Omur (cevrim)</span><input style={inputSt} type="number" min="0" value={form.expectedLife} onChange={e=>fv("expectedLife",e.target.value)} placeholder="1200"/></div>
            <div><span style={labelSt}>Kalan Omur %</span><input style={inputSt} type="number" min="0" max="100" value={form.remainingLifePct} onChange={e=>fv("remainingLifePct",e.target.value)} placeholder="100"/></div>
            <div><span style={labelSt}>Atanmis NC Program</span><input style={inputSt} value={form.assignedProgram} onChange={e=>fv("assignedProgram",e.target.value)} placeholder="O2345"/></div>
            <div><span style={labelSt}>Atanmis Is Emri</span><input style={inputSt} value={form.assignedWorkOrder} onChange={e=>fv("assignedWorkOrder",e.target.value)} placeholder="IE-012"/></div>
            <div style={{gridColumn:"1 / -1"}}><span style={labelSt}>Presetter Offset (ops.)</span><input style={inputSt} value={form.presetterOffset} onChange={e=>fv("presetterOffset",e.target.value)} placeholder="X:0.012 / Z:-0.004"/></div>
            <div style={{gridColumn:"1 / -1"}}><span style={labelSt}>Not</span><textarea style={{...inputSt,resize:"vertical",minHeight:70}} value={form.notes} onChange={e=>fv("notes",e.target.value)} placeholder="Aciklama..."/></div>
            <div style={{gridColumn:"1 / -1",display:"flex",gap:8}}>
              <button onClick={saveTool} style={{...btnSt("primary"),padding:"10px 14px"}}>Kaydet</button>
              <button onClick={()=>{setShowForm(false);setEditId(null);resetForm();}} style={{...btnSt("ghost"),padding:"10px 14px"}}>Iptal</button>
            </div>
          </div>
        </div>
      )}

      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"10px 12px",marginBottom:12}}>
        <div style={{fontSize:11,color:C.muted2,letterSpacing:1,textTransform:"uppercase",marginBottom:8}}>Stokdaki Urunler ({stockedTools.length})</div>
        {stockedTools.length===0?<div style={{fontSize:12,color:C.muted}}>Stokta takim yok</div>:(
          <div style={{display:"flex",gap:7,flexWrap:"wrap"}}>
            {stockedTools.map(t=><span key={t.id} style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,padding:"4px 8px",fontSize:11,color:C.muted2}}>{t.code||"-"} · {t.name||"-"} · <span style={{color:C.text,fontWeight:700}}>{Number(t.qty)||0}</span></span>)}
          </div>
        )}
      </div>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12,gap:8,flexWrap:"wrap"}}>
        <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase"}}>Takim Stogu · {tools.length} kayit · {lowCount} kritik stok · {lowLifeCount} kritik omur</div>
      </div>
      <div style={{marginBottom:12}}>
        <input style={{...inputSt,padding:"9px 12px",fontSize:13}} placeholder="Takim adi, kod, kategori veya konum ara..." value={search} onChange={e=>setSearch(e.target.value)}/>
      </div>
      {filtered.length===0&&<div style={{textAlign:"center",color:C.muted2,padding:"30px 20px",background:C.card,borderRadius:14,border:`1px solid ${C.border}`}}>Sonuc yok</div>}
      {filtered.map(t=>{
        const qty=Number(t.qty)||0;
        const min=Math.max(Number(t.minQty)||0,0);
        const critical=qty<=min;
        return (
          <div key={t.id} style={{background:C.card,border:`1px solid ${critical?C.red+"66":C.border}`,borderRadius:14,padding:"12px 14px",marginBottom:9}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",gap:10,marginBottom:8}}>
              <div>
                <div style={{fontSize:14,fontWeight:700,color:C.text}}>{t.name||"-"}</div>
                <div style={{fontSize:12,color:C.muted2,marginTop:2}}>{t.code?`${t.code} · `:""}{t.category||"Kategori yok"}</div>
              </div>
              <div style={{display:"flex",gap:5,flexWrap:"wrap",justifyContent:"flex-end"}}>
                <Badge label={`Stok ${qty}`} color={critical?C.red:C.green}/>
                <Badge label={`Min ${min}`} color={C.muted2}/>
                <Badge label={`Omur %${Math.max(0,Number(t.remainingLifePct)||0)}`} color={(Number(t.remainingLifePct)||0)<=20?C.red:C.warn}/>
              </div>
            </div>
            <div style={{display:"flex",gap:7,flexWrap:"wrap",fontSize:11,color:C.muted2,marginBottom:8}}>
              {t.location&&<span style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,padding:"3px 8px"}}>Konum: {t.location}</span>}
              {t.geometry&&<span style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,padding:"3px 8px"}}>Geo: {t.geometry}</span>}
              {t.toolMaterial&&<span style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,padding:"3px 8px"}}>{t.toolMaterial}</span>}
              {t.assignedProgram&&<span style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,padding:"3px 8px"}}>NC: {t.assignedProgram}</span>}
              {t.assignedWorkOrder&&<span style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,padding:"3px 8px"}}>IE: {t.assignedWorkOrder}</span>}
              {critical&&<span style={{background:C.redDim,border:`1px solid ${C.red}44`,borderRadius:8,padding:"3px 8px",color:C.red}}>Stok kritik</span>}
              {(Number(t.remainingLifePct)||0)<=20&&<span style={{background:C.redDim,border:`1px solid ${C.red}44`,borderRadius:8,padding:"3px 8px",color:C.red}}>Takim omru kritik</span>}
            </div>
            {t.notes&&<div style={{fontSize:12,color:C.muted2,marginBottom:8}}>{t.notes}</div>}
            {isAdmin&&(
              <div style={{display:"flex",gap:7}}>
                <button onClick={()=>openMovement(t.id,"in")} style={{...btnSt("green"),padding:"6px 10px",fontSize:12}}>Stok Girisi</button>
                <button onClick={()=>openMovement(t.id,"out")} style={{...btnSt("danger"),padding:"6px 10px",fontSize:12}}>Stok Cikisi</button>
                <button onClick={()=>{setEditId(t.id);setForm({code:t.code||"",name:t.name||"",category:t.category||"",qty:String(qty),minQty:String(min),location:t.location||"",geometry:t.geometry||"",toolMaterial:t.toolMaterial||"",expectedLife:String(t.expectedLife??""),remainingLifePct:String(t.remainingLifePct??"100"),assignedProgram:t.assignedProgram||"",assignedWorkOrder:t.assignedWorkOrder||"",presetterOffset:t.presetterOffset||"",notes:t.notes||""});setShowForm(true);}} style={{...btnSt("ghost"),padding:"6px 10px",fontSize:12}}>Duzenle</button>
                <button onClick={()=>removeTool(t.id,t.name||"Takim")} style={{...btnSt("danger"),padding:"6px 10px",fontSize:12}}>Sil</button>
              </div>
            )}
            {isAdmin&&moveOpenId===t.id&&(
              <div style={{marginTop:10,padding:10,background:C.surface,border:`1px solid ${C.border}`,borderRadius:10}}>
                <div style={{display:"grid",gridTemplateColumns:"120px 1fr",gap:8}}>
                  <select style={{...inputSt,padding:"7px 10px",fontSize:12}} value={moveForm.type} onChange={e=>setMoveForm(f=>({...f,type:e.target.value}))}>
                    <option value="in">Giris</option>
                    <option value="out">Cikis</option>
                  </select>
                  <input style={{...inputSt,padding:"7px 10px",fontSize:12}} type="number" min="1" placeholder="Miktar" value={moveForm.qty} onChange={e=>setMoveForm(f=>({...f,qty:e.target.value}))}/>
                  <select style={{...inputSt,padding:"7px 10px",fontSize:12,gridColumn:"1 / -1"}} value={moveForm.orderId} onChange={e=>setMoveForm(f=>({...f,orderId:e.target.value}))}>
                    <option value="">Is emri sec (opsiyonel)</option>
                    {orders.map(o=><option key={o.id} value={o.id}>{o.code} - {o.name}</option>)}
                  </select>
                  <input style={{...inputSt,padding:"7px 10px",fontSize:12,gridColumn:"1 / -1"}} placeholder="Not (opsiyonel)" value={moveForm.note} onChange={e=>setMoveForm(f=>({...f,note:e.target.value}))}/>
                </div>
                <div style={{display:"flex",gap:7,marginTop:8}}>
                  <button onClick={()=>saveMovement(t)} style={{...btnSt("primary"),padding:"6px 10px",fontSize:12}}>Hareket Kaydet</button>
                  <button onClick={()=>setMoveOpenId(null)} style={{...btnSt("ghost"),padding:"6px 10px",fontSize:12}}>Kapat</button>
                </div>
              </div>
            )}
            <div style={{marginTop:10}}>
              <div style={{color:C.muted2,fontSize:10,letterSpacing:.7,textTransform:"uppercase",marginBottom:6}}>Son Hareketler</div>
              {movements.filter(m=>m.toolId===t.id).slice(0,3).map((m,i)=>(
                <div key={m.id||i} style={{display:"flex",justifyContent:"space-between",fontSize:11,color:C.muted2,marginBottom:4}}>
                  <span>{m.type==="in"?"Giris":"Cikis"} · {m.qty} {m.orderCode?`· ${m.orderCode}`:""}</span>
                  <span>{(m.createdAt||"").slice(0,10)}</span>
                </div>
              ))}
              {movements.filter(m=>m.toolId===t.id).length===0&&<div style={{fontSize:11,color:C.muted}}>Hareket yok</div>}
            </div>
          </div>
        );
      })}
    </div>
  );
}

// ════════════════════════════════════════════════════════════
//  CUSTOMERS
// ════════════════════════════════════════════════════════════
function Customers() {
  const emptyForm={name:"",code:"",contact:"",phone:"",email:"",notes:""};
  const [customers,setCustomers]=useState([]);
  const [form,setForm]=useState(emptyForm);
  const [editId,setEditId]=useState(null);
  const [search,setSearch]=useState("");
  const [loading,setLoading]=useState(true);

  useEffect(()=>{
    window.DB.getAll("customers").then(list=>{
      setCustomers(list.sort((a,b)=>(a.name||"").localeCompare(b.name||"")));
      setLoading(false);
    });
  },[]);

  function nextCustomerCode(list=customers){
    const nums=list.map(c=>{
      const m=(c.code||"").toUpperCase().match(/^FRM-(\d+)$/);
      return m?Number(m[1]):null;
    }).filter(n=>n!==null);
    const next=(nums.length?Math.max(...nums):0)+1;
    return `FRM-${String(next).padStart(3,"0")}`;
  }

  const fv=(k,v)=>setForm(p=>({...p,[k]:v}));
  const q=search.trim().toLowerCase();
  const filtered=customers.filter(c=>
    !q ||
    (c.name||"").toLowerCase().includes(q) ||
    (c.code||"").toLowerCase().includes(q) ||
    (c.contact||"").toLowerCase().includes(q) ||
    (c.phone||"").toLowerCase().includes(q)
  );

  async function saveCustomer(){
    if(!form.name.trim()){alert("Firma adı zorunlu!");return;}
    const autoCode=editId?(form.code||""):nextCustomerCode();
    const data={
      name:form.name.trim(),
      code:autoCode,
      contact:form.contact.trim(),
      phone:form.phone.trim(),
      email:form.email.trim(),
      notes:form.notes.trim(),
      updatedAt:new Date().toISOString(),
    };
    if(editId){
      const ok=await window.DB.updateDoc("customers",editId,data);
      if(!ok){alert("Müşteri güncellenemedi.");return;}
      setCustomers(prev=>prev.map(x=>x.id===editId?{...x,...data}:x).sort((a,b)=>(a.name||"").localeCompare(b.name||"")));
      setEditId(null);
      setForm({...emptyForm,code:nextCustomerCode()});
      return;
    }
    const id=await window.DB.addDoc("customers",data);
    if(!id){alert("Müşteri kaydedilemedi.");return;}
    const nextCustomers=[{id,...data},...customers];
    setCustomers(nextCustomers.sort((a,b)=>(a.name||"").localeCompare(b.name||"")));
    setForm({...emptyForm,code:nextCustomerCode(nextCustomers)});
  }

  function startEdit(c){
    setEditId(c.id);
    setForm({
      name:c.name||"",
      code:c.code||"",
      contact:c.contact||"",
      phone:c.phone||"",
      email:c.email||"",
      notes:c.notes||"",
    });
  }

  async function removeCustomer(c){
    if(!confirm(`Müşteri silinsin mi? (${c.name})`)) return;
    const ok=await window.DB.deleteDoc("customers",c.id);
    if(!ok){alert("Müşteri silinemedi.");return;}
    setCustomers(prev=>prev.filter(x=>x.id!==c.id));
    if(editId===c.id){
      setEditId(null);
      setForm({...emptyForm,code:nextCustomerCode(customers.filter(x=>x.id!==c.id))});
    }
  }

  if(loading) return <div style={{padding:30,color:C.muted2,textAlign:"center"}}>Yükleniyor...</div>;

  return (
    <div style={{padding:16,display:"flex",flexDirection:"column",gap:12}}>
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:14}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
          <div style={{fontWeight:700,color:C.text}}>Müşteriler</div>
          {editId&&<Badge label="Düzenleme" color={C.warn}/>}
        </div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
          <div><span style={labelSt}>Firma Adı *</span><input style={inputSt} value={form.name} onChange={e=>fv("name",e.target.value)} placeholder="Firma adı"/></div>
          <div><span style={labelSt}>Firma Kodu (Otomatik)</span><input style={{...inputSt,background:C.surface,color:C.muted2}} value={editId?(form.code||"-"):nextCustomerCode()} readOnly/></div>
        </div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8,marginTop:8}}>
          <div><span style={labelSt}>Yetkili</span><input style={inputSt} value={form.contact} onChange={e=>fv("contact",e.target.value)} placeholder="Ad Soyad"/></div>
          <div><span style={labelSt}>Telefon</span><input style={inputSt} value={form.phone} onChange={e=>fv("phone",e.target.value)} placeholder="05xx xxx xx xx"/></div>
          <div><span style={labelSt}>E-posta</span><input style={inputSt} value={form.email} onChange={e=>fv("email",e.target.value)} placeholder="mail@firma.com"/></div>
        </div>
        <div style={{marginTop:8}}><span style={labelSt}>Not</span><textarea rows={2} style={{...inputSt,minHeight:64,resize:"vertical"}} value={form.notes} onChange={e=>fv("notes",e.target.value)} placeholder="Opsiyonel not..."/></div>
        <div style={{display:"flex",gap:8,marginTop:10}}>
          <button onClick={saveCustomer} style={{...btnSt("primary"),flex:1,padding:12}}>{editId?"Müşteriyi Güncelle":"Müşteri Kaydet"}</button>
          {editId&&<button onClick={()=>{setEditId(null);setForm({...emptyForm,code:nextCustomerCode()});}} style={{...btnSt("ghost"),padding:"12px 14px"}}>İptal</button>}
        </div>
      </div>

      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"10px 12px",display:"flex",justifyContent:"space-between",alignItems:"center",gap:8,flexWrap:"wrap"}}>
        <div style={{fontSize:12,color:C.muted2}}>Kayıtlı Firma: {customers.length}</div>
        <input style={{...inputSt,padding:"7px 10px",fontSize:12,minWidth:220}} value={search} onChange={e=>setSearch(e.target.value)} placeholder="Firma adı, kod veya yetkili ara..."/>
      </div>

      {filtered.length===0&&<div style={{textAlign:"center",color:C.muted2,padding:"28px 20px",background:C.card,borderRadius:14,border:`1px solid ${C.border}`}}>Müşteri bulunamadı</div>}
      {filtered.map(c=>(
        <div key={c.id} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:"12px 14px"}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",gap:10}}>
            <div>
              <div style={{fontWeight:700,color:C.text,fontSize:14}}>{c.name}</div>
              <div style={{fontSize:12,color:C.muted2,marginTop:2}}>{c.code||"-"} {c.contact?`· ${c.contact}`:""}</div>
              <div style={{fontSize:11,color:C.muted,marginTop:2}}>{c.phone||""} {c.email?`· ${c.email}`:""}</div>
            </div>
            <div style={{display:"flex",gap:7}}>
              <button onClick={()=>startEdit(c)} style={{...btnSt("ghost"),padding:"6px 10px",fontSize:12}}>Düzenle</button>
              <button onClick={()=>removeCustomer(c)} style={{...btnSt("danger"),padding:"6px 10px",fontSize:12}}>Sil</button>
            </div>
          </div>
          {c.notes&&<div style={{fontSize:12,color:C.muted2,marginTop:8}}>{c.notes}</div>}
        </div>
      ))}
    </div>
  );
}

function MaterialLibrary() {
  const MATERIAL_TYPE_OPTIONS=[["raw","Hammadde"],["semi","Yari Mamul"],["consumable","Sarf"]];
  const TRACKING_OPTIONS=[["none","Takip Yok"],["lot","Lot"],["serial","Seri No"]];
  const VALUATION_OPTIONS=[["fifo","FIFO"],["lifo","LIFO"],["weighted","Ortalama"]];
  const DEFAULT_MATERIALS = [
    {name:"Demir",density:7.87},
    {name:"SS 303",density:7.93},
    {name:"SS 304",density:8.00},
    {name:"SS 316/321",density:8.00},
    {name:"SS 420",density:7.75},
    {name:"SS 410/430",density:7.75},
    {name:"AL 7075",density:2.81},
    {name:"Pirinç",density:8.50},
    {name:"Bronz",density:8.80},
    {name:"Bakır",density:8.96},
    {name:"Titanyum",density:4.51},
    {name:"50CrV4",density:7.85},
    {name:"4340",density:7.85},
    {name:"4140 - 42CrMo4",density:7.85},
    {name:"C45",density:7.85},
    {name:"45NiCrMo16",density:7.85},
    {name:"41Cr4",density:7.85},
    {name:"100Cr6",density:7.81},
    {name:"POM ACETAL",density:1.41},
    {name:"14NiCr14",density:7.85},
    {name:"CK75",density:7.85},
    {name:"CK45",density:7.85},
    {name:"18NiCrMo5",density:7.85},
    {name:"CK67",density:7.85},
    {name:"8620",density:7.85},
    {name:"OTOMAT - 1045",density:7.85},
    {name:"OTOMAT - 1010 - C15",density:7.85},
  ];
  const [materials,setMaterials]=useState([]);
  const [loading,setLoading]=useState(true);
  const [showForm,setShowForm]=useState(false);
  const [editId,setEditId]=useState(null);
  const [search,setSearch]=useState("");
  const [seedChecked,setSeedChecked]=useState(false);
  const [form,setForm]=useState({name:"",code:"",density:"",stock:"",type:"raw",reorderPoint:"0",safetyStock:"0",leadTimeDays:"5",trackingMode:"lot",valuationMethod:"fifo",note:""});
  const fv=(k,v)=>setForm(p=>({...p,[k]:v}));
  const nextMaterialCode=useCallback((list=materials)=>{
    const nums=list.map(m=>{
      const mm=String(m.code||"").toUpperCase().match(/^(?:MLZ|M)-(\d+)$/);
      return mm?Number(mm[1]):null;
    }).filter(n=>n!==null);
    const next=(nums.length?Math.max(...nums):0)+1;
    return `MLZ-${String(next).padStart(3,"0")}`;
  },[materials]);

  const load=useCallback(async()=>{
    const rows=await window.DB.getAll("materials");
    setMaterials(rows.sort((a,b)=>(a.name||"").localeCompare(b.name||"","tr")));
    setLoading(false);
  },[]);
  useEffect(()=>{load();},[load]);
  useEffect(()=>{
    if(editId) return;
    setForm(prev=>({...prev,code:nextMaterialCode()}));
  },[editId,nextMaterialCode]);

  async function saveMaterial(){
    if(!form.name.trim()){alert("Malzeme adı zorunlu.");return;}
    const finalCode=editId?(form.code||nextMaterialCode()):nextMaterialCode();
    const densityVal=Number(String(form.density).replace(",","."));
    const payload={
      name:form.name.trim(),
      code:String(finalCode).toUpperCase(),
      density:densityVal>0?densityVal:0,
      stock:Math.max(0,Number(form.stock)||0),
      type:form.type||"raw",
      reorderPoint:Math.max(0,Number(form.reorderPoint)||0),
      safetyStock:Math.max(0,Number(form.safetyStock)||0),
      leadTimeDays:Math.max(0,Number(form.leadTimeDays)||0),
      trackingMode:form.trackingMode||"lot",
      valuationMethod:form.valuationMethod||"fifo",
      note:form.note.trim(),
      updatedAt:new Date().toISOString(),
    };
    if(editId){
      const ok=await window.DB.updateDoc("materials",editId,payload);
      if(!ok){alert("Malzeme güncellenemedi.");return;}
      setMaterials(prev=>prev.map(x=>x.id===editId?{...x,...payload}:x).sort((a,b)=>(a.name||"").localeCompare(b.name||"","tr")));
      setEditId(null);
      setShowForm(false);
      setForm({name:"",code:nextMaterialCode(),density:"",stock:"",type:"raw",reorderPoint:"0",safetyStock:"0",leadTimeDays:"5",trackingMode:"lot",valuationMethod:"fifo",note:""});
      return;
    }
    const id=await window.DB.addDoc("materials",payload);
    if(!id){alert("Malzeme kaydedilemedi.");return;}
    const nextList=[{id,...payload,createdAt:new Date().toISOString()},...materials];
    setMaterials(nextList.sort((a,b)=>(a.name||"").localeCompare(b.name||"","tr")));
    setShowForm(false);
    setForm({name:"",code:nextMaterialCode(nextList),density:"",stock:"",type:"raw",reorderPoint:"0",safetyStock:"0",leadTimeDays:"5",trackingMode:"lot",valuationMethod:"fifo",note:""});
  }

  async function removeMaterial(m){
    if(!confirm(`"${m.name}" silinsin mi?`)) return;
    const ok=await window.DB.deleteDoc("materials",m.id);
    if(!ok){alert("Malzeme silinemedi.");return;}
    setMaterials(prev=>prev.filter(x=>x.id!==m.id));
    if(editId===m.id){
      setEditId(null);
      setForm({name:"",code:nextMaterialCode(materials.filter(x=>x.id!==m.id)),density:"",stock:"",type:"raw",reorderPoint:"0",safetyStock:"0",leadTimeDays:"5",trackingMode:"lot",valuationMethod:"fifo",note:""});
    }
  }
  async function seedDefaultMaterials(showMessage=true){
    const existing=await window.DB.getAll("materials");
    const exists=new Set(existing.map(x=>String(x.name||"").trim().toLowerCase()));
    const work=[...existing];
    let added=0;
    for(const item of DEFAULT_MATERIALS){
      const key=String(item.name||"").trim().toLowerCase();
      if(!key||exists.has(key)) continue;
      const payload={
        name:item.name,
        code:nextMaterialCode(work),
        density:Number(item.density)||0,
        stock:0,
        type:"raw",
        reorderPoint:0,
        safetyStock:0,
        leadTimeDays:5,
        trackingMode:"lot",
        valuationMethod:"fifo",
        note:"",
        updatedAt:new Date().toISOString(),
        createdBy:"seed",
      };
      const id=await window.DB.addDoc("materials",payload);
      if(id){
        work.unshift({id,...payload,createdAt:new Date().toISOString()});
        exists.add(key);
        added++;
      }
    }
    if(added===0){if(showMessage) alert("Listedeki malzemeler zaten ekli.");return;}
    setMaterials(work.sort((a,b)=>(a.name||"").localeCompare(b.name||"","tr")));
    setForm(prev=>({...prev,code:nextMaterialCode(work)}));
    if(showMessage) alert(`${added} malzeme eklendi.`);
  }
  useEffect(()=>{
    if(loading||seedChecked) return;
    setSeedChecked(true);
    seedDefaultMaterials(false);
  },[loading,seedChecked]);

  const q=search.trim().toLowerCase();
  const stockedMaterials=[...materials].filter(m=>(Number(m.stock)||0)>0).sort((a,b)=>(Number(b.stock)||0)-(Number(a.stock)||0));
  const filtered=materials.filter(m=>{
    if(!q) return true;
    return (m.name||"").toLowerCase().includes(q)||
      (m.code||"").toLowerCase().includes(q)||
      (m.note||"").toLowerCase().includes(q);
  });

  if(loading) return <div style={{padding:30,color:C.muted2,textAlign:"center"}}>Yukleniyor...</div>;

  return (
    <div style={{padding:16,display:"flex",flexDirection:"column",gap:12}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",gap:8,flexWrap:"wrap"}}>
        <div style={{fontWeight:700,color:C.text}}>Malzeme Kutuphanesi</div>
        <div style={{display:"flex",gap:8}}>
          <button onClick={()=>{if(showForm){setShowForm(false);setEditId(null);setForm({name:"",code:nextMaterialCode(),density:"",stock:"",type:"raw",reorderPoint:"0",safetyStock:"0",leadTimeDays:"5",trackingMode:"lot",valuationMethod:"fifo",note:""});}else{setEditId(null);setForm({name:"",code:nextMaterialCode(),density:"",stock:"",type:"raw",reorderPoint:"0",safetyStock:"0",leadTimeDays:"5",trackingMode:"lot",valuationMethod:"fifo",note:""});setShowForm(true);}}} style={{...btnSt("primary"),padding:"8px 12px",fontSize:12}}>{showForm?"Kapat":"+ Yeni Ekle"}</button>
        </div>
      </div>

      {showForm&&(
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:14}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
          <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase"}}>{editId?"Malzeme Duzenle":"Yeni Malzeme"}</div>
          {editId&&<Badge label="Duzenleme" color={C.warn}/>}
        </div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
          <div><span style={labelSt}>Malzeme Adi *</span><input style={inputSt} value={form.name} onChange={e=>fv("name",e.target.value)} placeholder="AISI 304"/></div>
          <div><span style={labelSt}>Kod (Otomatik)</span><input style={{...inputSt,background:C.surface,color:C.muted2}} value={form.code||nextMaterialCode()} readOnly/></div>
          <div><span style={labelSt}>Ozgul Agirlik (g/cm3)</span><input style={inputSt} type="number" step="0.001" min="0" value={form.density} onChange={e=>fv("density",e.target.value)} placeholder="7.850"/></div>
          <div><span style={labelSt}>Stok</span><input style={inputSt} type="number" min="0" value={form.stock} onChange={e=>fv("stock",e.target.value)} placeholder="0"/></div>
          <div><span style={labelSt}>Tur</span><select style={inputSt} value={form.type||"raw"} onChange={e=>fv("type",e.target.value)}>{MATERIAL_TYPE_OPTIONS.map(([id,l])=><option key={id} value={id}>{l}</option>)}</select></div>
          <div><span style={labelSt}>Lead-Time (gun)</span><input style={inputSt} type="number" min="0" value={form.leadTimeDays} onChange={e=>fv("leadTimeDays",e.target.value)} placeholder="5"/></div>
          <div><span style={labelSt}>Yeniden Siparis Noktasi</span><input style={inputSt} type="number" min="0" value={form.reorderPoint} onChange={e=>fv("reorderPoint",e.target.value)} placeholder="0"/></div>
          <div><span style={labelSt}>Guvenlik Stogu</span><input style={inputSt} type="number" min="0" value={form.safetyStock} onChange={e=>fv("safetyStock",e.target.value)} placeholder="0"/></div>
          <div><span style={labelSt}>Izleme Tipi</span><select style={inputSt} value={form.trackingMode||"lot"} onChange={e=>fv("trackingMode",e.target.value)}>{TRACKING_OPTIONS.map(([id,l])=><option key={id} value={id}>{l}</option>)}</select></div>
          <div><span style={labelSt}>Maliyetleme Yontemi</span><select style={inputSt} value={form.valuationMethod||"fifo"} onChange={e=>fv("valuationMethod",e.target.value)}>{VALUATION_OPTIONS.map(([id,l])=><option key={id} value={id}>{l}</option>)}</select></div>
        </div>
        <div style={{marginTop:8}}>
          <span style={labelSt}>Not</span>
          <textarea rows={2} style={{...inputSt,minHeight:64,resize:"vertical"}} value={form.note} onChange={e=>fv("note",e.target.value)} placeholder="Opsiyonel not..."/>
        </div>
        <div style={{display:"flex",gap:8,marginTop:10}}>
          <button onClick={saveMaterial} style={{...btnSt("primary"),flex:1,padding:12}}>{editId?"Malzemeyi Guncelle":"Malzeme Kaydet"}</button>
          <button onClick={()=>{setEditId(null);setShowForm(false);setForm({name:"",code:nextMaterialCode(),density:"",stock:"",type:"raw",reorderPoint:"0",safetyStock:"0",leadTimeDays:"5",trackingMode:"lot",valuationMethod:"fifo",note:""});}} style={{...btnSt("ghost"),padding:"12px 14px"}}>Iptal</button>
        </div>
      </div>
      )}

      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"10px 12px"}}>
        <div style={{fontSize:11,color:C.muted2,letterSpacing:1,textTransform:"uppercase",marginBottom:8}}>Stokdaki Urunler ({stockedMaterials.length})</div>
        {stockedMaterials.length===0?<div style={{fontSize:12,color:C.muted}}>Stokta malzeme yok</div>:(
          <div style={{display:"flex",gap:7,flexWrap:"wrap"}}>
            {stockedMaterials.map(m=><span key={m.id} style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,padding:"4px 8px",fontSize:11,color:C.muted2}}>{m.code||"-"} · {m.name||"-"} · <span style={{color:C.text,fontWeight:700}}>{Number(m.stock)||0}</span></span>)}
          </div>
        )}
      </div>
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"10px 12px",display:"flex",justifyContent:"space-between",alignItems:"center",gap:8,flexWrap:"wrap"}}>
        <div style={{fontSize:12,color:C.muted2}}>Malzemeler ({materials.length})</div>
        <input style={{...inputSt,padding:"7px 10px",fontSize:12,minWidth:220}} value={search} onChange={e=>setSearch(e.target.value)} placeholder="Malzeme adi veya kod ara..."/>
      </div>

      {filtered.length===0&&<div style={{textAlign:"center",color:C.muted2,padding:"28px 20px",background:C.card,borderRadius:14,border:`1px solid ${C.border}`}}>Malzeme bulunamadi</div>}
      {filtered.map(m=>(
        <div key={m.id} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:"12px 14px"}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",gap:10}}>
            <div>
              <div style={{fontWeight:700,color:C.text,fontSize:14}}>{m.name}</div>
              <div style={{fontSize:12,color:C.muted2,marginTop:2}}>{m.code||"-"}{Number(m.density)>0?` · ${Number(m.density).toFixed(3)} g/cm3`:""} · Stok: {Number(m.stock)||0} · ROP: {safeNum(m.reorderPoint)} · SS: {safeNum(m.safetyStock)}</div>
              <div style={{fontSize:11,color:C.muted,marginTop:2}}>{m.type||"raw"} · Lead {safeNum(m.leadTimeDays)}g · {m.trackingMode||"lot"} · {String(m.valuationMethod||"fifo").toUpperCase()}</div>
            </div>
            <div style={{display:"flex",gap:7}}>
              <button onClick={()=>{setEditId(m.id);setShowForm(true);setForm({name:m.name||"",code:m.code||"",density:String(m.density??""),stock:String(m.stock??""),type:m.type||"raw",reorderPoint:String(m.reorderPoint??0),safetyStock:String(m.safetyStock??0),leadTimeDays:String(m.leadTimeDays??5),trackingMode:m.trackingMode||"lot",valuationMethod:m.valuationMethod||"fifo",note:m.note||""});}} style={{...btnSt("ghost"),padding:"6px 10px",fontSize:12}}>Duzenle</button>
              <button onClick={()=>removeMaterial(m)} style={{...btnSt("danger"),padding:"6px 10px",fontSize:12}}>Sil</button>
            </div>
          </div>
          {m.note&&<div style={{fontSize:12,color:C.muted2,marginTop:8}}>{m.note}</div>}
        </div>
      ))}
    </div>
  );
}

// ════════════════════════════════════════════════════════════
//  PART & PRODUCT DEFINITIONS
// ════════════════════════════════════════════════════════════
function PartProductManagement({currentUser,machines=DEFAULT_MACHINES}) {
  const [parts,setParts]=useState([]);
  const [materials,setMaterials]=useState([]);
  const [loading,setLoading]=useState(true);
  const [search,setSearch]=useState("");
  const [selectedPartId,setSelectedPartId]=useState("");
  const [uploading,setUploading]=useState(false);
  const [partForm,setPartForm]=useState({
    partNo:"",
    name:"",
    material:"",
    revision:"A",
    setupSec:"300",
    cycleSec:"60",
    qtyPerRaw:"1",
    rawUnitCost:"0",
    laborRateHour:"250",
    machineRateHour:"600",
    ncProgramVersion:"V1",
    drawingFile:null,
    notes:"",
  });
  const [bomForm,setBomForm]=useState({componentType:"raw_material",componentCode:"",componentName:"",qtyPer:"1",scrapPct:"0"});
  const [routingForm,setRoutingForm]=useState({operation:"Op-10",machine:machines[0]||"CNC-1",setupSec:"300",cycleSec:"60",ncProgram:"",tooling:""});

  const load=useCallback(async()=>{
    const [p,m]=await Promise.all([window.DB.getAll("parts"),window.DB.getAll("materials")]);
    setParts(p.sort((a,b)=>(a.partNo||"").localeCompare(b.partNo||"","tr")));
    setMaterials(m.sort((a,b)=>(a.name||"").localeCompare(b.name||"","tr")));
    setLoading(false);
  },[]);
  useEffect(()=>{load();},[load]);

  const selectedPart=parts.find(p=>p.id===selectedPartId)||null;
  const filtered=parts.filter(p=>{
    const q=search.toLowerCase().trim();
    if(!q) return true;
    return (p.partNo||"").toLowerCase().includes(q)||(p.name||"").toLowerCase().includes(q)||(p.material||"").toLowerCase().includes(q);
  });

  const partCostCalc=(()=>{
    const qtyRaw=Math.max(0,safeNum(partForm.qtyPerRaw));
    const rawUnit=Math.max(0,safeNum(partForm.rawUnitCost));
    const laborRate=Math.max(0,safeNum(partForm.laborRateHour));
    const machineRate=Math.max(0,safeNum(partForm.machineRateHour));
    const setupSec=Math.max(0,safeNum(partForm.setupSec));
    const cycleSec=Math.max(0,safeNum(partForm.cycleSec));
    const materialCost=qtyRaw*rawUnit;
    const laborCost=((setupSec+cycleSec)/3600)*laborRate;
    const machineCost=((setupSec+cycleSec)/3600)*machineRate;
    const unitCost=materialCost+laborCost+machineCost;
    return {materialCost,laborCost,machineCost,unitCost};
  })();

  const fv=(k,v)=>setPartForm(f=>({...f,[k]:v}));

  async function pickDrawing(e){
    const file=e.target.files&&e.target.files[0];
    if(!file) return;
    if(file.size>8*1024*1024){alert("Dosya en fazla 8MB olabilir.");return;}
    setUploading(true);
    const data=await fileToBase64(file);
    setUploading(false);
    setPartForm(f=>({...f,drawingFile:{name:file.name,size:file.size,type:file.type,data}}));
    e.target.value="";
  }

  async function savePart(){
    if(!partForm.partNo.trim()||!partForm.name.trim()){alert("Parca no ve ad zorunlu.");return;}
    const payload={
      partNo:partForm.partNo.trim().toUpperCase(),
      name:partForm.name.trim(),
      material:partForm.material.trim(),
      revision:(partForm.revision||"A").trim().toUpperCase(),
      setupSec:Math.max(0,safeNum(partForm.setupSec)),
      cycleSec:Math.max(0,safeNum(partForm.cycleSec)),
      qtyPerRaw:Math.max(0,safeNum(partForm.qtyPerRaw)),
      rawUnitCost:Math.max(0,safeNum(partForm.rawUnitCost)),
      laborRateHour:Math.max(0,safeNum(partForm.laborRateHour)),
      machineRateHour:Math.max(0,safeNum(partForm.machineRateHour)),
      ncProgramVersion:(partForm.ncProgramVersion||"V1").trim().toUpperCase(),
      unitCost:partCostCalc.unitCost,
      costBreakdown:{materialCost:partCostCalc.materialCost,laborCost:partCostCalc.laborCost,machineCost:partCostCalc.machineCost},
      drawingFile:partForm.drawingFile||null,
      notes:partForm.notes.trim(),
      bomLines:[],
      routingOps:[],
      updatedAt:new Date().toISOString(),
      updatedBy:currentUser.id,
    };
    const existing=parts.find(p=>(p.partNo||"").toUpperCase()===payload.partNo);
    if(existing){
      const ok=await window.DB.updateDoc("parts",existing.id,{...existing,...payload});
      if(!ok){alert("Parca guncellenemedi.");return;}
      await addAuditLog(currentUser.id,"part",existing.id,"update",existing,payload,{module:"parts"});
      setParts(prev=>prev.map(x=>x.id===existing.id?{...x,...payload}:x));
      setSelectedPartId(existing.id);
      return;
    }
    const id=await window.DB.addDoc("parts",payload);
    if(!id){alert("Parca kaydedilemedi.");return;}
    await addAuditLog(currentUser.id,"part",id,"create",null,payload,{module:"parts"});
    const next=[{id,...payload,createdAt:new Date().toISOString()},...parts].sort((a,b)=>(a.partNo||"").localeCompare(b.partNo||"","tr"));
    setParts(next);
    setSelectedPartId(id);
  }

  function loadPartToForm(p){
    setPartForm({
      partNo:p.partNo||"",
      name:p.name||"",
      material:p.material||"",
      revision:p.revision||"A",
      setupSec:String(p.setupSec??300),
      cycleSec:String(p.cycleSec??60),
      qtyPerRaw:String(p.qtyPerRaw??1),
      rawUnitCost:String(p.rawUnitCost??0),
      laborRateHour:String(p.laborRateHour??250),
      machineRateHour:String(p.machineRateHour??600),
      ncProgramVersion:p.ncProgramVersion||"V1",
      drawingFile:p.drawingFile||null,
      notes:p.notes||"",
    });
  }

  async function addBomLine(){
    if(!selectedPart){alert("Once parca secin.");return;}
    if(!bomForm.componentCode.trim()||safeNum(bomForm.qtyPer)<=0){alert("BOM satiri eksik.");return;}
    const line={
      id:`bom_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,6)}`,
      componentType:bomForm.componentType||"raw_material",
      componentCode:bomForm.componentCode.trim().toUpperCase(),
      componentName:bomForm.componentName.trim(),
      qtyPer:Math.max(0,safeNum(bomForm.qtyPer)),
      scrapPct:Math.max(0,Math.min(100,safeNum(bomForm.scrapPct))),
    };
    const nextLines=[...(selectedPart.bomLines||[]),line];
    const ok=await window.DB.updateDoc("parts",selectedPart.id,{bomLines:nextLines,updatedAt:new Date().toISOString(),updatedBy:currentUser.id});
    if(!ok){alert("BOM satiri eklenemedi.");return;}
    setParts(prev=>prev.map(x=>x.id===selectedPart.id?{...x,bomLines:nextLines}:x));
    setBomForm({componentType:"raw_material",componentCode:"",componentName:"",qtyPer:"1",scrapPct:"0"});
  }
  async function removeBomLine(lineId){
    if(!selectedPart) return;
    const next=(selectedPart.bomLines||[]).filter(x=>x.id!==lineId);
    await window.DB.updateDoc("parts",selectedPart.id,{bomLines:next,updatedAt:new Date().toISOString(),updatedBy:currentUser.id});
    setParts(prev=>prev.map(x=>x.id===selectedPart.id?{...x,bomLines:next}:x));
  }

  async function addRoutingOp(){
    if(!selectedPart){alert("Once parca secin.");return;}
    if(!routingForm.operation.trim()){alert("Operasyon adi zorunlu.");return;}
    const op={
      id:`op_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,6)}`,
      operation:routingForm.operation.trim(),
      machine:routingForm.machine||machines[0]||"CNC-1",
      setupSec:Math.max(0,safeNum(routingForm.setupSec)),
      cycleSec:Math.max(0,safeNum(routingForm.cycleSec)),
      ncProgram:routingForm.ncProgram.trim(),
      tooling:routingForm.tooling.trim(),
    };
    const next=[...(selectedPart.routingOps||[]),op];
    const ok=await window.DB.updateDoc("parts",selectedPart.id,{routingOps:next,updatedAt:new Date().toISOString(),updatedBy:currentUser.id});
    if(!ok){alert("Rota adimi eklenemedi.");return;}
    setParts(prev=>prev.map(x=>x.id===selectedPart.id?{...x,routingOps:next}:x));
    setRoutingForm({operation:"Op-10",machine:machines[0]||"CNC-1",setupSec:"300",cycleSec:"60",ncProgram:"",tooling:""});
  }
  async function removeRoutingOp(opId){
    if(!selectedPart) return;
    const next=(selectedPart.routingOps||[]).filter(x=>x.id!==opId);
    await window.DB.updateDoc("parts",selectedPart.id,{routingOps:next,updatedAt:new Date().toISOString(),updatedBy:currentUser.id});
    setParts(prev=>prev.map(x=>x.id===selectedPart.id?{...x,routingOps:next}:x));
  }

  if(loading) return <div style={{padding:30,color:C.muted2,textAlign:"center"}}>Yukleniyor...</div>;

  return (
    <div style={{padding:16,display:"grid",gridTemplateColumns:"340px minmax(0,1fr)",gap:12,alignItems:"start"}}>
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:12,position:"sticky",top:82}}>
        <div style={{fontWeight:700,color:C.text,marginBottom:8}}>Parca Kutuphanesi</div>
        <input style={{...inputSt,padding:"8px 10px",fontSize:12,marginBottom:8}} value={search} onChange={e=>setSearch(e.target.value)} placeholder="Parca no / ad / malzeme ara..."/>
        <div style={{maxHeight:"64vh",overflowY:"auto",paddingRight:4}}>
          {filtered.map(p=>(
            <button key={p.id} onClick={()=>{setSelectedPartId(p.id);loadPartToForm(p);}} style={{width:"100%",textAlign:"left",marginBottom:7,background:selectedPartId===p.id?C.accent+"16":C.surface,border:`1px solid ${selectedPartId===p.id?C.accent+"50":C.border}`,borderRadius:10,padding:"8px 10px",color:C.text,cursor:"pointer",fontFamily:"inherit"}}>
              <div style={{fontSize:13,fontWeight:700}}>{p.partNo}</div>
              <div style={{fontSize:11,color:C.muted2,marginTop:2}}>{p.name||"-"} · Rev.{p.revision||"A"} · {safeNum(p.unitCost).toFixed(2)} TRY</div>
            </button>
          ))}
          {filtered.length===0&&<div style={{fontSize:12,color:C.muted2,padding:"6px 2px"}}>Parca bulunamadi</div>}
        </div>
      </div>

      <div style={{display:"flex",flexDirection:"column",gap:12}}>
        <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:14}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
            <div style={{fontWeight:700,color:C.text}}>Parca Tanimi</div>
            {selectedPart&&<Badge label={`Secili: ${selectedPart.partNo}`} color={C.accent}/>}
          </div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8}}>
            <div><span style={labelSt}>Parca No *</span><input style={inputSt} value={partForm.partNo} onChange={e=>fv("partNo",e.target.value)} placeholder="PRT-001"/></div>
            <div><span style={labelSt}>Parca Adi *</span><input style={inputSt} value={partForm.name} onChange={e=>fv("name",e.target.value)} placeholder="Govde"/></div>
            <div><span style={labelSt}>Revizyon</span><input style={inputSt} value={partForm.revision} onChange={e=>fv("revision",e.target.value)}/></div>
            <div>
              <span style={labelSt}>Malzeme</span>
              <select style={inputSt} value={partForm.material} onChange={e=>fv("material",e.target.value)}>
                <option value="">Secin...</option>
                {materials.map(m=><option key={m.id} value={m.name||""}>{m.code?`${m.code} - `:""}{m.name||""}</option>)}
              </select>
            </div>
            <div><span style={labelSt}>Setup (sn)</span><input style={inputSt} type="number" min="0" value={partForm.setupSec} onChange={e=>fv("setupSec",e.target.value)}/></div>
            <div><span style={labelSt}>Cycle (sn)</span><input style={inputSt} type="number" min="0" value={partForm.cycleSec} onChange={e=>fv("cycleSec",e.target.value)}/></div>
            <div><span style={labelSt}>Hammadde Miktar</span><input style={inputSt} type="number" min="0" value={partForm.qtyPerRaw} onChange={e=>fv("qtyPerRaw",e.target.value)}/></div>
            <div><span style={labelSt}>Hammadde Birim Maliyet</span><input style={inputSt} type="number" min="0" value={partForm.rawUnitCost} onChange={e=>fv("rawUnitCost",e.target.value)}/></div>
            <div><span style={labelSt}>NC Program Versiyon</span><input style={inputSt} value={partForm.ncProgramVersion} onChange={e=>fv("ncProgramVersion",e.target.value)} placeholder="V1"/></div>
            <div><span style={labelSt}>Iscilik Saatlik</span><input style={inputSt} type="number" min="0" value={partForm.laborRateHour} onChange={e=>fv("laborRateHour",e.target.value)}/></div>
            <div><span style={labelSt}>Tezgah Saatlik</span><input style={inputSt} type="number" min="0" value={partForm.machineRateHour} onChange={e=>fv("machineRateHour",e.target.value)}/></div>
            <div>
              <span style={labelSt}>Teknik Resim</span>
              <label style={{...inputSt,display:"flex",alignItems:"center",justifyContent:"space-between",cursor:"pointer"}}>
                <span style={{fontSize:12,color:C.muted2,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{partForm.drawingFile?.name||"Dosya sec..."}</span>
                <span style={{fontSize:11,color:C.accent}}>{uploading?"Yukleniyor":"Sec"}</span>
                <input type="file" accept=".pdf,.dxf,.dwg,image/*" style={{display:"none"}} onChange={pickDrawing}/>
              </label>
            </div>
          </div>
          <div style={{marginTop:8}}>
            <span style={labelSt}>Not</span>
            <textarea rows={2} style={{...inputSt,minHeight:62,resize:"vertical"}} value={partForm.notes} onChange={e=>fv("notes",e.target.value)}/>
          </div>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",gap:8,flexWrap:"wrap",marginTop:10}}>
            <div style={{fontSize:12,color:C.muted2}}>
              Birim Maliyet = Malzeme {partCostCalc.materialCost.toFixed(2)} + Iscilik {partCostCalc.laborCost.toFixed(2)} + Tezgah {partCostCalc.machineCost.toFixed(2)} = <span style={{color:C.text,fontWeight:700}}>{partCostCalc.unitCost.toFixed(2)} TRY</span>
            </div>
            <button onClick={savePart} style={{...btnSt("primary"),padding:"8px 12px",fontSize:12}}>Parca Kaydet/Guncelle</button>
          </div>
        </div>

        {selectedPart&&(
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
            <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:14}}>
              <div style={{fontWeight:700,color:C.text,marginBottom:10}}>BOM (Urun Agaci)</div>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr .7fr .7fr auto",gap:6}}>
                <select style={{...inputSt,padding:"7px 9px",fontSize:12}} value={bomForm.componentType} onChange={e=>setBomForm(f=>({...f,componentType:e.target.value}))}><option value="raw_material">Hammadde</option><option value="semi_finished">Yari Mamul</option><option value="consumable">Sarf</option></select>
                <input style={{...inputSt,padding:"7px 9px",fontSize:12}} placeholder="Kod" value={bomForm.componentCode} onChange={e=>setBomForm(f=>({...f,componentCode:e.target.value}))}/>
                <input style={{...inputSt,padding:"7px 9px",fontSize:12}} placeholder="Miktar" type="number" min="0" value={bomForm.qtyPer} onChange={e=>setBomForm(f=>({...f,qtyPer:e.target.value}))}/>
                <input style={{...inputSt,padding:"7px 9px",fontSize:12}} placeholder="Hurda%" type="number" min="0" max="100" value={bomForm.scrapPct} onChange={e=>setBomForm(f=>({...f,scrapPct:e.target.value}))}/>
                <button onClick={addBomLine} style={{...btnSt("green"),padding:"7px 9px",fontSize:12}}>Ekle</button>
              </div>
              {(selectedPart.bomLines||[]).map(line=>(
                <div key={line.id} style={{marginTop:8,padding:"8px 10px",background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,display:"flex",justifyContent:"space-between",alignItems:"center",gap:8}}>
                  <div style={{fontSize:12,color:C.muted2}}>{line.componentType} · <span style={{color:C.text,fontWeight:700}}>{line.componentCode}</span>{line.componentName?` - ${line.componentName}`:""} · Qty: {safeNum(line.qtyPer)} · Hurda %{safeNum(line.scrapPct)}</div>
                  <button onClick={()=>removeBomLine(line.id)} style={{...btnSt("danger"),padding:"5px 9px",fontSize:11}}>Sil</button>
                </div>
              ))}
              {(selectedPart.bomLines||[]).length===0&&<div style={{fontSize:12,color:C.muted2,marginTop:8}}>BOM satiri yok.</div>}
            </div>

            <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:14}}>
              <div style={{fontWeight:700,color:C.text,marginBottom:10}}>Rota ve Operasyonlar</div>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr .8fr .8fr auto",gap:6}}>
                <input style={{...inputSt,padding:"7px 9px",fontSize:12}} placeholder="Operasyon" value={routingForm.operation} onChange={e=>setRoutingForm(f=>({...f,operation:e.target.value}))}/>
                <select style={{...inputSt,padding:"7px 9px",fontSize:12}} value={routingForm.machine} onChange={e=>setRoutingForm(f=>({...f,machine:e.target.value}))}>{machines.map(m=><option key={m} value={m}>{m}</option>)}</select>
                <input style={{...inputSt,padding:"7px 9px",fontSize:12}} type="number" min="0" placeholder="Setup sn" value={routingForm.setupSec} onChange={e=>setRoutingForm(f=>({...f,setupSec:e.target.value}))}/>
                <input style={{...inputSt,padding:"7px 9px",fontSize:12}} type="number" min="0" placeholder="Cycle sn" value={routingForm.cycleSec} onChange={e=>setRoutingForm(f=>({...f,cycleSec:e.target.value}))}/>
                <button onClick={addRoutingOp} style={{...btnSt("green"),padding:"7px 9px",fontSize:12}}>Ekle</button>
              </div>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:6,marginTop:6}}>
                <input style={{...inputSt,padding:"7px 9px",fontSize:12}} placeholder="NC Program (opsiyonel)" value={routingForm.ncProgram} onChange={e=>setRoutingForm(f=>({...f,ncProgram:e.target.value}))}/>
                <input style={{...inputSt,padding:"7px 9px",fontSize:12}} placeholder="Takim Notu (opsiyonel)" value={routingForm.tooling} onChange={e=>setRoutingForm(f=>({...f,tooling:e.target.value}))}/>
              </div>
              {(selectedPart.routingOps||[]).map(op=>(
                <div key={op.id} style={{marginTop:8,padding:"8px 10px",background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,display:"flex",justifyContent:"space-between",alignItems:"center",gap:8}}>
                  <div style={{fontSize:12,color:C.muted2}}><span style={{color:C.text,fontWeight:700}}>{op.operation}</span> · {op.machine} · Setup {safeNum(op.setupSec)}sn · Cycle {safeNum(op.cycleSec)}sn {op.ncProgram?`· NC ${op.ncProgram}`:""}</div>
                  <button onClick={()=>removeRoutingOp(op.id)} style={{...btnSt("danger"),padding:"5px 9px",fontSize:11}}>Sil</button>
                </div>
              ))}
              {(selectedPart.routingOps||[]).length===0&&<div style={{fontSize:12,color:C.muted2,marginTop:8}}>Rota adimi yok.</div>}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

// ════════════════════════════════════════════════════════════
//  SALES MANAGEMENT V2
// ════════════════════════════════════════════════════════════
function SalesManagement({currentUser,machines=DEFAULT_MACHINES,onOpenWorkOrders,defaultView="orders"}) {
  const [customers,setCustomers]=useState([]);
  const [customerPrices,setCustomerPrices]=useState([]);
  const [quotes,setQuotes]=useState([]);
  const [salesOrders,setSalesOrders]=useState([]);
  const [workOrders,setWorkOrders]=useState([]);
  const [loading,setLoading]=useState(true);
  const [view,setView]=useState(defaultView==="quotes"?"quotes":"orders");
  const [search,setSearch]=useState("");
  const [customerForm,setCustomerForm]=useState({name:"",code:"",contact:"",phone:"",email:"",discountPct:"0"});
  const [priceForm,setPriceForm]=useState({customerId:"",partNo:"",price:"",discountPct:"0",currency:"TRY"});
  const [quoteForm,setQuoteForm]=useState({
    code:"",
    customerId:"",
    validUntil:todayStr(),
    priority:"normal",
    note:"",
    lines:[{partNo:"",partName:"",revision:"A",qty:"1",unitPrice:"0",discountPct:"0",dueDate:todayStr(),partSec:"60",machine:(machines[0]||"CNC-1")}],
  });

  const nextCode=useCallback((prefix,list,regex)=>{
    const nums=list.map(x=>{
      const m=String(x.code||"").toUpperCase().match(regex);
      return m?Number(m[1]):null;
    }).filter(n=>n!==null);
    const next=(nums.length?Math.max(...nums):0)+1;
    return `${prefix}-${String(next).padStart(4,"0")}`;
  },[]);

  const load=useCallback(async()=>{
    const [c,prices,q,s,wo]=await Promise.all([
      window.DB.getAll("customers"),
      window.DB.getAll("customerPrices"),
      window.DB.getAll("salesQuotes"),
      window.DB.getAll("salesOrders"),
      window.DB.getAll("orders"),
    ]);
    setCustomers(c.sort((a,b)=>(a.name||"").localeCompare(b.name||"","tr")));
    setCustomerPrices(prices.sort((a,b)=>(b.updatedAt||"").localeCompare(a.updatedAt||"")));
    setQuotes(q.sort((a,b)=>(b.createdAt||"").localeCompare(a.createdAt||"")));
    setSalesOrders(s.sort((a,b)=>(b.createdAt||"").localeCompare(a.createdAt||"")));
    setWorkOrders(wo.sort((a,b)=>(b.createdAt||"").localeCompare(a.createdAt||"")));
    setQuoteForm(f=>({...f,code:nextCode("TKL",q,/^TKL-(\d+)$/)}));
    setLoading(false);
  },[nextCode]);
  useEffect(()=>{load();},[load]);
  useEffect(()=>{setView(defaultView==="quotes"?"quotes":"orders");},[defaultView]);

  const selectedCustomer=customers.find(c=>c.id===quoteForm.customerId)||null;
  const customerStats=customers.map(c=>{
    const rows=salesOrders.filter(s=>s.customerId===c.id);
    const totalAmount=rows.reduce((sum,row)=>sum+safeNum(row.totalAmount),0);
    const open=rows.filter(r=>!["delivered","cancelled"].includes(r.status||"")).length;
    return {id:c.id,name:c.name,totalOrders:rows.length,totalAmount,open};
  }).filter(x=>x.totalOrders>0).sort((a,b)=>b.totalAmount-a.totalAmount);

  const lineTotal=line=>{
    const qty=Math.max(0,safeNum(line.qty));
    const price=Math.max(0,safeNum(line.unitPrice));
    const disc=Math.max(0,Math.min(100,safeNum(line.discountPct)));
    const gross=qty*price;
    const discAmt=(gross*disc)/100;
    return {gross,discAmt,net:gross-discAmt};
  };
  const quoteTotals=quoteForm.lines.reduce((acc,line)=>{
    const t=lineTotal(line);
    acc.gross+=t.gross; acc.discount+=t.discAmt; acc.net+=t.net;
    return acc;
  },{gross:0,discount:0,net:0});

  const setQ=(k,v)=>setQuoteForm(f=>({...f,[k]:v}));
  const setLine=(idx,k,v)=>setQuoteForm(f=>({...f,lines:f.lines.map((line,i)=>i===idx?{...line,[k]:v}:line)}));
  const addLine=()=>setQuoteForm(f=>({...f,lines:[...f.lines,{partNo:"",partName:"",revision:"A",qty:"1",unitPrice:"0",discountPct:"0",dueDate:todayStr(),partSec:"60",machine:(machines[0]||"CNC-1")}]}));
  const removeLine=idx=>setQuoteForm(f=>({...f,lines:f.lines.filter((_,i)=>i!==idx)}));

  function applyCustomerPrice(idx,partNo){
    const priceRow=customerPrices.find(p=>p.customerId===quoteForm.customerId&&String(p.partNo||"").trim().toLowerCase()===String(partNo||"").trim().toLowerCase());
    if(!priceRow) return;
    setLine(idx,"unitPrice",String(priceRow.price||0));
    setLine(idx,"discountPct",String(priceRow.discountPct||0));
  }

  async function saveCustomer(){
    if(!customerForm.name.trim()){alert("Musteri adi zorunlu.");return;}
    const payload={
      name:customerForm.name.trim(),
      code:(customerForm.code||`CUS-${Date.now().toString(36).toUpperCase()}`).toUpperCase(),
      contact:customerForm.contact.trim(),
      phone:customerForm.phone.trim(),
      email:customerForm.email.trim(),
      discountPct:Math.max(0,Math.min(100,safeNum(customerForm.discountPct))),
      updatedAt:new Date().toISOString(),
    };
    const id=await window.DB.addDoc("customers",payload);
    if(!id){alert("Musteri kaydedilemedi.");return;}
    await addAuditLog(currentUser.id,"customer",id,"create",null,payload,{module:"sales"});
    setCustomers(prev=>[{id,...payload,createdAt:new Date().toISOString()},...prev].sort((a,b)=>(a.name||"").localeCompare(b.name||"","tr")));
    setCustomerForm({name:"",code:"",contact:"",phone:"",email:"",discountPct:"0"});
  }

  async function savePrice(){
    if(!priceForm.customerId||!priceForm.partNo.trim()){alert("Musteri ve parca no zorunlu.");return;}
    const payload={
      customerId:priceForm.customerId,
      partNo:priceForm.partNo.trim().toUpperCase(),
      price:Math.max(0,safeNum(priceForm.price)),
      discountPct:Math.max(0,Math.min(100,safeNum(priceForm.discountPct))),
      currency:priceForm.currency||"TRY",
      updatedAt:new Date().toISOString(),
      updatedBy:currentUser.id,
    };
    const id=await window.DB.addDoc("customerPrices",payload);
    if(!id){alert("Fiyat kaydi olusturulamadi.");return;}
    setCustomerPrices(prev=>[{id,...payload,createdAt:new Date().toISOString()},...prev]);
    setPriceForm({customerId:"",partNo:"",price:"",discountPct:"0",currency:"TRY"});
  }

  async function saveQuote(){
    if(!quoteForm.customerId){alert("Musteri secin.");return;}
    if(!quoteForm.lines.length){alert("En az bir satir ekleyin.");return;}
    if(quoteForm.lines.some(l=>!l.partNo||safeNum(l.qty)<=0)){alert("Satirlarda parca no ve miktar zorunlu.");return;}
    const customer=customers.find(c=>c.id===quoteForm.customerId);
    const payload={
      code:(quoteForm.code||nextCode("TKL",quotes,/^TKL-(\d+)$/)).toUpperCase(),
      customerId:customer?.id||"",
      customerName:customer?.name||"",
      validUntil:quoteForm.validUntil||todayStr(),
      priority:quoteForm.priority||"normal",
      note:quoteForm.note.trim(),
      lines:quoteForm.lines.map(l=>({
        partNo:String(l.partNo||"").trim().toUpperCase(),
        partName:String(l.partName||"").trim(),
        revision:String(l.revision||"A").trim().toUpperCase(),
        qty:Math.max(0,safeNum(l.qty)),
        unitPrice:Math.max(0,safeNum(l.unitPrice)),
        discountPct:Math.max(0,Math.min(100,safeNum(l.discountPct))),
        dueDate:l.dueDate||todayStr(),
        partSec:Math.max(1,safeNum(l.partSec)||60),
        machine:l.machine||machines[0]||"CNC-1",
      })),
      grossAmount:quoteTotals.gross,
      discountAmount:quoteTotals.discount,
      totalAmount:quoteTotals.net,
      status:"offer",
      updatedAt:new Date().toISOString(),
      createdBy:currentUser.id,
    };
    const id=await window.DB.addDoc("salesQuotes",payload);
    if(!id){alert("Teklif kaydedilemedi.");return;}
    await addAuditLog(currentUser.id,"salesQuote",id,"create",null,payload,{module:"sales"});
    setQuotes(prev=>[{id,...payload,createdAt:new Date().toISOString()},...prev]);
    setQuoteForm({
      code:nextCode("TKL",[...quotes,{id,...payload}],/^TKL-(\d+)$/),
      customerId:"",
      validUntil:todayStr(),
      priority:"normal",
      note:"",
      lines:[{partNo:"",partName:"",revision:"A",qty:"1",unitPrice:"0",discountPct:"0",dueDate:todayStr(),partSec:"60",machine:(machines[0]||"CNC-1")}],
    });
    setView("quotes");
  }

  async function setQuoteStatus(q,status){
    if(q.status===status) return;
    const patch={status,updatedAt:new Date().toISOString(),updatedBy:currentUser.id};
    const ok=await window.DB.updateDoc("salesQuotes",q.id,patch);
    if(!ok){alert("Teklif durumu guncellenemedi.");return;}
    setQuotes(prev=>prev.map(x=>x.id===q.id?{...x,...patch}:x));
  }

  async function convertQuoteToOrder(q){
    if(!q.lines||q.lines.length===0){alert("Teklif satiri yok.");return;}
    const existing=salesOrders.find(s=>s.sourceQuoteId===q.id);
    if(existing){alert(`Bu teklif zaten siparise donustu: ${existing.code}`);return;}
    const orderCode=nextCode("SIP",salesOrders,/^SIP-(\d+)$/);
    const qtyTotal=q.lines.reduce((sum,l)=>sum+safeNum(l.qty),0);
    const dueDate=[...q.lines].sort((a,b)=>String(a.dueDate||"").localeCompare(String(b.dueDate||"")))[0]?.dueDate||todayStr();
    const payload={
      code:orderCode,
      customerId:q.customerId||"",
      customerName:q.customerName||"",
      sourceQuoteId:q.id,
      sourceQuoteCode:q.code||"",
      lines:q.lines||[],
      qty:qtyTotal,
      dueDate,
      priority:q.priority||"normal",
      totalAmount:safeNum(q.totalAmount),
      deliveredQty:0,
      deliveries:[],
      status:"approved",
      createdBy:currentUser.id,
      updatedAt:new Date().toISOString(),
    };
    const id=await window.DB.addDoc("salesOrders",payload);
    if(!id){alert("Siparis olusturulamadi.");return;}
    await window.DB.updateDoc("salesQuotes",q.id,{status:"converted",orderId:id,orderCode:orderCode,updatedAt:new Date().toISOString()});
    await addAuditLog(currentUser.id,"salesOrder",id,"create_from_quote",{quoteId:q.id},{...payload,id},{module:"sales"});
    setSalesOrders(prev=>[{id,...payload,createdAt:new Date().toISOString()},...prev]);
    setQuotes(prev=>prev.map(x=>x.id===q.id?{...x,status:"converted",orderId:id,orderCode}:x));
    setView("orders");
  }

  function openPrintableDoc(title,rows,footer=""){
    const html=`<!doctype html><html><head><meta charset="utf-8"/><title>${title}</title>
      <style>body{font-family:Arial,sans-serif;padding:24px;color:#111}h1{font-size:20px}table{border-collapse:collapse;width:100%;margin-top:16px}
      th,td{border:1px solid #ccc;padding:8px;text-align:left;font-size:12px}th{background:#f5f5f5}.ft{margin-top:16px;font-size:12px;color:#444}</style></head>
      <body><h1>${title}</h1><table><thead><tr><th>Parca No</th><th>Aciklama</th><th>Miktar</th><th>Birim Fiyat</th><th>Iskonto%</th><th>Tutar</th><th>Termin</th></tr></thead><tbody>
      ${rows.map(r=>`<tr><td>${r.partNo||""}</td><td>${r.partName||""}</td><td>${safeNum(r.qty)}</td><td>${safeNum(r.unitPrice).toFixed(2)}</td><td>${safeNum(r.discountPct).toFixed(2)}</td><td>${(safeNum(r.qty)*safeNum(r.unitPrice)*(1-safeNum(r.discountPct)/100)).toFixed(2)}</td><td>${r.dueDate||""}</td></tr>`).join("")}
      </tbody></table><div class="ft">${footer}</div></body></html>`;
    const w=window.open("","_blank","width=980,height=720");
    if(!w) return;
    w.document.write(html);
    w.document.close();
    w.focus();
    setTimeout(()=>w.print(),250);
  }

  function printQuote(q){
    openPrintableDoc(`Proforma Teklif - ${q.code||""}`,q.lines||[],`Musteri: ${q.customerName||"-"} · Gecerlilik: ${q.validUntil||"-"} · Toplam: ${safeNum(q.totalAmount).toFixed(2)} TRY`);
  }
  function printOrder(o){
    openPrintableDoc(`Siparis Onay Formu - ${o.code||""}`,o.lines||[],`Musteri: ${o.customerName||"-"} · Termin: ${o.dueDate||"-"} · Toplam: ${safeNum(o.totalAmount).toFixed(2)} TRY`);
  }

  async function addDelivery(order){
    const qtyInput=prompt("Teslim edilecek miktar:");
    if(qtyInput===null) return;
    const qty=Math.max(0,safeNum(qtyInput));
    if(!qty){alert("Gecerli miktar girin.");return;}
    const note=prompt("Teslim notu (opsiyonel):")||"";
    const deliveries=[...(order.deliveries||[]),{date:todayStr(),qty,note,createdBy:currentUser.id}];
    const deliveredQty=safeNum(order.deliveredQty)+qty;
    const totalQty=safeNum(order.qty);
    const status=deliveredQty>=totalQty&&totalQty>0?"delivered":"in_production";
    const patch={deliveries,deliveredQty,status,updatedAt:new Date().toISOString(),updatedBy:currentUser.id};
    const ok=await window.DB.updateDoc("salesOrders",order.id,patch);
    if(!ok){alert("Teslim kaydi eklenemedi.");return;}
    await addAuditLog(currentUser.id,"salesOrder",order.id,"delivery_add",order,{...order,...patch},{module:"sales"});
    setSalesOrders(prev=>prev.map(x=>x.id===order.id?{...x,...patch}:x));
  }

  async function convertOrderToWorkOrders(order){
    if(order.workOrderIds&&order.workOrderIds.length>0){alert("Bu siparis icin is emri olusturulmus.");return;}
    if(!order.lines||order.lines.length===0){alert("Siparis satiri bulunamadi.");return;}
    const createdIds=[];
    const createdCodes=[];
    let seed=[...workOrders];
    for(const line of order.lines){
      const code=nextCode("IE",seed,/^IE-(\d+)$/);
      const woPayload={
        code,
        name:line.partName||line.partNo||order.code,
        customerId:order.customerId||"",
        customerName:order.customerName||"",
        material:line.material||"",
        partNo:line.partNo||"",
        revision:line.revision||"",
        qty:Math.max(0,safeNum(line.qty)),
        dueDate:line.dueDate||order.dueDate||"",
        priority:order.priority||"normal",
        partSec:Math.max(1,safeNum(line.partSec)||60),
        machines:[line.machine||machines[0]||"CNC-1"],
        notes:`Siparis ${order.code} otomatik olusturma`,
        files:[],
        status:"planned",
        sourceType:"sales_auto",
        sourceSalesOrderId:order.id,
        sourceSalesOrderCode:order.code||"",
        dependencies:[],
        createdBy:currentUser.id,
        updatedAt:new Date().toISOString(),
      };
      const id=await window.DB.addDoc("orders",woPayload);
      if(!id) continue;
      seed=[{id,...woPayload,createdAt:new Date().toISOString()},...seed];
      createdIds.push(id);
      createdCodes.push(code);
      await addAuditLog(currentUser.id,"workOrder",id,"create_from_sales_order",null,woPayload,{orderId:order.id,module:"sales"});
    }
    if(createdIds.length===0){alert("Is emri olusturulamadi.");return;}
    const patch={workOrderIds:createdIds,workOrderCodes:createdCodes,status:"in_production",updatedAt:new Date().toISOString(),updatedBy:currentUser.id};
    await window.DB.updateDoc("salesOrders",order.id,patch);
    setSalesOrders(prev=>prev.map(x=>x.id===order.id?{...x,...patch}:x));
    setWorkOrders(seed);
    if(onOpenWorkOrders) onOpenWorkOrders();
  }

  const q=search.trim().toLowerCase();
  const filteredQuotes=quotes.filter(x=>!q||(x.code||"").toLowerCase().includes(q)||(x.customerName||"").toLowerCase().includes(q)||(x.status||"").toLowerCase().includes(q));
  const filteredOrders=salesOrders.filter(x=>!q||(x.code||"").toLowerCase().includes(q)||(x.customerName||"").toLowerCase().includes(q)||(x.status||"").toLowerCase().includes(q));
  const statusLabel=s=>getSalesStatusMeta(s).label;
  const statusColor=s=>getSalesStatusMeta(s).color;

  if(loading) return <div style={{padding:30,color:C.muted2,textAlign:"center"}}>Yukleniyor...</div>;

  return (
    <div style={{padding:16,display:"flex",flexDirection:"column",gap:12}}>
      <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
        <button onClick={()=>setView("orders")} style={chip(view==="orders",C.accent)}>Siparisler</button>
        <button onClick={()=>setView("quotes")} style={chip(view==="quotes",C.warn)}>Teklifler</button>
        <button onClick={()=>setView("pricing")} style={chip(view==="pricing",C.green)}>Musteri/Fiyat</button>
      </div>

      {view==="pricing"&&(
        <>
          <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:14}}>
            <div style={{fontWeight:700,color:C.text,marginBottom:10}}>Musteri Karti</div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
              <div><span style={labelSt}>Musteri Adi *</span><input style={inputSt} value={customerForm.name} onChange={e=>setCustomerForm(f=>({...f,name:e.target.value}))}/></div>
              <div><span style={labelSt}>Kod</span><input style={inputSt} value={customerForm.code} onChange={e=>setCustomerForm(f=>({...f,code:e.target.value}))}/></div>
              <div><span style={labelSt}>Yetkili</span><input style={inputSt} value={customerForm.contact} onChange={e=>setCustomerForm(f=>({...f,contact:e.target.value}))}/></div>
              <div><span style={labelSt}>Telefon</span><input style={inputSt} value={customerForm.phone} onChange={e=>setCustomerForm(f=>({...f,phone:e.target.value}))}/></div>
              <div><span style={labelSt}>E-Posta</span><input style={inputSt} value={customerForm.email} onChange={e=>setCustomerForm(f=>({...f,email:e.target.value}))}/></div>
              <div><span style={labelSt}>Varsayilan Iskonto %</span><input style={inputSt} type="number" min="0" max="100" value={customerForm.discountPct} onChange={e=>setCustomerForm(f=>({...f,discountPct:e.target.value}))}/></div>
            </div>
            <div style={{marginTop:10,display:"flex",justifyContent:"flex-end"}}><button onClick={saveCustomer} style={{...btnSt("primary"),padding:"8px 12px",fontSize:12}}>Musteri Kaydet</button></div>
          </div>
          <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:14}}>
            <div style={{fontWeight:700,color:C.text,marginBottom:10}}>Musteri Bazli Fiyat Listesi</div>
            <div style={{display:"grid",gridTemplateColumns:"1.2fr 1fr 1fr 1fr 0.8fr",gap:8}}>
              <div><span style={labelSt}>Musteri</span><select style={inputSt} value={priceForm.customerId} onChange={e=>setPriceForm(f=>({...f,customerId:e.target.value}))}><option value="">Secin</option>{customers.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
              <div><span style={labelSt}>Parca No</span><input style={inputSt} value={priceForm.partNo} onChange={e=>setPriceForm(f=>({...f,partNo:e.target.value}))}/></div>
              <div><span style={labelSt}>Birim Fiyat</span><input style={inputSt} type="number" min="0" value={priceForm.price} onChange={e=>setPriceForm(f=>({...f,price:e.target.value}))}/></div>
              <div><span style={labelSt}>Iskonto %</span><input style={inputSt} type="number" min="0" max="100" value={priceForm.discountPct} onChange={e=>setPriceForm(f=>({...f,discountPct:e.target.value}))}/></div>
              <div><span style={labelSt}>Para</span><select style={inputSt} value={priceForm.currency} onChange={e=>setPriceForm(f=>({...f,currency:e.target.value}))}><option value="TRY">TRY</option><option value="EUR">EUR</option><option value="USD">USD</option></select></div>
            </div>
            <div style={{marginTop:10,display:"flex",justifyContent:"space-between",alignItems:"center",gap:8,flexWrap:"wrap"}}>
              <div style={{fontSize:12,color:C.muted2}}>Kayitli fiyat satiri: {customerPrices.length}</div>
              <button onClick={savePrice} style={{...btnSt("green"),padding:"8px 12px",fontSize:12}}>Fiyat Kaydet</button>
            </div>
            {customerPrices.slice(0,30).map(p=>{
              const cust=customers.find(c=>c.id===p.customerId);
              return <div key={p.id} style={{marginTop:8,padding:"8px 10px",background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,fontSize:12,color:C.muted2}}>{cust?.name||"-"} · {p.partNo} · {safeNum(p.price).toFixed(2)} {p.currency||"TRY"} · Iskonto %{safeNum(p.discountPct)}</div>;
            })}
          </div>
          {customerStats.length>0&&(
            <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:14}}>
              <div style={{fontWeight:700,color:C.text,marginBottom:10}}>Musteri Siparis Istatistikleri</div>
              <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(220px,1fr))",gap:8}}>
                {customerStats.map(s=>(
                  <div key={s.id} style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,padding:"10px 12px"}}>
                    <div style={{fontWeight:700,color:C.text,fontSize:13}}>{s.name}</div>
                    <div style={{fontSize:11,color:C.muted2,marginTop:2}}>Siparis: {s.totalOrders} · Acik: {s.open}</div>
                    <div style={{fontSize:13,color:C.accent,marginTop:4,fontWeight:700}}>{safeNum(s.totalAmount).toFixed(2)} TRY</div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </>
      )}

      {view==="quotes"&&(
        <>
          <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:14}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
              <div style={{fontWeight:700,color:C.text}}>Teklif Olustur</div>
              <Badge label={quoteForm.code||"-"} color={C.warn}/>
            </div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8}}>
              <div><span style={labelSt}>Musteri</span><select style={inputSt} value={quoteForm.customerId} onChange={e=>setQ("customerId",e.target.value)}><option value="">Secin</option>{customers.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
              <div><span style={labelSt}>Gecerlilik</span><input style={inputSt} type="date" value={quoteForm.validUntil} onChange={e=>setQ("validUntil",e.target.value||todayStr())}/></div>
              <div><span style={labelSt}>Oncelik</span><select style={inputSt} value={quoteForm.priority} onChange={e=>setQ("priority",e.target.value)}><option value="acil">Acil</option><option value="normal">Normal</option><option value="dusuk">Dusuk</option></select></div>
            </div>
            <div style={{marginTop:10}}>
              <span style={labelSt}>Teklif Satirlari</span>
              {quoteForm.lines.map((line,idx)=>(
                <div key={idx} style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,padding:10,marginBottom:8}}>
                  <div style={{display:"grid",gridTemplateColumns:"1fr 1fr .7fr .7fr .7fr .9fr .7fr .8fr auto",gap:6}}>
                    <input style={{...inputSt,padding:"7px 9px",fontSize:12}} placeholder="Parca No" value={line.partNo} onChange={e=>{setLine(idx,"partNo",e.target.value);applyCustomerPrice(idx,e.target.value);}}/>
                    <input style={{...inputSt,padding:"7px 9px",fontSize:12}} placeholder="Parca Adi" value={line.partName} onChange={e=>setLine(idx,"partName",e.target.value)}/>
                    <input style={{...inputSt,padding:"7px 9px",fontSize:12}} placeholder="Rev" value={line.revision} onChange={e=>setLine(idx,"revision",e.target.value)}/>
                    <input style={{...inputSt,padding:"7px 9px",fontSize:12}} type="number" min="1" placeholder="Adet" value={line.qty} onChange={e=>setLine(idx,"qty",e.target.value)}/>
                    <input style={{...inputSt,padding:"7px 9px",fontSize:12}} type="number" min="0" placeholder="Fiyat" value={line.unitPrice} onChange={e=>setLine(idx,"unitPrice",e.target.value)}/>
                    <input style={{...inputSt,padding:"7px 9px",fontSize:12}} type="number" min="0" max="100" placeholder="Iskonto%" value={line.discountPct} onChange={e=>setLine(idx,"discountPct",e.target.value)}/>
                    <input style={{...inputSt,padding:"7px 9px",fontSize:12}} type="date" value={line.dueDate} onChange={e=>setLine(idx,"dueDate",e.target.value||todayStr())}/>
                    <input style={{...inputSt,padding:"7px 9px",fontSize:12}} type="number" min="1" placeholder="Parca sn" value={line.partSec} onChange={e=>setLine(idx,"partSec",e.target.value)}/>
                    <button onClick={()=>removeLine(idx)} style={{...btnSt("danger"),padding:"7px 9px",fontSize:12}}>Sil</button>
                  </div>
                  <div style={{fontSize:11,color:C.muted2,marginTop:6}}>
                    Satir Net: {lineTotal(line).net.toFixed(2)} TRY
                  </div>
                </div>
              ))}
              <button onClick={addLine} style={{...btnSt("ghost"),padding:"7px 10px",fontSize:12}}>+ Satir Ekle</button>
            </div>
            <div style={{marginTop:10}}><span style={labelSt}>Not</span><textarea style={{...inputSt,minHeight:64,resize:"vertical"}} value={quoteForm.note} onChange={e=>setQ("note",e.target.value)}/></div>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",gap:8,flexWrap:"wrap",marginTop:10}}>
              <div style={{fontSize:12,color:C.muted2}}>Brut: {quoteTotals.gross.toFixed(2)} · Iskonto: {quoteTotals.discount.toFixed(2)} · Net: <span style={{color:C.text,fontWeight:700}}>{quoteTotals.net.toFixed(2)} TRY</span></div>
              <button onClick={saveQuote} style={{...btnSt("primary"),padding:"8px 12px",fontSize:12}}>Teklif Kaydet</button>
            </div>
          </div>

          <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"10px 12px",display:"flex",justifyContent:"space-between",alignItems:"center",gap:8,flexWrap:"wrap"}}>
            <div style={{fontSize:12,color:C.muted2}}>Teklifler ({quotes.length})</div>
            <input style={{...inputSt,padding:"7px 10px",fontSize:12,minWidth:220}} value={search} onChange={e=>setSearch(e.target.value)} placeholder="Kod / musteri / durum ara..."/>
          </div>
          {filteredQuotes.map(qr=>(
            <div key={qr.id} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:"12px 14px"}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",gap:10}}>
                <div>
                  <div style={{display:"flex",gap:7,alignItems:"center",flexWrap:"wrap"}}>
                    <span style={{fontWeight:800,fontFamily:"monospace",fontSize:14,color:C.text}}>{qr.code}</span>
                    <Badge label={statusLabel(qr.status)} color={statusColor(qr.status)}/>
                  </div>
                  <div style={{fontSize:13,color:C.text,marginTop:3}}>{qr.customerName||"-"}</div>
                  <div style={{fontSize:11,color:C.muted2,marginTop:2}}>Satir: {(qr.lines||[]).length} · Gecerlilik: {qr.validUntil||"-"} · Net: {safeNum(qr.totalAmount).toFixed(2)} TRY</div>
                </div>
                <div style={{display:"flex",gap:7,flexWrap:"wrap",justifyContent:"flex-end"}}>
                  <button onClick={()=>printQuote(qr)} style={{...btnSt("ghost"),padding:"6px 10px",fontSize:12}}>PDF/Yazdir</button>
                  <button onClick={()=>setQuoteStatus(qr,"approved")} style={{...btnSt("green"),padding:"6px 10px",fontSize:12}}>Onayla</button>
                  <button onClick={()=>convertQuoteToOrder(qr)} style={{...btnSt("primary"),padding:"6px 10px",fontSize:12}}>Siparise Donustur</button>
                  <button onClick={()=>setQuoteStatus(qr,"cancelled")} style={{...btnSt("danger"),padding:"6px 10px",fontSize:12}}>Iptal</button>
                </div>
              </div>
            </div>
          ))}
          {filteredQuotes.length===0&&<div style={{textAlign:"center",color:C.muted2,padding:"24px 20px",background:C.card,borderRadius:14,border:`1px solid ${C.border}`}}>Teklif bulunamadi</div>}
        </>
      )}

      {view==="orders"&&(
        <>
          <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"10px 12px",display:"flex",justifyContent:"space-between",alignItems:"center",gap:8,flexWrap:"wrap"}}>
            <div style={{fontSize:12,color:C.muted2}}>Siparisler ({salesOrders.length})</div>
            <input style={{...inputSt,padding:"7px 10px",fontSize:12,minWidth:220}} value={search} onChange={e=>setSearch(e.target.value)} placeholder="Kod / musteri / durum ara..."/>
          </div>
          {filteredOrders.map(o=>{
            const remaining=Math.max(0,safeNum(o.qty)-safeNum(o.deliveredQty));
            const progress=safeNum(o.qty)>0?Math.round((safeNum(o.deliveredQty)/safeNum(o.qty))*100):0;
            return (
              <div key={o.id} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:"12px 14px"}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",gap:10}}>
                  <div>
                    <div style={{display:"flex",gap:7,alignItems:"center",flexWrap:"wrap"}}>
                      <span style={{fontWeight:800,fontFamily:"monospace",fontSize:14,color:C.text}}>{o.code||"-"}</span>
                      <Badge label={statusLabel(o.status)} color={statusColor(o.status)}/>
                      {o.sourceQuoteCode&&<Badge label={`Teklif ${o.sourceQuoteCode}`} color={C.warn}/>}
                    </div>
                    <div style={{fontSize:13,color:C.text,marginTop:3}}>{o.customerName||"-"}</div>
                    <div style={{fontSize:11,color:C.muted2,marginTop:2}}>Termin: {o.dueDate||"-"} · Toplam Adet: {safeNum(o.qty)} · Teslim: {safeNum(o.deliveredQty)} · Kalan: {remaining}</div>
                    <div style={{marginTop:6,background:C.border,borderRadius:99,height:6,overflow:"hidden",maxWidth:260}}>
                      <div style={{width:`${Math.min(100,progress)}%`,height:"100%",background:progress>=100?C.green:C.accent,borderRadius:99}}/>
                    </div>
                  </div>
                  <div style={{display:"flex",gap:7,flexWrap:"wrap",justifyContent:"flex-end"}}>
                    <button onClick={()=>printOrder(o)} style={{...btnSt("ghost"),padding:"6px 10px",fontSize:12}}>Onay/PDF</button>
                    <button onClick={()=>addDelivery(o)} style={{...btnSt("green"),padding:"6px 10px",fontSize:12}}>Kismi Teslim</button>
                    <button onClick={()=>convertOrderToWorkOrders(o)} style={{...btnSt("primary"),padding:"6px 10px",fontSize:12}}>Is Emri Olustur</button>
                  </div>
                </div>
                {(o.deliveries||[]).length>0&&(
                  <div style={{marginTop:8,fontSize:11,color:C.muted2}}>
                    Son teslimler: {(o.deliveries||[]).slice(-3).map(d=>`${d.date}: ${safeNum(d.qty)}`).join(" · ")}
                  </div>
                )}
              </div>
            );
          })}
          {filteredOrders.length===0&&<div style={{textAlign:"center",color:C.muted2,padding:"24px 20px",background:C.card,borderRadius:14,border:`1px solid ${C.border}`}}>Siparis bulunamadi</div>}
        </>
      )}
    </div>
  );
}

// ════════════════════════════════════════════════════════════
// ============================================
//  SALES ORDERS
// ============================================
function SalesOrders({currentUser,machines=DEFAULT_MACHINES,onOpenWorkOrders}) {
  const [salesOrders,setSalesOrders]=useState([]);
  const [workOrders,setWorkOrders]=useState([]);
  const [customers,setCustomers]=useState([]);
  const [materials,setMaterials]=useState([]);
  const [loading,setLoading]=useState(true);
  const [editId,setEditId]=useState(null);
  const [search,setSearch]=useState("");
  const emptyForm={code:"",name:"",customerId:"",material:"",qty:"",dueDate:todayStr(),partSec:"",machines:[],note:"",status:"new"};
  const [form,setForm]=useState(emptyForm);

  const nextSalesCode=useCallback((list=salesOrders)=>{
    const nums=list.map(o=>{
      const m=(o.code||"").toUpperCase().match(/^SP-(\d+)$/);
      return m?Number(m[1]):null;
    }).filter(n=>n!==null);
    const next=(nums.length?Math.max(...nums):0)+1;
    return `SP-${String(next).padStart(3,"0")}`;
  },[salesOrders]);
  const nextWorkOrderCode=useCallback((list=workOrders)=>{
    const nums=list.map(o=>{
      const m=(o.code||"").toUpperCase().match(/^IE-(\d+)$/);
      return m?Number(m[1]):null;
    }).filter(n=>n!==null);
    const next=(nums.length?Math.max(...nums):0)+1;
    return `IE-${String(next).padStart(3,"0")}`;
  },[workOrders]);

  const load=useCallback(async()=>{
    const [s,o,c,m]=await Promise.all([window.DB.getAll("salesOrders"),window.DB.getAll("orders"),window.DB.getAll("customers"),window.DB.getAll("materials")]);
    setSalesOrders(s.sort((a,b)=>(b.createdAt||"").localeCompare(a.createdAt||"")));
    setWorkOrders(o.sort((a,b)=>(b.createdAt||"").localeCompare(a.createdAt||"")));
    setCustomers(c.sort((a,b)=>(a.name||"").localeCompare(b.name||"")));
    setMaterials(m.sort((a,b)=>(a.name||"").localeCompare(b.name||"","tr")));
    setLoading(false);
  },[]);
  useEffect(()=>{load();},[load]);

  const fv=(k,v)=>setForm(p=>({...p,[k]:v}));
  const toggleMachine=m=>fv("machines",form.machines.includes(m)?form.machines.filter(x=>x!==m):[...form.machines,m]);

  async function saveSalesOrder() {
    if(!form.name.trim()){alert("Siparis adi zorunlu.");return;}
    const pickedCustomer=customers.find(c=>c.id===form.customerId);
    const finalCode=editId?form.code:(form.code||nextSalesCode());
    const data={
      code:finalCode.toUpperCase(),
      name:form.name.trim(),
      customerId:pickedCustomer?.id||"",
      customerName:pickedCustomer?.name||"",
      material:form.material.trim(),
      qty:Math.max(0,Number(form.qty)||0),
      dueDate:form.dueDate||"",
      partSec:Math.max(0,Number(form.partSec)||0),
      machines:form.machines||[],
      note:form.note.trim(),
      status:form.status||"new",
      updatedAt:new Date().toISOString(),
      ...(editId?{}:{createdBy:currentUser.id}),
    };
    if(editId){
      const ok=await window.DB.updateDoc("salesOrders",editId,data);
      if(!ok){alert("Siparis guncellenemedi.");return;}
      setSalesOrders(prev=>prev.map(x=>x.id===editId?{...x,...data}:x));
    }else{
      const id=await window.DB.addDoc("salesOrders",data);
      if(!id){alert("Siparis kaydedilemedi.");return;}
      setSalesOrders(prev=>[{id,...data,createdAt:new Date().toISOString()},...prev]);
    }
    setEditId(null);
    setForm({...emptyForm,code:nextSalesCode()});
  }

  async function convertToWorkOrder(s) {
    if((s.status||"")==="converted"&&s.workOrderId){alert("Bu siparis zaten is emrine donusturulmus.");return;}
    if(!s.partSec||Number(s.partSec)<=0){alert("Donusum icin sipariste parca suresi girin.");return;}
    if(!s.machines||s.machines.length===0){alert("Donusum icin sipariste en az bir tezgah secin.");return;}
    const workCode=nextWorkOrderCode();
    const workData={
      code:workCode,
      name:s.name||"",
      customerId:s.customerId||"",
      customerName:s.customerName||"",
      material:s.material||"",
      partSec:Number(s.partSec)||0,
      machines:s.machines||[],
      notes:[s.note?`Siparis Notu: ${s.note}`:"",s.qty?`Siparis Adedi: ${s.qty}`:"",s.dueDate?`Termin: ${s.dueDate}`:""].filter(Boolean).join(" | "),
      files:[],
      status:"planned",
      sourceType:"sales_auto",
      sourceSalesOrderId:s.id||"",
      sourceSalesOrderCode:s.code||"",
      dueDate:s.dueDate||"",
      qty:Number(s.qty)||0,
      priority:"normal",
      createdBy:currentUser.id,
      updatedAt:new Date().toISOString(),
    };
    const workId=await window.DB.addDoc("orders",workData);
    if(!workId){alert("Is emri olusturulamadi.");return;}
    const salesPatch={status:"converted",workOrderId:workId,workOrderCode:workCode,convertedAt:new Date().toISOString(),updatedAt:new Date().toISOString()};
    const salesOk=await window.DB.updateDoc("salesOrders",s.id,salesPatch);
    if(!salesOk){alert("Siparis isaretlenemedi; is emri olustu fakat siparis durumu guncellenemedi.");}
    setWorkOrders(prev=>[{id:workId,...workData,createdAt:new Date().toISOString()},...prev]);
    setSalesOrders(prev=>prev.map(x=>x.id===s.id?{...x,...salesPatch}:x));
    if(onOpenWorkOrders) onOpenWorkOrders();
  }

  async function removeSalesOrder(s){
    if(!confirm(`"${s.code||s.name||"Siparis"}" silinsin mi?`)) return;
    const ok=await window.DB.deleteDoc("salesOrders",s.id);
    if(!ok){alert("Siparis silinemedi.");return;}
    setSalesOrders(prev=>prev.filter(x=>x.id!==s.id));
    if(editId===s.id){
      setEditId(null);
      setForm({...emptyForm,code:nextSalesCode()});
    }
  }

  const q=search.trim().toLowerCase();
  const materialOptions=(form.material&& !materials.some(x=>x.name===form.material))
    ? [...materials,{id:"__current__",name:form.material}]
    : materials;
  const filtered=salesOrders.filter(s=>{
    if(!q) return true;
    return (s.code||"").toLowerCase().includes(q)||
      (s.name||"").toLowerCase().includes(q)||
      (s.customerName||"").toLowerCase().includes(q)||
      (s.material||"").toLowerCase().includes(q);
  });

  useEffect(()=>{
    setForm(prev=>editId?prev:{...prev,code:nextSalesCode()});
  },[editId,nextSalesCode]);

  if(loading) return <div style={{padding:30,color:C.muted2,textAlign:"center"}}>Yukleniyor...</div>;

  return (
    <div style={{padding:16,display:"flex",flexDirection:"column",gap:12}}>
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:14}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
          <div style={{fontWeight:700,color:C.text}}>Siparis Formu</div>
          {editId&&<Badge label="Duzenleme" color={C.warn}/>}
        </div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
          <div><span style={labelSt}>Siparis Kodu</span><input style={{...inputSt,background:editId?C.surface:C.card,color:editId?C.text:C.accent,fontWeight:700}} value={form.code} readOnly={!editId} onChange={e=>fv("code",e.target.value.toUpperCase())}/></div>
          <div><span style={labelSt}>Siparis Adi *</span><input style={inputSt} value={form.name} onChange={e=>fv("name",e.target.value)} placeholder="Parca / urun adi"/></div>
          <div>
            <span style={labelSt}>Musteri</span>
            <select style={inputSt} value={form.customerId||""} onChange={e=>fv("customerId",e.target.value)}>
              <option value="">Musteri secin</option>
              {customers.map(c=><option key={c.id} value={c.id}>{c.name}{c.code?` (${c.code})`:""}</option>)}
            </select>
          </div>
          <div>
            <span style={labelSt}>Malzeme</span>
            <select style={inputSt} value={form.material||""} onChange={e=>fv("material",e.target.value)}>
              <option value="">Malzeme secin...</option>
              {materialOptions.map(m=><option key={m.id||m.name} value={m.name||""}>{m.code?`${m.code} - `:""}{m.name||""}</option>)}
            </select>
          </div>
          <div><span style={labelSt}>Siparis Adedi</span><input style={inputSt} type="number" min="0" value={form.qty} onChange={e=>fv("qty",e.target.value)} placeholder="0"/></div>
          <div><span style={labelSt}>Termin</span><input style={inputSt} type="date" value={form.dueDate||""} onChange={e=>fv("dueDate",e.target.value||"")}/></div>
          <div>
            <span style={labelSt}>Parca Suresi (sn) *</span>
            <input style={inputSt} type="number" min="1" value={form.partSec} onChange={e=>fv("partSec",e.target.value)} placeholder="Orn: 90"/>
          </div>
          <div>
            <span style={labelSt}>Durum</span>
            <select style={inputSt} value={form.status||"new"} onChange={e=>fv("status",e.target.value)}>
              {SALES_STATUS_OPTIONS.map(s=><option key={s.id} value={s.id}>{s.label}</option>)}
            </select>
          </div>
        </div>
        <div style={{marginTop:9}}>
          <span style={labelSt}>Tezgah Atamasi *</span>
          <div style={{display:"flex",gap:7,flexWrap:"wrap"}}>
            {machines.map(m=><button key={m} onClick={()=>toggleMachine(m)} style={chip(form.machines.includes(m))}>{m}</button>)}
          </div>
        </div>
        <div style={{marginTop:9}}>
          <span style={labelSt}>Not</span>
          <textarea rows={2} style={{...inputSt,minHeight:64,resize:"vertical"}} value={form.note} onChange={e=>fv("note",e.target.value)} placeholder="Opsiyonel not..."/>
        </div>
        <div style={{display:"flex",gap:8,marginTop:10}}>
          <button onClick={saveSalesOrder} style={{...btnSt("primary"),flex:1,padding:12}}>{editId?"Siparisi Guncelle":"Siparis Kaydet"}</button>
          {editId&&<button onClick={()=>{setEditId(null);setForm({...emptyForm,code:nextSalesCode()});}} style={{...btnSt("ghost"),padding:"12px 14px"}}>Iptal</button>}
        </div>
      </div>

      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"10px 12px",display:"flex",justifyContent:"space-between",alignItems:"center",gap:8,flexWrap:"wrap"}}>
        <div style={{fontSize:12,color:C.muted2}}>Siparisler ({salesOrders.length})</div>
        <input style={{...inputSt,padding:"7px 10px",fontSize:12,minWidth:220}} value={search} onChange={e=>setSearch(e.target.value)} placeholder="Kod, siparis veya musteri ara..."/>
      </div>

      {filtered.length===0&&<div style={{textAlign:"center",color:C.muted2,padding:"28px 20px",background:C.card,borderRadius:14,border:`1px solid ${C.border}`}}>Siparis bulunamadi</div>}
      {filtered.map(s=>(
        <div key={s.id} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:"12px 14px"}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",gap:10}}>
            <div>
              <div style={{display:"flex",alignItems:"center",gap:7,flexWrap:"wrap"}}>
                <span style={{fontWeight:800,fontFamily:"monospace",fontSize:14,color:C.text}}>{s.code||"-"}</span>
                <Badge label={getSalesStatusMeta(s.status).label} color={getSalesStatusMeta(s.status).color}/>
                {s.workOrderCode&&<Badge label={`IE: ${s.workOrderCode}`} color={C.green}/>}
              </div>
              <div style={{fontSize:13,color:C.text,marginTop:3}}>{s.name||"-"}</div>
              <div style={{fontSize:11,color:C.muted2,marginTop:2}}>
                {s.customerName?`${s.customerName} · `:""}
                {s.material?`${s.material} · `:""}
                {s.qty?`${s.qty} adet · `:""}
                {s.dueDate?`Termin: ${s.dueDate}`:"Termin yok"}
              </div>
              <div style={{fontSize:11,color:C.muted,marginTop:1}}>
                {s.partSec?`Parca: ${fmtSec(s.partSec)} · `:"Parca suresi yok · "}
                {(s.machines||[]).join(", ")||"Tezgah secilmemis"}
              </div>
            </div>
            <div style={{display:"flex",gap:7,flexWrap:"wrap",justifyContent:"flex-end"}}>
              <button onClick={()=>{setEditId(s.id);setForm({code:s.code||"",name:s.name||"",customerId:s.customerId||"",material:s.material||"",qty:String(s.qty??""),dueDate:s.dueDate||todayStr(),partSec:String(s.partSec??""),machines:s.machines||[],note:s.note||"",status:s.status||"new"});}} style={{...btnSt("ghost"),padding:"6px 10px",fontSize:12}}>Duzenle</button>
              <button onClick={()=>convertToWorkOrder(s)} disabled={Boolean(s.workOrderId)} style={{...btnSt("primary"),padding:"6px 10px",fontSize:12,opacity:s.workOrderId?0.6:1,cursor:s.workOrderId?"not-allowed":"pointer"}}>{s.workOrderId?"Donusturuldu":"Is Emrine Donustur"}</button>
              <button onClick={()=>removeSalesOrder(s)} style={{...btnSt("danger"),padding:"6px 10px",fontSize:12}}>Sil</button>
            </div>
          </div>
          {s.note&&<div style={{marginTop:8,fontSize:12,color:C.muted2}}>{s.note}</div>}
        </div>
      ))}
    </div>
  );
}
//  WORK ORDERS
// ════════════════════════════════════════════════════════════
function WorkOrders({currentUser,machines=DEFAULT_MACHINES}) {
  const [orders,setOrders]=useState([]);
  const [customers,setCustomers]=useState([]);
  const [materials,setMaterials]=useState([]);
  const [toolMovements,setToolMovements]=useState([]);
  const [entries,setEntries]=useState([]);
  const [loading,setLoading]=useState(true);
  const [showForm,setShowForm]=useState(false);
  const [editId,setEditId]=useState(null);
  const [statusFilters,setStatusFilters]=useState([]);
  const [search,setSearch]=useState("");
  const [viewOrder,setViewOrder]=useState(null);
  const [viewOrderMoves,setViewOrderMoves]=useState([]);
  const [previewFile,setPreviewFile]=useState(null);
  const [uploading,setUploading]=useState(false);
  const fileRef=useRef();
  const emptyForm={code:"",name:"",partNo:"",revision:"A",customerId:"",material:"",qty:"1",dueDate:todayStr(),priority:"normal",dependencies:[],partSec:"",machines:[],notes:"",files:[],status:"planned",sourceType:"manual"};
  const [form,setForm]=useState(emptyForm);
  const nextOrderCode=useCallback((list=orders)=>{
    const nums=list.map(o=>{
      const m=(o.code||"").toUpperCase().match(/^IE-(\d+)$/);
      return m?Number(m[1]):null;
    }).filter(n=>n!==null);
    const next=(nums.length?Math.max(...nums):0)+1;
    return `IE-${String(next).padStart(3,"0")}`;
  },[orders]);

  const load=useCallback(async()=>{
    const [o,m,c,ml,en]=await Promise.all([window.DB.getAll("orders"),window.DB.getAll("toolMovements"),window.DB.getAll("customers"),window.DB.getAll("materials"),window.DB.getAll("entries")]);
    setOrders(o.sort((a,b)=>(b.createdAt||"").localeCompare(a.createdAt||"")));
    setToolMovements(m.sort((a,b)=>(b.createdAt||"").localeCompare(a.createdAt||"")));
    setCustomers(c.sort((a,b)=>(a.name||"").localeCompare(b.name||"")));
    setMaterials(ml.sort((a,b)=>(a.name||"").localeCompare(b.name||"","tr")));
    setEntries(en.sort((a,b)=>(b.createdAt||"").localeCompare(a.createdAt||"")));
    setLoading(false);
  },[]);
  useEffect(()=>{load();},[load]);
  const entryToolChanges=entries
    .filter(e=>(Number(e.machineToolQty??e.machineToolChange??0)>0)&&(e.jobCode||""))
    .map(e=>({
      id:`entry_${e.id||Math.random().toString(36).slice(2,7)}`,
      orderId:"",
      orderCode:e.jobCode||"",
      toolCode:e.machineToolCode||"",
      toolName:e.machineToolName||"Takım",
      type:"change",
      qty:Number(e.machineToolQty??e.machineToolChange??0)||0,
      createdAt:e.createdAt||`${e.date||todayStr()}T00:00:00`,
      userName:e.operatorName||e.operatorId||"",
      note:[e.shift?`Vardiya: ${e.shift}`:"",e.machine?`Tezgah: ${e.machine}`:""].filter(Boolean).join(" · "),
      date:e.date||"",
    }));
  useEffect(()=>{
    if(!viewOrder){ setViewOrderMoves([]); return; }
    const stockMoves=toolMovements.filter(m=>(m.orderId&&m.orderId===viewOrder.id)||(!m.orderId&&m.orderCode===viewOrder.code));
    const entryMoves=entryToolChanges.filter(m=>m.orderCode===viewOrder.code);
    setViewOrderMoves([...stockMoves,...entryMoves].sort((a,b)=>(b.createdAt||"").localeCompare(a.createdAt||"")));
  },[viewOrder,toolMovements,entryToolChanges]);

  const fv=(k,v)=>setForm(p=>({...p,[k]:v}));
  const toggleMachine=m=>fv("machines",form.machines.includes(m)?form.machines.filter(x=>x!==m):[...form.machines,m]);
  const canPreview=f=>!!(f&&f.data&&(f.type?.startsWith("image/")||f.type==="application/pdf"));

  async function handleFiles(fileList) {
    setUploading(true);
    const results=[];
    for(const file of Array.from(fileList)){
      if(file.size>5*1024*1024){alert(`${file.name} 5MB'dan büyük, atlandı.`);continue;}
      const b64=await fileToBase64(file);
      results.push({name:file.name,size:file.size,type:file.type,data:b64});
    }
    fv("files",[...form.files,...results]);
    setUploading(false);
  }

  async function save() {
    if(!form.name||!form.partSec){alert("Parça adı ve süre zorunlu!");return;}
    if(form.machines.length===0){alert("En az bir tezgah seçin!");return;}
    const finalCode=editId?form.code:(form.code||nextOrderCode());
    const pickedCustomer=customers.find(c=>c.id===form.customerId);
    const data={
      code:finalCode.toUpperCase(),
      name:form.name,
      partNo:(form.partNo||"").trim().toUpperCase(),
      revision:(form.revision||"A").trim().toUpperCase(),
      customerId:pickedCustomer?.id||"",
      customerName:pickedCustomer?.name||"",
      material:form.material,
      qty:Math.max(0,safeNum(form.qty)||0),
      dueDate:form.dueDate||"",
      priority:form.priority||"normal",
      dependencies:(form.dependencies||[]).filter(Boolean),
      partSec:Number(form.partSec),
      machines:form.machines,
      notes:form.notes,
      files:form.files,
      sourceType:form.sourceType||"manual",
      status:editId?(form.status||"planned"):"planned",
      updatedAt:new Date().toISOString(),
    };
    if(editId){
      await window.DB.updateDoc("orders",editId,data);
      setOrders(o=>o.map(x=>x.id===editId?{...x,...data}:x));
    } else {
      const id=await window.DB.addDoc("orders",{...data,createdBy:currentUser.id});
      if(id) setOrders(o=>[{id,...data,createdAt:new Date().toISOString()},...o]);
    }
    setShowForm(false); setForm(emptyForm); setEditId(null);
  }

  async function setOrderStatus(o,status) {
    if(o.status===status) return;
    await window.DB.updateDoc("orders",o.id,{status});
    setOrders(orders=>orders.map(x=>x.id===o.id?{...x,status}:x));
  }

  const q=search.trim().toLowerCase();
  const usageCountByOrder={};
  const productionByOrder={};
  toolMovements.forEach(m=>{
    const key=m.orderId||m.orderCode;
    if(!key) return;
    usageCountByOrder[key]=(usageCountByOrder[key]||0)+1;
  });
  entryToolChanges.forEach(m=>{
    const key=m.orderCode;
    if(!key) return;
    usageCountByOrder[key]=(usageCountByOrder[key]||0)+1;
  });
  entries.forEach(e=>{
    const key=e.jobCode||"";
    if(!key) return;
    if(!productionByOrder[key]) productionByOrder[key]={correct:0,wrong:0,total:0};
    productionByOrder[key].correct+=(Number(e.correct)||0);
    productionByOrder[key].wrong+=(Number(e.wrong)||0);
    productionByOrder[key].total+=(Number(e.correct)||0)+(Number(e.wrong)||0);
  });
  const toggleStatusFilter=statusId=>{
    setStatusFilters(prev=>prev.includes(statusId)?prev.filter(x=>x!==statusId):[...prev,statusId]);
  };
  const filteredOrders=orders.filter(o=>{
    const statusOk=statusFilters.length===0 ? true : statusFilters.includes(o.status||"passive");
    const textOk=!q || (o.code||"").toLowerCase().includes(q) || (o.name||"").toLowerCase().includes(q) || (o.material||"").toLowerCase().includes(q) || (o.customerName||"").toLowerCase().includes(q);
    return statusOk&&textOk;
  });

  if(loading) return <div style={{padding:30,color:C.muted2,textAlign:"center"}}>Yükleniyor...</div>;
  const materialOptions=(form.material&& !materials.some(x=>x.name===form.material))
    ? [...materials,{id:"__current__",name:form.material}]
    : materials;

  if(viewOrder) return (
    <div style={{padding:16}}>
      <button onClick={()=>{setPreviewFile(null);setViewOrder(null);}} style={{...btnSt("ghost"),marginBottom:16,padding:"8px 14px",fontSize:13}}>← Geri</button>
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:16,marginBottom:12}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:12}}>
          <div><div style={{fontWeight:800,fontSize:18,fontFamily:"monospace",color:C.text}}>{viewOrder.code}</div><div style={{fontSize:15,fontWeight:600,marginTop:2,color:C.text}}>{viewOrder.name}</div></div>
          <Badge label={getOrderStatusMeta(viewOrder.status).label} color={getOrderStatusMeta(viewOrder.status).color}/>
        </div>
        {[["Musteri",viewOrder.customerName],["Parca No",viewOrder.partNo],["Revizyon",viewOrder.revision],["Malzeme",viewOrder.material],["Miktar",safeNum(viewOrder.qty)>0?`${safeNum(viewOrder.qty)} adet`:""],["Termin",viewOrder.dueDate],["Oncelik",(PRIORITY_OPTIONS.find(p=>p.id===viewOrder.priority)||{}).label],["Kaynak",viewOrder.sourceType==="sales_auto"?"Siparisten Otomatik":"Manuel"],["Bagimliliklar",(viewOrder.dependencies||[]).join(", ")],["Parca Suresi",fmtSec(viewOrder.partSec)],["Maks Uretim/Gun",viewOrder.partSec?Math.floor(EFFECTIVE_SECONDS/viewOrder.partSec)+" adet":"-"],["Tezgahlar",(viewOrder.machines||[]).join(", ")],["Notlar",viewOrder.notes]].map(([l,v])=>v?(
          <div key={l} style={{marginBottom:10}}><div style={{color:C.muted2,fontSize:11,letterSpacing:.8,textTransform:"uppercase",marginBottom:2}}>{l}</div><div style={{fontSize:14,color:C.text}}>{v}</div></div>
        ):null)}
        <div style={{marginBottom:2}}>
          <div style={{color:C.muted2,fontSize:11,letterSpacing:.8,textTransform:"uppercase",marginBottom:2}}>Üretilen Adetler</div>
          <div style={{fontSize:14,color:C.text}}>
            Toplam: {(productionByOrder[viewOrder.code]?.total)||0} · Doğru: {(productionByOrder[viewOrder.code]?.correct)||0} · Hatalı: {(productionByOrder[viewOrder.code]?.wrong)||0}
          </div>
        </div>
      </div>
      <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",marginBottom:10}}>Takım Kullanımları ({viewOrderMoves.length})</div>
      {viewOrderMoves.length===0?(
        <div style={{color:C.muted,fontSize:13,textAlign:"center",padding:20,background:C.card,borderRadius:12,border:`1px solid ${C.border}`,marginBottom:12}}>Bu iş emrine bağlı takım hareketi yok</div>
      ):(
        <div style={{marginBottom:12}}>
          {viewOrderMoves.map((m,i)=>(
            <div key={m.id||i} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:10,padding:"10px 12px",marginBottom:7,display:"flex",justifyContent:"space-between",alignItems:"center",gap:10}}>
              <div>
                <div style={{fontSize:13,color:C.text,fontWeight:700}}>{m.toolCode?`${m.toolCode} · `:""}{m.toolName||"Takım"}</div>
                <div style={{fontSize:11,color:C.muted2,marginTop:2}}>{(m.createdAt||"").slice(0,16).replace("T"," ")} {m.userName?`· ${m.userName}`:""} {m.note?`· ${m.note}`:""}</div>
              </div>
              <Badge label={`${m.type==="in"?"Giriş":(m.type==="out"?"Çıkış":"Degisim")} ${m.qty}`} color={m.type==="in"?C.green:(m.type==="out"?C.red:C.warn)}/>
            </div>
          ))}
        </div>
      )}
      <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",marginBottom:10}}>Teknik Dosyalar ({(viewOrder.files||[]).length})</div>
      {(viewOrder.files||[]).length===0?<div style={{color:C.muted,fontSize:13,textAlign:"center",padding:20,background:C.card,borderRadius:12,border:`1px solid ${C.border}`}}>Dosya yüklenmemiş</div>:
        (viewOrder.files||[]).map((f,i)=>(
          <div key={i} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"12px 14px",marginBottom:8,display:"flex",alignItems:"center",gap:12}}>
            <div style={{fontSize:28,flexShrink:0}}>{getFileIcon(f.name)}</div>
            <div style={{flex:1,minWidth:0}}><div style={{fontWeight:600,fontSize:13,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",color:C.text}}>{f.name}</div><div style={{color:C.muted2,fontSize:11,marginTop:2}}>{formatBytes(f.size)}</div></div>
            {f.data&&f.type&&f.type.startsWith("image/")&&<img src={f.data} alt={f.name} style={{width:48,height:48,objectFit:"cover",borderRadius:8,border:`1px solid ${C.border}`}}/>}
            {canPreview(f)&&<button onClick={()=>setPreviewFile(f)} style={{...btnSt(),padding:"6px 10px",fontSize:12,flexShrink:0}}>Görüntüle</button>}
            {f.data&&<a href={f.data} download={f.name} style={{...btnSt("ghost"),padding:"6px 10px",fontSize:12,textDecoration:"none",flexShrink:0}}>⬇</a>}
          </div>
        ))
      }
      {previewFile&&(
        <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,.72)",zIndex:60,display:"flex",alignItems:"center",justifyContent:"center",padding:16}} onClick={()=>setPreviewFile(null)}>
          <div style={{width:"100%",maxWidth:960,maxHeight:"88vh",background:C.card,border:`1px solid ${C.border}`,borderRadius:14,overflow:"hidden",display:"flex",flexDirection:"column"}} onClick={e=>e.stopPropagation()}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"10px 12px",borderBottom:`1px solid ${C.border}`}}>
              <div style={{fontSize:13,fontWeight:700,color:C.text,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{previewFile.name}</div>
              <button onClick={()=>setPreviewFile(null)} style={{...btnSt("ghost"),padding:"6px 10px",fontSize:12}}>Kapat</button>
            </div>
            <div style={{padding:10,overflow:"auto",background:C.surface}}>
              {previewFile.type&&previewFile.type.startsWith("image/")&&<img src={previewFile.data} alt={previewFile.name} style={{width:"100%",height:"auto",borderRadius:10,border:`1px solid ${C.border}`}}/>}
              {previewFile.type==="application/pdf"&&<iframe title={previewFile.name} src={previewFile.data} style={{width:"100%",height:"70vh",border:`1px solid ${C.border}`,borderRadius:10,background:"#fff"}}/>}
            </div>
          </div>
        </div>
      )}
    </div>
  );

  if(showForm) return (
    <div style={{padding:16}}>
      <button onClick={()=>{setShowForm(false);setForm(emptyForm);setEditId(null);}} style={{...btnSt("ghost"),marginBottom:16,padding:"8px 14px",fontSize:13}}>← Geri</button>
      <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",marginBottom:16}}>{editId?"İş Emri Düzenle":"Yeni İş Emri"}</div>
      <div style={{display:"flex",flexDirection:"column",gap:14}}>
        <div><span style={labelSt}>İş Emri Kodu *</span><input style={{...inputSt,background:editId?C.surface:C.card,color:editId?C.text:C.accent,fontWeight:700}} placeholder="IE-001" value={form.code} readOnly={!editId} onChange={e=>fv("code",e.target.value.toUpperCase())}/></div>
        <div><span style={labelSt}>Parça Adı *</span><input style={inputSt} placeholder="Parça adı" value={form.name} onChange={e=>fv("name",e.target.value)}/></div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8}}>
          <div><span style={labelSt}>Parca No</span><input style={inputSt} placeholder="PRT-001" value={form.partNo||""} onChange={e=>fv("partNo",e.target.value)}/></div>
          <div><span style={labelSt}>Revizyon</span><input style={inputSt} placeholder="A" value={form.revision||"A"} onChange={e=>fv("revision",e.target.value)}/></div>
          <div><span style={labelSt}>Miktar</span><input style={inputSt} type="number" min="0" value={form.qty||"1"} onChange={e=>fv("qty",e.target.value)}/></div>
        </div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8}}>
          <div><span style={labelSt}>Termin</span><input style={inputSt} type="date" value={form.dueDate||todayStr()} onChange={e=>fv("dueDate",e.target.value||todayStr())}/></div>
          <div>
            <span style={labelSt}>Oncelik</span>
            <select style={inputSt} value={form.priority||"normal"} onChange={e=>fv("priority",e.target.value)}>
              {PRIORITY_OPTIONS.map(p=><option key={p.id} value={p.id}>{p.label}</option>)}
            </select>
          </div>
          <div>
            <span style={labelSt}>Kaynak</span>
            <select style={inputSt} value={form.sourceType||"manual"} onChange={e=>fv("sourceType",e.target.value)}>
              <option value="manual">Manuel</option>
              <option value="sales_auto">Siparisten Otomatik</option>
            </select>
          </div>
        </div>
        <div>
          <span style={labelSt}>Müşteri</span>
          <select style={inputSt} value={form.customerId||""} onChange={e=>fv("customerId",e.target.value)}>
            <option value="">Müşteri seçin (opsiyonel)</option>
            {customers.map(c=><option key={c.id} value={c.id}>{c.name}{c.code?` (${c.code})`:""}</option>)}
          </select>
        </div>
        <div>
          <span style={labelSt}>Malzeme</span>
          <select style={inputSt} value={form.material||""} onChange={e=>fv("material",e.target.value)}>
            <option value="">Malzeme secin...</option>
            {materialOptions.map(m=><option key={m.id||m.name} value={m.name||""}>{m.code?`${m.code} - `:""}{m.name||""}</option>)}
          </select>
        </div>
        <div>
          <span style={labelSt}>Parça Süresi (saniye) *</span>
          <input style={inputSt} type="number" min="1" placeholder="Örn: 90" value={form.partSec} onChange={e=>fv("partSec",e.target.value)}/>
          {form.partSec>0&&<div style={{color:C.muted2,fontSize:11,marginTop:5}}>→ Maks: <span style={{color:C.accent,fontWeight:700}}>{Math.floor(EFFECTIVE_SECONDS/Number(form.partSec))} adet</span>/gün ({fmtSec(Number(form.partSec))}/parça)</div>}
        </div>
        <div>
          <span style={labelSt}>Tezgah Ataması *</span>
          <div style={{display:"flex",gap:7,flexWrap:"wrap"}}>
            {machines.map(m=><button key={m} onClick={()=>toggleMachine(m)} style={chip(form.machines.includes(m))}>{m}</button>)}
          </div>
        </div>
        <div>
          <span style={labelSt}>Bagimli Is Emirleri</span>
          <select multiple style={{...inputSt,minHeight:86}} value={form.dependencies||[]} onChange={e=>fv("dependencies",Array.from(e.target.selectedOptions).map(o=>o.value))}>
            {orders.filter(o=>o.id!==editId).map(o=><option key={o.id} value={o.code||o.id}>{o.code} - {o.name}</option>)}
          </select>
          <div style={{fontSize:11,color:C.muted2,marginTop:5}}>Ctrl/Cmd ile birden fazla secim yapabilirsiniz.</div>
        </div>
        <div><span style={labelSt}>Notlar</span><textarea style={{...inputSt,resize:"vertical",minHeight:70}} placeholder="Notlar..." value={form.notes} onChange={e=>fv("notes",e.target.value)}/></div>
        <div>
          <span style={labelSt}>Teknik Dosyalar</span>
          <div onClick={()=>fileRef.current?.click()} style={{border:`2px dashed ${C.border}`,borderRadius:12,padding:20,textAlign:"center",cursor:"pointer",background:C.surface}} onDragOver={e=>e.preventDefault()} onDrop={e=>{e.preventDefault();handleFiles(e.dataTransfer.files);}}>
            <div style={{fontSize:28,marginBottom:6}}>📎</div>
            <div style={{color:C.muted2,fontSize:13}}>{uploading?"Yükleniyor...":"Dosya seç veya sürükle bırak"}</div>
            <div style={{color:C.muted,fontSize:11,marginTop:4}}>Resim, PDF, DXF, DWG · Maks 5MB/dosya</div>
          </div>
          <input ref={fileRef} type="file" multiple accept="image/*,.pdf,.dxf,.dwg,.step,.stp" style={{display:"none"}} onChange={e=>handleFiles(e.target.files)}/>
          {form.files.map((f,i)=>(
            <div key={i} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:10,padding:"10px 12px",marginTop:8,display:"flex",alignItems:"center",gap:10}}>
              <span style={{fontSize:20}}>{getFileIcon(f.name)}</span>
              <div style={{flex:1,minWidth:0}}><div style={{fontSize:12,fontWeight:600,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",color:C.text}}>{f.name}</div><div style={{fontSize:11,color:C.muted2}}>{formatBytes(f.size)}</div></div>
              {f.data&&f.type&&f.type.startsWith("image/")&&<img src={f.data} alt="" style={{width:36,height:36,objectFit:"cover",borderRadius:6}}/>}
              <button onClick={()=>fv("files",form.files.filter((_,idx)=>idx!==i))} style={{background:"transparent",border:"none",color:C.red,fontSize:18,cursor:"pointer"}}>×</button>
            </div>
          ))}
        </div>
        <div style={{display:"flex",gap:8}}><button onClick={save} style={{...btnSt("primary"),flex:1,padding:13}}>💾 Kaydet</button><button onClick={()=>{setShowForm(false);setForm(emptyForm);setEditId(null);}} style={{...btnSt("ghost"),padding:13}}>İptal</button></div>
      </div>
    </div>
  );

  return (
    <div style={{padding:16}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
        <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase"}}>İş Emirleri · {orders.filter(o=>isOpenOrderStatus(o.status)).length} acik</div>
        <button onClick={()=>{setEditId(null);setForm({...emptyForm,code:nextOrderCode()});setShowForm(true);}} style={{...btnSt("primary"),padding:"8px 14px",fontSize:12}}>+ Yeni</button>
      </div>
      <div style={{display:"flex",gap:8,marginBottom:12,flexWrap:"wrap"}}>
        <input style={{...inputSt,flex:"1 1 230px",padding:"9px 12px",fontSize:13}} placeholder="Kod, parça veya malzeme ara..." value={search} onChange={e=>setSearch(e.target.value)}/>
      </div>
      <div style={{display:"flex",gap:7,marginBottom:12,flexWrap:"wrap"}}>
        <button onClick={()=>setStatusFilters([])} style={chip(statusFilters.length===0,C.muted2)}>Tüm Durumlar</button>
        {ORDER_STATUS_OPTIONS.map(s=><button key={s.id} onClick={()=>toggleStatusFilter(s.id)} style={chip(statusFilters.includes(s.id),s.color)}>{s.label}</button>)}
      </div>
      {orders.length===0&&<div style={{textAlign:"center",color:C.muted2,padding:"40px 20px",background:C.card,borderRadius:14,border:`1px solid ${C.border}`}}><div style={{fontSize:36,marginBottom:10}}>📋</div>Henüz iş emri yok</div>}
      {orders.length>0&&filteredOrders.length===0&&<div style={{textAlign:"center",color:C.muted2,padding:"24px 20px",background:C.card,borderRadius:14,border:`1px solid ${C.border}`}}>Filtreye uygun iş emri bulunamadı</div>}
      {filteredOrders.map(o=>(
        <div key={o.id} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:"13px 15px",marginBottom:10,opacity:(o.status==="passive"||o.status==="liquidation")?.6:1}}>
          <div style={{marginBottom:8}}>
            <div style={{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"}}>
              <span style={{fontWeight:800,fontSize:14,fontFamily:"monospace",color:C.text}}>{o.code}</span>
              <Badge label={getOrderStatusMeta(o.status).label} color={getOrderStatusMeta(o.status).color}/>
              {(o.files||[]).length>0&&<Badge label={`${o.files.length} dosya`} color={C.purple}/>}
              {(usageCountByOrder[o.id]||usageCountByOrder[o.code])>0&&<Badge label={`${usageCountByOrder[o.id]||usageCountByOrder[o.code]} takım`} color={C.warn}/>}
              {(productionByOrder[o.code]?.total||0)>0&&<Badge label={`${productionByOrder[o.code].total} adet`} color={C.green}/>}
            </div>
            <div style={{fontSize:13,color:C.muted2,marginTop:3}}>{o.name}</div>
            {o.partNo&&<div style={{fontSize:11,color:C.muted2,marginTop:1}}>🧩 {o.partNo}{o.revision?` Rev.${o.revision}`:""}</div>}
            {o.customerName&&<div style={{fontSize:11,color:C.accent,marginTop:1}}>🏢 {o.customerName}</div>}
            {o.material&&<div style={{fontSize:11,color:C.muted,marginTop:1}}>🔩 {o.material}</div>}
            <div style={{fontSize:11,color:C.muted,marginTop:1}}>⏱ {fmtSec(o.partSec)} · {(o.machines||[]).join(", ")}</div>
            <div style={{fontSize:11,color:C.muted2,marginTop:1}}>📅 {o.dueDate||"-"} · 🔢 {safeNum(o.qty)} adet · 🚦 {(PRIORITY_OPTIONS.find(p=>p.id===o.priority)||{}).label||"Normal"}</div>
            <div style={{fontSize:11,color:C.muted2,marginTop:1}}>🏷 {o.sourceType==="sales_auto"?"Siparisten Otomatik":"Manuel"}{(o.dependencies||[]).length>0?` · ⛓ ${o.dependencies.length} bagimlilik`:""}</div>
          </div>
          <div style={{display:"flex",gap:7,flexWrap:"wrap"}}>
            <button onClick={()=>setViewOrder(o)} style={{...btnSt("ghost"),padding:"6px 12px",fontSize:12}}>👁 Görüntüle</button>
            <button onClick={()=>{setForm({code:o.code,name:o.name,partNo:o.partNo||"",revision:o.revision||"A",customerId:o.customerId||"",material:o.material||"",qty:String(o.qty??"1"),dueDate:o.dueDate||todayStr(),priority:o.priority||"normal",dependencies:o.dependencies||[],partSec:o.partSec,machines:o.machines||[],notes:o.notes||"",files:o.files||[],status:o.status||"planned",sourceType:o.sourceType||"manual"});setEditId(o.id);setShowForm(true);}} style={{...btnSt(),padding:"6px 12px",fontSize:12}}>✏️ Düzenle</button>
            <select style={{...inputSt,width:150,padding:"6px 10px",fontSize:12}} value={o.status||"passive"} onChange={e=>setOrderStatus(o,e.target.value)}>
              {ORDER_STATUS_OPTIONS.map(s=><option key={s.id} value={s.id}>{s.label}</option>)}
            </select>
          </div>
        </div>
      ))}
    </div>
  );
}

// ════════════════════════════════════════════════════════════
//  DATA ENTRY
// ════════════════════════════════════════════════════════════
function DataEntry({currentUser,machines=DEFAULT_MACHINES}) {
  const [orders,setOrders]=useState([]);
  const [tools,setTools]=useState([]);
  const [plans,setPlans]=useState([]);
  const [todayEntries,setTodayEntries]=useState([]);
  const [saved,setSaved]=useState(false);
  const [search,setSearch]=useState("");
  const [showPicker,setShowPicker]=useState(false);
  const [editId,setEditId]=useState(null);
  const [showToolModal,setShowToolModal]=useState(false);
  const [showShiftModal,setShowShiftModal]=useState(false);
  const [toolDraft,setToolDraft]=useState({machineToolId:"",machineToolQty:"1"});
  const [shiftDraft,setShiftDraft]=useState({correct:"",wrong:""});
  const [form,setForm]=useState({
    entryDate:todayStr(),
    machine:machines[0]||"CNC-1",
    shift:"sabah",
    selectedOrder:null,
    correct:"",
    wrong:"",
    machineToolId:"",
    machineToolQty:"1",
  });

  useEffect(()=>{
    Promise.all([window.DB.getAll("orders"),window.DB.getAll("toolStock"),window.DB.getAll("plans")]).then(([o,t,p])=>{
      setOrders(o.filter(x=>isOpenOrderStatus(x.status)));
      setTools(t);
      setPlans(p||[]);
    });
  },[]);

  useEffect(()=>{
    window.DB.getAll("entries").then(e=>setTodayEntries(e.filter(x=>x.date===form.entryDate&&x.operatorId===currentUser.id)));
  },[currentUser.id,form.entryDate]);

  const fv=(k,v)=>setForm(p=>({...p,[k]:v}));
  const filtered=orders.filter(o=>o.code.toLowerCase().includes(search.toLowerCase())||o.name.toLowerCase().includes(search.toLowerCase()));
  const toolOptions=[...tools].sort((a,b)=>(a.code||"").localeCompare(b.code||""));
  const addUsage=(map,id,qty)=>{
    if(!id) return;
    const q=Number(qty)||0;
    if(q<=0) return;
    map.set(id,(map.get(id)||0)+q);
  };
  const getUsageMap=entry=>{
    const map=new Map();
    if(!entry) return map;
    addUsage(map,entry.machineToolId,entry.machineToolQty??entry.machineToolChange??0);
    addUsage(map,entry.orderToolId,entry.orderToolQty??entry.orderToolChange??0);
    return map;
  };
  const getDeltaMap=(prevEntry,nextEntry)=>{
    const delta=new Map();
    getUsageMap(prevEntry).forEach((qty,id)=>delta.set(id,(delta.get(id)||0)+qty));
    getUsageMap(nextEntry).forEach((qty,id)=>delta.set(id,(delta.get(id)||0)-qty));
    return delta;
  };
  const invertDeltaMap=delta=>{
    const inv=new Map();
    delta.forEach((d,id)=>inv.set(id,-d));
    return inv;
  };
  async function applyToolStockDelta(delta){
    const changes=[...delta.entries()].filter(([,d])=>d!==0);
    if(changes.length===0) return true;
    for(const [id,d] of changes){
      const tool=tools.find(t=>t.id===id);
      if(!tool){
        alert("Seçili takım stokta bulunamadı. Lütfen tekrar seçin.");
        return false;
      }
      const nextQty=(Number(tool.qty)||0)+d;
      if(nextQty<0){
        alert(`Yetersiz stok: ${tool.code||tool.name||"Takım"}`);
        return false;
      }
    }
    for(const [id,d] of changes){
      const tool=tools.find(t=>t.id===id);
      const nextQty=(Number(tool.qty)||0)+d;
      const ok=await window.DB.updateDoc("toolStock",id,{qty:nextQty,updatedAt:new Date().toISOString()});
      if(!ok){
        alert("Takım stoğu güncellenemedi.");
        return false;
      }
    }
    setTools(prev=>prev.map(t=>{
      const d=delta.get(t.id)||0;
      return d===0?t:{...t,qty:(Number(t.qty)||0)+d};
    }));
    return true;
  }
  const selectedDateObj=parseYmdLocal(form.entryDate);
  const selectedDateLabel=new Intl.DateTimeFormat("tr-TR",{weekday:"long",day:"2-digit",month:"long",year:"numeric"}).format(selectedDateObj);
  function getPlannedOrder(machine,date){
    if(!machine||!date) return null;
    const planned=plans.find(p=>p.machine===machine&&p.date===date);
    if(!planned) return null;
    const activeOrder=orders.find(o=>o.id===planned.orderId);
    if(activeOrder) return activeOrder;
    if(planned.orderCode||planned.orderName){
      return {
        id:planned.orderId||"",
        code:planned.orderCode||"",
        name:planned.orderName||"",
        partSec:Number(planned.orderPartSec)||0,
        material:"",
      };
    }
    return null;
  }
  function selectMachine(machine){
    const plannedOrder=getPlannedOrder(machine,form.entryDate);
    setForm(p=>({...p,machine,selectedOrder:plannedOrder||null}));
    setShowPicker(false);
    setSearch("");
  }
  useEffect(()=>{
    if(editId) return;
    const plannedOrder=getPlannedOrder(form.machine,form.entryDate);
    setForm(prev=>{
      const prevKey=(prev.selectedOrder?.id||prev.selectedOrder?.code||"");
      const nextKey=(plannedOrder?.id||plannedOrder?.code||"");
      if(prevKey===nextKey) return prev;
      return {...prev,selectedOrder:plannedOrder||null};
    });
  },[editId,form.machine,form.entryDate,plans,orders]);
  const resetEntryForm=()=>setForm(p=>({
    entryDate:p.entryDate,
    machine:p.machine||machines[0]||"CNC-1",
    shift:p.shift||"sabah",
    selectedOrder:null,
    correct:"",
    wrong:"",
    machineToolId:"",
    machineToolQty:"1",
  }));

  async function submitShiftEnd(correctValue,wrongValue) {
    if(!form.selectedOrder){alert("İş emri seçin!");return false;}
    if(correctValue===""||Number(correctValue)<0){alert("Doğru adet zorunlu!");return false;}
    const correctNum=Number(correctValue);
    const wrongNum=Number(wrongValue)||0;
    const machineTool=tools.find(t=>t.id===form.machineToolId);
    const machineToolQty=form.machineToolId?Math.max(1,Number(form.machineToolQty)||1):0;
    const d=parseYmdLocal(form.entryDate);
    const entry={
      date:ymdLocal(d), week:weekStart(d), month:monthStr(d),
      machine:form.machine, shift:form.shift,
      operatorId:currentUser.id, operatorName:currentUser.fullName,
      jobCode:form.selectedOrder.code, jobName:form.selectedOrder.name,
      partSec:Number(form.selectedOrder.partSec),
      correct:correctNum, wrong:wrongNum,
      machineToolId:machineTool?.id||"",
      machineToolCode:machineTool?.code||"",
      machineToolName:machineTool?.name||"",
      machineToolQty,
      machineToolChange:machineToolQty,
    };
    const prevEntry=editId?todayEntries.find(x=>x.id===editId):null;
    const stockDelta=getDeltaMap(prevEntry,entry);
    const stockOk=await applyToolStockDelta(stockDelta);
    if(!stockOk) return false;
    if(editId){
      const ok=await window.DB.updateDoc("entries",editId,entry);
      if(ok){
        setTodayEntries(e=>e.map(x=>x.id===editId?{...x,...entry}:x));
        setEditId(null);
        setSaved(true); setTimeout(()=>setSaved(false),2000);
        resetEntryForm();
        setShiftDraft({correct:"",wrong:""});
        return true;
      }else{
        await applyToolStockDelta(invertDeltaMap(stockDelta));
        return false;
      }
    }
    const id=await window.DB.addDoc("entries",entry);
    if(id){
      setTodayEntries(e=>[{id,...entry},...e]);
      setSaved(true); setTimeout(()=>setSaved(false),2000);
      resetEntryForm();
      setShiftDraft({correct:"",wrong:""});
      return true;
    }else{
      await applyToolStockDelta(invertDeltaMap(stockDelta));
      return false;
    }
  }

  function startEdit(entry){
    const matched=orders.find(o=>o.code===entry.jobCode);
    const selectedOrder=matched||{code:entry.jobCode,name:entry.jobName,partSec:entry.partSec};
    setEditId(entry.id);
    setShowPicker(false);
    setForm({
      entryDate:entry.date||todayStr(),
      machine:entry.machine||machines[0]||"CNC-1",
      shift:entry.shift||"sabah",
      selectedOrder,
      correct:String(entry.correct??""),
      wrong:String(entry.wrong??0),
      machineToolId:entry.machineToolId||"",
      machineToolQty:String(entry.machineToolQty??entry.machineToolChange??1),
    });
    setShiftDraft({
      correct:String(entry.correct??""),
      wrong:String(entry.wrong??0),
    });
  }

  async function removeEntry(entry){
    if(!confirm(`Bu girisi silmek istiyor musunuz? (${entry.jobCode})`)) return;
    const stockDelta=getDeltaMap(entry,null);
    const stockOk=await applyToolStockDelta(stockDelta);
    if(!stockOk) return;
    const ok=await window.DB.deleteDoc("entries",entry.id);
    if(!ok){
      await applyToolStockDelta(invertDeltaMap(stockDelta));
      return;
    }
    setTodayEntries(e=>e.filter(x=>x.id!==entry.id));
    if(editId===entry.id){
      setEditId(null);
      resetEntryForm();
    }
  }

  function openToolChangeModal(){
    setToolDraft({
      machineToolId:form.machineToolId||"",
      machineToolQty:String(form.machineToolQty||"1"),
    });
    setShowToolModal(true);
  }

  function approveToolChange(){
    const machineToolQty=toolDraft.machineToolId?String(Math.max(1,Number(toolDraft.machineToolQty)||1)):"1";
    setForm(p=>({
      ...p,
      machineToolId:toolDraft.machineToolId||"",
      machineToolQty,
    }));
    setShowToolModal(false);
  }

  function openShiftEndModal(){
    setShiftDraft({
      correct:String(form.correct||""),
      wrong:String(form.wrong||0),
    });
    setShowShiftModal(true);
  }

  async function approveShiftEnd(){
    const ok=await submitShiftEnd(shiftDraft.correct,shiftDraft.wrong);
    if(ok) setShowShiftModal(false);
  }

  const machineToolPicked=tools.find(t=>t.id===form.machineToolId);

  return (
    <div style={{padding:16,display:"flex",flexDirection:"column",gap:14}}>
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"10px 12px",display:"flex",justifyContent:"space-between",alignItems:"center",gap:10,flexWrap:"wrap"}}>
        <div style={{fontSize:13,fontWeight:600,color:C.text,textTransform:"capitalize"}}>{selectedDateLabel}</div>
        <div style={{minWidth:170}}>
          <input style={{...inputSt,padding:"8px 10px",fontSize:13}} type="date" max={todayStr()} value={form.entryDate} onChange={e=>fv("entryDate",e.target.value||todayStr())}/>
        </div>
      </div>
      {editId&&(
        <div style={{background:C.warnDim,border:`1px solid ${C.warn}50`,borderRadius:10,padding:"10px 12px",display:"flex",justifyContent:"space-between",alignItems:"center",gap:10}}>
          <span style={{fontSize:12,color:C.warn,fontWeight:700}}>Düzenleme modu açık</span>
          <button onClick={()=>{setEditId(null);resetEntryForm();}} style={{...btnSt("ghost"),padding:"6px 10px",fontSize:12}}>İptal</button>
        </div>
      )}
      <div>
        <span style={labelSt}>Tezgah</span>
        <div style={{display:"flex",gap:7,flexWrap:"wrap"}}>
          {machines.map(m=><button key={m} onClick={()=>selectMachine(m)} style={chip(form.machine===m)}>{m}</button>)}
        </div>
      </div>
      <div>
        <span style={labelSt}>Vardiya</span>
        <div style={{display:"flex",gap:7,flexWrap:"wrap"}}>
          {SHIFTS.map(s=><button key={s.id} onClick={()=>fv("shift",s.id)} style={chip(form.shift===s.id)}>{s.label}<br/><span style={{fontSize:10,color:form.shift===s.id?C.accent:C.muted}}>{s.time}</span></button>)}
        </div>
      </div>
      <div>
        <span style={labelSt}>İş Emri *</span>
        {form.selectedOrder?(
          <div style={{background:C.surface,border:`1px solid ${C.accent}50`,borderRadius:10,padding:"12px 14px",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
            <div>
              <div style={{fontWeight:700,fontFamily:"monospace",fontSize:14,color:C.text}}>{form.selectedOrder.code}</div>
              <div style={{fontSize:12,color:C.muted2,marginTop:1}}>{form.selectedOrder.name} · {fmtSec(form.selectedOrder.partSec)} · Maks: {Number(form.selectedOrder.partSec)>0?Math.floor(EFFECTIVE_SECONDS/form.selectedOrder.partSec):"-"} adet/gün</div>
              {form.selectedOrder.material&&<div style={{fontSize:11,color:C.muted,marginTop:1}}>🔩 {form.selectedOrder.material}</div>}
            </div>
            <button onClick={()=>fv("selectedOrder",null)} style={{background:"transparent",border:"none",color:C.red,fontSize:20,cursor:"pointer"}}>×</button>
          </div>
        ):(
          <>
            <button onClick={()=>setShowPicker(!showPicker)} style={{...inputSt,textAlign:"left",cursor:"pointer",color:C.muted2,display:"block"}}>{orders.length===0?"Aktif iş emri yok":"İş emri seçin..."}</button>
            {showPicker&&(
              <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:10,marginTop:4,overflow:"hidden"}}>
                <input style={{...inputSt,borderRadius:0,borderBottom:`1px solid ${C.border}`}} placeholder="Ara..." value={search} onChange={e=>setSearch(e.target.value)} autoFocus/>
                <div style={{maxHeight:240,overflowY:"auto"}}>
                  {filtered.length===0&&<div style={{padding:16,color:C.muted2,textAlign:"center",fontSize:13}}>Sonuç yok</div>}
                  {filtered.map(o=>(
                    <div key={o.id} onClick={()=>{fv("selectedOrder",o);setShowPicker(false);setSearch("");}} style={{padding:"12px 14px",cursor:"pointer",borderBottom:`1px solid ${C.border}`}}>
                      <div style={{fontWeight:700,fontFamily:"monospace",fontSize:13,color:C.text}}>{o.code}</div>
                      <div style={{fontSize:12,color:C.muted2,marginTop:1}}>{o.name} · ⏱{fmtSec(o.partSec)} · {(o.machines||[]).join(", ")}</div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </>
        )}
      </div>
      <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,padding:"12px 14px"}}>
        <div style={{fontSize:11,color:C.muted2,textTransform:"uppercase",letterSpacing:.7,marginBottom:8}}>Seçili Takım Değişimi</div>
        {machineToolPicked?(
          <div style={{display:"flex",flexWrap:"wrap",gap:8}}>
            {machineToolPicked&&<Badge label={`İş Emri: ${machineToolPicked.code||machineToolPicked.name} x${Math.max(1,Number(form.machineToolQty)||1)}`} color={C.warn}/>}
          </div>
        ):(
          <div style={{fontSize:12,color:C.muted2}}>Takım değişimi seçilmedi</div>
        )}
      </div>
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10}}>
        <button onClick={openToolChangeModal} style={{...btnSt("ghost"),padding:14,fontSize:14,borderColor:C.warn+"55",color:C.warn}}>Takım Değişimi</button>
        <button onClick={openShiftEndModal} style={{...btnSt(saved?"green":"primary"),padding:14,fontSize:14}}>{editId?"Vardiya Sonu Güncelle":"Vardiya Sonu"}</button>
      </div>
      {tools.length===0&&<div style={{fontSize:12,color:C.warn}}>Takım stoğunda kayıt yok. Önce Takım Stoğu ekranından takım ekleyin.</div>}
      <div style={{fontSize:12,color:C.muted2}}>Kayıt, yalnızca <strong>Vardiya Sonu</strong> onaylandığında oluşturulur.</div>
      {showToolModal&&(
        <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,.65)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:40,padding:14}} onClick={()=>setShowToolModal(false)}>
          <div style={{width:"100%",maxWidth:680,background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:16}} onClick={e=>e.stopPropagation()}>
            <div style={{fontWeight:700,color:C.text,fontSize:16,marginBottom:10}}>Takım Değişimi</div>
            <div style={{display:"flex",gap:10,flexWrap:"wrap"}}>
              <div style={{flex:"1 1 260px"}}>
                <span style={labelSt}>İş Emri Takım Değişimi</span>
                <div style={{display:"grid",gridTemplateColumns:"1fr 95px",gap:8}}>
                  <select style={inputSt} value={toolDraft.machineToolId} onChange={e=>setToolDraft(p=>({...p,machineToolId:e.target.value}))}>
                    <option value="">Takım seç (opsiyonel)</option>
                    {toolOptions.map(t=><option key={t.id} value={t.id}>{t.code} - {t.name} (Stok: {Number(t.qty)||0})</option>)}
                  </select>
                  <input style={inputSt} type="number" min="1" placeholder="Adet" disabled={!toolDraft.machineToolId} value={toolDraft.machineToolQty} onChange={e=>setToolDraft(p=>({...p,machineToolQty:e.target.value}))}/>
                </div>
              </div>
            </div>
            <div style={{display:"flex",gap:8,justifyContent:"flex-end",marginTop:14}}>
              <button onClick={()=>setShowToolModal(false)} style={{...btnSt("ghost"),padding:"10px 14px"}}>İptal</button>
              <button onClick={approveToolChange} style={{...btnSt("primary"),padding:"10px 14px"}}>Değişimi Onayla</button>
            </div>
          </div>
        </div>
      )}
      {showShiftModal&&(
        <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,.65)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:40,padding:14}} onClick={()=>setShowShiftModal(false)}>
          <div style={{width:"100%",maxWidth:560,background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:16}} onClick={e=>e.stopPropagation()}>
            <div style={{fontWeight:700,color:C.text,fontSize:16,marginBottom:10}}>Vardiya Sonu</div>
            <div style={{display:"flex",gap:10}}>
              <div style={{flex:1}}><span style={labelSt}>✅ Doğru Adet *</span><input style={{...inputSt,borderColor:C.green+"50"}} type="number" min="0" placeholder="0" value={shiftDraft.correct} onChange={e=>setShiftDraft(p=>({...p,correct:e.target.value}))}/></div>
              <div style={{flex:1}}><span style={labelSt}>❌ Hatalı Adet</span><input style={{...inputSt,borderColor:C.red+"50"}} type="number" min="0" placeholder="0" value={shiftDraft.wrong} onChange={e=>setShiftDraft(p=>({...p,wrong:e.target.value}))}/></div>
            </div>
            <div style={{display:"flex",gap:8,justifyContent:"flex-end",marginTop:14}}>
              <button onClick={()=>setShowShiftModal(false)} style={{...btnSt("ghost"),padding:"10px 14px"}}>İptal</button>
              <button onClick={approveShiftEnd} style={{...btnSt(saved?"green":"primary"),padding:"10px 14px"}}>{editId?"Güncellemeyi Onayla":"Vardiyayı Onayla"}</button>
            </div>
          </div>
        </div>
      )}
      {todayEntries.length>0&&(
        <div>
          <span style={{...labelSt,marginTop:4}}>Seçili Gün Girişlerim</span>
          {todayEntries.slice(0,5).map(e=>{
            const p=calcPerf(e.correct,e.wrong,e.partSec);
            const machineToolQty=Number(e.machineToolQty??e.machineToolChange??0);
            return (
              <div key={e.id} style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,padding:"12px 14px",marginBottom:8}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                  <div><span style={{fontWeight:700,fontSize:13,fontFamily:"monospace",color:C.text}}>{e.jobCode}</span><span style={{fontSize:12,color:C.muted2,marginLeft:6}}>{e.jobName}</span></div>
                  <div style={{display:"flex",gap:5}}><Badge label={e.machine} color={C.accent}/><Badge label={e.shift} color={C.muted2}/></div>
                </div>
                <div style={{display:"flex",gap:12,marginTop:7,fontSize:13}}>
                  <span style={{color:C.green,fontWeight:600}}>✅ {e.correct}</span>
                  <span style={{color:C.red,fontWeight:600}}>❌ {e.wrong}</span>
                  {p&&<span style={{color:C.muted2}}>Maks/gün: {p.max}</span>}
                </div>
                {machineToolQty>0&&<div style={{display:"flex",gap:8,marginTop:7,fontSize:12,color:C.muted2,flexWrap:"wrap"}}>
                  {machineToolQty>0&&<Badge label={"İş Emri: "+((e.machineToolCode||e.machineToolName)?`${e.machineToolCode||e.machineToolName} x${machineToolQty}`:`${machineToolQty}`)} color={C.warn}/>}
                </div>}
                <div style={{marginTop:8,display:"flex",gap:8}}>
                  <button onClick={()=>startEdit(e)} style={{...btnSt("ghost"),padding:"6px 10px",fontSize:12}}>Düzenle</button>
                  <button onClick={()=>removeEntry(e)} style={{...btnSt("danger"),padding:"6px 10px",fontSize:12}}>Sil</button>
                </div>
                {p&&<PerfBar perf={p.perf} small/>}
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}

// ════════════════════════════════════════════════════════════
//  REPORT
// ════════════════════════════════════════════════════════════
function Report({currentUser,machines=DEFAULT_MACHINES}) {
  const [period,setPeriod]=useState("gunluk");
  const [rangeEnabled,setRangeEnabled]=useState(false);
  const [fromDate,setFromDate]=useState(()=>todayStr());
  const [toDate,setToDate]=useState(()=>todayStr());
  const [entries,setEntries]=useState([]);
  const [loading,setLoading]=useState(true);

  useEffect(()=>{window.DB.getAll("entries").then(e=>{setEntries(e);setLoading(false);});},[]);

  function applyRangePreset(type){
    const end=todayStr();
    const endDate=parseYmdLocal(end);
    let start=end;
    if(type==="last7"){
      const d=new Date(endDate); d.setDate(d.getDate()-6); start=ymdLocal(d);
    }else if(type==="last30"){
      const d=new Date(endDate); d.setDate(d.getDate()-29); start=ymdLocal(d);
    }else if(type==="thisMonth"){
      const d=new Date(endDate.getFullYear(),endDate.getMonth(),1); start=ymdLocal(d);
    }
    setRangeEnabled(true);
    setFromDate(start);
    setToDate(end);
  }

  const today=todayStr(),thisWeek=weekStart(),thisMonth=monthStr();
  const rangeStart=fromDate<=toDate?fromDate:toDate;
  const rangeEnd=fromDate<=toDate?toDate:fromDate;
  const filtered=entries.filter(e=>rangeEnabled?(e.date>=rangeStart&&e.date<=rangeEnd):(period==="gunluk"?e.date===today:period==="haftalik"?e.week===thisWeek:e.month===thisMonth));
  const byJob={};
  filtered.forEach(e=>{
    if(!byJob[e.jobCode]) byJob[e.jobCode]={jobCode:e.jobCode,jobName:e.jobName,correct:0,wrong:0,partSec:e.partSec,machines:new Set(),ops:new Set()};
    byJob[e.jobCode].correct+=e.correct; byJob[e.jobCode].wrong+=e.wrong;
    byJob[e.jobCode].machines.add(e.machine); byJob[e.jobCode].ops.add(e.operatorName||e.operatorId);
  });
  const jobs=Object.values(byJob).map(j=>({...j,machines:[...j.machines],ops:[...j.ops]}));
  const totalC=filtered.reduce((s,e)=>s+e.correct,0);
  const totalW=filtered.reduce((s,e)=>s+e.wrong,0);
  const qual=totalC+totalW>0?Math.round((totalC/(totalC+totalW))*100):0;
  const periodLabel=rangeEnabled?`Tarih Aralığı (${rangeStart} - ${rangeEnd})`:(period==="gunluk"?"Günlük":period==="haftalik"?"Haftalık":"Aylık");
  const dailyBars=machines.map(m=>{
    const md=filtered.filter(e=>e.machine===m);
    const correct=md.reduce((s,e)=>s+e.correct,0);
    const wrong=md.reduce((s,e)=>s+e.wrong,0);
    const total=correct+wrong;
    return {machine:m,correct,wrong,total};
  }).filter(x=>x.total>0);
  const dailyBarsPct=dailyBars.map(b=>({
    ...b,
    correctPct:(totalC+totalW)>0?(b.correct/(totalC+totalW))*100:0,
    wrongPct:(totalC+totalW)>0?(b.wrong/(totalC+totalW))*100:0,
  }));
  const dailyMaxPct=Math.max(5,Math.ceil((Math.max(0,...dailyBarsPct.map(b=>b.correctPct+b.wrongPct))+2)/5)*5);
  const chartPalette=["#4f8ef7","#00c896","#ffb830","#9b7ff4","#ff4d6d","#2dd4bf","#f97316","#38bdf8"];
  const dayKeys=(()=>{
    if(rangeEnabled){
      const start=parseYmdLocal(rangeStart);
      const end=parseYmdLocal(rangeEnd);
      const out=[];
      const cur=new Date(start);
      while(cur<=end&&out.length<120){
        out.push(ymdLocal(cur));
        cur.setDate(cur.getDate()+1);
      }
      return out;
    }
    if(period==="gunluk") return [today];
    if(period==="haftalik"){
      const start=parseYmdLocal(thisWeek);
      return Array.from({length:7},(_,i)=>{
        const d=new Date(start);
        d.setDate(start.getDate()+i);
        return ymdLocal(d);
      });
    }
    const [y,m]=thisMonth.split("-").map(Number);
    const count=new Date(y,m,0).getDate();
    return Array.from({length:count},(_,i)=>`${thisMonth}-${pad2(i+1)}`);
  })();
  const dayLabels=dayKeys.map(k=>{
    const d=parseYmdLocal(k);
    if(rangeEnabled) return String(d.getDate());
    if(period==="haftalik") return new Intl.DateTimeFormat("tr-TR",{weekday:"short",day:"2-digit"}).format(d);
    if(period==="aylik") return String(d.getDate());
    return new Intl.DateTimeFormat("tr-TR",{day:"2-digit",month:"2-digit"}).format(d);
  });
  const lineSeries=machines.map((m,i)=>{
    const totals=dayKeys.map(day=>filtered
      .filter(e=>e.machine===m&&e.date===day)
      .reduce((s,e)=>s+e.correct+e.wrong,0)
    );
    return {name:m,color:chartPalette[i%chartPalette.length],totals};
  });
  const maxLineValue=Math.max(1,...lineSeries.flatMap(s=>s.totals));

  if(loading) return <div style={{padding:30,color:C.muted2,textAlign:"center"}}>Yükleniyor...</div>;

  return (
    <div style={{padding:16}}>
      <div style={{display:"flex",gap:7,marginBottom:16}}>
        {[["gunluk","Günlük"],["haftalik","Haftalık"],["aylik","Aylık"]].map(([id,lbl])=>(
          <button key={id} onClick={()=>{setPeriod(id);setRangeEnabled(false);}} style={{flex:1,...chip(!rangeEnabled&&period===id)}}>{lbl}</button>
        ))}
      </div>
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"10px 12px",marginBottom:12}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:rangeEnabled?10:0}}>
          <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase"}}>Filtre</div>
          <button onClick={()=>setRangeEnabled(v=>!v)} style={chip(rangeEnabled,C.accent)}>{rangeEnabled?"Tarih Aralığı: Açık":"Tarih Aralığı"}</button>
        </div>
        {rangeEnabled&&(
          <div style={{display:"flex",flexDirection:"column",gap:8}}>
            <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
              <button onClick={()=>applyRangePreset("last7")} style={{...btnSt("ghost"),padding:"7px 10px",fontSize:12}}>Son 7 gün</button>
              <button onClick={()=>applyRangePreset("last30")} style={{...btnSt("ghost"),padding:"7px 10px",fontSize:12}}>Son 30 gün</button>
              <button onClick={()=>applyRangePreset("thisMonth")} style={{...btnSt("ghost"),padding:"7px 10px",fontSize:12}}>Bu ay</button>
            </div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr auto",gap:8,alignItems:"end"}}>
            <div><span style={labelSt}>Başlangıç</span><input type="date" value={fromDate} max={today} onChange={e=>setFromDate(e.target.value||today)} style={{...inputSt,padding:"9px 10px",fontSize:13}}/></div>
            <div><span style={labelSt}>Bitiş</span><input type="date" value={toDate} max={today} onChange={e=>setToDate(e.target.value||today)} style={{...inputSt,padding:"9px 10px",fontSize:13}}/></div>
            <button onClick={()=>{const t=todayStr();setFromDate(t);setToDate(t);}} style={{...btnSt("ghost"),padding:"9px 11px",fontSize:12,marginBottom:1}}>Bugün</button>
            </div>
          </div>
        )}
      </div>
      {filtered.length===0?(
        <div style={{textAlign:"center",color:C.muted2,padding:"40px 20px",background:C.card,borderRadius:14,border:`1px solid ${C.border}`}}><div style={{fontSize:36,marginBottom:10}}>📰</div>Bu dönemde kayıt yok</div>
      ):(
        <>
          <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"12px 14px",marginBottom:12}}>
            <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",marginBottom:10}}>Tezgah Grafiği · {periodLabel}</div>
            {period==="gunluk"?(
              <>
                <div style={{display:"flex",gap:14,alignItems:"center",marginBottom:8,fontSize:11,color:C.muted2}}>
                  <span style={{display:"inline-flex",alignItems:"center",gap:5}}><span style={{width:12,height:12,borderRadius:3,background:C.green,display:"inline-block"}}/>Doğru</span>
                  <span style={{display:"inline-flex",alignItems:"center",gap:5}}><span style={{width:12,height:12,borderRadius:3,background:C.red,display:"inline-block"}}/>Yanlış</span>
                </div>
                <div style={{height:250,overflowX:"auto"}}>
                  <svg width="100%" height="250" viewBox="0 0 760 250" preserveAspectRatio="none">
                    <rect x="0" y="0" width="760" height="250" fill="transparent"/>
                    {[0,1,2,3,4,5].map(i=>{
                      const y=210-(170*(i/5));
                      const v=Math.round((dailyMaxPct*i)/5);
                      return (
                        <g key={i}>
                          <line x1="58" y1={y} x2="740" y2={y} stroke={C.border} strokeWidth="1"/>
                          <text x="50" y={y+4} fill={C.muted2} fontSize="10" textAnchor="end">{v}%</text>
                        </g>
                      );
                    })}
                    <line x1="58" y1="40" x2="58" y2="210" stroke={C.muted2} strokeWidth="1.2"/>
                    <line x1="58" y1="210" x2="740" y2="210" stroke={C.muted2} strokeWidth="1.2"/>
                    {dailyBarsPct.map((b,i)=>{
                      const n=Math.max(dailyBarsPct.length,1);
                      const band=680/n;
                      const barW=Math.min(56,band*.62);
                      const x=60+(band*i)+((band-barW)/2);
                      const hCorrect=(b.correctPct/dailyMaxPct)*170;
                      const hWrong=(b.wrongPct/dailyMaxPct)*170;
                      const yCorrect=210-hCorrect;
                      const yWrong=yCorrect-hWrong;
                      return (
                        <g key={b.machine}>
                          <rect x={x} y={yCorrect} width={barW} height={Math.max(hCorrect,1)} fill={C.green}/>
                          <rect x={x} y={yWrong} width={barW} height={Math.max(hWrong,1)} fill={C.red}/>
                          {(b.correct+b.wrong)>0&&<text x={x+barW/2} y={Math.max(yWrong-6,16)} fill={C.text} fontSize="10" textAnchor="middle">{b.correct+b.wrong}</text>}
                          <text x={x+barW/2} y="228" fill={C.muted2} fontSize="10" textAnchor="middle">{b.machine}</text>
                        </g>
                      );
                    })}
                    <text x="399" y="245" fill={C.muted2} fontSize="11" textAnchor="middle">Tezgah</text>
                  </svg>
                </div>
                <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(120px,1fr))",gap:6}}>
                  {dailyBars.map(b=>(
                    <div key={b.machine} style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,padding:"6px 8px",fontSize:11,color:C.muted2}}>
                      <span style={{color:C.text,fontWeight:700}}>{b.machine}</span> · <span style={{color:C.green}}>✓ {b.correct}</span> <span style={{color:C.red}}>✕ {b.wrong}</span>
                    </div>
                  ))}
                </div>
              </>
            ):(
              <>
                <div style={{display:"flex",gap:12,flexWrap:"wrap",marginBottom:10}}>
                  {lineSeries.map(s=>(
                    <div key={s.name} style={{display:"flex",alignItems:"center",gap:6,fontSize:11,color:C.muted2}}>
                      <span style={{width:12,height:3,borderRadius:99,background:s.color,display:"inline-block"}}/>
                      <span>{s.name}</span>
                    </div>
                  ))}
                </div>
                <div style={{height:220,overflowX:"auto"}}>
                  <svg width="100%" height="220" viewBox="0 0 760 220" preserveAspectRatio="none">
                    <rect x="0" y="0" width="760" height="220" fill="transparent" />
                    {[0,1,2,3,4].map(i=>{
                      const y=20+i*40;
                      const v=Math.round(maxLineValue*((4-i)/4));
                      return (
                        <g key={i}>
                          <line x1="56" y1={y} x2="740" y2={y} stroke={C.border} strokeWidth="1" />
                          <text x="50" y={y+4} fill={C.muted2} fontSize="10" textAnchor="end">{v}</text>
                        </g>
                      );
                    })}
                    {lineSeries.map(s=>{
                      const n=Math.max(dayKeys.length-1,1);
                      const pts=s.totals.map((v,i)=>{
                        const x=56+(684*(i/n));
                        const y=180-((v/maxLineValue)*160);
                        return `${x},${y}`;
                      }).join(" ");
                      return <polyline key={s.name} points={pts} fill="none" stroke={s.color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" />;
                    })}
                    {dayLabels.map((lbl,i)=>{
                      const n=Math.max(dayLabels.length-1,1);
                      const x=56+(684*(i/n));
                      return <text key={i} x={x} y="206" fill={C.muted2} fontSize="10" textAnchor="middle">{lbl}</text>;
                    })}
                  </svg>
                </div>
              </>
            )}
          </div>
          <div style={{display:"flex",gap:8,marginBottom:16}}>
            {[{l:"Doğru",v:totalC,col:C.green},{l:"Hatalı",v:totalW,col:C.red},{l:"Kalite",v:`${qual}%`,col:qual>=90?C.green:qual>=75?C.warn:C.red}].map(({l,v,col})=>(
              <div key={l} style={{flex:1,background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"12px 14px"}}>
                <div style={{color:C.muted2,fontSize:10,letterSpacing:1,textTransform:"uppercase",marginBottom:3}}>{l}</div>
                <div style={{color:col,fontSize:24,fontWeight:800,fontFamily:"monospace"}}>{v}</div>
              </div>
            ))}
          </div>
          <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",marginBottom:10}}>İş Emri Bazlı</div>
          {jobs.map(j=>{
            const p=calcPerf(j.correct,j.wrong,j.partSec);
            const q=j.correct+j.wrong>0?Math.round((j.correct/(j.correct+j.wrong))*100):0;
            return (
              <div key={j.jobCode} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:"14px 16px",marginBottom:10}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:8}}>
                  <div><div style={{fontWeight:800,fontSize:14,fontFamily:"monospace",color:C.text}}>{j.jobCode}</div><div style={{fontSize:12,color:C.muted2,marginTop:1}}>{j.jobName}</div><div style={{fontSize:11,color:C.muted,marginTop:1}}>{j.machines.join(", ")} · {j.ops.join(", ")}</div></div>
                  <div style={{textAlign:"right"}}><div style={{fontSize:10,color:C.muted2}}>Kalite</div><div style={{fontWeight:800,color:q>=90?C.green:q>=75?C.warn:C.red,fontSize:16}}>{q}%</div></div>
                </div>
                <div style={{display:"flex",gap:8,fontSize:13,marginBottom:p?6:0}}>
                  <div style={{background:C.greenDim,border:`1px solid ${C.green}30`,borderRadius:8,padding:"5px 12px",color:C.green,fontWeight:700}}>✅ {j.correct}</div>
                  <div style={{background:C.redDim,border:`1px solid ${C.red}30`,borderRadius:8,padding:"5px 12px",color:C.red,fontWeight:700}}>❌ {j.wrong}</div>
                  {p&&<div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,padding:"5px 12px",color:C.muted2,fontSize:12}}>Maks/gün: {p.max}</div>}
                </div>
                {p&&<PerfBar perf={p.perf}/>}
              </div>
            );
          })}
          <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",marginBottom:10,marginTop:18}}>Tezgah Özeti</div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
            {machines.map(m=>{
              const md=filtered.filter(e=>e.machine===m);
              const mc=md.reduce((s,e)=>s+e.correct,0),mw=md.reduce((s,e)=>s+e.wrong,0);
              const mq=mc+mw>0?Math.round((mc/(mc+mw))*100):null;
              return (
                <div key={m} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"12px 14px",opacity:md.length===0?.4:1}}>
                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4}}><span style={{fontWeight:700,color:C.text}}>{m}</span>{mq!==null&&<span style={{color:mq>=90?C.green:mq>=75?C.warn:C.red,fontWeight:700,fontSize:13}}>{mq}%</span>}</div>
                  <div style={{fontSize:12,color:C.muted2}}>{md.length===0?"Kayıt yok":`✅ ${mc}  ❌ ${mw}`}</div>
                  {mq!==null&&<div style={{background:C.border,borderRadius:99,height:4,marginTop:8}}><div style={{width:`${mq}%`,height:"100%",background:mq>=90?C.green:mq>=75?C.warn:C.red,borderRadius:99}}/></div>}
                </div>
              );
            })}
          </div>
          {currentUser.role==="admin"&&(()=>{
            const byOp={};
            filtered.forEach(e=>{const k=e.operatorName||e.operatorId;if(!byOp[k])byOp[k]={name:k,correct:0,wrong:0};byOp[k].correct+=e.correct;byOp[k].wrong+=e.wrong;});
            const ops=Object.values(byOp).sort((a,b)=>b.correct-a.correct);
            if(!ops.length) return null;
            return (<>
              <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",marginBottom:10,marginTop:18}}>Operatör Performansı</div>
              {ops.map((op,i)=>{const q=op.correct+op.wrong>0?Math.round((op.correct/(op.correct+op.wrong))*100):0;return(
                <div key={op.name} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"12px 16px",marginBottom:8,display:"flex",alignItems:"center",gap:12}}>
                  <div style={{width:28,height:28,borderRadius:8,background:i===0?C.warn+"25":C.surface,display:"flex",alignItems:"center",justifyContent:"center",color:i===0?C.warn:C.muted2,fontWeight:800,fontSize:13}}>{i+1}</div>
                  <div style={{flex:1}}><div style={{fontWeight:600,fontSize:13,color:C.text}}>{op.name}</div><div style={{fontSize:12,color:C.muted2,marginTop:1}}>✅ {op.correct} &nbsp; ❌ {op.wrong}</div></div>
                  <div style={{color:q>=90?C.green:q>=75?C.warn:C.red,fontWeight:800,fontSize:15}}>{q}%</div>
                </div>
              );})}
            </>);
          })()}
        </>
      )}
    </div>
  );
}

// ════════════════════════════════════════════════════════════
//  PLANNING
// ════════════════════════════════════════════════════════════
function Planning({currentUser,machines=DEFAULT_MACHINES}) {
  const emptyForm={startDate:todayStr(),endDate:todayStr(),machine:machines[0]||"CNC-1",orderId:"",note:""};
  const [form,setForm]=useState(emptyForm);
  const [orders,setOrders]=useState([]);
  const [plans,setPlans]=useState([]);
  const [editId,setEditId]=useState(null);
  const [loading,setLoading]=useState(true);
  const [dateFilter,setDateFilter]=useState(todayStr());
  const [ganttMonth,setGanttMonth]=useState(monthStr());
  const [selectedPlan,setSelectedPlan]=useState(null);
  const [dragPlanId,setDragPlanId]=useState(null);
  const [exporting,setExporting]=useState(false);
  const ganttRef=useRef(null);

  useEffect(()=>{
    async function load(){
      const [o,p]=await Promise.all([window.DB.getAll("orders"),window.DB.getAll("plans")]);
      setOrders(o.filter(x=>isOpenOrderStatus(x.status)));
      setPlans(p.sort((a,b)=>(b.date||"").localeCompare(a.date||"")));
      setLoading(false);
    }
    load();
  },[]);

  useEffect(()=>{
    if(!machines.includes(form.machine)){
      setForm(f=>({...f,machine:machines[0]||"CNC-1"}));
    }
  },[machines.join(","),form.machine]);

  const fv=(k,v)=>setForm(f=>({...f,[k]:v}));
  const selectedOrder=orders.find(o=>o.id===form.orderId)||null;
  const allPlanSegments=buildPlanSegments(plans);
  const sortedPlanSegments=allPlanSegments.filter(seg=>!dateFilter||((seg.startDate||"")<=dateFilter&&(seg.endDate||"")>=dateFilter));
  const startObj=parseYmdLocal(form.startDate||todayStr());
  const endObj=parseYmdLocal(form.endDate||form.startDate||todayStr());
  const rangeStart=startObj<=endObj?startObj:endObj;
  const rangeEnd=startObj<=endObj?endObj:startObj;
  const rangeDays=Math.max(1,Math.floor((rangeEnd-rangeStart)/86400000)+1);
  const rangeLabel=`${ymdLocal(rangeStart)} - ${ymdLocal(rangeEnd)} (${rangeDays} gün)`;
  const ganttDate=new Date(...ganttMonth.split("-").map((x,i)=>i===1?Number(x)-1:Number(x)),1);
  const ganttDaysCount=new Date(ganttDate.getFullYear(),ganttDate.getMonth()+1,0).getDate();
  const ganttDays=Array.from({length:ganttDaysCount},(_,i)=>`${ganttMonth}-${pad2(i+1)}`);
  const monthPlans=plans.filter(p=>(p.date||"").startsWith(ganttMonth+"-"));
  const segmentById={};
  const ganttRows=machines.map(machine=>{
    const byDate={};
    const machinePlans=monthPlans
      .filter(p=>p.machine===machine)
      .sort((a,b)=>(a.date||"").localeCompare(b.date||""));
    let current=null;
    machinePlans.forEach(p=>{
      if(!current){
        current={machine,orderId:p.orderId,orderCode:p.orderCode,orderName:p.orderName,orderCustomerName:p.orderCustomerName,note:p.note,startDate:p.date,endDate:p.date,plans:[p]};
        return;
      }
      const prevDate=current.endDate;
      const nextDate=ymdLocal(new Date(parseYmdLocal(prevDate).getFullYear(),parseYmdLocal(prevDate).getMonth(),parseYmdLocal(prevDate).getDate()+1));
      const sameOrder=(current.orderId||"")===(p.orderId||"");
      if(sameOrder&&p.date===nextDate){
        current.endDate=p.date;
        current.plans.push(p);
      }else{
        const segId=`${current.machine}|${current.orderId||current.orderCode||"x"}|${current.startDate}|${current.endDate}`;
        const seg={...current,id:segId};
        segmentById[segId]=seg;
        current.plans.forEach(cp=>{
          byDate[cp.date]={...cp,_segmentId:segId,_isStart:cp.date===seg.startDate,_isEnd:cp.date===seg.endDate};
        });
        current={machine,orderId:p.orderId,orderCode:p.orderCode,orderName:p.orderName,orderCustomerName:p.orderCustomerName,note:p.note,startDate:p.date,endDate:p.date,plans:[p]};
      }
    });
    if(current){
      const segId=`${current.machine}|${current.orderId||current.orderCode||"x"}|${current.startDate}|${current.endDate}`;
      const seg={...current,id:segId};
      segmentById[segId]=seg;
      current.plans.forEach(cp=>{
        byDate[cp.date]={...cp,_segmentId:segId,_isStart:cp.date===seg.startDate,_isEnd:cp.date===seg.endDate};
      });
    }
    return {machine,byDate};
  });
  const orderColorPalette=["#4f8ef7","#00c896","#ffb830","#9b7ff4","#ff4d6d","#2dd4bf","#f97316","#38bdf8","#22c55e","#ef4444","#eab308","#14b8a6"];
  function colorFromOrder(orderId){
    const key=String(orderId||"");
    let h=0;
    for(let i=0;i<key.length;i++) h=((h<<5)-h)+key.charCodeAt(i);
    return orderColorPalette[Math.abs(h)%orderColorPalette.length];
  }
  const monthOrderMap={};
  monthPlans.forEach(p=>{if(p.orderId&&!monthOrderMap[p.orderId]) monthOrderMap[p.orderId]={id:p.orderId,code:p.orderCode,name:p.orderName,customer:p.orderCustomerName||"",color:colorFromOrder(p.orderId)};});
  const monthOrders=Object.values(monthOrderMap);
  function shiftGanttMonth(delta){
    const [y,m]=ganttMonth.split("-").map(Number);
    const d=new Date(y,m-1+delta,1);
    setGanttMonth(`${d.getFullYear()}-${pad2(d.getMonth()+1)}`);
  }
  const ganttMonthLabel=new Intl.DateTimeFormat("tr-TR",{month:"long",year:"numeric"}).format(new Date(ganttDate.getFullYear(),ganttDate.getMonth(),1));

  async function refreshPlans(){
    const p=await window.DB.getAll("plans");
    setPlans(p.sort((a,b)=>(b.date||"").localeCompare(a.date||"")));
  }

  async function resizeSegment(segmentId,targetDate,edge){
    const seg=segmentById[segmentId];
    if(!seg||!targetDate) return;
    const oldStart=seg.startDate;
    const oldEnd=seg.endDate;
    const nextStart=edge==="start"?(targetDate<=oldEnd?targetDate:oldEnd):oldStart;
    const nextEnd=edge==="end"?(targetDate>=oldStart?targetDate:oldStart):oldEnd;
    if(nextStart===oldStart&&nextEnd===oldEnd) return;
    const oldDates=getDateRange(oldStart,oldEnd);
    const nextDates=getDateRange(nextStart,nextEnd);
    const oldSet=new Set(oldDates);
    const nextSet=new Set(nextDates);
    const toRemove=oldDates.filter(d=>!nextSet.has(d));
    const toAdd=nextDates.filter(d=>!oldSet.has(d));
    const segPlanByDate={};
    seg.plans.forEach(p=>{segPlanByDate[p.date]=p;});
    const segPlanIds=new Set(seg.plans.map(p=>p.id));
    const duplicateAdd=toAdd.filter(d=>plans.some(p=>p.machine===seg.machine&&p.date===d&&!segPlanByDate[d]));
    if(duplicateAdd.length>0){
      alert(`Çakışma var: ${duplicateAdd.slice(0,4).join(", ")}`);
      return;
    }
    if(editId&&segPlanIds.has(editId)){
      setForm(f=>({...f,startDate:nextStart,endDate:nextEnd}));
    }
    const base=seg.plans[0];
    for(const d of toRemove){
      const p=segPlanByDate[d];
      if(p){
        const ok=await window.DB.deleteDoc("plans",p.id);
        if(!ok){alert("Plan güncellenemedi (silme).");await refreshPlans();return;}
      }
    }
    for(const d of toAdd){
      const data={
        machine:seg.machine,
        orderId:base.orderId||"",
        orderCode:base.orderCode||"",
        orderName:base.orderName||"",
        orderPartSec:base.orderPartSec||0,
        orderCustomerName:base.orderCustomerName||"",
        note:base.note||"",
        status:base.status||"planned",
        createdBy:base.createdBy||"",
        date:d,
        week:weekStart(parseYmdLocal(d)),
        month:monthStr(parseYmdLocal(d)),
        updatedAt:new Date().toISOString(),
      };
      const id=await window.DB.addDoc("plans",data);
      if(!id){alert("Plan güncellenemedi (ekleme).");await refreshPlans();return;}
    }
    await refreshPlans();
  }

  async function loadScriptOnce(src,globalName){
    if(globalName&&window[globalName]) return true;
    if(document.querySelector(`script[data-src="${src}"]`)) return true;
    const s=document.createElement("script");
    s.src=src;
    s.async=true;
    s.dataset.src=src;
    document.head.appendChild(s);
    await new Promise((res,rej)=>{s.onload=res;s.onerror=rej;});
    return true;
  }

  async function exportGanttPng(){
    if(!ganttRef.current) return;
    try{
      setExporting(true);
      await loadScriptOnce("https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js","html2canvas");
      const canvas=await window.html2canvas(ganttRef.current,{backgroundColor:"#12151f",scale:2});
      const a=document.createElement("a");
      a.href=canvas.toDataURL("image/png");
      a.download=`gantt-${ganttMonth}.png`;
      a.click();
    }catch{
      alert("PNG dışa aktarma başarısız.");
    }finally{
      setExporting(false);
    }
  }

  async function exportGanttPdf(){
    if(!ganttRef.current) return;
    try{
      setExporting(true);
      await loadScriptOnce("https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js","html2canvas");
      await loadScriptOnce("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js","jspdf");
      const canvas=await window.html2canvas(ganttRef.current,{backgroundColor:"#12151f",scale:2});
      const imgData=canvas.toDataURL("image/png");
      const {jsPDF}=window.jspdf;
      const pdf=new jsPDF({orientation:"landscape",unit:"pt",format:"a4"});
      const w=pdf.internal.pageSize.getWidth();
      const h=pdf.internal.pageSize.getHeight();
      const ratio=Math.min(w/canvas.width,h/canvas.height);
      const rw=canvas.width*ratio;
      const rh=canvas.height*ratio;
      const x=(w-rw)/2;
      const y=(h-rh)/2;
      pdf.addImage(imgData,"PNG",x,y,rw,rh);
      pdf.save(`gantt-${ganttMonth}.pdf`);
    }catch{
      alert("PDF dışa aktarma başarısız.");
    }finally{
      setExporting(false);
    }
  }

  function getDateRange(startDate,endDate){
    const s=parseYmdLocal(startDate);
    const e=parseYmdLocal(endDate);
    const from=s<=e?s:e;
    const to=s<=e?e:s;
    const out=[];
    const d=new Date(from);
    while(d<=to){
      out.push(ymdLocal(d));
      d.setDate(d.getDate()+1);
    }
    return out;
  }
  function samePlanOrder(a,b){
    return String(a?.orderId||a?.orderCode||"")===String(b?.orderId||b?.orderCode||"");
  }
  function buildPlanSegments(list){
    const byMachine={};
    list.forEach(p=>{
      const key=p.machine||"";
      if(!byMachine[key]) byMachine[key]=[];
      byMachine[key].push(p);
    });
    const out=[];
    Object.keys(byMachine).forEach(machine=>{
      const rows=[...byMachine[machine]].sort((a,b)=>(a.date||"").localeCompare(b.date||""));
      let cur=null;
      rows.forEach(p=>{
        if(!cur){
          cur={machine,orderId:p.orderId||"",orderCode:p.orderCode||"",orderName:p.orderName||"",orderCustomerName:p.orderCustomerName||"",note:p.note||"",startDate:p.date||"",endDate:p.date||"",plans:[p]};
          return;
        }
        const nextDate=ymdLocal(new Date(parseYmdLocal(cur.endDate).getFullYear(),parseYmdLocal(cur.endDate).getMonth(),parseYmdLocal(cur.endDate).getDate()+1));
        if(samePlanOrder(cur,p)&&p.date===nextDate){
          cur.endDate=p.date;
          cur.plans.push(p);
        }else{
          out.push({...cur,id:`${cur.machine}|${cur.orderId||cur.orderCode||"x"}|${cur.startDate}|${cur.endDate}`});
          cur={machine,orderId:p.orderId||"",orderCode:p.orderCode||"",orderName:p.orderName||"",orderCustomerName:p.orderCustomerName||"",note:p.note||"",startDate:p.date||"",endDate:p.date||"",plans:[p]};
        }
      });
      if(cur) out.push({...cur,id:`${cur.machine}|${cur.orderId||cur.orderCode||"x"}|${cur.startDate}|${cur.endDate}`});
    });
    return out.sort((a,b)=>{
      const da=(a.startDate||"").localeCompare(b.startDate||"");
      if(da!==0) return da;
      return (a.machine||"").localeCompare(b.machine||"");
    });
  }
  function findSegmentForPlan(plan){
    if(!plan) return null;
    if(plan._segmentId&&segmentById[plan._segmentId]) return segmentById[plan._segmentId];
    const all=buildPlanSegments(plans);
    return all.find(seg=>(seg.plans||[]).some(x=>x.id===plan.id))||null;
  }

  async function savePlan(){
    if(!form.startDate||!form.endDate){alert("Tarih aralığı seçin!");return;}
    if(!form.machine){alert("Tezgah seçin!");return;}
    if(!form.orderId){alert("İş emri seçin!");return;}
    const picked=orders.find(o=>o.id===form.orderId);
    if(!picked){alert("Geçerli bir iş emri seçin!");return;}
    const planDates=editId?[form.startDate]:getDateRange(form.startDate,form.endDate);
    const duplicateDates=planDates.filter(dt=>plans.some(p=>p.id!==editId&&p.date===dt&&p.machine===form.machine));
    if(duplicateDates.length>0){
      alert(`Bu tezgah için plan zaten var: ${duplicateDates.slice(0,5).join(", ")}${duplicateDates.length>5?" ...":""}`);
      return;
    }
    const baseData={
      machine:form.machine,
      orderId:picked.id,
      orderCode:picked.code,
      orderName:picked.name,
      orderPartSec:Number(picked.partSec)||0,
      orderCustomerName:picked.customerName||"",
      note:form.note.trim(),
      status:"planned",
      updatedAt:new Date().toISOString(),
      ...(editId?{}:{createdBy:currentUser.id}),
    };
    if(editId){
      const seg=buildPlanSegments(plans).find(s=>(s.plans||[]).some(x=>x.id===editId))||null;
      if(!seg||!seg.plans||seg.plans.length===0){alert("Düzenlenecek plan bulunamadı.");return;}
      const segIds=new Set(seg.plans.map(x=>x.id));
      const targetDates=getDateRange(form.startDate,form.endDate);
      const duplicateDates=targetDates.filter(dt=>plans.some(p=>!segIds.has(p.id)&&p.date===dt&&p.machine===form.machine));
      if(duplicateDates.length>0){
        alert(`Bu tezgah için plan zaten var: ${duplicateDates.slice(0,5).join(", ")}${duplicateDates.length>5?" ...":""}`);
        return;
      }
      for(const old of seg.plans){
        const ok=await window.DB.deleteDoc("plans",old.id);
        if(!ok){alert("Plan güncellenemedi (silme).");await refreshPlans();return;}
      }
      const recreated=[];
      for(const dt of targetDates){
        const data={
          ...baseData,
          date:dt,
          week:weekStart(parseYmdLocal(dt)),
          month:monthStr(parseYmdLocal(dt)),
        };
        const id=await window.DB.addDoc("plans",data);
        if(!id){alert("Plan güncellenemedi (ekleme).");await refreshPlans();return;}
        recreated.push({id,...data});
      }
      setPlans(prev=>{
        const cleaned=prev.filter(x=>!segIds.has(x.id));
        return [...recreated.reverse(),...cleaned];
      });
      setEditId(null);
      setForm({...emptyForm,machine:form.machine,startDate:form.startDate,endDate:form.endDate});
      return;
    }
    const created=[];
    for(const dt of planDates){
      const data={
        ...baseData,
        date:dt,
        week:weekStart(parseYmdLocal(dt)),
        month:monthStr(parseYmdLocal(dt)),
      };
      const id=await window.DB.addDoc("plans",data);
      if(!id){
        alert(`Plan kaydı sırasında hata oluştu. Oluşan kayıt: ${created.length}/${planDates.length}`);
        break;
      }
      created.push({id,...data});
    }
    if(created.length>0){
      setPlans(p=>[...created.reverse(),...p]);
      setForm({...emptyForm,machine:form.machine,startDate:form.startDate,endDate:form.endDate});
    }
  }

  function startEdit(plan){
    const seg=(plan&&plan.plans&&plan.plans.length)?plan:findSegmentForPlan(plan);
    const firstPlan=(seg&&seg.plans&&seg.plans.length)?seg.plans[0]:plan;
    setEditId(firstPlan?.id||null);
    setForm({
      startDate:seg?.startDate||firstPlan?.date||todayStr(),
      endDate:seg?.endDate||firstPlan?.date||todayStr(),
      machine:firstPlan?.machine||machines[0]||"CNC-1",
      orderId:firstPlan?.orderId||"",
      note:firstPlan?.note||"",
    });
  }

  async function removePlan(plan){
    const seedPlan=(plan&&plan.plans&&plan.plans.length)?plan.plans[0]:plan;
    const segment=findSegmentForPlan(seedPlan)||(plan&&plan.plans&&plan.plans.length?plan:null);
    if(!segment||!segment.plans||segment.plans.length===0){alert("Silinecek plan bulunamadı.");return;}
    if(!confirm(`Plan silinsin mi? (${segment.orderCode||"-"} / ${segment.machine||"-"} / ${segment.startDate||"-"} - ${segment.endDate||"-"})`)) return;
    for(const p of segment.plans){
      const ok=await window.DB.deleteDoc("plans",p.id);
      if(!ok){alert("Plan silinemedi.");await refreshPlans();return;}
    }
    const removedIds=new Set(segment.plans.map(x=>x.id));
    setPlans(prev=>prev.filter(x=>!removedIds.has(x.id)));
    if(editId&&removedIds.has(editId)){
      setEditId(null);
      setForm({...emptyForm,machine:form.machine,startDate:form.startDate,endDate:form.endDate});
    }
  }

  if(loading) return <div style={{padding:30,color:C.muted2,textAlign:"center"}}>Yükleniyor...</div>;

  return (
    <div style={{padding:16,display:"flex",flexDirection:"column",gap:12}}>
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:14}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",gap:8,flexWrap:"wrap",marginBottom:10}}>
          <div style={{fontWeight:700,color:C.text}}>Aylık Plan Gantt</div>
          <div style={{display:"flex",alignItems:"center",gap:6,flexWrap:"wrap",justifyContent:"flex-end"}}>
            <button onClick={()=>shiftGanttMonth(-1)} style={{...btnSt("ghost"),padding:"6px 10px",fontSize:12}}>◀</button>
            <div style={{fontSize:13,color:C.text,minWidth:140,textAlign:"center",textTransform:"capitalize"}}>{ganttMonthLabel}</div>
            <button onClick={()=>shiftGanttMonth(1)} style={{...btnSt("ghost"),padding:"6px 10px",fontSize:12}}>▶</button>
            <button onClick={()=>setGanttMonth(monthStr())} style={{...btnSt("ghost"),padding:"6px 10px",fontSize:12}}>Bu Ay</button>
            <button onClick={exportGanttPng} disabled={exporting} style={{...btnSt("ghost"),padding:"6px 10px",fontSize:12,opacity:exporting?0.7:1}}>PNG</button>
            <button onClick={exportGanttPdf} disabled={exporting} style={{...btnSt("ghost"),padding:"6px 10px",fontSize:12,opacity:exporting?0.7:1}}>PDF</button>
          </div>
        </div>
        {monthOrders.length>0&&<div style={{display:"flex",gap:7,flexWrap:"wrap",marginBottom:10}}>
          {monthOrders.map(o=><span key={o.id} style={{display:"inline-flex",alignItems:"center",gap:6,background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,padding:"4px 8px",fontSize:11,color:C.muted2}}><span style={{width:10,height:10,borderRadius:3,background:o.color,display:"inline-block"}}/>{o.code?`${o.code} - ${o.name||""}${o.customer?` - ${o.customer}`:""}`:(o.name||"İş Emri")}</span>)}
        </div>}
        <div style={{overflowX:"hidden"}} ref={ganttRef}>
          <div>
            <div style={{display:"grid",gridTemplateColumns:`92px repeat(${ganttDays.length}, minmax(0,1fr))`,columnGap:1,rowGap:2,alignItems:"center",marginBottom:6}}>
              <div style={{fontSize:10,color:C.muted2,fontWeight:700,textTransform:"uppercase",letterSpacing:.6}}>Tezgah</div>
              {ganttDays.map((d,i)=>{
                const wd=parseYmdLocal(d).getDay();
                const weekend=wd===0||wd===6;
                return <div key={d} style={{fontSize:9,textAlign:"center",color:weekend?C.warn:C.muted2,opacity:weekend?0.95:0.85,lineHeight:1}}>{i+1}</div>;
              })}
            </div>
            {ganttRows.map(row=>(
              <div key={row.machine} style={{display:"grid",gridTemplateColumns:`92px repeat(${ganttDays.length}, minmax(0,1fr))`,columnGap:1,rowGap:2,alignItems:"center",marginBottom:4}}>
                <div style={{fontSize:11,fontWeight:700,color:C.text,paddingRight:4,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{row.machine}</div>
                {ganttDays.map(d=>{
                  const p=row.byDate[d];
                  if(!p) return <div key={d} onDragOver={e=>e.preventDefault()} onDrop={async e=>{e.preventDefault();const raw=e.dataTransfer.getData("text/plain")||dragPlanId;if(!raw) return;let payload=null;try{payload=JSON.parse(raw);}catch{}if(payload&&payload.type&&payload.segmentId){await resizeSegment(payload.segmentId,d,payload.type);}setDragPlanId(null);}} style={{height:16,borderRadius:3,background:C.surface,border:`1px solid ${C.border}`}}/>;
                  const col=colorFromOrder(p.orderId||p.orderCode||p.orderName);
                  return <div
                    key={d}
                    title={`${d} · ${row.machine} · ${p.orderCode||""} ${p.orderName||""}${p.orderCustomerName?` · ${p.orderCustomerName}`:""}`}
                    onDragOver={e=>e.preventDefault()}
                    onDrop={async e=>{e.preventDefault();const raw=e.dataTransfer.getData("text/plain")||dragPlanId;if(!raw) return;let payload=null;try{payload=JSON.parse(raw);}catch{}if(payload&&payload.type&&payload.segmentId){await resizeSegment(payload.segmentId,d,payload.type);}setDragPlanId(null);}}
                    onClick={()=>setSelectedPlan(p)}
                    style={{height:16,borderRadius:3,background:col,border:`1px solid ${col}99`,boxShadow:`inset 0 0 0 1px ${col}99`,cursor:"pointer",position:"relative"}}
                  >
                    {p._isStart&&<span
                      draggable
                      onDragStart={e=>{const payload=JSON.stringify({type:"start",segmentId:p._segmentId});setDragPlanId(payload);e.dataTransfer.setData("text/plain",payload);}}
                      title="Başlangıcı sürükle"
                      style={{position:"absolute",left:0,top:0,bottom:0,width:5,background:"rgba(0,0,0,.35)",cursor:"ew-resize"}}
                    />}
                    {p._isEnd&&<span
                      draggable
                      onDragStart={e=>{const payload=JSON.stringify({type:"end",segmentId:p._segmentId});setDragPlanId(payload);e.dataTransfer.setData("text/plain",payload);}}
                      title="Bitişi sürükle"
                      style={{position:"absolute",right:0,top:0,bottom:0,width:5,background:"rgba(0,0,0,.35)",cursor:"ew-resize"}}
                    />}
                  </div>;
                })}
              </div>
            ))}
          </div>
        </div>
      </div>
      {selectedPlan&&(
        <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,.65)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:50,padding:14}} onClick={()=>setSelectedPlan(null)}>
          <div style={{width:"100%",maxWidth:520,background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:16}} onClick={e=>e.stopPropagation()}>
            <div style={{fontWeight:700,color:C.text,fontSize:16,marginBottom:10}}>Plan Detayı</div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,fontSize:13,color:C.muted2}}>
              <div><strong>Tarih:</strong> {selectedPlan.date||"-"}</div>
              <div><strong>Tezgah:</strong> {selectedPlan.machine||"-"}</div>
              <div><strong>İş Emri:</strong> {selectedPlan.orderCode||"-"}</div>
              <div><strong>Ad:</strong> {selectedPlan.orderName||"-"}</div>
              <div><strong>Firma:</strong> {selectedPlan.orderCustomerName||"-"}</div>
            </div>
            {selectedPlan.note&&<div style={{marginTop:10,fontSize:13,color:C.muted2}}>{selectedPlan.note}</div>}
            <div style={{display:"flex",gap:8,justifyContent:"flex-end",marginTop:14}}>
              <button onClick={()=>setSelectedPlan(null)} style={{...btnSt("ghost"),padding:"9px 12px"}}>Kapat</button>
              <button onClick={()=>{startEdit(selectedPlan);setSelectedPlan(null);}} style={{...btnSt("ghost"),padding:"9px 12px"}}>Düzenle</button>
              <button onClick={async()=>{const p=selectedPlan;setSelectedPlan(null);await removePlan(p);}} style={{...btnSt("danger"),padding:"9px 12px"}}>Sil</button>
            </div>
          </div>
        </div>
      )}
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:14}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
          <div style={{fontWeight:700,color:C.text}}>Planlama</div>
          {editId&&<Badge label="Düzenleme" color={C.warn}/>}
        </div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
          <div><span style={labelSt}>Başlangıç</span><input type="date" value={form.startDate} onChange={e=>fv("startDate",e.target.value||todayStr())} style={{...inputSt,padding:"9px 10px",fontSize:13}}/></div>
          <div><span style={labelSt}>Bitiş</span><input type="date" value={form.endDate} onChange={e=>fv("endDate",e.target.value||form.startDate||todayStr())} style={{...inputSt,padding:"9px 10px",fontSize:13}}/></div>
        </div>
        <div style={{fontSize:12,color:C.muted2,marginTop:6}}>{editId?`Düzenlenen aralık: ${form.startDate}${form.endDate&&form.endDate!==form.startDate?` - ${form.endDate}`:""}`:`Uygulanacak aralık: ${rangeLabel}`}</div>
        <div style={{marginTop:9}}>
          <span style={labelSt}>Tezgah</span>
          <div style={{display:"flex",gap:7,flexWrap:"wrap"}}>
            {machines.map(m=><button key={m} onClick={()=>fv("machine",m)} style={chip(form.machine===m)}>{m}</button>)}
          </div>
        </div>
        <div style={{marginTop:9}}>
          <span style={labelSt}>İş Emri</span>
          <select value={form.orderId} onChange={e=>fv("orderId",e.target.value)} style={inputSt}>
            <option value="">İş emri seçin...</option>
            {orders.map(o=><option key={o.id} value={o.id}>{o.code} - {o.name}{o.customerName?` - ${o.customerName}`:""} ({(o.machines||[]).join(", ")})</option>)}
          </select>
          {selectedOrder&&<div style={{fontSize:12,color:C.muted2,marginTop:6}}>Parça süresi: {fmtSec(selectedOrder.partSec)} · Maks/gün: {selectedOrder.partSec?Math.floor(EFFECTIVE_SECONDS/selectedOrder.partSec):"-"}</div>}
        </div>
        <div style={{marginTop:9}}>
          <span style={labelSt}>Not</span>
          <textarea value={form.note} onChange={e=>fv("note",e.target.value)} rows={2} style={{...inputSt,minHeight:64,resize:"vertical"}} placeholder="Opsiyonel not..."/>
        </div>
        <div style={{display:"flex",gap:8,marginTop:10}}>
          <button onClick={savePlan} style={{...btnSt("primary"),flex:1,padding:12}}>{editId?"Planı Güncelle":"Aralığı Planla"}</button>
          {editId&&<button onClick={()=>{setEditId(null);setForm({...emptyForm,machine:form.machine,startDate:form.startDate,endDate:form.endDate});}} style={{...btnSt("ghost"),padding:"12px 14px"}}>İptal</button>}
        </div>
      </div>

      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"10px 12px",display:"flex",justifyContent:"space-between",alignItems:"center",gap:8,flexWrap:"wrap"}}>
        <div style={{fontSize:12,color:C.muted2}}>Planlar ({sortedPlanSegments.length})</div>
        <div style={{display:"flex",gap:8,alignItems:"center"}}>
          <input type="date" value={dateFilter} onChange={e=>setDateFilter(e.target.value)} style={{...inputSt,padding:"7px 9px",fontSize:12,minWidth:150}}/>
          {dateFilter&&<button onClick={()=>setDateFilter("")} style={{...btnSt("ghost"),padding:"7px 10px",fontSize:12}}>Tümü</button>}
        </div>
      </div>

      {sortedPlanSegments.length===0&&<div style={{textAlign:"center",color:C.muted2,padding:"28px 20px",background:C.card,borderRadius:14,border:`1px solid ${C.border}`}}>Plan bulunamadı</div>}
      {sortedPlanSegments.map(seg=>(
        <div key={seg.id} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:"12px 14px"}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",gap:8}}>
            <div>
              <div style={{fontWeight:800,fontFamily:"monospace",fontSize:14,color:C.text}}>{seg.orderCode}</div>
              <div style={{fontSize:12,color:C.muted2,marginTop:2}}>{seg.orderName}{seg.orderCustomerName?` - ${seg.orderCustomerName}`:""}</div>
            </div>
            <div style={{display:"flex",gap:5,flexWrap:"wrap",justifyContent:"flex-end"}}>
              <Badge label={`${seg.startDate||"-"}${seg.endDate&&seg.endDate!==seg.startDate?` - ${seg.endDate}`:""}`} color={C.accent}/>
              <Badge label={seg.machine||"-"} color={C.warn}/>
            </div>
          </div>
          {seg.note&&<div style={{marginTop:8,fontSize:12,color:C.muted2}}>{seg.note}</div>}
          <div style={{marginTop:9,display:"flex",gap:8}}>
            <button onClick={()=>startEdit((seg.plans&&seg.plans[0])||seg)} style={{...btnSt("ghost"),padding:"6px 10px",fontSize:12}}>Düzenle</button>
            <button onClick={()=>removePlan(seg)} style={{...btnSt("danger"),padding:"6px 10px",fontSize:12}}>Sil</button>
          </div>
        </div>
      ))}
    </div>
  );
}

// ════════════════════════════════════════════════════════════
//  MACHINE CONNECTIVITY PREP
// ════════════════════════════════════════════════════════════
function MachineConnectivityPrep({currentUser,machines=DEFAULT_MACHINES}) {
  const emptyForm={
    code:"",
    machineName:machines[0]||"CNC-1",
    brand:"Fanuc",
    protocol:"FOCAS2",
    connectionMode:"not_connected",
    ip:"",
    port:"",
    pollingSec:"10",
    timezone:"Europe/Istanbul",
    edgeAgent:"IPC-01",
    ncTransfer:"bidirectional",
    notes:"",
    dataPoints:{...MACHINE_DEFAULT_POINTS},
  };
  const [profiles,setProfiles]=useState([]);
  const [loading,setLoading]=useState(true);
  const [showForm,setShowForm]=useState(false);
  const [editId,setEditId]=useState(null);
  const [form,setForm]=useState(emptyForm);
  const [search,setSearch]=useState("");
  const [simMap,setSimMap]=useState({});
  const [savingEdge,setSavingEdge]=useState(false);
  const [edgeConfig,setEdgeConfig]=useState({
    ipcName:"IPC-01",
    location:"Atolye A",
    defaultPollingSec:10,
    maxBufferRows:5000,
    resendSec:5,
    syncBatch:200,
    timezone:"Europe/Istanbul",
  });

  const load=useCallback(async()=>{
    const [rows,edgeDoc,mockRows]=await Promise.all([
      window.DB.getAll("machineConnectors"),
      window.DB.getDoc("config","edgeConnectivity"),
      window.DB.getAll("machineTelemetryMock"),
    ]);
    setProfiles(rows.sort((a,b)=>(a.machineName||"").localeCompare(b.machineName||"","tr")));
    if(edgeDoc){
      setEdgeConfig(prev=>({
        ...prev,
        ipcName:edgeDoc.ipcName||prev.ipcName,
        location:edgeDoc.location||prev.location,
        defaultPollingSec:Number(edgeDoc.defaultPollingSec)||prev.defaultPollingSec,
        maxBufferRows:Number(edgeDoc.maxBufferRows)||prev.maxBufferRows,
        resendSec:Number(edgeDoc.resendSec)||prev.resendSec,
        syncBatch:Number(edgeDoc.syncBatch)||prev.syncBatch,
        timezone:edgeDoc.timezone||prev.timezone,
      }));
    }
    const latest={};
    mockRows
      .sort((a,b)=>(b.collectedAtUtc||"").localeCompare(a.collectedAtUtc||""))
      .forEach(r=>{
        if(!r.machineId||latest[r.machineId]) return;
        latest[r.machineId]=r;
      });
    setSimMap(latest);
    setLoading(false);
  },[]);
  useEffect(()=>{load();},[load]);

  useEffect(()=>{
    const options=MACHINE_PROTOCOL_OPTIONS[form.brand]||[];
    if(options.length===0||options.includes(form.protocol)) return;
    setForm(f=>({...f,protocol:options[0]}));
  },[form.brand,form.protocol]);

  const protocolOptions=MACHINE_PROTOCOL_OPTIONS[form.brand]||[];
  const fv=(k,v)=>setForm(f=>({...f,[k]:v}));
  const fp=(k,v)=>setForm(f=>({...f,dataPoints:{...f.dataPoints,[k]:v}}));
  const fe=(k,v)=>setEdgeConfig(p=>({...p,[k]:v}));

  function nextConnectorCode(list=profiles){
    const nums=list.map(r=>{
      const m=String(r.code||"").toUpperCase().match(/^MC-(\d+)$/);
      return m?Number(m[1]):null;
    }).filter(n=>n!==null);
    const next=(nums.length?Math.max(...nums):0)+1;
    return `MC-${String(next).padStart(3,"0")}`;
  }

  function modeMeta(mode){
    if(mode==="live") return {label:"Canli",color:C.green};
    if(mode==="simulation") return {label:"Simulasyon",color:C.warn};
    return {label:"Bagli Degil",color:C.muted2};
  }

  async function saveEdgeConfig(){
    setSavingEdge(true);
    const payload={
      ipcName:(edgeConfig.ipcName||"IPC-01").trim(),
      location:(edgeConfig.location||"").trim(),
      defaultPollingSec:Math.max(1,Number(edgeConfig.defaultPollingSec)||10),
      maxBufferRows:Math.max(100,Number(edgeConfig.maxBufferRows)||5000),
      resendSec:Math.max(1,Number(edgeConfig.resendSec)||5),
      syncBatch:Math.max(1,Number(edgeConfig.syncBatch)||200),
      timezone:(edgeConfig.timezone||"Europe/Istanbul").trim(),
      updatedAt:new Date().toISOString(),
      updatedBy:currentUser.id,
    };
    const ok=await window.DB.setDoc("config","edgeConnectivity",payload);
    setSavingEdge(false);
    if(!ok){alert("IPC ayari kaydedilemedi.");return;}
    setEdgeConfig(payload);
  }

  async function saveProfile(){
    if(!form.machineName.trim()){alert("Makina adi zorunlu.");return;}
    if(!form.brand||!form.protocol){alert("Marka ve protokol secin.");return;}
    const payload={
      code:(form.code||nextConnectorCode()).toUpperCase(),
      machineName:form.machineName.trim(),
      brand:form.brand,
      protocol:form.protocol,
      connectionMode:form.connectionMode||"not_connected",
      ip:form.ip.trim(),
      port:String(form.port||"").trim(),
      pollingSec:Math.max(1,Number(form.pollingSec)||10),
      timezone:(form.timezone||"Europe/Istanbul").trim(),
      edgeAgent:(form.edgeAgent||edgeConfig.ipcName||"IPC-01").trim(),
      ncTransfer:"bidirectional",
      notes:form.notes.trim(),
      dataPoints:{...MACHINE_DEFAULT_POINTS,...(form.dataPoints||{})},
      updatedAt:new Date().toISOString(),
      updatedBy:currentUser.id,
      ...(editId?{}:{createdBy:currentUser.id}),
    };
    if(editId){
      const ok=await window.DB.updateDoc("machineConnectors",editId,payload);
      if(!ok){alert("Makina profili guncellenemedi.");return;}
      setProfiles(prev=>prev.map(x=>x.id===editId?{...x,...payload}:x).sort((a,b)=>(a.machineName||"").localeCompare(b.machineName||"","tr")));
    }else{
      const id=await window.DB.addDoc("machineConnectors",payload);
      if(!id){alert("Makina profili kaydedilemedi.");return;}
      setProfiles(prev=>[{id,...payload,createdAt:new Date().toISOString()},...prev].sort((a,b)=>(a.machineName||"").localeCompare(b.machineName||"","tr")));
    }
    setEditId(null);
    setShowForm(false);
    setForm({...emptyForm,code:nextConnectorCode(),edgeAgent:edgeConfig.ipcName||"IPC-01"});
  }

  function startCreate(){
    setEditId(null);
    setForm({...emptyForm,code:nextConnectorCode(),machineName:machines[0]||"CNC-1",edgeAgent:edgeConfig.ipcName||"IPC-01"});
    setShowForm(true);
  }

  function startEdit(row){
    const protocolList=MACHINE_PROTOCOL_OPTIONS[row.brand]||[];
    setEditId(row.id);
    setForm({
      code:row.code||nextConnectorCode(),
      machineName:row.machineName||machines[0]||"CNC-1",
      brand:row.brand||"Fanuc",
      protocol:(row.protocol&&protocolList.includes(row.protocol))?row.protocol:(protocolList[0]||"FOCAS2"),
      connectionMode:row.connectionMode||"not_connected",
      ip:row.ip||"",
      port:row.port||"",
      pollingSec:String(Number(row.pollingSec)||10),
      timezone:row.timezone||"Europe/Istanbul",
      edgeAgent:row.edgeAgent||edgeConfig.ipcName||"IPC-01",
      ncTransfer:"bidirectional",
      notes:row.notes||"",
      dataPoints:{...MACHINE_DEFAULT_POINTS,...(row.dataPoints||{})},
    });
    setShowForm(true);
  }

  async function removeProfile(row){
    if(!confirm(`"${row.machineName||row.code||"Makina"}" profili silinsin mi?`)) return;
    const ok=await window.DB.deleteDoc("machineConnectors",row.id);
    if(!ok){alert("Makina profili silinemedi.");return;}
    setProfiles(prev=>prev.filter(x=>x.id!==row.id));
    setSimMap(prev=>{const n={...prev};delete n[row.id];return n;});
    if(editId===row.id){
      setEditId(null);
      setShowForm(false);
      setForm({...emptyForm,code:nextConnectorCode()});
    }
  }

  async function setConnectionMode(row,mode){
    const patch={connectionMode:mode,updatedAt:new Date().toISOString(),updatedBy:currentUser.id};
    const ok=await window.DB.updateDoc("machineConnectors",row.id,patch);
    if(!ok){alert("Baglanti modu guncellenemedi.");return;}
    setProfiles(prev=>prev.map(x=>x.id===row.id?{...x,...patch}:x));
  }

  async function simulateProfile(row){
    const statePool=["running","idle","alarm","setup"];
    const status=statePool[Math.floor(Math.random()*statePool.length)];
    const nowIso=new Date().toISOString();
    let machineLocalTime=nowIso;
    try{
      machineLocalTime=new Date().toLocaleString("sv-SE",{timeZone:row.timezone||"Europe/Istanbul",hour12:false}).replace(" ","T");
    }catch{}
    const nextPart=(Number(row.mockPartCounter)||0)+(status==="running"?Math.floor(Math.random()*2):0);
    const sample={
      machineId:row.id,
      machineCode:row.code||"",
      machineName:row.machineName||"",
      status,
      programName:`O${String(1000+Math.floor(Math.random()*9000))}`,
      spindleLoad:status==="running"?Math.floor(45+Math.random()*45):Math.floor(Math.random()*20),
      feedOverride:Math.floor(85+Math.random()*20),
      cycleElapsedSec:status==="running"?Math.floor(20+Math.random()*260):0,
      partCounter:nextPart,
      activeAlarms:status==="alarm"?["A-102 OVERLOAD"]:[],
      toolNumber:1+Math.floor(Math.random()*24),
      toolLifeRemainPct:Math.floor(20+Math.random()*80),
      operatorId:`OP-${String(1+Math.floor(Math.random()*8)).padStart(3,"0")}`,
      collectedAtUtc:nowIso,
      machineLocalTime,
      source:"simulation",
    };
    await window.DB.addDoc("machineTelemetryMock",sample);
    const patch={
      connectionMode:"simulation",
      status:"simulating",
      mockPartCounter:nextPart,
      lastHeartbeatAt:nowIso,
      updatedAt:nowIso,
      updatedBy:currentUser.id,
    };
    await window.DB.updateDoc("machineConnectors",row.id,patch);
    setProfiles(prev=>prev.map(x=>x.id===row.id?{...x,...patch}:x));
    setSimMap(prev=>({...prev,[row.id]:sample}));
  }

  const q=search.trim().toLowerCase();
  const filtered=profiles.filter(r=>{
    if(!q) return true;
    return (r.machineName||"").toLowerCase().includes(q)||
      (r.code||"").toLowerCase().includes(q)||
      (r.brand||"").toLowerCase().includes(q)||
      (r.protocol||"").toLowerCase().includes(q)||
      (r.ip||"").toLowerCase().includes(q);
  });
  const plannedCount=profiles.filter(r=>(r.connectionMode||"not_connected")==="not_connected").length;
  const simCount=profiles.filter(r=>r.connectionMode==="simulation").length;
  const liveCount=profiles.filter(r=>r.connectionMode==="live").length;
  const pilotTarget=5;

  if(loading) return <div style={{padding:30,color:C.muted2,textAlign:"center"}}>Yukleniyor...</div>;

  return (
    <div style={{padding:16,display:"flex",flexDirection:"column",gap:12}}>
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:14}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",gap:8,flexWrap:"wrap",marginBottom:8}}>
          <div style={{fontWeight:700,color:C.text}}>Makina Baglanti Hazirligi (Baglanti Yok Modu)</div>
          <button onClick={startCreate} style={{...btnSt("primary"),padding:"8px 12px",fontSize:12}}>+ Makina Profili</button>
        </div>
        <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(120px,1fr))",gap:8}}>
          <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,padding:"8px 10px"}}><div style={{fontSize:10,color:C.muted2,letterSpacing:.8,textTransform:"uppercase"}}>Pilot Hedef</div><div style={{fontWeight:800,color:C.accent,fontSize:18}}>{pilotTarget}</div></div>
          <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,padding:"8px 10px"}}><div style={{fontSize:10,color:C.muted2,letterSpacing:.8,textTransform:"uppercase"}}>Toplam Profil</div><div style={{fontWeight:800,color:C.text,fontSize:18}}>{profiles.length}</div></div>
          <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,padding:"8px 10px"}}><div style={{fontSize:10,color:C.muted2,letterSpacing:.8,textTransform:"uppercase"}}>Bagli Degil</div><div style={{fontWeight:800,color:C.muted2,fontSize:18}}>{plannedCount}</div></div>
          <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,padding:"8px 10px"}}><div style={{fontSize:10,color:C.muted2,letterSpacing:.8,textTransform:"uppercase"}}>Simulasyon</div><div style={{fontWeight:800,color:C.warn,fontSize:18}}>{simCount}</div></div>
          <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,padding:"8px 10px"}}><div style={{fontSize:10,color:C.muted2,letterSpacing:.8,textTransform:"uppercase"}}>Canli</div><div style={{fontWeight:800,color:C.green,fontSize:18}}>{liveCount}</div></div>
        </div>
      </div>

      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:14}}>
        <div style={{fontWeight:700,color:C.text,marginBottom:10}}>IPC Edge Konfigurasyonu</div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
          <div><span style={labelSt}>IPC Adi</span><input style={inputSt} value={edgeConfig.ipcName} onChange={e=>fe("ipcName",e.target.value)} placeholder="IPC-01"/></div>
          <div><span style={labelSt}>Konum</span><input style={inputSt} value={edgeConfig.location} onChange={e=>fe("location",e.target.value)} placeholder="Atolye A"/></div>
          <div><span style={labelSt}>Default Polling (sn)</span><input style={inputSt} type="number" min="1" value={edgeConfig.defaultPollingSec} onChange={e=>fe("defaultPollingSec",e.target.value)}/></div>
          <div><span style={labelSt}>Maks Buffer Kaydi</span><input style={inputSt} type="number" min="100" value={edgeConfig.maxBufferRows} onChange={e=>fe("maxBufferRows",e.target.value)}/></div>
          <div><span style={labelSt}>Resend Periyodu (sn)</span><input style={inputSt} type="number" min="1" value={edgeConfig.resendSec} onChange={e=>fe("resendSec",e.target.value)}/></div>
          <div><span style={labelSt}>Sync Batch</span><input style={inputSt} type="number" min="1" value={edgeConfig.syncBatch} onChange={e=>fe("syncBatch",e.target.value)}/></div>
          <div style={{gridColumn:"1 / -1"}}><span style={labelSt}>Timezone</span><input style={inputSt} value={edgeConfig.timezone} onChange={e=>fe("timezone",e.target.value)} placeholder="Europe/Istanbul"/></div>
        </div>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",gap:8,flexWrap:"wrap",marginTop:10}}>
          <div style={{fontSize:12,color:C.muted2}}>Bu alanlar baglanti yapmadan once edge agent paketine aktarilacak hazir ayarlardir.</div>
          <button onClick={saveEdgeConfig} disabled={savingEdge} style={{...btnSt("green"),padding:"8px 12px",fontSize:12,opacity:savingEdge?0.7:1}}>{savingEdge?"Kaydediliyor...":"IPC Ayarini Kaydet"}</button>
        </div>
      </div>

      {showForm&&(
        <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:14}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",gap:8,marginBottom:10}}>
            <div style={{fontWeight:700,color:C.text}}>{editId?"Makina Profili Duzenle":"Yeni Makina Profili"}</div>
            {form.ncTransfer==="bidirectional"&&<Badge label="NC Transfer Cift Yon" color={C.accent}/>}
          </div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
            <div><span style={labelSt}>Profil Kodu</span><input style={{...inputSt,background:C.surface,color:C.muted2}} value={form.code||nextConnectorCode()} readOnly/></div>
            <div>
              <span style={labelSt}>Makina</span>
              <select style={inputSt} value={form.machineName} onChange={e=>fv("machineName",e.target.value)}>
                {machines.map(m=><option key={m} value={m}>{m}</option>)}
              </select>
            </div>
            <div>
              <span style={labelSt}>Marka</span>
              <select style={inputSt} value={form.brand} onChange={e=>fv("brand",e.target.value)}>
                {MACHINE_BRAND_OPTIONS.map(b=><option key={b} value={b}>{b}</option>)}
              </select>
            </div>
            <div>
              <span style={labelSt}>Protokol</span>
              <select style={inputSt} value={form.protocol} onChange={e=>fv("protocol",e.target.value)}>
                {protocolOptions.map(p=><option key={p} value={p}>{p}</option>)}
              </select>
            </div>
            <div>
              <span style={labelSt}>Baglanti Modu</span>
              <select style={inputSt} value={form.connectionMode} onChange={e=>fv("connectionMode",e.target.value)}>
                <option value="not_connected">Bagli Degil</option>
                <option value="simulation">Simulasyon</option>
                <option value="live">Canli</option>
              </select>
            </div>
            <div><span style={labelSt}>Polling (sn)</span><input style={inputSt} type="number" min="1" value={form.pollingSec} onChange={e=>fv("pollingSec",e.target.value)}/></div>
            <div><span style={labelSt}>IP (Opsiyonel)</span><input style={inputSt} value={form.ip} onChange={e=>fv("ip",e.target.value)} placeholder="192.168.1.25"/></div>
            <div><span style={labelSt}>Port (Opsiyonel)</span><input style={inputSt} value={form.port} onChange={e=>fv("port",e.target.value)} placeholder="8193 / 4840"/></div>
            <div><span style={labelSt}>Edge Agent</span><input style={inputSt} value={form.edgeAgent} onChange={e=>fv("edgeAgent",e.target.value)} placeholder="IPC-01"/></div>
            <div><span style={labelSt}>Timezone</span><input style={inputSt} value={form.timezone} onChange={e=>fv("timezone",e.target.value)} placeholder="Europe/Istanbul"/></div>
            <div style={{gridColumn:"1 / -1"}}><span style={labelSt}>Not</span><textarea style={{...inputSt,minHeight:64,resize:"vertical"}} value={form.notes} onChange={e=>fv("notes",e.target.value)} placeholder="Kablo takildiginda canliya alinacak gibi notlar..."/></div>
          </div>
          <div style={{marginTop:10}}>
            <div style={{fontSize:11,color:C.muted2,letterSpacing:1,textTransform:"uppercase",marginBottom:7}}>Toplanacak Veriler</div>
            <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(170px,1fr))",gap:7}}>
              {MACHINE_DATA_POINTS.map(dp=>{
                const active=Boolean(form.dataPoints?.[dp.id]);
                return (
                  <button key={dp.id} onClick={()=>fp(dp.id,!active)} style={{...chip(active,active?C.accent:C.muted2),textAlign:"left",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                    <span>{dp.label}</span><span>{active?"On":"Off"}</span>
                  </button>
                );
              })}
            </div>
          </div>
          <div style={{display:"flex",gap:8,marginTop:10}}>
            <button onClick={saveProfile} style={{...btnSt("primary"),flex:1,padding:12}}>{editId?"Profili Guncelle":"Profili Kaydet"}</button>
            <button onClick={()=>{setEditId(null);setShowForm(false);setForm({...emptyForm,code:nextConnectorCode()});}} style={{...btnSt("ghost"),padding:"12px 14px"}}>Iptal</button>
          </div>
        </div>
      )}

      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"10px 12px",display:"flex",justifyContent:"space-between",alignItems:"center",gap:8,flexWrap:"wrap"}}>
        <div style={{fontSize:12,color:C.muted2}}>Makina Profilleri ({profiles.length})</div>
        <input style={{...inputSt,padding:"7px 10px",fontSize:12,minWidth:220}} value={search} onChange={e=>setSearch(e.target.value)} placeholder="Makina, kod, marka, protokol ara..."/>
      </div>

      {filtered.length===0&&<div style={{textAlign:"center",color:C.muted2,padding:"28px 20px",background:C.card,borderRadius:14,border:`1px solid ${C.border}`}}>Makina profili bulunamadi</div>}
      {filtered.map(row=>{
        const mode=modeMeta(row.connectionMode||"not_connected");
        const sample=simMap[row.id];
        return (
          <div key={row.id} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:"12px 14px"}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",gap:10}}>
              <div>
                <div style={{display:"flex",alignItems:"center",gap:7,flexWrap:"wrap"}}>
                  <span style={{fontWeight:800,fontFamily:"monospace",fontSize:13,color:C.text}}>{row.code||"-"}</span>
                  <Badge label={mode.label} color={mode.color}/>
                  <Badge label={`${row.brand||"-"} / ${row.protocol||"-"}`} color={C.muted2}/>
                  <Badge label={`Polling ${Number(row.pollingSec)||10}s`} color={C.warn}/>
                </div>
                <div style={{fontSize:14,color:C.text,marginTop:3}}>{row.machineName||"-"}</div>
                <div style={{fontSize:11,color:C.muted2,marginTop:2}}>
                  {(row.edgeAgent||edgeConfig.ipcName||"IPC-01")} · {(row.timezone||"Europe/Istanbul")}
                  {row.ip?` · ${row.ip}${row.port?`:${row.port}`:""}`:" · IP tanimsiz"}
                </div>
                <div style={{fontSize:11,color:C.muted,marginTop:2}}>NC Transfer: Cift Yon · Son heartbeat: {(row.lastHeartbeatAt||"-").slice(0,19).replace("T"," ")||"-"}</div>
              </div>
              <div style={{display:"flex",gap:7,flexWrap:"wrap",justifyContent:"flex-end"}}>
                <button onClick={()=>simulateProfile(row)} style={{...btnSt("primary"),padding:"6px 10px",fontSize:12}}>Simule Et</button>
                <button onClick={()=>setConnectionMode(row,"not_connected")} style={{...btnSt("ghost"),padding:"6px 10px",fontSize:12}}>Bagli Degil</button>
                <button onClick={()=>setConnectionMode(row,"live")} style={{...btnSt("green"),padding:"6px 10px",fontSize:12}}>Canliya Hazir</button>
                <button onClick={()=>startEdit(row)} style={{...btnSt("ghost"),padding:"6px 10px",fontSize:12}}>Duzenle</button>
                <button onClick={()=>removeProfile(row)} style={{...btnSt("danger"),padding:"6px 10px",fontSize:12}}>Sil</button>
              </div>
            </div>
            {row.notes&&<div style={{fontSize:12,color:C.muted2,marginTop:8}}>{row.notes}</div>}
            <div style={{marginTop:8,fontSize:11,color:C.muted2}}>
              Veri noktasi: {MACHINE_DATA_POINTS.filter(p=>row.dataPoints?.[p.id]).map(p=>p.label).join(", ")||"Secilmemis"}
            </div>
            {sample&&(
              <div style={{marginTop:8,background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,padding:"8px 10px",fontSize:11,color:C.muted2}}>
                <div style={{marginBottom:4,color:C.text,fontWeight:700}}>Son Simulasyon Ornegi</div>
                <div>Durum: {sample.status} · Program: {sample.programName} · Spindle: %{sample.spindleLoad} · Feed: %{sample.feedOverride}</div>
                <div>Cevrim: {sample.cycleElapsedSec}s · Parca: {sample.partCounter} · Takim: T{sample.toolNumber} (%{sample.toolLifeRemainPct})</div>
                <div>Zaman UTC: {sample.collectedAtUtc?.slice(0,19).replace("T"," ")} · Lokal: {sample.machineLocalTime||"-"}</div>
              </div>
            )}
          </div>
        );
      })}
    </div>
  );
}

function MRPDashboard({currentUser,machines=DEFAULT_MACHINES}){
  const [loading,setLoading]=useState(true);
  const [data,setData]=useState({orders:[],sales:[],materials:[],prs:[],connectors:[],telemetry:[],downtimes:[],entries:[],notifs:[],tools:[]});
  const load=useCallback(async()=>{
    const [orders,sales,materials,prs,connectors,telemetry,downtimes,entries,notifs,tools]=await Promise.all([
      window.DB.getAll("orders"),
      window.DB.getAll("salesOrders"),
      window.DB.getAll("materials"),
      window.DB.getAll("purchaseRequests"),
      window.DB.getAll("machineConnectors"),
      window.DB.getAll("machineTelemetryMock"),
      window.DB.getAll("downtimeEvents"),
      window.DB.getAll("entries"),
      window.DB.getAll("notifications"),
      window.DB.getAll("toolStock"),
    ]);
    setData({orders,sales,materials,prs,connectors,telemetry,downtimes,entries,notifs,tools});
    setLoading(false);
  },[]);
  useEffect(()=>{load();},[load]);

  if(loading) return <div style={{padding:30,color:C.muted2,textAlign:"center"}}>Yukleniyor...</div>;
  const today=todayStr();
  const openOrders=data.orders.filter(o=>isOpenOrderStatus(o.status));
  const lateOrders=openOrders.filter(o=>o.dueDate&&o.dueDate<today);
  const nearSales=data.sales.filter(s=>{
    if(["delivered","cancelled"].includes(s.status||"")) return false;
    const due=s.dueDate||"";
    if(!due) return false;
    return dayDiff(today,due)>=0&&dayDiff(today,due)<=3;
  });
  const lowStocks=data.materials.filter(m=>(safeNum(m.stock)<=Math.max(safeNum(m.reorderPoint),safeNum(m.safetyStock),0)));
  const pendingPr=data.prs.filter(r=>!["received","cancelled","closed"].includes(r.status||""));
  const unresolvedNotifs=data.notifs.filter(n=>!["resolved","closed"].includes(n.status||""));
  const lowLifeTools=data.tools.filter(t=>safeNum(t.remainingLifePct)<=20);

  const latestTelemetry={};
  [...data.telemetry].sort((a,b)=>(b.collectedAtUtc||"").localeCompare(a.collectedAtUtc||"")).forEach(t=>{
    if(!t.machineId||latestTelemetry[t.machineId]) return;
    latestTelemetry[t.machineId]=t;
  });
  const machineRows=(data.connectors.length?data.connectors:machines.map((m,idx)=>({id:`virt_${idx}`,machineName:m,connectionMode:"not_connected"}))).map(mc=>{
    const t=latestTelemetry[mc.id]||null;
    const machineName=mc.machineName||mc.code||mc.id;
    const rows=data.entries.filter(e=>e.machine===machineName&&e.date===today);
    const stopMin=data.downtimes.filter(d=>d.machine===machineName&&d.date===today).reduce((s,d)=>s+safeNum(d.durationMin),0);
    const planned=EFFECTIVE_SECONDS;
    const up=Math.max(0,planned-stopMin*60);
    const produced=rows.reduce((s,e)=>s+safeNum(e.correct)+safeNum(e.wrong),0);
    const correct=rows.reduce((s,e)=>s+safeNum(e.correct),0);
    const cycleSecAvg=rows.length?rows.reduce((s,e)=>s+safeNum(e.partSec||0),0)/rows.length:60;
    const runSec=produced*Math.max(1,cycleSecAvg);
    const availability=planned>0?up/planned:0;
    const performance=up>0?Math.min(1,runSec/up):0;
    const quality=produced>0?correct/produced:1;
    const oee=Math.round(availability*performance*quality*100);
    return {
      id:mc.id,
      machineName,
      status:t?.status||(mc.connectionMode==="simulation"?"simulation":"offline"),
      program:t?.programName||"-",
      partCounter:safeNum(t?.partCounter),
      alarms:(t?.activeAlarms||[]).length,
      oee,
      availability:Math.round(availability*100),
      performance:Math.round(performance*100),
      quality:Math.round(quality*100),
    };
  });
  const statusColor=s=>{
    if(["running","live"].includes(s)) return C.green;
    if(["alarm"].includes(s)) return C.red;
    if(["idle","setup","simulation"].includes(s)) return C.warn;
    return C.muted2;
  };

  return (
    <div style={{padding:16,display:"flex",flexDirection:"column",gap:12}}>
      <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(180px,1fr))",gap:8}}>
        {[["Acik Is Emri",openOrders.length,C.accent],["Geciken Is",lateOrders.length,lateOrders.length?C.red:C.green],["Kritik Stok",lowStocks.length,lowStocks.length?C.warn:C.green],["Acil Satin Alma",pendingPr.length,pendingPr.length?C.warn:C.green],["Bekleyen Bildirim",unresolvedNotifs.length,unresolvedNotifs.length?C.red:C.green],["Kritik Takim Omru",lowLifeTools.length,lowLifeTools.length?C.red:C.green]].map(([l,v,col])=>(
          <div key={l} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"10px 12px"}}>
            <div style={{fontSize:11,color:C.muted2,letterSpacing:1,textTransform:"uppercase"}}>{l}</div>
            <div style={{fontSize:26,color:col,fontWeight:800,fontFamily:"monospace",marginTop:4}}>{v}</div>
          </div>
        ))}
      </div>

      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:14}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10,flexWrap:"wrap",gap:8}}>
          <div style={{fontWeight:700,color:C.text}}>Canli Atolye Gorunumu</div>
          <button onClick={load} style={{...btnSt("ghost"),padding:"6px 10px",fontSize:12}}>Yenile</button>
        </div>
        <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(220px,1fr))",gap:8}}>
          {machineRows.map(m=>(
            <div key={m.id} style={{background:C.surface,border:`1px solid ${statusColor(m.status)}55`,borderRadius:10,padding:"10px 12px"}}>
              <div style={{display:"flex",justifyContent:"space-between",gap:6,alignItems:"center"}}>
                <div style={{fontWeight:700,color:C.text}}>{m.machineName}</div>
                <Badge label={m.status||"offline"} color={statusColor(m.status)}/>
              </div>
              <div style={{fontSize:11,color:C.muted2,marginTop:3}}>Program: {m.program}</div>
              <div style={{fontSize:11,color:C.muted2}}>Parca: {m.partCounter} · Alarm: {m.alarms}</div>
              <div style={{fontSize:12,color:C.text,marginTop:6}}>OEE %{m.oee} (A %{m.availability} / P %{m.performance} / Q %{m.quality})</div>
            </div>
          ))}
        </div>
      </div>

      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
        <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:14}}>
          <div style={{fontSize:11,color:C.muted2,letterSpacing:1,textTransform:"uppercase",marginBottom:8}}>Termin Riski Olan Is Emirleri</div>
          {lateOrders.slice(0,8).map(o=>(
            <div key={o.id} style={{padding:"7px 0",borderBottom:`1px solid ${C.border}`,fontSize:12,color:C.muted2}}>
              <span style={{color:C.text,fontWeight:700,fontFamily:"monospace"}}>{o.code}</span> · {o.name||"-"} · {o.dueDate||"-"}
            </div>
          ))}
          {lateOrders.length===0&&<div style={{fontSize:12,color:C.muted2}}>Geciken is emri yok.</div>}
        </div>
        <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:14}}>
          <div style={{fontSize:11,color:C.muted2,letterSpacing:1,textTransform:"uppercase",marginBottom:8}}>Yaklasan Satis Terminleri (3 Gun)</div>
          {nearSales.slice(0,8).map(s=>(
            <div key={s.id} style={{padding:"7px 0",borderBottom:`1px solid ${C.border}`,fontSize:12,color:C.muted2}}>
              <span style={{color:C.text,fontWeight:700,fontFamily:"monospace"}}>{s.code||"-"}</span> · {s.customerName||"-"} · {s.dueDate||"-"}
            </div>
          ))}
          {nearSales.length===0&&<div style={{fontSize:12,color:C.muted2}}>Yaklasan termin bulunmuyor.</div>}
        </div>
      </div>
    </div>
  );
}

function MPSModule(){
  const [loading,setLoading]=useState(true);
  const [sales,setSales]=useState([]);
  const [orders,setOrders]=useState([]);
  const [mpsPlans,setMpsPlans]=useState([]);
  const [form,setForm]=useState({partNo:"",weekStart:startOfWeekYmd(todayStr()),plannedQty:"0",note:""});
  const setF=(k,v)=>setForm(p=>({...p,[k]:v}));
  const load=useCallback(async()=>{
    const [s,o,m]=await Promise.all([window.DB.getAll("salesOrders"),window.DB.getAll("orders"),window.DB.getAll("mpsPlans")]);
    setSales(s); setOrders(o); setMpsPlans(m);
    setLoading(false);
  },[]);
  useEffect(()=>{load();},[load]);
  async function savePlan(){
    if(!form.partNo.trim()){alert("Parca no zorunlu.");return;}
    const payload={
      partNo:form.partNo.trim().toUpperCase(),
      weekStart:startOfWeekYmd(form.weekStart||todayStr()),
      plannedQty:Math.max(0,safeNum(form.plannedQty)),
      note:form.note.trim(),
      updatedAt:new Date().toISOString(),
    };
    const id=await window.DB.addDoc("mpsPlans",payload);
    if(!id){alert("MPS kaydi olusturulamadi.");return;}
    setMpsPlans(prev=>[{id,...payload,createdAt:new Date().toISOString()},...prev]);
    setForm({partNo:"",weekStart:startOfWeekYmd(todayStr()),plannedQty:"0",note:""});
  }

  if(loading) return <div style={{padding:30,color:C.muted2,textAlign:"center"}}>Yukleniyor...</div>;
  const base=startOfWeekYmd(todayStr());
  const buckets=Array.from({length:8},(_,i)=>{
    const start=addDays(base,i*7);
    const end=addDays(start,6);
    const demand=sales.reduce((sum,s)=>{
      if(["cancelled","delivered"].includes(s.status||"")) return sum;
      if(s.lines&&s.lines.length){
        return sum+s.lines.filter(l=>l.dueDate>=start&&l.dueDate<=end).reduce((x,l)=>x+safeNum(l.qty),0);
      }
      if(s.dueDate>=start&&s.dueDate<=end) return sum+safeNum(s.qty);
      return sum;
    },0);
    const wo=orders.filter(o=>o.dueDate>=start&&o.dueDate<=end).reduce((s,o)=>s+safeNum(o.qty),0);
    const mps=mpsPlans.filter(p=>p.weekStart===start).reduce((s,p)=>s+safeNum(p.plannedQty),0);
    const balance=(wo+mps)-demand;
    return {start,end,demand,wo,mps,balance};
  });
  const exportRows=buckets.map(b=>({hafta:`${b.start} - ${b.end}`,talep:b.demand,isEmriArz:b.wo,mpsPlan:b.mps,bakiye:b.balance}));

  return (
    <div style={{padding:16,display:"flex",flexDirection:"column",gap:12}}>
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:14}}>
        <div style={{fontWeight:700,color:C.text,marginBottom:10}}>MPS Plan Girdisi</div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8}}>
          <div><span style={labelSt}>Parca No</span><input style={inputSt} value={form.partNo} onChange={e=>setF("partNo",e.target.value)} placeholder="PRT-001"/></div>
          <div><span style={labelSt}>Hafta Baslangic</span><input style={inputSt} type="date" value={form.weekStart} onChange={e=>setF("weekStart",e.target.value||todayStr())}/></div>
          <div><span style={labelSt}>Planlanan Adet</span><input style={inputSt} type="number" min="0" value={form.plannedQty} onChange={e=>setF("plannedQty",e.target.value)}/></div>
        </div>
        <div style={{marginTop:8}}><span style={labelSt}>Not</span><textarea rows={2} style={{...inputSt,minHeight:62,resize:"vertical"}} value={form.note} onChange={e=>setF("note",e.target.value)}/></div>
        <div style={{display:"flex",gap:8,justifyContent:"space-between",marginTop:10,flexWrap:"wrap"}}>
          <button onClick={savePlan} style={{...btnSt("primary"),padding:"8px 12px",fontSize:12}}>MPS Kaydet</button>
          <button onClick={()=>downloadCsv(`mps-${todayStr()}.csv`,[{label:"Hafta",key:"hafta"},{label:"Talep",key:"talep"},{label:"Is Emri Arz",key:"isEmriArz"},{label:"MPS Plan",key:"mpsPlan"},{label:"Bakiye",key:"bakiye"}],exportRows)} style={{...btnSt("ghost"),padding:"8px 12px",fontSize:12}}>CSV Indir</button>
        </div>
      </div>
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:14}}>
        <div style={{fontSize:11,color:C.muted2,letterSpacing:1,textTransform:"uppercase",marginBottom:8}}>8 Haftalik Ana Uretim Plani</div>
        {buckets.map(b=>(
          <div key={b.start} style={{display:"grid",gridTemplateColumns:"1.3fr repeat(4,.8fr)",gap:8,padding:"8px 0",borderBottom:`1px solid ${C.border}`,fontSize:12,alignItems:"center"}}>
            <div style={{color:C.text,fontWeight:700}}>{b.start} - {b.end}</div>
            <div style={{color:C.muted2}}>Talep: {b.demand}</div>
            <div style={{color:C.muted2}}>WO: {b.wo}</div>
            <div style={{color:C.muted2}}>MPS: {b.mps}</div>
            <div style={{color:b.balance<0?C.red:C.green,fontWeight:700}}>Bakiye: {b.balance}</div>
          </div>
        ))}
      </div>
    </div>
  );
}

function MRPRunModule({currentUser}){
  const [loading,setLoading]=useState(true);
  const [parts,setParts]=useState([]);
  const [materials,setMaterials]=useState([]);
  const [orders,setOrders]=useState([]);
  const [purchaseRequests,setPurchaseRequests]=useState([]);
  const [result,setResult]=useState([]);
  const [running,setRunning]=useState(false);
  const load=useCallback(async()=>{
    const [p,m,o,r]=await Promise.all([window.DB.getAll("parts"),window.DB.getAll("materials"),window.DB.getAll("orders"),window.DB.getAll("purchaseRequests")]);
    setParts(p); setMaterials(m); setOrders(o); setPurchaseRequests(r);
    setLoading(false);
  },[]);
  useEffect(()=>{load();},[load]);

  function runMrp(){
    setRunning(true);
    const partMap={};
    parts.forEach(p=>{partMap[String(p.partNo||"").toUpperCase()]=p;});
    const materialByCode={};
    materials.forEach(m=>{
      materialByCode[String(m.code||"").toUpperCase()]=m;
      materialByCode[String(m.name||"").toUpperCase()]=m;
    });
    const agg={};
    const activeOrders=orders.filter(o=>isOpenOrderStatus(o.status));
    activeOrders.forEach(o=>{
      const key=String(o.partNo||"").toUpperCase();
      const part=partMap[key];
      if(!part||(part.bomLines||[]).length===0) return;
      (part.bomLines||[]).forEach(line=>{
        const code=String(line.componentCode||"").toUpperCase();
        if(!code) return;
        const gross=safeNum(o.qty)*safeNum(line.qtyPer)*(1+safeNum(line.scrapPct)/100);
        if(!agg[code]) agg[code]={componentCode:code,componentName:line.componentName||"",grossReq:0,orders:new Set()};
        agg[code].grossReq+=gross;
        agg[code].orders.add(o.code||o.id);
      });
    });
    const rows=Object.values(agg).map(r=>{
      const mat=materialByCode[r.componentCode]||null;
      const onHand=safeNum(mat?.stock);
      const safety=Math.max(safeNum(mat?.safetyStock),0);
      const openPr=purchaseRequests.filter(x=>!["received","cancelled","closed"].includes(x.status||"")&&String(x.materialCode||x.materialName||"").toUpperCase()===r.componentCode).reduce((s,x)=>s+safeNum(x.qty),0);
      const net=Math.max(0,Math.ceil((r.grossReq+safety)-(onHand+openPr)));
      return {
        componentCode:r.componentCode,
        componentName:r.componentName||mat?.name||"-",
        grossReq:Math.ceil(r.grossReq),
        onHand,
        openPr,
        safety,
        net,
        leadTimeDays:Math.max(0,safeNum(mat?.leadTimeDays||5)),
        orders:[...r.orders],
        materialId:mat?.id||"",
      };
    }).sort((a,b)=>b.net-a.net);
    setResult(rows);
    setRunning(false);
  }

  async function createRequests(){
    const shortages=result.filter(r=>r.net>0);
    if(shortages.length===0){alert("Acik satin alma ihtiyaci bulunmuyor.");return;}
    const now=new Date().toISOString();
    for(const row of shortages){
      const payload={
        code:`PR-${Date.now().toString().slice(-6)}-${Math.floor(Math.random()*99)}`,
        materialId:row.materialId||"",
        materialCode:row.componentCode,
        materialName:row.componentName,
        qty:row.net,
        needDate:addDays(todayStr(),row.leadTimeDays||0),
        priority:"high",
        source:"mrp_auto",
        status:"pending",
        orderRefs:row.orders,
        createdBy:currentUser.id,
        updatedAt:now,
      };
      await window.DB.addDoc("purchaseRequests",payload);
      await addAuditLog(currentUser.id,"purchaseRequest","", "create_from_mrp",null,payload,{module:"mrp"});
    }
    await window.DB.addDoc("mrpRuns",{ranAt:now,createdBy:currentUser.id,rowCount:shortages.length,rows:result});
    alert(`${shortages.length} satin alma talebi olusturuldu.`);
    load();
  }

  if(loading) return <div style={{padding:30,color:C.muted2,textAlign:"center"}}>Yukleniyor...</div>;
  const critical=result.filter(r=>r.net>0).length;
  return (
    <div style={{padding:16,display:"flex",flexDirection:"column",gap:12}}>
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:14,display:"flex",justifyContent:"space-between",alignItems:"center",gap:8,flexWrap:"wrap"}}>
        <div>
          <div style={{fontWeight:700,color:C.text}}>MRP Net Ihtiyac Calistirma</div>
          <div style={{fontSize:12,color:C.muted2,marginTop:3}}>BOM + acik is emirleri + mevcut stok + acik PR bazli hesap.</div>
        </div>
        <div style={{display:"flex",gap:8}}>
          <button onClick={runMrp} disabled={running} style={{...btnSt("primary"),padding:"8px 12px",fontSize:12,opacity:running?0.7:1}}>{running?"Calisiyor...":"MRP Calistir"}</button>
          <button onClick={createRequests} style={{...btnSt("green"),padding:"8px 12px",fontSize:12}}>Talep Olustur</button>
        </div>
      </div>
      <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit,minmax(180px,1fr))",gap:8}}>
        <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"10px 12px"}}><div style={{fontSize:11,color:C.muted2}}>BOM Lu Parca</div><div style={{fontSize:23,color:C.accent,fontWeight:800}}>{parts.filter(p=>(p.bomLines||[]).length>0).length}</div></div>
        <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"10px 12px"}}><div style={{fontSize:11,color:C.muted2}}>Acik Is Emri</div><div style={{fontSize:23,color:C.text,fontWeight:800}}>{orders.filter(o=>isOpenOrderStatus(o.status)).length}</div></div>
        <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"10px 12px"}}><div style={{fontSize:11,color:C.muted2}}>Kritik Eksik</div><div style={{fontSize:23,color:critical?C.red:C.green,fontWeight:800}}>{critical}</div></div>
      </div>
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:14}}>
        <div style={{fontSize:11,color:C.muted2,letterSpacing:1,textTransform:"uppercase",marginBottom:8}}>Net Ihtiyac Sonucu ({result.length})</div>
        {result.map(r=>(
          <div key={r.componentCode} style={{padding:"8px 0",borderBottom:`1px solid ${C.border}`,display:"grid",gridTemplateColumns:"1.3fr repeat(5,.8fr)",gap:8,fontSize:12,alignItems:"center"}}>
            <div style={{color:C.text,fontWeight:700}}>{r.componentCode} · {r.componentName}</div>
            <div style={{color:C.muted2}}>Brut: {r.grossReq}</div>
            <div style={{color:C.muted2}}>Stok: {r.onHand}</div>
            <div style={{color:C.muted2}}>Acik PR: {r.openPr}</div>
            <div style={{color:C.muted2}}>SS: {r.safety}</div>
            <div style={{color:r.net>0?C.red:C.green,fontWeight:700}}>Net: {r.net}</div>
          </div>
        ))}
        {result.length===0&&<div style={{fontSize:12,color:C.muted2}}>MRP henuz calistirilmadi.</div>}
      </div>
    </div>
  );
}

function PurchasingModule({currentUser}){
  const [loading,setLoading]=useState(true);
  const [suppliers,setSuppliers]=useState([]);
  const [materials,setMaterials]=useState([]);
  const [requests,setRequests]=useState([]);
  const [quotes,setQuotes]=useState([]);
  const [orders,setOrders]=useState([]);
  const [receipts,setReceipts]=useState([]);
  const [view,setView]=useState("requests");
  const [supplierForm,setSupplierForm]=useState({name:"",code:"",leadTimeDays:"7",email:"",phone:"",currency:"TRY"});
  const [reqForm,setReqForm]=useState({materialId:"",qty:"",needDate:todayStr(),priority:"normal",note:""});
  const [quoteForm,setQuoteForm]=useState({requestId:"",supplierId:"",unitPrice:"0",leadTimeDays:"7",currency:"TRY",note:""});
  const [recvForm,setRecvForm]=useState({poId:"",acceptedQty:"",rejectedQty:"0",receiptDate:todayStr(),note:""});

  const load=useCallback(async()=>{
    const [s,m,r,q,p,gr]=await Promise.all([
      window.DB.getAll("suppliers"),
      window.DB.getAll("materials"),
      window.DB.getAll("purchaseRequests"),
      window.DB.getAll("supplierQuotes"),
      window.DB.getAll("purchaseOrders"),
      window.DB.getAll("goodsReceipts"),
    ]);
    setSuppliers(s); setMaterials(m); setRequests(r); setQuotes(q); setOrders(p); setReceipts(gr);
    setLoading(false);
  },[]);
  useEffect(()=>{load();},[load]);
  const matById=Object.fromEntries(materials.map(m=>[m.id,m]));
  const reqById=Object.fromEntries(requests.map(r=>[r.id,r]));

  async function saveSupplier(){
    if(!supplierForm.name.trim()){alert("Tedarikci adi zorunlu.");return;}
    const payload={name:supplierForm.name.trim(),code:(supplierForm.code||`TED-${Date.now().toString().slice(-4)}`).toUpperCase(),leadTimeDays:Math.max(0,safeNum(supplierForm.leadTimeDays)),email:supplierForm.email.trim(),phone:supplierForm.phone.trim(),currency:supplierForm.currency||"TRY",updatedAt:new Date().toISOString()};
    const id=await window.DB.addDoc("suppliers",payload);
    if(!id){alert("Tedarikci kaydedilemedi.");return;}
    setSuppliers(prev=>[{id,...payload},...prev]);
    setSupplierForm({name:"",code:"",leadTimeDays:"7",email:"",phone:"",currency:"TRY"});
  }
  async function saveRequest(){
    if(!reqForm.materialId||safeNum(reqForm.qty)<=0){alert("Malzeme ve miktar zorunlu.");return;}
    const mat=matById[reqForm.materialId];
    const payload={code:`PR-${String(Date.now()).slice(-6)}`,materialId:reqForm.materialId,materialCode:mat?.code||"",materialName:mat?.name||"",qty:Math.max(0,safeNum(reqForm.qty)),needDate:reqForm.needDate||todayStr(),priority:reqForm.priority||"normal",source:"manual",status:"pending",note:reqForm.note.trim(),createdBy:currentUser.id,updatedAt:new Date().toISOString()};
    const id=await window.DB.addDoc("purchaseRequests",payload);
    if(!id){alert("Talep olusturulamadi.");return;}
    setRequests(prev=>[{id,...payload},...prev]);
    setReqForm({materialId:"",qty:"",needDate:todayStr(),priority:"normal",note:""});
  }
  async function setRequestStatus(r,status){
    const patch={status,updatedAt:new Date().toISOString()};
    const ok=await window.DB.updateDoc("purchaseRequests",r.id,patch);
    if(!ok) return;
    setRequests(prev=>prev.map(x=>x.id===r.id?{...x,...patch}:x));
  }
  async function saveQuote(){
    if(!quoteForm.requestId||!quoteForm.supplierId){alert("Talep ve tedarikci secin.");return;}
    const req=reqById[quoteForm.requestId];
    const supplier=suppliers.find(s=>s.id===quoteForm.supplierId);
    const payload={requestId:req.id,requestCode:req.code||"",supplierId:supplier.id,supplierName:supplier.name||"",unitPrice:Math.max(0,safeNum(quoteForm.unitPrice)),leadTimeDays:Math.max(0,safeNum(quoteForm.leadTimeDays)),currency:quoteForm.currency||supplier.currency||"TRY",total:Math.max(0,safeNum(quoteForm.unitPrice))*safeNum(req.qty),note:quoteForm.note.trim(),status:"new",updatedAt:new Date().toISOString()};
    const id=await window.DB.addDoc("supplierQuotes",payload);
    if(!id){alert("Teklif kaydedilemedi.");return;}
    setQuotes(prev=>[{id,...payload},...prev]);
    setQuoteForm({requestId:"",supplierId:"",unitPrice:"0",leadTimeDays:"7",currency:"TRY",note:""});
  }
  async function quoteToPo(q){
    const req=reqById[q.requestId];
    if(!req){alert("Talep bulunamadi.");return;}
    const payload={code:`PO-${String(Date.now()).slice(-6)}`,requestId:req.id,requestCode:req.code||"",supplierId:q.supplierId,supplierName:q.supplierName||"",materialId:req.materialId||"",materialCode:req.materialCode||"",materialName:req.materialName||"",qty:safeNum(req.qty),unitPrice:safeNum(q.unitPrice),currency:q.currency||"TRY",total:safeNum(req.qty)*safeNum(q.unitPrice),orderDate:todayStr(),expectedDate:addDays(todayStr(),safeNum(q.leadTimeDays)),receivedQty:0,rejectedQty:0,status:"ordered",createdBy:currentUser.id,updatedAt:new Date().toISOString()};
    const id=await window.DB.addDoc("purchaseOrders",payload);
    if(!id){alert("PO olusturulamadi.");return;}
    await setRequestStatus(req,"ordered");
    setOrders(prev=>[{id,...payload},...prev]);
  }
  async function receivePo(){
    const po=orders.find(o=>o.id===recvForm.poId);
    if(!po){alert("PO secin.");return;}
    const accepted=Math.max(0,safeNum(recvForm.acceptedQty));
    const rejected=Math.max(0,safeNum(recvForm.rejectedQty));
    if(accepted+rejected<=0){alert("Alinan miktar girin.");return;}
    const payload={poId:po.id,poCode:po.code||"",materialId:po.materialId||"",materialCode:po.materialCode||"",materialName:po.materialName||"",acceptedQty:accepted,rejectedQty:rejected,receiptDate:recvForm.receiptDate||todayStr(),note:recvForm.note.trim(),createdBy:currentUser.id,createdAt:new Date().toISOString()};
    const rid=await window.DB.addDoc("goodsReceipts",payload);
    if(!rid){alert("Malzeme girisi kaydedilemedi.");return;}
    const newAccepted=safeNum(po.receivedQty)+accepted;
    const newRejected=safeNum(po.rejectedQty)+rejected;
    const totalIn=newAccepted+newRejected;
    const status=totalIn>=safeNum(po.qty)?"received":"partial";
    await window.DB.updateDoc("purchaseOrders",po.id,{receivedQty:newAccepted,rejectedQty:newRejected,status,updatedAt:new Date().toISOString()});
    if(po.materialId){
      const mat=matById[po.materialId];
      if(mat) await window.DB.updateDoc("materials",mat.id,{stock:safeNum(mat.stock)+accepted,updatedAt:new Date().toISOString()});
    }
    setRecvForm({poId:"",acceptedQty:"",rejectedQty:"0",receiptDate:todayStr(),note:""});
    load();
  }

  if(loading) return <div style={{padding:30,color:C.muted2,textAlign:"center"}}>Yukleniyor...</div>;
  const openReq=requests.filter(r=>!["received","cancelled","closed"].includes(r.status||""));
  const supplierPerf=suppliers.map(s=>{
    const pos=orders.filter(o=>o.supplierId===s.id);
    const gr=receipts.filter(r=>pos.some(p=>p.id===r.poId));
    const onTime=gr.filter(r=>{
      const po=pos.find(p=>p.id===r.poId);
      return po&&r.receiptDate<=po.expectedDate;
    }).length;
    const quality=gr.reduce((a,r)=>a+safeNum(r.acceptedQty),0);
    const total=gr.reduce((a,r)=>a+safeNum(r.acceptedQty)+safeNum(r.rejectedQty),0);
    return {id:s.id,name:s.name||"-",po:pos.length,onTimePct:gr.length?Math.round((onTime/gr.length)*100):0,qualityPct:total?Math.round((quality/total)*100):0};
  });

  return (
    <div style={{padding:16,display:"flex",flexDirection:"column",gap:12}}>
      <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
        <button onClick={()=>setView("requests")} style={chip(view==="requests",C.accent)}>Talep ve PO</button>
        <button onClick={()=>setView("suppliers")} style={chip(view==="suppliers",C.green)}>Tedarikciler</button>
        <button onClick={()=>setView("quotes")} style={chip(view==="quotes",C.warn)}>Teklifler</button>
      </div>
function ModulePlaceholder({title,desc,items=[]}) {
  return (
    <div style={{padding:16,display:"flex",flexDirection:"column",gap:12}}>
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:16}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",gap:8,flexWrap:"wrap"}}>
          <div style={{fontWeight:700,color:C.text,fontSize:16}}>{title}</div>
          <Badge label="MRP Roadmap" color={C.warn}/>
        </div>
        <div style={{fontSize:13,color:C.muted2,marginTop:8}}>{desc}</div>
      </div>
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:14}}>
        <div style={{fontSize:11,color:C.muted2,letterSpacing:1,textTransform:"uppercase",marginBottom:10}}>Planlanan Ozellikler</div>
        {items.length===0&&<div style={{fontSize:13,color:C.muted2}}>Bu modul icin backlog tanimi bekleniyor.</div>}
        {items.map((it,idx)=>(
          <div key={idx} style={{display:"flex",gap:10,alignItems:"flex-start",padding:"8px 0",borderBottom:idx===items.length-1?"none":`1px solid ${C.border}`}}>
            <span style={{color:C.accent,fontWeight:800,fontSize:13,minWidth:18}}>{idx+1}.</span>
            <span style={{fontSize:13,color:C.text}}>{it}</span>
          </div>
        ))}
      </div>
    </div>
  );
}

// ════════════════════════════════════════════════════════════
//  MAIN APP
// ════════════════════════════════════════════════════════════
function App() {
  const [currentUser,setCurrentUser]=useState(null);
  const [loading,setLoading]=useState(true);
  const [tab,setTab]=useState("dashboard");
  const [workMode,setWorkMode]=useState("planlama");
  const [machines,setMachines]=useState(DEFAULT_MACHINES);
  const [logoSrc,setLogoSrc]=useState(LOGO_SRC);
  const [isTablet,setIsTablet]=useState(()=>typeof window!=="undefined"?window.matchMedia("(min-width: 768px)").matches:false);
  const [isDesktop,setIsDesktop]=useState(()=>typeof window!=="undefined"?window.matchMedia("(min-width: 1200px)").matches:false);
  const [logoError,setLogoError]=useState(false);
  const [mobileMenuOpen,setMobileMenuOpen]=useState(false);

  useEffect(()=>{
    async function init() {
      const mc=await window.DB.getDoc("config","machines");
      if(mc&&mc.list&&mc.list.length>0) setMachines(mc.list);
      const branding=await window.DB.getDoc("config","branding");
      if(branding&&branding.logo) setLogoSrc(branding.logo);
      const session=window.Session.get();
      if(session){
        const u=await window.DB.getDoc("users",session.username);
        if(u&&u.status==="active") setCurrentUser(u);
        else window.Session.clear();
      }
      setLoading(false);
    }
    if(window.FB_READY) init();
    else window.addEventListener("fb_ready",init,{once:true});
  },[]);

  useEffect(()=>{
    const mq=window.matchMedia("(min-width: 768px)");
    const onChange=e=>setIsTablet(e.matches);
    setIsTablet(mq.matches);
    if(mq.addEventListener) mq.addEventListener("change",onChange);
    else mq.addListener(onChange);
    return ()=>{
      if(mq.removeEventListener) mq.removeEventListener("change",onChange);
      else mq.removeListener(onChange);
    };
  },[]);
  useEffect(()=>{
    const mq=window.matchMedia("(min-width: 1200px)");
    const onChange=e=>setIsDesktop(e.matches);
    setIsDesktop(mq.matches);
    if(mq.addEventListener) mq.addEventListener("change",onChange);
    else mq.addListener(onChange);
    return ()=>{
      if(mq.removeEventListener) mq.removeEventListener("change",onChange);
      else mq.removeListener(onChange);
    };
  },[]);
  useEffect(()=>{setLogoError(false);},[logoSrc]);

  async function updateMachines(list){
    setMachines(list);
    await window.DB.setDoc("config","machines",{list});
  }
  async function updateLogo(logoData){
    const next=logoData||LOGO_SRC;
    setLogoSrc(next);
    await window.DB.setDoc("config","branding",{logo:logoData||""});
  }
  async function logout(){window.Session.clear();setCurrentUser(null);setTab("dashboard");}

  if(loading) return <div style={{background:C.bg,minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",gap:12}}><div style={{width:40,height:40,border:`3px solid ${C.border}`,borderTop:`3px solid ${C.accent}`,borderRadius:"50%",animation:"spin 1s linear infinite"}}/><div style={{color:C.muted2,fontSize:13}}>Bağlanıyor...</div><style>{`@keyframes spin{to{transform:rotate(360deg)}}`}</style></div>;
  if(!currentUser) return <AuthScreen onLogin={u=>setCurrentUser(u)} logoSrc={logoSrc}/>;

  const isAdmin=currentUser.role==="admin";
  const canEntry=hasPermission(currentUser,"data_entry");
  const canReport=hasPermission(currentUser,"view_reports");
  const canOrders=hasPermission(currentUser,"manage_orders")||isAdmin;
  const canPlanning=canOrders;
  const canCustomers=canOrders;
  const canUsers=hasPermission(currentUser,"approve_users")||isAdmin;
  const canTools=true;
  const canMachinePrep=canOrders;
  const MODE_GROUPS={
    planlama:["Planlama","Tedarik ve Stok"],
    operasyon:["Operasyon","Tedarik ve Stok","Analiz ve Yonetim"],
    yonetim:["Planlama","Operasyon","Tedarik ve Stok","Analiz ve Yonetim","Sistem"],
  };
  const MODE_OPTIONS=[
    {id:"planlama",label:"Planlama Modu",color:C.accent},
    {id:"operasyon",label:"Operasyon Modu",color:C.green},
    {id:"yonetim",label:"Yonetim Modu",color:C.warn},
  ];
  const allTabs=useMemo(()=>[
    {id:"dashboard",icon:"dashboard",label:"MRP Panel",group:"Planlama",enabled:(canEntry||canOrders||canReport)},
    {id:"planning",icon:"planning",label:"Cizelgeleme",group:"Planlama",enabled:canPlanning},
    {id:"mps",icon:"mps",label:"MPS",group:"Planlama",enabled:canPlanning},
    {id:"mrp",icon:"mrp",label:"MRP Run",group:"Planlama",enabled:canPlanning},
    {id:"quotes",icon:"quotes",label:"Teklif Yonetimi",group:"Planlama",enabled:canOrders},
    {id:"sales",icon:"sales",label:"Satis Siparisleri",group:"Planlama",enabled:canOrders},
    {id:"orders",icon:"orders",label:"Is Emirleri",group:"Operasyon",enabled:canOrders},
    {id:"giris",icon:"giris",label:"Uretim Girisi",group:"Operasyon",enabled:canEntry},
    {id:"downtime",icon:"downtime",label:"Durus Yonetimi",group:"Operasyon",enabled:(canEntry||canReport||canOrders)},
    {id:"quality",icon:"quality",label:"Kalite ve Izlenebilirlik",group:"Operasyon",enabled:(canOrders||canReport)},
    {id:"materials",icon:"materials",label:"Malzeme Kutuphanesi",group:"Tedarik ve Stok",enabled:canOrders},
    {id:"tools",icon:"tools",label:"Takim Yonetimi",group:"Tedarik ve Stok",enabled:canTools},
    {id:"purchase",icon:"purchase",label:"Satin Alma Planlama",group:"Tedarik ve Stok",enabled:canOrders},
    {id:"customers",icon:"customers",label:"Musteriler",group:"Tedarik ve Stok",enabled:canCustomers},
    {id:"rapor",icon:"rapor",label:"Raporlar",group:"Analiz ve Yonetim",enabled:canReport},
    {id:"notifications",icon:"notifications",label:"Bildirim Merkezi",group:"Analiz ve Yonetim",enabled:(canUsers||canOrders||canReport)},
    {id:"cost",icon:"cost",label:"Maliyetleme",group:"Analiz ve Yonetim",enabled:(canOrders||canReport)},
    {id:"machineprep",icon:"machines",label:"Makina Hazirlik",group:"Sistem",enabled:canMachinePrep},
    {id:"integrations",icon:"integration",label:"Entegrasyonlar",group:"Sistem",enabled:(canUsers||isAdmin)},
    {id:"users",icon:"users",label:"Ayarlar ve Guvenlik",group:"Sistem",enabled:canUsers},
  ],[canEntry,canOrders,canReport,canPlanning,canTools,canCustomers,canMachinePrep,canUsers,isAdmin]);
  const enabledTabs=useMemo(()=>allTabs.filter(t=>t.enabled),[allTabs]);
  const activeGroups=MODE_GROUPS[workMode]||MODE_GROUPS.planlama;
  const tabs=useMemo(()=>{
    const modeTabs=enabledTabs.filter(t=>activeGroups.includes(t.group));
    return modeTabs.length>0?modeTabs:enabledTabs;
  },[enabledTabs,activeGroups.join("|")]);
  const groupedTabs=useMemo(()=>{
    const out={};
    tabs.forEach(t=>{
      if(!out[t.group]) out[t.group]=[];
      out[t.group].push(t);
    });
    return out;
  },[tabs]);
  const groupOrder=["Planlama","Operasyon","Tedarik ve Stok","Analiz ve Yonetim","Sistem"];
  const visibleGroups=groupOrder.filter(g=>groupedTabs[g]&&groupedTabs[g].length>0);

  useEffect(()=>{
    if(tabs.length===0) return;
    if(!tabs.some(t=>t.id===tab)) setTab(tabs[0].id);
  },[tabs,tab]);
  useEffect(()=>{setMobileMenuOpen(false);},[tab,workMode]);

  const layoutMode=isDesktop?"desktop":(isTablet?"tablet":"mobile");
  const contentMaxWidth=layoutMode==="desktop"?1520:(layoutMode==="tablet"?1180:520);
  const headerPadding=layoutMode==="desktop"?"16px 24px":(layoutMode==="tablet"?"14px 20px":"14px 14px");
  const desktopSidebarW=300;
  const tabletSidebarW=240;
  const mobilePrimary=tabs.slice(0,4);

  function getActiveView() {
    if(tab==="giris") return <DataEntry currentUser={currentUser} machines={machines}/>;
    if(tab==="planning") return <Planning currentUser={currentUser} machines={machines}/>;
    if(tab==="machineprep") return <MachineConnectivityPrep currentUser={currentUser} machines={machines}/>;
    if(tab==="customers") return <Customers/>;
    if(tab==="materials") return <MaterialLibrary/>;
    if(tab==="sales") return <SalesManagement currentUser={currentUser} machines={machines} onOpenWorkOrders={()=>setTab("orders")} defaultView="orders"/>;
    if(tab==="rapor") return <Report currentUser={currentUser} machines={machines}/>;
    if(tab==="tools") return <ToolStock currentUser={currentUser} machines={machines}/>;
    if(tab==="orders") return <WorkOrders currentUser={currentUser} machines={machines}/>;
    if(tab==="users") return <AdminUsers currentUser={currentUser} machines={machines} onMachinesUpdate={updateMachines} currentLogo={logoSrc} onLogoUpdate={updateLogo}/>;
    if(tab==="dashboard") return <ModulePlaceholder title="MRP Ana Panel" desc="Bu ekran siparis, kapasite, malzeme riskleri ve tedarik istisnalarini tek panelde birlestirecek." items={["Geciken is emri ve termin riski","Kritik stok ve satin alma alarm listesi","Makina doluluk ve vardiya bazli kapasite ozetleri","Bugun tamamlanacak is emirleri"]}/>;
    if(tab==="mps") return <ModulePlaceholder title="MPS (Master Production Schedule)" desc="Haftalik/aylik ana uretim plani, talep ve kapasiteyi tek tabloda optimize eder." items={["Urun bazli zaman kovasi planlama","Frozen/slushy horizon yonetimi","Talep senaryosu karsilastirmasi"]}/>;
    if(tab==="mrp") return <ModulePlaceholder title="MRP Run" desc="Net ihtiyac hesaplama, lot kurallari ve lead-time etkisini dikkate alarak planli siparis onerisi uretir." items={["Gross/Net requirement hesaplama","Safety stock ve reorder point kontrolu","Otomatik malzeme rezervasyon oneri listesi"]}/>;
    if(tab==="quotes") return <SalesManagement currentUser={currentUser} machines={machines} onOpenWorkOrders={()=>setTab("orders")} defaultView="quotes"/>;
    if(tab==="purchase") return <ModulePlaceholder title="Satin Alma Planlama" desc="MRP ciktilarini satin alma taleplerine donusturur ve tedarik surecine aktarir." items={["PR/PO taslak olusturma","Tedarikci lead-time ve termin kontrolu","Hizlandir/yavaslat (expedite/de-expedite) oneri listesi"]}/>;
    if(tab==="downtime") return <ModulePlaceholder title="Durus Yonetimi" desc="Durus tipleri, operator girisleri ve otomatik durus analizi bu moduldedir." items={["Durus nedeni zorunlu giris kurallari","Sure-neden kaydi ve tekrar eden hata analizi","Bakim ekibine ariza bildirimi"]}/>;
    if(tab==="quality") return <ModulePlaceholder title="Kalite ve Izlenebilirlik" desc="Parca bazli seri no izi, inspeksiyon sonucu, scrap ve FAI akisini yonetir." items={["WO-Makina-Operator-Program versiyon zinciri","Olcum sonucu ve pass/fail kaydi","Scrap neden kodu ve maliyet etkisi"]}/>;
    if(tab==="notifications") return <ModulePlaceholder title="Bildirim Merkezi" desc="Sistem alarmlari ve operasyonel uyarilar burada yonetilir." items={["Tezgah alarmi ve gecikme uyarilari","Stok kritik seviye bildirimleri","Takim omru ve cevrim sapma bildirimleri"]}/>;
    if(tab==="cost") return <ModulePlaceholder title="Maliyetleme" desc="Parca ve is emri bazli maliyetleri planlanan ve gerceklesen olarak karsilastirir." items={["Malzeme + iscilik + makina sure maliyeti","Scrap/rework maliyet analizi","Musteri ve urun bazli karlilik"]}/>;
    if(tab==="integrations") return <ModulePlaceholder title="Entegrasyonlar" desc="ERP, CAM ve bildirim sistemleri ile cift yon veri senkronu bu moduldedir." items={["ERP siparis/BOM/routing sync","CAM program versiyon baglama","Webhook + email + SMS alarm akislari"]}/>;
    return <ModulePlaceholder title="Modul" desc="Secili modul tanimli degil." items={[]}/>;
  }
  const activeView=getActiveView();

  const modeSwitch=(
    <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
      {MODE_OPTIONS.map(m=>(
        <button key={m.id} onClick={()=>setWorkMode(m.id)} style={{...chip(workMode===m.id,m.color),padding:"7px 10px",fontSize:11}}>
          {m.label}
        </button>
      ))}
    </div>
  );

  const menuSection=compact=>(
    <div style={{display:"flex",flexDirection:"column",gap:10}}>
      {visibleGroups.map(g=>(
        <div key={g}>
          <div style={{fontSize:10,color:C.muted2,letterSpacing:1,textTransform:"uppercase",marginBottom:6,padding:compact?"0 2px":"0 4px"}}>{g}</div>
          <div style={{display:"flex",flexDirection:"column",gap:6}}>
            {groupedTabs[g].map(t=>(
              <button key={t.id} onClick={()=>setTab(t.id)} style={{display:"flex",alignItems:"center",gap:10,textAlign:"left",padding:compact?"9px 10px":"10px 12px",borderRadius:10,border:`1px solid ${tab===t.id?C.accent:C.border}`,background:tab===t.id?C.accent+"18":C.card,color:tab===t.id?C.accent:C.text,cursor:"pointer",fontFamily:"inherit"}}>
                <span style={{width:22,display:"inline-flex",justifyContent:"center",alignItems:"center"}}><NavIcon name={t.icon}/></span>
                <span style={{fontSize:compact?12:13,fontWeight:tab===t.id?700:500}}>{t.label}</span>
              </button>
            ))}
          </div>
        </div>
      ))}
    </div>
  );

  return (
    <div style={{background:C.bg,minHeight:"100vh",color:C.text,fontFamily:"'DM Sans','Segoe UI',sans-serif"}}>
      <div style={{width:"100%",maxWidth:contentMaxWidth,margin:"0 auto",paddingBottom:layoutMode==="mobile"?76:20}}>
        <div style={{background:C.surface,borderBottom:`1px solid ${C.border}`,padding:headerPadding,position:"sticky",top:0,zIndex:10}}>
          <div style={{display:"flex",alignItems:"center",gap:10,flexWrap:"wrap"}}>
            <div style={{width:34,height:34,borderRadius:10,background:"transparent",display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden"}}>
              {!logoError?<img src={logoSrc||LOGO_SRC} alt="Logo" onError={()=>setLogoError(true)} style={{width:"100%",height:"100%",objectFit:"cover"}}/>:<span style={{fontSize:16}}>⚙️</span>}
            </div>
            <div style={{flex:1,minWidth:220}}>
              <div style={{fontWeight:700,fontSize:14,color:C.text}}>CNC Atolye MRP Platformu</div>
              <div style={{color:C.muted2,fontSize:11,display:"flex",alignItems:"center",gap:5,flexWrap:"wrap"}}>
                <span>{currentUser.fullName}</span>
                <Badge label={isAdmin?"Yonetici":"Operator"} color={isAdmin?C.accent:C.muted2}/>
                <Badge label={layoutMode==="desktop"?"Desktop":(layoutMode==="tablet"?"Tablet":"Mobil")} color={C.muted2}/>
              </div>
            </div>
            {modeSwitch}
            <button onClick={logout} style={{...btnSt("ghost"),padding:"7px 12px",fontSize:12}}>Cikis</button>
          </div>
        </div>

        {layoutMode==="desktop"&&(
          <div style={{display:"grid",gridTemplateColumns:`${desktopSidebarW}px minmax(0,1fr)`,gap:14,alignItems:"start",padding:"12px 10px"}}>
            <div style={{position:"sticky",top:76}}>
              <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:14,padding:10,maxHeight:"calc(100vh - 100px)",overflowY:"auto"}}>
                {menuSection(false)}
              </div>
            </div>
            <div style={{minWidth:0}}>{activeView}</div>
          </div>
        )}
        {layoutMode==="tablet"&&(
          <div style={{display:"grid",gridTemplateColumns:`minmax(0,1fr) ${tabletSidebarW}px`,gap:14,alignItems:"start",padding:"10px"}}>
            <div style={{minWidth:0}}>{activeView}</div>
            <div style={{position:"sticky",top:76}}>
              <div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:14,padding:8,maxHeight:"calc(100vh - 100px)",overflowY:"auto"}}>
                {menuSection(true)}
              </div>
            </div>
          </div>
        )}
        {layoutMode==="mobile"&&(
          <>
            {activeView}
            <div style={{position:"fixed",bottom:0,left:"50%",transform:"translateX(-50%)",width:"100%",maxWidth:520,background:C.surface,borderTop:`1px solid ${C.border}`,display:"flex",overflowX:"auto",overflowY:"hidden",WebkitOverflowScrolling:"touch",zIndex:20}}>
              {mobilePrimary.map(t=>(
                <button key={t.id} onClick={()=>setTab(t.id)} style={{flex:"1 0 86px",minWidth:86,padding:"12px 10px 10px",border:"none",background:"transparent",cursor:"pointer",color:tab===t.id?C.accent:C.muted,borderTop:`2px solid ${tab===t.id?C.accent:"transparent"}`,fontFamily:"inherit"}}>
                  <div style={{display:"inline-flex",justifyContent:"center",alignItems:"center",height:20}}><NavIcon name={t.icon} size={19}/></div>
                  <div style={{fontSize:10,fontWeight:tab===t.id?700:400,marginTop:2}}>{t.label}</div>
                </button>
              ))}
              <button onClick={()=>setMobileMenuOpen(true)} style={{flex:"0 0 82px",minWidth:82,padding:"12px 10px 10px",border:"none",background:"transparent",cursor:"pointer",color:mobileMenuOpen?C.accent:C.muted,borderTop:`2px solid ${mobileMenuOpen?C.accent:"transparent"}`,fontFamily:"inherit"}}>
                <div style={{display:"inline-flex",justifyContent:"center",alignItems:"center",height:20}}><NavIcon name="users" size={19}/></div>
                <div style={{fontSize:10,fontWeight:mobileMenuOpen?700:400,marginTop:2}}>Menu</div>
              </button>
            </div>
            {mobileMenuOpen&&(
              <div onClick={()=>setMobileMenuOpen(false)} style={{position:"fixed",inset:0,background:"rgba(0,0,0,.55)",zIndex:30,display:"flex",alignItems:"flex-end"}}>
                <div onClick={e=>e.stopPropagation()} style={{width:"100%",maxHeight:"80vh",background:C.surface,borderTop:`1px solid ${C.border}`,borderTopLeftRadius:16,borderTopRightRadius:16,padding:12,overflowY:"auto"}}>
                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
                    <div style={{fontWeight:700,color:C.text}}>MRP Menusu</div>
                    <button onClick={()=>setMobileMenuOpen(false)} style={{...btnSt("ghost"),padding:"6px 10px",fontSize:12}}>Kapat</button>
                  </div>
                  {menuSection(true)}
                </div>
              </div>
            )}
          </>
        )}
      </div>
    </div>
  );
}
ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>


