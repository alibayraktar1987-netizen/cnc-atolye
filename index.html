<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
<title>CNC AtÃ¶lye Takip</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet"/>
<style>*{box-sizing:border-box;margin:0;padding:0;}body{background:#0a0c12;}</style>
</head>
<body>
<div id="root"></div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, collection, getDocs, addDoc, updateDoc, deleteDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA6BAv57T-M_oeg5c0-irynYThqQv0s1xI",
  authDomain: "cnc-atolye.firebaseapp.com",
  projectId: "cnc-atolye",
  storageBucket: "cnc-atolye.firebasestorage.app",
  messagingSenderId: "1059210834667",
  appId: "1:1059210834667:web:1e506c41567b4e273784ae"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// â”€â”€ DB HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.DB = {
  async getDoc(col, id) {
    try { const s = await getDoc(doc(db, col, id)); return s.exists() ? { id: s.id, ...s.data() } : null; } catch { return null; }
  },
  async setDoc(col, id, data) {
    try { await setDoc(doc(db, col, id), data, { merge: true }); return true; } catch(e) { console.error(e); return false; }
  },
  async getAll(col) {
    try { const s = await getDocs(collection(db, col)); return s.docs.map(d => ({ id: d.id, ...d.data() })); } catch { return []; }
  },
  async addDoc(col, data) {
    try { const r = await addDoc(collection(db, col), { ...data, createdAt: new Date().toISOString() }); return r.id; } catch { return null; }
  },
  async updateDoc(col, id, data) {
    try { await updateDoc(doc(db, col, id), data); return true; } catch { return false; }
  },
  async deleteDoc(col, id) {
    try { await deleteDoc(doc(db, col, id)); return true; } catch { return false; }
  }
};

// â”€â”€ SESSION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.Session = {
  get() { try { const s = localStorage.getItem("cnc_session"); return s ? JSON.parse(s) : null; } catch { return null; } },
  set(u) { localStorage.setItem("cnc_session", JSON.stringify(u)); },
  clear() { localStorage.removeItem("cnc_session"); }
};

// Signal that Firebase is ready
window.FB_READY = true;
window.dispatchEvent(new Event("fb_ready"));
</script>

<!-- React + Babel -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel" data-presets="react">
const { useState, useEffect, useCallback, useRef } = React;

// â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_MACHINES = ["CNC-1","CNC-2","CNC-3","CNC-4"];
const SHIFTS = [
  { id:"sabah", label:"Sabah", time:"06:00â€“14:00" },
  { id:"ogleden", label:"Ã–ÄŸleden Sonra", time:"14:00â€“22:00" },
  { id:"gece", label:"Gece", time:"22:00â€“06:00" },
];
const EFFECTIVE_SECONDS = 72000;
const PERMISSIONS = [
  { id:"data_entry", label:"Veri GiriÅŸi", icon:"ğŸ“", desc:"Ãœretim verisi girebilir" },
  { id:"view_reports", label:"Rapor GÃ¶rÃ¼ntÃ¼leme", icon:"ğŸ“Š", desc:"TÃ¼m raporlarÄ± gÃ¶rebilir" },
  { id:"manage_orders", label:"Ä°ÅŸ Emri OluÅŸturma", icon:"ğŸ“‹", desc:"Ä°ÅŸ emri ekleyip dÃ¼zenleyebilir" },
  { id:"approve_users", label:"KullanÄ±cÄ± Onaylama", icon:"ğŸ‘¥", desc:"KullanÄ±cÄ±larÄ± onaylayabilir" },
];

const C = {
  bg:"#0a0c12", surface:"#12151f", card:"#181b28", border:"#252837",
  accent:"#4f8ef7", accentDim:"#4f8ef715",
  green:"#00c896", greenDim:"#00c89615",
  red:"#ff4d6d", redDim:"#ff4d6d15",
  warn:"#ffb830", warnDim:"#ffb83015",
  purple:"#9b7ff4",
  text:"#e2e5f0", muted:"#5a5f75", muted2:"#8b90a8",
};

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const todayStr = () => new Date().toISOString().slice(0,10);
const monthStr = (d=new Date()) => d.toISOString().slice(0,7);
function weekStart(d=new Date()) {
  const x=new Date(d); const day=x.getDay();
  x.setDate(x.getDate()-(day===0?6:day-1));
  return x.toISOString().slice(0,10);
}
function calcPerf(correct,wrong,partSec) {
  if(!partSec||partSec<=0) return null;
  const max=Math.floor(EFFECTIVE_SECONDS/partSec);
  return {max, perf:max>0?Math.round(((correct+wrong)/max)*100):0};
}
function fmtSec(s) {
  if(!s) return "";
  const m=Math.floor(s/60),sec=s%60;
  return m>0?(sec>0?m+"dk "+sec+"sn":m+"dk"):sec+"sn";
}
function hasPermission(user,perm) {
  if(user.role==="admin") return true;
  return (user.permissions||[]).includes(perm);
}
async function fileToBase64(file) {
  return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
}
function getFileIcon(name) {
  const ext=(name||"").split(".").pop().toLowerCase();
  if(["jpg","jpeg","png","gif","webp"].includes(ext)) return "ğŸ–¼ï¸";
  if(ext==="pdf") return "ğŸ“„";
  if(["dxf","dwg"].includes(ext)) return "ğŸ“";
  return "ğŸ“";
}
function formatBytes(b) {
  if(b<1024) return b+" B";
  if(b<1048576) return (b/1024).toFixed(1)+" KB";
  return (b/1048576).toFixed(1)+" MB";
}
function hashPass(p) { return btoa(unescape(encodeURIComponent(p))); }

// â”€â”€ STYLE ATOMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const labelSt={color:C.muted2,fontSize:11,letterSpacing:.8,textTransform:"uppercase",fontWeight:600,marginBottom:6,display:"block"};
const inputSt={width:"100%",background:C.surface,border:`1px solid ${C.border}`,borderRadius:10,padding:"11px 14px",color:C.text,fontSize:14,outline:"none",boxSizing:"border-box",fontFamily:"inherit"};
const chip=(active,color=C.accent)=>({padding:"8px 13px",borderRadius:9,border:`1px solid ${active?color:C.border}`,background:active?color+"18":C.surface,color:active?color:C.muted2,fontSize:12,fontWeight:active?700:400,cursor:"pointer",fontFamily:"inherit"});
const btnSt=(v="primary")=>({border:"none",borderRadius:10,padding:"11px 18px",fontSize:13,fontWeight:700,cursor:"pointer",fontFamily:"inherit",transition:"opacity .15s",
  ...(v==="primary"?{background:C.accent,color:"#fff",boxShadow:`0 4px 18px ${C.accent}30`}:
     v==="danger"?{background:C.red,color:"#fff"}:
     v==="green"?{background:C.green,color:"#0a0c12",boxShadow:`0 4px 18px ${C.green}30`}:
     v==="ghost"?{background:"transparent",color:C.muted2,border:`1px solid ${C.border}`}:
     {background:C.surface,color:C.text,border:`1px solid ${C.border}`})});

function Badge({label:l,color=C.muted2}) {
  return <span style={{background:color+"20",color,border:`1px solid ${color}40`,borderRadius:6,padding:"2px 8px",fontSize:10,fontWeight:700,letterSpacing:.5,textTransform:"uppercase"}}>{l}</span>;
}
function PerfBar({perf,small}) {
  const col=perf>=85?C.green:perf>=60?C.warn:C.red;
  return (
    <div style={{marginTop:small?4:8}}>
      <div style={{display:"flex",justifyContent:"space-between",fontSize:11,color:C.muted2,marginBottom:3}}>
        <span>Performans</span><span style={{color:col,fontWeight:700}}>{perf}%</span>
      </div>
      <div style={{background:C.border,borderRadius:99,height:small?4:6,overflow:"hidden"}}>
        <div style={{width:`${Math.min(perf,100)}%`,height:"100%",background:col,borderRadius:99,transition:"width .6s ease"}}/>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH SCREEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function AuthScreen({onLogin}) {
  const [mode,setMode]=useState("login");
  const [form,setForm]=useState({username:"",password:"",confirm:"",fullName:""});
  const [err,setErr]=useState(""); const [ok,setOk]=useState(""); const [loading,setLoading]=useState(false);
  const f=k=>e=>setForm(p=>({...p,[k]:e.target.value}));

  async function doLogin() {
    setErr(""); setLoading(true);
    const u = await window.DB.getDoc("users", form.username.toLowerCase());
    if(!u){setErr("KullanÄ±cÄ± bulunamadÄ±.");setLoading(false);return;}
    if(u.password!==hashPass(form.password)){setErr("Åifre hatalÄ±.");setLoading(false);return;}
    if(u.status==="pending"){setErr("HesabÄ±nÄ±z onay bekliyor.");setLoading(false);return;}
    if(u.status==="rejected"){setErr("HesabÄ±nÄ±z reddedildi.");setLoading(false);return;}
    window.Session.set({username:u.id});
    onLogin(u); setLoading(false);
  }

  async function doRegister() {
    setErr(""); setOk("");
    if(!form.username||!form.password||!form.fullName){setErr("TÃ¼m alanlar zorunlu.");return;}
    if(form.password!==form.confirm){setErr("Åifreler eÅŸleÅŸmiyor.");return;}
    if(form.password.length<4){setErr("Åifre en az 4 karakter.");return;}
    setLoading(true);
    const key=form.username.toLowerCase().trim();
    const existing=await window.DB.getDoc("users",key);
    if(existing){setErr("Bu kullanÄ±cÄ± adÄ± alÄ±nmÄ±ÅŸ.");setLoading(false);return;}
    const allUsers=await window.DB.getAll("users");
    const isFirst=allUsers.length===0;
    const saved=await window.DB.setDoc("users",key,{
      username:key, fullName:form.fullName, password:hashPass(form.password),
      role:isFirst?"admin":"operator", status:isFirst?"active":"pending",
      permissions:["data_entry","view_reports"]
    });
    if(!saved){setErr("Kullanici kaydi olusturulamadi. Veritabani yetkilerini (Firestore Rules) kontrol edin.");setLoading(false);return;}
    setOk(isFirst?"Ä°lk kullanÄ±cÄ± â†’ otomatik YÃ¶netici! GiriÅŸ yapabilirsiniz.":"KayÄ±t baÅŸarÄ±lÄ±! YÃ¶netici onayÄ±nÄ± bekleyin.");
    setMode("login"); setForm({username:"",password:"",confirm:"",fullName:""}); setLoading(false);
  }

  return (
    <div style={{minHeight:"100vh",background:C.bg,display:"flex",alignItems:"center",justifyContent:"center",padding:20}}>
      <div style={{width:"100%",maxWidth:380}}>
        <div style={{textAlign:"center",marginBottom:28}}>
          <div style={{width:60,height:60,borderRadius:18,background:`linear-gradient(135deg,${C.accent},#7b5cf0)`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:28,margin:"0 auto 10px"}}>âš™ï¸</div>
          <div style={{fontWeight:800,fontSize:22,color:C.text,letterSpacing:-.5}}>CNC AtÃ¶lye</div>
          <div style={{color:C.muted2,fontSize:13,marginTop:2}}>Ä°ÅŸ Takip Sistemi</div>
        </div>
        <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:18,padding:24}}>
          <div style={{display:"flex",background:C.surface,borderRadius:10,padding:3,marginBottom:20}}>
            {[["login","GiriÅŸ Yap"],["register","KayÄ±t Ol"]].map(([id,lbl])=>(
              <button key={id} onClick={()=>{setMode(id);setErr("");setOk("");}} style={{flex:1,padding:"9px 0",border:"none",borderRadius:8,cursor:"pointer",background:mode===id?C.card:"transparent",color:mode===id?C.text:C.muted2,fontWeight:mode===id?700:400,fontSize:13,fontFamily:"inherit"}}>{lbl}</button>
            ))}
          </div>
          {err&&<div style={{background:C.redDim,border:`1px solid ${C.red}40`,borderRadius:10,padding:"10px 14px",color:C.red,fontSize:13,marginBottom:14}}>{err}</div>}
          {ok&&<div style={{background:C.greenDim,border:`1px solid ${C.green}40`,borderRadius:10,padding:"10px 14px",color:C.green,fontSize:13,marginBottom:14}}>{ok}</div>}
          <div style={{display:"flex",flexDirection:"column",gap:12}}>
            {mode==="register"&&<div><span style={labelSt}>Ad Soyad</span><input style={inputSt} placeholder="AdÄ±nÄ±z SoyadÄ±nÄ±z" value={form.fullName} onChange={f("fullName")}/></div>}
            <div><span style={labelSt}>KullanÄ±cÄ± AdÄ±</span><input style={inputSt} placeholder="kullanici_adi" value={form.username} onChange={f("username")} autoCapitalize="none" autoCorrect="off"/></div>
            <div><span style={labelSt}>Åifre</span><input style={inputSt} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" type="password" value={form.password} onChange={f("password")}/></div>
            {mode==="register"&&<div><span style={labelSt}>Åifre Tekrar</span><input style={inputSt} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" type="password" value={form.confirm} onChange={f("confirm")}/></div>}
            <button onClick={mode==="login"?doLogin:doRegister} style={{...btnSt("primary"),width:"100%",padding:14,fontSize:15,opacity:loading?.7:1}} disabled={loading}>
              {loading?"...":mode==="login"?"GiriÅŸ Yap":"KayÄ±t Ol"}
            </button>
          </div>
        </div>
        <div style={{textAlign:"center",color:C.muted,fontSize:11,marginTop:12}}>Ä°lk kayÄ±t otomatik YÃ¶netici olur.</div>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MACHINE SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function MachineSettings({machines,onUpdate}) {
  const [editing,setEditing]=useState(false);
  const [draft,setDraft]=useState([...machines]);
  const [newName,setNewName]=useState("");

  async function save() {
    const cleaned=draft.map(m=>m.trim()).filter(Boolean);
    if(cleaned.length===0){alert("En az 1 tezgah gerekli!");return;}
    await onUpdate(cleaned); setEditing(false);
  }
  return (
    <div style={{marginBottom:24}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
        <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",fontWeight:600}}>Tezgah Ä°simleri</div>
        {!editing&&<button onClick={()=>{setDraft([...machines]);setEditing(true);}} style={{...btnSt("ghost"),padding:"6px 12px",fontSize:12}}>âœï¸ DÃ¼zenle</button>}
      </div>
      {!editing?(
        <div style={{display:"flex",gap:7,flexWrap:"wrap"}}>
          {machines.map((m,i)=><div key={i} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:9,padding:"8px 14px",fontSize:13,fontWeight:600,color:C.text}}>{m}</div>)}
        </div>
      ):(
        <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:14}}>
          <div style={{display:"flex",flexDirection:"column",gap:8,marginBottom:12}}>
            {draft.map((m,i)=>(
              <div key={i} style={{display:"flex",gap:8,alignItems:"center"}}>
                <input value={m} onChange={e=>setDraft(d=>d.map((x,idx)=>idx===i?e.target.value:x))} style={{...inputSt,flex:1,padding:"9px 12px",fontSize:13}}/>
                <button onClick={()=>setDraft(d=>d.filter((_,idx)=>idx!==i))} style={{background:"transparent",border:`1px solid ${C.red}50`,borderRadius:8,color:C.red,width:34,height:34,cursor:"pointer",fontSize:16,flexShrink:0}}>Ã—</button>
              </div>
            ))}
          </div>
          <div style={{display:"flex",gap:8,marginBottom:12}}>
            <input value={newName} onChange={e=>setNewName(e.target.value)} onKeyDown={e=>{if(e.key==="Enter"&&newName.trim()){setDraft(d=>[...d,newName.trim()]);setNewName("");}}} placeholder="Yeni tezgah adÄ±..." style={{...inputSt,flex:1,padding:"9px 12px",fontSize:13}}/>
            <button onClick={()=>{if(newName.trim()){setDraft(d=>[...d,newName.trim()]);setNewName("");}}} style={{...btnSt("primary"),padding:"9px 14px",fontSize:13,flexShrink:0}}>+ Ekle</button>
          </div>
          <div style={{display:"flex",gap:8}}>
            <button onClick={save} style={{...btnSt("green"),flex:1,padding:10}}>ğŸ’¾ Kaydet</button>
            <button onClick={()=>setEditing(false)} style={{...btnSt("ghost"),padding:10}}>Ä°ptal</button>
          </div>
        </div>
      )}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN USERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function AdminUsers({currentUser,machines,onMachinesUpdate}) {
  const [users,setUsers]=useState([]);
  const [loading,setLoading]=useState(true);
  const [expanded,setExpanded]=useState(null);

  const load=useCallback(async()=>{ const u=await window.DB.getAll("users"); setUsers(u); setLoading(false); },[]);
  useEffect(()=>{load();},[load]);

  async function update(id,patch) {
    await window.DB.updateDoc("users",id,patch);
    setUsers(u=>u.map(x=>x.id===id?{...x,...patch}:x));
  }
  async function togglePerm(id,permId) {
    const u=users.find(x=>x.id===id);
    const perms=[...(u.permissions||[])];
    const idx=perms.indexOf(permId);
    if(idx>=0) perms.splice(idx,1); else perms.push(permId);
    await update(id,{permissions:perms});
  }

  const list=[...users].sort((a,b)=>{const o={pending:0,active:1,rejected:2};return(o[a.status]??3)-(o[b.status]??3);});
  if(loading) return <div style={{padding:30,color:C.muted2,textAlign:"center"}}>YÃ¼kleniyor...</div>;

  return (
    <div style={{padding:16}}>
      <MachineSettings machines={machines} onUpdate={onMachinesUpdate}/>
      <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",marginBottom:12}}>KullanÄ±cÄ± YÃ¶netimi Â· {list.length} kullanÄ±cÄ±</div>
      {list.map(u=>(
        <div key={u.id} style={{background:C.card,border:`1px solid ${u.status==="pending"?C.warn+"60":C.border}`,borderRadius:14,padding:"14px 16px",marginBottom:10}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:8}}>
            <div><div style={{fontWeight:700,fontSize:14}}>{u.fullName}</div><div style={{color:C.muted2,fontSize:12,marginTop:1}}>@{u.username||u.id}</div></div>
            <div style={{display:"flex",gap:5,flexWrap:"wrap",justifyContent:"flex-end"}}>
              <Badge label={u.role==="admin"?"YÃ¶netici":"OperatÃ¶r"} color={u.role==="admin"?C.accent:C.muted2}/>
              <Badge label={u.status==="active"?"Aktif":u.status==="pending"?"Bekliyor":"AskÄ±da"} color={u.status==="active"?C.green:u.status==="pending"?C.warn:C.red}/>
            </div>
          </div>
          {u.id!==currentUser.id&&(
            <>
              <div style={{display:"flex",gap:7,flexWrap:"wrap",marginBottom:8}}>
                {u.status==="pending"&&<><button onClick={()=>update(u.id,{status:"active"})} style={{...btnSt("green"),padding:"7px 13px",fontSize:12}}>âœ“ Onayla</button><button onClick={()=>update(u.id,{status:"rejected"})} style={{...btnSt("danger"),padding:"7px 13px",fontSize:12}}>âœ• Reddet</button></>}
                {u.status==="active"&&<><button onClick={()=>update(u.id,{role:u.role==="admin"?"operator":"admin"})} style={{...btnSt(),padding:"7px 13px",fontSize:12}}>{u.role==="admin"?"ğŸ‘· OperatÃ¶r Yap":"ğŸ‘‘ YÃ¶netici Yap"}</button><button onClick={()=>update(u.id,{status:"rejected"})} style={{...btnSt("danger"),padding:"7px 13px",fontSize:12}}>AskÄ±ya Al</button></>}
                {u.status==="rejected"&&<button onClick={()=>update(u.id,{status:"active"})} style={{...btnSt("green"),padding:"7px 13px",fontSize:12}}>AktifleÅŸtir</button>}
                {u.role==="operator"&&<button onClick={()=>setExpanded(expanded===u.id?null:u.id)} style={{...btnSt("ghost"),padding:"7px 13px",fontSize:12}}>{expanded===u.id?"â–² Gizle":"âš™ï¸ Yetkiler"}</button>}
              </div>
              {expanded===u.id&&u.role==="operator"&&(
                <div style={{background:C.surface,borderRadius:10,padding:12,border:`1px solid ${C.border}`}}>
                  <div style={{color:C.muted2,fontSize:11,letterSpacing:.8,textTransform:"uppercase",marginBottom:10,fontWeight:600}}>KullanÄ±cÄ± Yetkileri</div>
                  {PERMISSIONS.map(p=>{
                    const active=(u.permissions||[]).includes(p.id);
                    return (
                      <div key={p.id} onClick={()=>togglePerm(u.id,p.id)} style={{display:"flex",alignItems:"center",gap:12,padding:"10px 12px",borderRadius:9,marginBottom:6,cursor:"pointer",background:active?C.accent+"12":C.card,border:`1px solid ${active?C.accent+"40":C.border}`}}>
                        <div style={{fontSize:18}}>{p.icon}</div>
                        <div style={{flex:1}}><div style={{fontWeight:600,fontSize:13,color:active?C.accent:C.text}}>{p.label}</div><div style={{fontSize:11,color:C.muted2,marginTop:1}}>{p.desc}</div></div>
                        <div style={{width:20,height:20,borderRadius:5,border:`2px solid ${active?C.accent:C.border}`,background:active?C.accent:"transparent",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>{active&&<span style={{color:"#fff",fontSize:12,fontWeight:800}}>âœ“</span>}</div>
                      </div>
                    );
                  })}
                </div>
              )}
            </>
          )}
          {u.id===currentUser.id&&<div style={{color:C.muted,fontSize:11}}>Bu sizin hesabÄ±nÄ±z</div>}
        </div>
      ))}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WORK ORDERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function WorkOrders({currentUser,machines=DEFAULT_MACHINES}) {
  const [orders,setOrders]=useState([]);
  const [loading,setLoading]=useState(true);
  const [showForm,setShowForm]=useState(false);
  const [editId,setEditId]=useState(null);
  const [viewOrder,setViewOrder]=useState(null);
  const [uploading,setUploading]=useState(false);
  const fileRef=useRef();
  const emptyForm={code:"",name:"",material:"",partSec:"",machines:[],notes:"",files:[]};
  const [form,setForm]=useState(emptyForm);

  const load=useCallback(async()=>{ const o=await window.DB.getAll("orders"); setOrders(o.sort((a,b)=>b.createdAt?.localeCompare(a.createdAt))); setLoading(false); },[]);
  useEffect(()=>{load();},[load]);

  const fv=(k,v)=>setForm(p=>({...p,[k]:v}));
  const toggleMachine=m=>fv("machines",form.machines.includes(m)?form.machines.filter(x=>x!==m):[...form.machines,m]);

  async function handleFiles(fileList) {
    setUploading(true);
    const results=[];
    for(const file of Array.from(fileList)){
      if(file.size>5*1024*1024){alert(`${file.name} 5MB'dan bÃ¼yÃ¼k, atlandÄ±.`);continue;}
      const b64=await fileToBase64(file);
      results.push({name:file.name,size:file.size,type:file.type,data:b64});
    }
    fv("files",[...form.files,...results]);
    setUploading(false);
  }

  async function save() {
    if(!form.code||!form.name||!form.partSec){alert("Kod, parÃ§a adÄ± ve sÃ¼re zorunlu!");return;}
    if(form.machines.length===0){alert("En az bir tezgah seÃ§in!");return;}
    const data={code:form.code.toUpperCase(),name:form.name,material:form.material,partSec:Number(form.partSec),machines:form.machines,notes:form.notes,files:form.files,status:"active",updatedAt:new Date().toISOString()};
    if(editId){
      await window.DB.updateDoc("orders",editId,data);
      setOrders(o=>o.map(x=>x.id===editId?{...x,...data}:x));
    } else {
      const id=await window.DB.addDoc("orders",{...data,createdBy:currentUser.id});
      if(id) setOrders(o=>[{id,...data,createdAt:new Date().toISOString()},...o]);
    }
    setShowForm(false); setForm(emptyForm); setEditId(null);
  }

  async function toggleStatus(o) {
    const ns=o.status==="active"?"passive":"active";
    await window.DB.updateDoc("orders",o.id,{status:ns});
    setOrders(orders=>orders.map(x=>x.id===o.id?{...x,status:ns}:x));
  }

  if(loading) return <div style={{padding:30,color:C.muted2,textAlign:"center"}}>YÃ¼kleniyor...</div>;

  if(viewOrder) return (
    <div style={{padding:16}}>
      <button onClick={()=>setViewOrder(null)} style={{...btnSt("ghost"),marginBottom:16,padding:"8px 14px",fontSize:13}}>â† Geri</button>
      <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:16,marginBottom:12}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:12}}>
          <div><div style={{fontWeight:800,fontSize:18,fontFamily:"monospace",color:C.text}}>{viewOrder.code}</div><div style={{fontSize:15,fontWeight:600,marginTop:2,color:C.text}}>{viewOrder.name}</div></div>
          <Badge label={viewOrder.status==="active"?"Aktif":"Pasif"} color={viewOrder.status==="active"?C.green:C.muted2}/>
        </div>
        {[["Malzeme",viewOrder.material],["ParÃ§a SÃ¼resi",fmtSec(viewOrder.partSec)],["Maks Ãœretim/GÃ¼n",viewOrder.partSec?Math.floor(EFFECTIVE_SECONDS/viewOrder.partSec)+" adet":"-"],["Tezgahlar",(viewOrder.machines||[]).join(", ")],["Notlar",viewOrder.notes]].map(([l,v])=>v?(
          <div key={l} style={{marginBottom:10}}><div style={{color:C.muted2,fontSize:11,letterSpacing:.8,textTransform:"uppercase",marginBottom:2}}>{l}</div><div style={{fontSize:14,color:C.text}}>{v}</div></div>
        ):null)}
      </div>
      <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",marginBottom:10}}>Teknik Dosyalar ({(viewOrder.files||[]).length})</div>
      {(viewOrder.files||[]).length===0?<div style={{color:C.muted,fontSize:13,textAlign:"center",padding:20,background:C.card,borderRadius:12,border:`1px solid ${C.border}`}}>Dosya yÃ¼klenmemiÅŸ</div>:
        (viewOrder.files||[]).map((f,i)=>(
          <div key={i} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"12px 14px",marginBottom:8,display:"flex",alignItems:"center",gap:12}}>
            <div style={{fontSize:28,flexShrink:0}}>{getFileIcon(f.name)}</div>
            <div style={{flex:1,minWidth:0}}><div style={{fontWeight:600,fontSize:13,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",color:C.text}}>{f.name}</div><div style={{color:C.muted2,fontSize:11,marginTop:2}}>{formatBytes(f.size)}</div></div>
            {f.data&&f.type&&f.type.startsWith("image/")&&<img src={f.data} alt={f.name} style={{width:48,height:48,objectFit:"cover",borderRadius:8,border:`1px solid ${C.border}`}}/>}
            {f.data&&<a href={f.data} download={f.name} style={{...btnSt("ghost"),padding:"6px 10px",fontSize:12,textDecoration:"none",flexShrink:0}}>â¬‡</a>}
          </div>
        ))
      }
    </div>
  );

  if(showForm) return (
    <div style={{padding:16}}>
      <button onClick={()=>{setShowForm(false);setForm(emptyForm);setEditId(null);}} style={{...btnSt("ghost"),marginBottom:16,padding:"8px 14px",fontSize:13}}>â† Geri</button>
      <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",marginBottom:16}}>{editId?"Ä°ÅŸ Emri DÃ¼zenle":"Yeni Ä°ÅŸ Emri"}</div>
      <div style={{display:"flex",flexDirection:"column",gap:14}}>
        <div><span style={labelSt}>Ä°ÅŸ Emri Kodu *</span><input style={inputSt} placeholder="IE-001" value={form.code} onChange={e=>fv("code",e.target.value.toUpperCase())}/></div>
        <div><span style={labelSt}>ParÃ§a AdÄ± *</span><input style={inputSt} placeholder="ParÃ§a adÄ±" value={form.name} onChange={e=>fv("name",e.target.value)}/></div>
        <div><span style={labelSt}>Malzeme</span><input style={inputSt} placeholder="AISI 304, AlÃ¼minyum 6061..." value={form.material} onChange={e=>fv("material",e.target.value)}/></div>
        <div>
          <span style={labelSt}>ParÃ§a SÃ¼resi (saniye) *</span>
          <input style={inputSt} type="number" min="1" placeholder="Ã–rn: 90" value={form.partSec} onChange={e=>fv("partSec",e.target.value)}/>
          {form.partSec>0&&<div style={{color:C.muted2,fontSize:11,marginTop:5}}>â†’ Maks: <span style={{color:C.accent,fontWeight:700}}>{Math.floor(EFFECTIVE_SECONDS/Number(form.partSec))} adet</span>/gÃ¼n ({fmtSec(Number(form.partSec))}/parÃ§a)</div>}
        </div>
        <div>
          <span style={labelSt}>Tezgah AtamasÄ± *</span>
          <div style={{display:"flex",gap:7,flexWrap:"wrap"}}>
            {machines.map(m=><button key={m} onClick={()=>toggleMachine(m)} style={chip(form.machines.includes(m))}>{m}</button>)}
          </div>
        </div>
        <div><span style={labelSt}>Notlar</span><textarea style={{...inputSt,resize:"vertical",minHeight:70}} placeholder="Notlar..." value={form.notes} onChange={e=>fv("notes",e.target.value)}/></div>
        <div>
          <span style={labelSt}>Teknik Dosyalar</span>
          <div onClick={()=>fileRef.current?.click()} style={{border:`2px dashed ${C.border}`,borderRadius:12,padding:20,textAlign:"center",cursor:"pointer",background:C.surface}} onDragOver={e=>e.preventDefault()} onDrop={e=>{e.preventDefault();handleFiles(e.dataTransfer.files);}}>
            <div style={{fontSize:28,marginBottom:6}}>ğŸ“</div>
            <div style={{color:C.muted2,fontSize:13}}>{uploading?"YÃ¼kleniyor...":"Dosya seÃ§ veya sÃ¼rÃ¼kle bÄ±rak"}</div>
            <div style={{color:C.muted,fontSize:11,marginTop:4}}>Resim, PDF, DXF, DWG Â· Maks 5MB/dosya</div>
          </div>
          <input ref={fileRef} type="file" multiple accept="image/*,.pdf,.dxf,.dwg,.step,.stp" style={{display:"none"}} onChange={e=>handleFiles(e.target.files)}/>
          {form.files.map((f,i)=>(
            <div key={i} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:10,padding:"10px 12px",marginTop:8,display:"flex",alignItems:"center",gap:10}}>
              <span style={{fontSize:20}}>{getFileIcon(f.name)}</span>
              <div style={{flex:1,minWidth:0}}><div style={{fontSize:12,fontWeight:600,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",color:C.text}}>{f.name}</div><div style={{fontSize:11,color:C.muted2}}>{formatBytes(f.size)}</div></div>
              {f.data&&f.type&&f.type.startsWith("image/")&&<img src={f.data} alt="" style={{width:36,height:36,objectFit:"cover",borderRadius:6}}/>}
              <button onClick={()=>fv("files",form.files.filter((_,idx)=>idx!==i))} style={{background:"transparent",border:"none",color:C.red,fontSize:18,cursor:"pointer"}}>Ã—</button>
            </div>
          ))}
        </div>
        <div style={{display:"flex",gap:8}}><button onClick={save} style={{...btnSt("primary"),flex:1,padding:13}}>ğŸ’¾ Kaydet</button><button onClick={()=>{setShowForm(false);setForm(emptyForm);setEditId(null);}} style={{...btnSt("ghost"),padding:13}}>Ä°ptal</button></div>
      </div>
    </div>
  );

  return (
    <div style={{padding:16}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}}>
        <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase"}}>Ä°ÅŸ Emirleri Â· {orders.filter(o=>o.status==="active").length} aktif</div>
        <button onClick={()=>setShowForm(true)} style={{...btnSt("primary"),padding:"8px 14px",fontSize:12}}>+ Yeni</button>
      </div>
      {orders.length===0&&<div style={{textAlign:"center",color:C.muted2,padding:"40px 20px",background:C.card,borderRadius:14,border:`1px solid ${C.border}`}}><div style={{fontSize:36,marginBottom:10}}>ğŸ“‹</div>HenÃ¼z iÅŸ emri yok</div>}
      {orders.map(o=>(
        <div key={o.id} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:"13px 15px",marginBottom:10,opacity:o.status==="passive"?.6:1}}>
          <div style={{marginBottom:8}}>
            <div style={{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap"}}>
              <span style={{fontWeight:800,fontSize:14,fontFamily:"monospace",color:C.text}}>{o.code}</span>
              <Badge label={o.status==="active"?"Aktif":"Pasif"} color={o.status==="active"?C.green:C.muted2}/>
              {(o.files||[]).length>0&&<Badge label={`${o.files.length} dosya`} color={C.purple}/>}
            </div>
            <div style={{fontSize:13,color:C.muted2,marginTop:3}}>{o.name}</div>
            {o.material&&<div style={{fontSize:11,color:C.muted,marginTop:1}}>ğŸ”© {o.material}</div>}
            <div style={{fontSize:11,color:C.muted,marginTop:1}}>â± {fmtSec(o.partSec)} Â· {(o.machines||[]).join(", ")}</div>
          </div>
          <div style={{display:"flex",gap:7,flexWrap:"wrap"}}>
            <button onClick={()=>setViewOrder(o)} style={{...btnSt("ghost"),padding:"6px 12px",fontSize:12}}>ğŸ‘ GÃ¶rÃ¼ntÃ¼le</button>
            <button onClick={()=>{setForm({code:o.code,name:o.name,material:o.material||"",partSec:o.partSec,machines:o.machines||[],notes:o.notes||"",files:o.files||[]});setEditId(o.id);setShowForm(true);}} style={{...btnSt(),padding:"6px 12px",fontSize:12}}>âœï¸ DÃ¼zenle</button>
            <button onClick={()=>toggleStatus(o)} style={{...btnSt(o.status==="active"?"danger":"green"),padding:"6px 12px",fontSize:12}}>{o.status==="active"?"Pasife Al":"AktifleÅŸtir"}</button>
          </div>
        </div>
      ))}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA ENTRY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function DataEntry({currentUser,machines=DEFAULT_MACHINES}) {
  const [orders,setOrders]=useState([]);
  const [todayEntries,setTodayEntries]=useState([]);
  const [saved,setSaved]=useState(false);
  const [search,setSearch]=useState("");
  const [showPicker,setShowPicker]=useState(false);
  const [form,setForm]=useState({machine:machines[0]||"CNC-1",shift:"sabah",selectedOrder:null,correct:"",wrong:""});

  useEffect(()=>{
    window.DB.getAll("orders").then(o=>setOrders(o.filter(x=>x.status==="active")));
    window.DB.getAll("entries").then(e=>setTodayEntries(e.filter(x=>x.date===todayStr()&&x.operatorId===currentUser.id)));
  },[currentUser.id]);

  const fv=(k,v)=>setForm(p=>({...p,[k]:v}));
  const filtered=orders.filter(o=>o.code.toLowerCase().includes(search.toLowerCase())||o.name.toLowerCase().includes(search.toLowerCase()));

  async function submit() {
    if(!form.selectedOrder){alert("Ä°ÅŸ emri seÃ§in!");return;}
    if(!form.correct){alert("DoÄŸru adet zorunlu!");return;}
    const entry={
      date:todayStr(), week:weekStart(), month:monthStr(),
      machine:form.machine, shift:form.shift,
      operatorId:currentUser.id, operatorName:currentUser.fullName,
      jobCode:form.selectedOrder.code, jobName:form.selectedOrder.name,
      partSec:Number(form.selectedOrder.partSec),
      correct:Number(form.correct), wrong:Number(form.wrong)||0,
    };
    const id=await window.DB.addDoc("entries",entry);
    if(id){
      setTodayEntries(e=>[{id,...entry},...e]);
      setSaved(true); setTimeout(()=>setSaved(false),2000);
      setForm(p=>({...p,correct:"",wrong:""}));
    }
  }

  return (
    <div style={{padding:16,display:"flex",flexDirection:"column",gap:14}}>
      <div>
        <span style={labelSt}>Tezgah</span>
        <div style={{display:"flex",gap:7,flexWrap:"wrap"}}>
          {machines.map(m=><button key={m} onClick={()=>fv("machine",m)} style={chip(form.machine===m)}>{m}</button>)}
        </div>
      </div>
      <div>
        <span style={labelSt}>Vardiya</span>
        <div style={{display:"flex",gap:7,flexWrap:"wrap"}}>
          {SHIFTS.map(s=><button key={s.id} onClick={()=>fv("shift",s.id)} style={chip(form.shift===s.id)}>{s.label}<br/><span style={{fontSize:10,color:form.shift===s.id?C.accent:C.muted}}>{s.time}</span></button>)}
        </div>
      </div>
      <div>
        <span style={labelSt}>Ä°ÅŸ Emri *</span>
        {form.selectedOrder?(
          <div style={{background:C.surface,border:`1px solid ${C.accent}50`,borderRadius:10,padding:"12px 14px",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
            <div>
              <div style={{fontWeight:700,fontFamily:"monospace",fontSize:14,color:C.text}}>{form.selectedOrder.code}</div>
              <div style={{fontSize:12,color:C.muted2,marginTop:1}}>{form.selectedOrder.name} Â· {fmtSec(form.selectedOrder.partSec)} Â· Maks: {Math.floor(EFFECTIVE_SECONDS/form.selectedOrder.partSec)} adet/gÃ¼n</div>
              {form.selectedOrder.material&&<div style={{fontSize:11,color:C.muted,marginTop:1}}>ğŸ”© {form.selectedOrder.material}</div>}
            </div>
            <button onClick={()=>fv("selectedOrder",null)} style={{background:"transparent",border:"none",color:C.red,fontSize:20,cursor:"pointer"}}>Ã—</button>
          </div>
        ):(
          <>
            <button onClick={()=>setShowPicker(!showPicker)} style={{...inputSt,textAlign:"left",cursor:"pointer",color:C.muted2,display:"block"}}>{orders.length===0?"Aktif iÅŸ emri yok":"Ä°ÅŸ emri seÃ§in..."}</button>
            {showPicker&&(
              <div style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:10,marginTop:4,overflow:"hidden"}}>
                <input style={{...inputSt,borderRadius:0,borderBottom:`1px solid ${C.border}`}} placeholder="Ara..." value={search} onChange={e=>setSearch(e.target.value)} autoFocus/>
                <div style={{maxHeight:240,overflowY:"auto"}}>
                  {filtered.length===0&&<div style={{padding:16,color:C.muted2,textAlign:"center",fontSize:13}}>SonuÃ§ yok</div>}
                  {filtered.map(o=>(
                    <div key={o.id} onClick={()=>{fv("selectedOrder",o);setShowPicker(false);setSearch("");}} style={{padding:"12px 14px",cursor:"pointer",borderBottom:`1px solid ${C.border}`}}>
                      <div style={{fontWeight:700,fontFamily:"monospace",fontSize:13,color:C.text}}>{o.code}</div>
                      <div style={{fontSize:12,color:C.muted2,marginTop:1}}>{o.name} Â· â±{fmtSec(o.partSec)} Â· {(o.machines||[]).join(", ")}</div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </>
        )}
      </div>
      <div style={{display:"flex",gap:10}}>
        <div style={{flex:1}}><span style={labelSt}>âœ… DoÄŸru Adet *</span><input style={{...inputSt,borderColor:C.green+"50"}} type="number" min="0" placeholder="0" value={form.correct} onChange={e=>fv("correct",e.target.value)}/></div>
        <div style={{flex:1}}><span style={labelSt}>âŒ HatalÄ± Adet</span><input style={{...inputSt,borderColor:C.red+"50"}} type="number" min="0" placeholder="0" value={form.wrong} onChange={e=>fv("wrong",e.target.value)}/></div>
      </div>
      <button onClick={submit} style={{...btnSt(saved?"green":"primary"),width:"100%",padding:14,fontSize:15}}>{saved?"âœ“ Kaydedildi!":"Kaydet"}</button>
      {todayEntries.length>0&&(
        <div>
          <span style={{...labelSt,marginTop:4}}>BugÃ¼nkÃ¼ GiriÅŸlerim</span>
          {todayEntries.slice(0,5).map(e=>{
            const p=calcPerf(e.correct,e.wrong,e.partSec);
            return (
              <div key={e.id} style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:12,padding:"12px 14px",marginBottom:8}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                  <div><span style={{fontWeight:700,fontSize:13,fontFamily:"monospace",color:C.text}}>{e.jobCode}</span><span style={{fontSize:12,color:C.muted2,marginLeft:6}}>{e.jobName}</span></div>
                  <div style={{display:"flex",gap:5}}><Badge label={e.machine} color={C.accent}/><Badge label={e.shift} color={C.muted2}/></div>
                </div>
                <div style={{display:"flex",gap:12,marginTop:7,fontSize:13}}>
                  <span style={{color:C.green,fontWeight:600}}>âœ… {e.correct}</span>
                  <span style={{color:C.red,fontWeight:600}}>âŒ {e.wrong}</span>
                  {p&&<span style={{color:C.muted2}}>Maks/gÃ¼n: {p.max}</span>}
                </div>
                {p&&<PerfBar perf={p.perf} small/>}
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function Report({currentUser,machines=DEFAULT_MACHINES}) {
  const [period,setPeriod]=useState("gunluk");
  const [entries,setEntries]=useState([]);
  const [loading,setLoading]=useState(true);

  useEffect(()=>{window.DB.getAll("entries").then(e=>{setEntries(e);setLoading(false);});},[]);

  const today=todayStr(),thisWeek=weekStart(),thisMonth=monthStr();
  const filtered=entries.filter(e=>period==="gunluk"?e.date===today:period==="haftalik"?e.week===thisWeek:e.month===thisMonth);
  const byJob={};
  filtered.forEach(e=>{
    if(!byJob[e.jobCode]) byJob[e.jobCode]={jobCode:e.jobCode,jobName:e.jobName,correct:0,wrong:0,partSec:e.partSec,machines:new Set(),ops:new Set()};
    byJob[e.jobCode].correct+=e.correct; byJob[e.jobCode].wrong+=e.wrong;
    byJob[e.jobCode].machines.add(e.machine); byJob[e.jobCode].ops.add(e.operatorName||e.operatorId);
  });
  const jobs=Object.values(byJob).map(j=>({...j,machines:[...j.machines],ops:[...j.ops]}));
  const totalC=filtered.reduce((s,e)=>s+e.correct,0);
  const totalW=filtered.reduce((s,e)=>s+e.wrong,0);
  const qual=totalC+totalW>0?Math.round((totalC/(totalC+totalW))*100):0;

  if(loading) return <div style={{padding:30,color:C.muted2,textAlign:"center"}}>YÃ¼kleniyor...</div>;

  return (
    <div style={{padding:16}}>
      <div style={{display:"flex",gap:7,marginBottom:16}}>
        {[["gunluk","GÃ¼nlÃ¼k"],["haftalik","HaftalÄ±k"],["aylik","AylÄ±k"]].map(([id,lbl])=>(
          <button key={id} onClick={()=>setPeriod(id)} style={{flex:1,...chip(period===id)}}>{lbl}</button>
        ))}
      </div>
      {filtered.length===0?(
        <div style={{textAlign:"center",color:C.muted2,padding:"40px 20px",background:C.card,borderRadius:14,border:`1px solid ${C.border}`}}><div style={{fontSize:36,marginBottom:10}}>ğŸ“­</div>Bu dÃ¶nemde kayÄ±t yok</div>
      ):(
        <>
          <div style={{display:"flex",gap:8,marginBottom:16}}>
            {[{l:"DoÄŸru",v:totalC,col:C.green},{l:"HatalÄ±",v:totalW,col:C.red},{l:"Kalite",v:`${qual}%`,col:qual>=90?C.green:qual>=75?C.warn:C.red}].map(({l,v,col})=>(
              <div key={l} style={{flex:1,background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"12px 14px"}}>
                <div style={{color:C.muted2,fontSize:10,letterSpacing:1,textTransform:"uppercase",marginBottom:3}}>{l}</div>
                <div style={{color:col,fontSize:24,fontWeight:800,fontFamily:"monospace"}}>{v}</div>
              </div>
            ))}
          </div>
          <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",marginBottom:10}}>Ä°ÅŸ Emri BazlÄ±</div>
          {jobs.map(j=>{
            const p=calcPerf(j.correct,j.wrong,j.partSec);
            const q=j.correct+j.wrong>0?Math.round((j.correct/(j.correct+j.wrong))*100):0;
            return (
              <div key={j.jobCode} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:14,padding:"14px 16px",marginBottom:10}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:8}}>
                  <div><div style={{fontWeight:800,fontSize:14,fontFamily:"monospace",color:C.text}}>{j.jobCode}</div><div style={{fontSize:12,color:C.muted2,marginTop:1}}>{j.jobName}</div><div style={{fontSize:11,color:C.muted,marginTop:1}}>{j.machines.join(", ")} Â· {j.ops.join(", ")}</div></div>
                  <div style={{textAlign:"right"}}><div style={{fontSize:10,color:C.muted2}}>Kalite</div><div style={{fontWeight:800,color:q>=90?C.green:q>=75?C.warn:C.red,fontSize:16}}>{q}%</div></div>
                </div>
                <div style={{display:"flex",gap:8,fontSize:13,marginBottom:p?6:0}}>
                  <div style={{background:C.greenDim,border:`1px solid ${C.green}30`,borderRadius:8,padding:"5px 12px",color:C.green,fontWeight:700}}>âœ… {j.correct}</div>
                  <div style={{background:C.redDim,border:`1px solid ${C.red}30`,borderRadius:8,padding:"5px 12px",color:C.red,fontWeight:700}}>âŒ {j.wrong}</div>
                  {p&&<div style={{background:C.surface,border:`1px solid ${C.border}`,borderRadius:8,padding:"5px 12px",color:C.muted2,fontSize:12}}>Maks/gÃ¼n: {p.max}</div>}
                </div>
                {p&&<PerfBar perf={p.perf}/>}
              </div>
            );
          })}
          <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",marginBottom:10,marginTop:18}}>Tezgah Ã–zeti</div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
            {machines.map(m=>{
              const md=filtered.filter(e=>e.machine===m);
              const mc=md.reduce((s,e)=>s+e.correct,0),mw=md.reduce((s,e)=>s+e.wrong,0);
              const mq=mc+mw>0?Math.round((mc/(mc+mw))*100):null;
              return (
                <div key={m} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"12px 14px",opacity:md.length===0?.4:1}}>
                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4}}><span style={{fontWeight:700,color:C.text}}>{m}</span>{mq!==null&&<span style={{color:mq>=90?C.green:mq>=75?C.warn:C.red,fontWeight:700,fontSize:13}}>{mq}%</span>}</div>
                  <div style={{fontSize:12,color:C.muted2}}>{md.length===0?"KayÄ±t yok":`âœ… ${mc}  âŒ ${mw}`}</div>
                  {mq!==null&&<div style={{background:C.border,borderRadius:99,height:4,marginTop:8}}><div style={{width:`${mq}%`,height:"100%",background:mq>=90?C.green:mq>=75?C.warn:C.red,borderRadius:99}}/></div>}
                </div>
              );
            })}
          </div>
          {currentUser.role==="admin"&&(()=>{
            const byOp={};
            filtered.forEach(e=>{const k=e.operatorName||e.operatorId;if(!byOp[k])byOp[k]={name:k,correct:0,wrong:0};byOp[k].correct+=e.correct;byOp[k].wrong+=e.wrong;});
            const ops=Object.values(byOp).sort((a,b)=>b.correct-a.correct);
            if(!ops.length) return null;
            return (<>
              <div style={{color:C.muted2,fontSize:11,letterSpacing:1,textTransform:"uppercase",marginBottom:10,marginTop:18}}>OperatÃ¶r PerformansÄ±</div>
              {ops.map((op,i)=>{const q=op.correct+op.wrong>0?Math.round((op.correct/(op.correct+op.wrong))*100):0;return(
                <div key={op.name} style={{background:C.card,border:`1px solid ${C.border}`,borderRadius:12,padding:"12px 16px",marginBottom:8,display:"flex",alignItems:"center",gap:12}}>
                  <div style={{width:28,height:28,borderRadius:8,background:i===0?C.warn+"25":C.surface,display:"flex",alignItems:"center",justifyContent:"center",color:i===0?C.warn:C.muted2,fontWeight:800,fontSize:13}}>{i+1}</div>
                  <div style={{flex:1}}><div style={{fontWeight:600,fontSize:13,color:C.text}}>{op.name}</div><div style={{fontSize:12,color:C.muted2,marginTop:1}}>âœ… {op.correct} &nbsp; âŒ {op.wrong}</div></div>
                  <div style={{color:q>=90?C.green:q>=75?C.warn:C.red,fontWeight:800,fontSize:15}}>{q}%</div>
                </div>
              );})}
            </>);
          })()}
        </>
      )}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAIN APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function App() {
  const [currentUser,setCurrentUser]=useState(null);
  const [loading,setLoading]=useState(true);
  const [tab,setTab]=useState("giris");
  const [machines,setMachines]=useState(DEFAULT_MACHINES);

  useEffect(()=>{
    async function init() {
      // Load machines config
      const mc=await window.DB.getDoc("config","machines");
      if(mc&&mc.list&&mc.list.length>0) setMachines(mc.list);
      // Restore session
      const session=window.Session.get();
      if(session){
        const u=await window.DB.getDoc("users",session.username);
        if(u&&u.status==="active") setCurrentUser(u);
        else window.Session.clear();
      }
      setLoading(false);
    }
    if(window.FB_READY) init();
    else window.addEventListener("fb_ready",init,{once:true});
  },[]);

  async function updateMachines(list){
    setMachines(list);
    await window.DB.setDoc("config","machines",{list});
  }
  async function logout(){window.Session.clear();setCurrentUser(null);setTab("giris");}

  if(loading) return <div style={{background:C.bg,minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",gap:12}}><div style={{width:40,height:40,border:`3px solid ${C.border}`,borderTop:`3px solid ${C.accent}`,borderRadius:"50%",animation:"spin 1s linear infinite"}}/><div style={{color:C.muted2,fontSize:13}}>BaÄŸlanÄ±yor...</div><style>{`@keyframes spin{to{transform:rotate(360deg)}}`}</style></div>;
  if(!currentUser) return <AuthScreen onLogin={u=>setCurrentUser(u)}/>;

  const isAdmin=currentUser.role==="admin";
  const canEntry=hasPermission(currentUser,"data_entry");
  const canReport=hasPermission(currentUser,"view_reports");
  const canOrders=hasPermission(currentUser,"manage_orders")||isAdmin;
  const canUsers=hasPermission(currentUser,"approve_users")||isAdmin;

  const tabs=[
    ...(canEntry?[{id:"giris",icon:"ğŸ“",label:"GiriÅŸ"}]:[]),
    ...(canReport?[{id:"rapor",icon:"ğŸ“Š",label:"Rapor"}]:[]),
    ...(canOrders?[{id:"orders",icon:"ğŸ“‹",label:"Ä°ÅŸ Emirleri"}]:[]),
    ...(canUsers?[{id:"users",icon:"ğŸ‘¥",label:"KullanÄ±cÄ±lar"}]:[]),
  ];

  return (
    <div style={{background:C.bg,minHeight:"100vh",color:C.text,fontFamily:"'DM Sans','Segoe UI',sans-serif",maxWidth:480,margin:"0 auto",paddingBottom:80}}>
      <div style={{background:C.surface,borderBottom:`1px solid ${C.border}`,padding:"14px 16px",position:"sticky",top:0,zIndex:10}}>
        <div style={{display:"flex",alignItems:"center",gap:10}}>
          <div style={{width:34,height:34,borderRadius:10,background:`linear-gradient(135deg,${C.accent},#7b5cf0)`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:16}}>âš™ï¸</div>
          <div style={{flex:1}}><div style={{fontWeight:700,fontSize:14,color:C.text}}>CNC AtÃ¶lye Takip</div><div style={{color:C.muted2,fontSize:11,display:"flex",alignItems:"center",gap:5}}><span>{currentUser.fullName}</span><Badge label={isAdmin?"YÃ¶netici":"OperatÃ¶r"} color={isAdmin?C.accent:C.muted2}/></div></div>
          <button onClick={logout} style={{...btnSt("ghost"),padding:"7px 12px",fontSize:12}}>Ã‡Ä±kÄ±ÅŸ</button>
        </div>
      </div>
      {tab==="giris"&&<DataEntry currentUser={currentUser} machines={machines}/>}
      {tab==="rapor"&&<Report currentUser={currentUser} machines={machines}/>}
      {tab==="orders"&&<WorkOrders currentUser={currentUser} machines={machines}/>}
      {tab==="users"&&<AdminUsers currentUser={currentUser} machines={machines} onMachinesUpdate={updateMachines}/>}
      <div style={{position:"fixed",bottom:0,left:"50%",transform:"translateX(-50%)",width:"100%",maxWidth:480,background:C.surface,borderTop:`1px solid ${C.border}`,display:"flex",zIndex:20}}>
        {tabs.map(t=>(
          <button key={t.id} onClick={()=>setTab(t.id)} style={{flex:1,padding:"12px 0 10px",border:"none",background:"transparent",cursor:"pointer",color:tab===t.id?C.accent:C.muted,borderTop:`2px solid ${tab===t.id?C.accent:"transparent"}`,fontFamily:"inherit"}}>
            <div style={{fontSize:20}}>{t.icon}</div>
            <div style={{fontSize:10,fontWeight:tab===t.id?700:400,marginTop:2}}>{t.label}</div>
          </button>
        ))}
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
